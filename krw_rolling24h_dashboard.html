<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KRW Rolling 24h Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>

  <style>
    :root{
      --bg:#f8fafc;
      --panel:#ffffff;
      --border:#e5e7eb;
      --text:#0f172a;
      --muted:#64748b;

      --shadow:0 1px 2px rgba(15,23,42,.06);
      --radius:14px;

      --accent:#2563eb;
      --accent-2:#7c3aed;

      --sidebar:#0b1220;
      --sidebarText:#e2e8f0;
      --sidebarMuted:#94a3b8;

      --chip:#f1f5f9;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif;
    }
     
    /* Layout */
    .app{
      display:grid;
      grid-template-columns: 260px 1fr;
      min-height:100vh;
    }
    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
    }

    /* Sidebar */
    .sidebar{
      background:var(--sidebar);
      padding:18px 14px;
      position:sticky;
      top:0;
      height:100vh;
      overflow:auto;
      border-right:1px solid rgba(255,255,255,.06);
    }
    @media (max-width: 980px){
      .sidebar{
        position:relative;
        height:auto;
      }
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 10px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      margin-bottom:14px;
    }
    .logo{
      width:32px; height:32px;
      border-radius:10px;
      background:linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow:0 6px 18px rgba(37,99,235,.25);
    }
    .brand h1{
      margin:0;
      font-size:14px;
      color:var(--sidebarText);
      letter-spacing:-0.2px;
    }
    .brand p{
      margin:2px 0 0;
      font-size:12px;
      color:var(--sidebarMuted);
    }

    .navsec{
      margin:14px 0;
    }
    .navtitle{
      font-size:11px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:rgba(226,232,240,.7);
      padding:0 10px;
      margin:0 0 8px;
    }
    .nav a{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border-radius:10px;
      color:var(--sidebarText);
      text-decoration:none;
      font-size:13px;
      transition: background .15s ease;
    }
    .nav a:hover{ background:rgba(255,255,255,.06); }
    .nav a .tag{
      font-size:11px;
      color:var(--sidebarMuted);
      background:rgba(255,255,255,.06);
      padding:2px 8px;
      border-radius:999px;
      white-space:nowrap;
    }

    /* Main */
    .main{
      padding:18px 18px 34px;
    }
    .topbar{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
      margin-bottom:14px;
    }
    .topbar .title h2{
      margin:0;
      font-size:20px;
      letter-spacing:-0.3px;
    }
    .topbar .title p{
      margin:6px 0 0;
      font-size:13px;
      color:var(--muted);
      max-width:820px;
      line-height:1.45;
    }
    .topbar .meta{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .chip{
      background:var(--chip);
      border:1px solid var(--border);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color:#334155;
      white-space:nowrap;
    }
    .chip b{ font-weight:700; }

    /* Cards / widgets */
    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }

    .kpiGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-bottom:14px;
    }
    @media (min-width: 980px){
      .kpiGrid{ grid-template-columns: repeat(4, 1fr); }
    }
    .kpi{
      padding:12px 12px;
      min-width:0;
    }
    .kpi .label{ color:var(--muted); font-size:12px; margin:0 0 6px; }
    .kpi .value{ font-size:20px; font-weight:800; letter-spacing:-0.3px; margin:0; }
    .kpi .note{ color:var(--muted); font-size:12px; margin-top:6px; }

    /* Section header */
    .section{
      margin-top:16px;
    }
    .sectionHead{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin:0 0 10px;
    }
    .sectionHead h3{
      margin:0;
      font-size:14px;
      letter-spacing:-0.2px;
    }
    .sectionHead p{
      margin:6px 0 0;
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
    }
    .sectionHead .right{
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }

    /* Widget grid (The Block-like) */
    .widgets{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 1100px){
      .widgets{ grid-template-columns: repeat(2, 1fr); }
    }

    .widget{
      padding:12px;
    }
    .widgetHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .wTitle{
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .wIcon{
      width:28px; height:28px;
      border-radius:10px;
      background:#eef2ff;
      border:1px solid #e0e7ff;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#3730a3;
      font-weight:800;
      font-size:12px;
      flex:0 0 auto;
    }
    .wTitle h4{
      margin:0;
      font-size:13px;
      letter-spacing:-0.2px;
    }
    .wTitle .desc{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }
    .wMeta{
      text-align:right;
      color:var(--muted);
      font-size:11px;
      white-space:nowrap;
    }

    /* Chart areas */
    .chart{
      width:100%;
      height:320px;
    }
    #totalChart{ height:360px; }
    #treemap{ height:360px; }
    #stableChart{ height:220px; }

    /* Controls */
    .toolbar{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .btn{
      border:1px solid var(--border);
      background:#fff;
      color:#334155;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
    }
    .btn.active{
      border-color:#0f172a;
      color:#0f172a;
      font-weight:800;
    }

    /* Lists */
    .list{ margin:0; padding:0; list-style:none; }
    .list li{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:9px 2px;
      border-top:1px solid var(--border);
      font-size:12.5px;
      color:#0f172a;
    }
    .list li:first-child{ border-top:none; }
    .pill{
      font-size:11px;
      color:#334155;
      background:var(--chip);
      border:1px solid var(--border);
      padding:3px 8px;
      border-radius:999px;
      white-space:nowrap;
    }
    .footnote{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
    }
    code{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body>
<div class="app">

  <!-- LEFT SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>KRW Market Board</h1>
        <p>Rolling 24h · 8h snapshot</p>
      </div>
    </div>

    <div class="navsec">
      <div class="navtitle">Markets</div>
      <nav class="nav">
        <a href="#sec-overview">Overview <span class="tag">KRW</span></a>
        <a href="#sec-flows">Flows & Share <span class="tag">EX</span></a>
        <a href="#sec-concentration">Concentration <span class="tag">Top10</span></a>
        <a href="#sec-stables">Stablecoins <span class="tag">K-Safety</span></a>
      </nav>
    </div>

    <div class="navsec">
      <div class="navtitle">K-Intelligence</div>
      <nav class="nav">
        <a href="#sec-topcoins">Top Coins <span class="tag">Heat</span></a>
        <a href="#sec-extop">Exchange Top5 <span class="tag">Up/BT/CO</span></a>
        <a href="#sec-kimchi">Smart Kimchi <span class="tag">Premium</span></a>
      </nav>
    </div>

    <div class="navsec">
      <div class="navtitle">Data</div>
      <nav class="nav">
        <a href="#sec-data">Paths <span class="tag">JSON</span></a>
      </nav>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">

    <div class="topbar">
      <div class="title">
        <h2>KRW Rolling 24h Dashboard</h2>
        <p>“최근 24시간(rolling) 거래대금”을 8시간마다 갱신해 한국 KRW 시장의 현재 판(테마/쏠림/거래소 이동)을 한 페이지에서 확인합니다.</p>
      </div>
      <div class="meta">
        <span class="chip" id="metaUpdated">UPDATED: -</span>
        <span class="chip" id="metaSignal">SIGNAL: -</span>
      </div>
    </div>

    <!-- KPI -->
    <section id="sec-overview" class="kpiGrid">
      <div class="panel kpi">
        <p class="label">현재(최근 24h) 총 거래대금</p>
        <p class="value" id="kpiTotal">-</p>
        <div class="note" id="kpiTs">-</div>
      </div>
      <div class="panel kpi">
        <p class="label">Top10 쏠림 (최근 24h)</p>
        <p class="value" id="kpiTop10">-</p>
        <div class="note" id="kpiTop10Note">-</div>
      </div>
      <div class="panel kpi">
        <p class="label">거래소 구도 (최근 24h)</p>
        <p class="value" id="kpiEx">-</p>
        <div class="note" id="kpiExNote">-</div>
      </div>
      <div class="panel kpi" style="border-color:#bfdbfe;">
        <p class="label" style="color:#1d4ed8;">K-Safety (Stablecoin Share)</p>
        <p class="value" id="kpiStable">-</p>
        <div class="note" id="kpiStableNote">-</div>
      </div>
    </section>

    <!-- TOTAL (big) -->
    <section class="section" id="sec-flows">
      <div class="sectionHead">
        <div>
          <h3>Flow</h3>
          <p>총 거래대금 수준(라인) + 직전 대비 변화(막대)로 “시장 온도”를 봅니다.</p>
          <div class="toolbar">
            <button class="btn" id="btn1d">1D</button>
            <button class="btn active" id="btn3d">3D</button>
            <button class="btn" id="btn7d">7D</button>
            <span class="pill">rolling 24h · overlaps ok</span>
          </div>
        </div>
        <div class="right">Snapshot cadence: 8h</div>
      </div>

      <div class="panel widget">
        <div class="widgetHead">
          <div class="wTitle">
            <div class="wIcon">Σ</div>
            <div>
              <h4>총 거래대금 추이 (Rolling 24h)</h4>
              <div class="desc">Step line(수준) + Δ bar(직전 대비) 조합</div>
            </div>
          </div>
          <div class="wMeta" id="wTotalMeta">UPDATED: -</div>
        </div>
        <div id="totalChart" class="chart"></div>
      </div>

      <!-- share + top10 vs rest : ✅ “아래 나란히 / 덜 좁게” -->
      <div class="widgets" style="margin-top:12px;">
        <div class="panel widget" id="sec-concentration">
          <div class="widgetHead">
            <div class="wTitle">
              <div class="wIcon">%</div>
              <div>
                <h4>거래소 점유율(%) 추이</h4>
                <div class="desc">업비트·빗썸·코인원 비중 이동</div>
              </div>
            </div>
            <div class="wMeta">SOURCE:BLOCKMEDIA</div>
          </div>
          <div id="shareChart" class="chart"></div>
        </div>

        <div class="panel widget">
          <div class="widgetHead">
            <div class="wTitle">
              <div class="wIcon">10</div>
              <div>
                <h4>Top10 vs Rest (쏠림/확산)</h4>
                <div class="desc">Top10/Rest 분해 + Top10 점유율 라인</div>
              </div>
            </div>
            <div class="wMeta">SOURCE:BLOCKMEDIA</div>
          </div>
          <div id="topRestChart" class="chart"></div>
        </div>
      </div>
    </section>

    <!-- Right-side style blocks: Top coins, stable, exchange top, kimchi -->
    <section class="section" id="sec-topcoins">
      <div class="sectionHead">
        <div>
          <h3>Top Coins</h3>
          <p>“어떤 알트에 쏠렸는지”를 한 눈에 확인합니다.</p>
        </div>
        <div class="right">
          <span class="pill" id="pillNow">-</span>
          <span class="pill" id="pillSignal">-</span>
        </div>
      </div>

      <div class="widgets">
        <div class="panel widget">
          <div class="widgetHead">
            <div class="wTitle">
              <div class="wIcon">T</div>
              <div>
                <h4>Top10 Treemap</h4>
                <div class="desc">규모(거래대금) 기준 시각화</div>
              </div>
            </div>
            <div class="wMeta">VIEW: 24h</div>
          </div>
          <div id="treemap" class="chart"></div>

          <ul class="list" id="top10List" style="margin-top:8px;"></ul>
        </div>

        <div class="panel widget" id="sec-stables">
          <div class="widgetHead">
            <div class="wTitle">
              <div class="wIcon">S</div>
              <div>
                <h4>Stable Dominance</h4>
                <div class="desc">KRW 시장 “안전선호/대기자금” 신호</div>
              </div>
            </div>
            <div class="wMeta">K-Safety</div>
          </div>
          <div id="stableChart" class="chart"></div>

          <div class="footnote">
            KPI의 <b>K-Safety</b>와 동일한 데이터(스테이블 거래대금/비중) 기반입니다.
          </div>
        </div>
      </div>
    </section>

    <section class="section" id="sec-extop">
      <div class="sectionHead">
        <div>
          <h3>Exchange Top5</h3>
          <p>거래소별로 “채널 쏠림(상위 코인)”을 따로 봅니다.</p>
        </div>
        <div class="right">Upbit · Bithumb · Coinone</div>
      </div>

      <div class="widgets">
        <div class="panel widget">
          <div class="widgetHead">
            <div class="wTitle">
              <div class="wIcon">U</div>
              <div>
                <h4>Upbit Top5</h4>
                <div class="desc">최근 24h 거래대금 기준</div>
              </div>
            </div>
            <div class="wMeta">KRW pairs</div>
          </div>
          <ul class="list" id="upTop5"></ul>
        </div>

        <div class="panel widget">
          <div class="widgetHead">
            <div class="wTitle">
              <div class="wIcon">B</div>
              <div>
                <h4>Bithumb Top5</h4>
                <div class="desc">최근 24h 거래대금 기준</div>
              </div>
            </div>
            <div class="wMeta">KRW pairs</div>
          </div>
          <ul class="list" id="btTop5"></ul>
        </div>
      </div>

      <div class="panel widget" style="margin-top:12px;">
        <div class="widgetHead">
          <div class="wTitle">
            <div class="wIcon">C</div>
            <div>
              <h4>Coinone Top5</h4>
              <div class="desc">최근 24h 거래대금 기준</div>
            </div>
          </div>
          <div class="wMeta">KRW pairs</div>
        </div>
        <ul class="list" id="coTop5"></ul>
      </div>
    </section>

    <section class="section" id="sec-kimchi">
      <div class="sectionHead">
        <div>
          <h3>Smart Kimchi</h3>
          <p>BTC/ETH 김프 추이 + Kimchi Type/Score로 “지금 김프의 성격”을 봅니다.</p>
        </div>
        <div class="right" id="kimchiUpdated">UPDATED: -</div>
      </div>

      <div class="widgets">
        <div class="panel widget">
          <div class="widgetHead">
            <div class="wTitle">
              <div class="wIcon">%</div>
              <div>
                <h4>Kimchi Premium % (BTC/ETH/Combo)</h4>
                <div class="desc">국내(Upbit KRW) vs 글로벌(USD) * 환산</div>
              </div>
            </div>
            <div class="wMeta">v1</div>
          </div>
          <div id="kimchiPremChart" class="chart"></div>
        </div>

        <div class="panel widget">
          <div class="widgetHead">
            <div class="wTitle">
              <div class="wIcon">K</div>
              <div>
                <h4>Kimchi Type & Score</h4>
                <div class="desc">Retail/Constraint/Neutral 분류 + score</div>
              </div>
            </div>
            <div class="wMeta">v1</div>
          </div>
          <div id="kimchiScoreChart" class="chart"></div>

          <div style="margin-top:10px;">
            <div class="pill" style="display:inline-block; margin-bottom:8px;">Kimchi Comment</div>
            <div style="font-size:14px; line-height:1.55;">
              <div id="kimchiCommentHead" style="font-weight:700;">-</div>
              <div id="kimchiCommentBody" class="sub" style="margin:6px 0 0;">-</div>
            </div>
          </div>
          
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
            <span class="pill" id="kimchiTypePill">-</span>
            <span class="pill" id="kimchiScorePill">-</span>
            <span class="pill" id="kimchiPremPill">-</span>
          </div>
        </div>
      </div>
    </section>

    <section class="section" id="sec-data">
      <div class="panel widget">
        <div class="widgetHead">
          <div class="wTitle">
            <div class="wIcon">JS</div>
            <div>
              <h4>Data Paths</h4>
              <div class="desc">GitHub Pages에서 읽는 JSON 경로</div>
            </div>
          </div>
          <div class="wMeta">/bm/out/history/</div>
        </div>
        <div class="footnote">
          KRW: <code>/bm/out/history/krw_24h_latest.json</code> · <code>/bm/out/history/krw_24h_snapshots.json</code><br/>
          Kimchi: <code>/bm/out/history/kimchi_latest.json</code> · <code>/bm/out/history/kimchi_snapshots.json</code>
        </div>
      </div>
    </section>

  </main>
</div>
  
<script>
  function num(x){
    const n = Number(x);
    return Number.isFinite(n) ? n : 0;
  }
  function fmtKRW(n){
    n = num(n);
    const abs = Math.abs(n);
    if (abs >= 1e12) return (n/1e12).toFixed(2) + "조원";
    if (abs >= 1e8)  return (n/1e8).toFixed(0) + "억원";
    return n.toLocaleString("ko-KR") + "원";
  }
  function fmtPct(p){
    if (p === null || p === undefined || Number.isNaN(p)) return "-";
    const sign = p > 0 ? "+" : "";
    return sign + Number(p).toFixed(2) + "%";
  }
  function fmtPct1(p){
    if (p === null || p === undefined || Number.isNaN(p)) return "-";
    const sign = p > 0 ? "+" : "";
    return sign + Number(p).toFixed(1) + "%";
  }
  async function loadJSON(url){
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error("Failed to load: " + url + " (" + res.status + ")");
    return await res.json();
  }

  function urls(){
    const bust = "v=" + Date.now();
    return {
      latest: "/bm/out/history/krw_24h_latest.json?" + bust,
      hist:   "/bm/out/history/krw_24h_snapshots.json?" + bust,
      kimchiLatest: "/bm/out/history/kimchi_latest.json?" + bust,
      kimchiHist:   "/bm/out/history/kimchi_snapshots.json?" + bust
    };
  }

  let treemap, totalChart, shareChart, topRestChart, stableChart, kimchiPremChart, kimchiScoreChart;
  let HISTORY = [], LATEST = null;
  let KIMCHI_HIST = [], KIMCHI_LATEST = null;
  let CURRENT_RANGE = 3;

  function setActive(range){
    document.getElementById("btn1d")?.classList.toggle("active", range === 1);
    document.getElementById("btn3d")?.classList.toggle("active", range === 3);
    document.getElementById("btn7d")?.classList.toggle("active", range === 7);
  }

  function sliceByDays(history, days){
    const need = days * 3;
    const arr = Array.isArray(history) ? history : [];
    return arr.slice(-Math.max(need, 2));
  }

  function buildSeries(hist){
    const x = hist.map(h => h.timestamp_label);
    const total = hist.map(h => num(h.totals?.combined_24h));
    const up = hist.map(h => num(h.totals?.upbit_24h));
    const bt = hist.map(h => num(h.totals?.bithumb_24h));
    const co = hist.map(h => num(h.totals?.coinone_24h));
    const top10 = hist.map(h => num(h.top10?.top10_total_24h));
    const rest = hist.map(h => num(h.top10?.rest_total_24h));
    const topShare = hist.map(h => num(h.top10?.top10_share_pct));
    const delta = total.map((v,i)=> i===0 ? null : (v - total[i-1]));
    return { x, total, delta, up, bt, co, top10, rest, topShare };
  }

  function render(rangeDays){
    CURRENT_RANGE = rangeDays;
    setActive(rangeDays);

    const hist = sliceByDays(HISTORY, rangeDays);
    const s = buildSeries(hist);

    totalChart?.setOption({
      grid: { left: 72, right: 72, top: 44, bottom: 44 },
      tooltip: {
        trigger: "axis",
        axisPointer: { type: "cross" },
        formatter: (params) => {
          const i = params[0].dataIndex;
          const d = s.delta[i];
          const dText = (d === null) ? "-" : (d>=0 ? "▲ " : "▼ ") + fmtKRW(Math.abs(d));
          return `<b>${s.x[i]}</b><br/>총 ${fmtKRW(s.total[i])}<br/>직전 대비 ${dText}`;
        }
      },
      legend: { top: 0, left: 0, data: ["Total (24h)", "Δ vs prev"] },
      xAxis: { type: "category", 
               data: s.x, 
               axisLabel: { color: "#6b7280", rotate: (s.x.length > 10 ? 25 : 0) } 
      },
      yAxis: [
        { 
          type: "value", 
          name: "", 
          axisLabel: { color: "#6b7280", margin: 14 },
        { type: "value", name: "KRW (Δ)", axisLabel: { color: "#6b7280" }, splitLine: { show: false } }
      ],
      series: [
        { name: "Total (24h)", type: "line", step: "end", smooth: false, symbolSize: 6, data: s.total },
        { name: "Δ vs prev", type: "bar", yAxisIndex: 1, barWidth: 14, data: s.delta }
      ]
    }, true);

    if (stableChart){
      const stablePct = hist.map(h => num(h.stablecoins?.stable_dominance_pct));
      const stableVol = hist.map(h => num(h.stablecoins?.total_stable_vol_24h));
      stableChart.setOption({
        grid: { left: 56, right: 18, top: 22, bottom: 36 },
        tooltip: {
          trigger: "axis",
          formatter: (params) => {
            const i = params[0].dataIndex;
            return `<b>${s.x[i]}</b><br/>Stable Dom ${stablePct[i].toFixed(1)}%<br/>Stable Vol ${fmtKRW(stableVol[i])}`;
          }
        },
        legend: { top: 0, left: 0, data: ["Stable Dom %"] },
        xAxis: { type: "category", data: s.x, axisLabel: { rotate: (s.x.length > 10 ? 25 : 0) } },
        yAxis: { type: "value", name: "%", min: 0, max: 100, splitLine: { show: true } },
        series: [{ name: "Stable Dom %", type: "line", smooth: true, symbolSize: 6, data: stablePct }]
      }, true);
    }

    const shareUp = s.total.map((_,i)=> s.total[i] > 0 ? s.up[i]/s.total[i]*100 : 0);
    const shareBt = s.total.map((_,i)=> s.total[i] > 0 ? s.bt[i]/s.total[i]*100 : 0);
    const shareCo = s.total.map((_,i)=> s.total[i] > 0 ? s.co[i]/s.total[i]*100 : 0);
    shareChart?.setOption({
      grid: { left: 44, right: 14, top: 34, bottom: 34, containLabel: true },
      tooltip: {
        trigger:"axis",
        formatter:(params)=>{
          const i = params[0].dataIndex;
          return `<b>${s.x[i]}</b><br/>업비트 ${shareUp[i].toFixed(1)}%<br/>빗썸 ${shareBt[i].toFixed(1)}%<br/>코인원 ${shareCo[i].toFixed(1)}%`;
        }
      },
      legend: { top: 6, left: 0, itemWidth: 14, itemHeight: 8, data: ["Upbit","Bithumb","Coinone"] },
      xAxis: { type:"category", data:s.x, axisLabel:{ rotate:(s.x.length>10?25:0) } },
      yAxis: { type:"value", min:0, max:100, name:"%" },
      series: [
        { name:"Upbit", type:"line", stack:"s", areaStyle:{}, smooth:true, symbolSize:3, data: shareUp },
        { name:"Bithumb", type:"line", stack:"s", areaStyle:{}, smooth:true, symbolSize:3, data: shareBt },
        { name:"Coinone", type:"line", stack:"s", areaStyle:{}, smooth:true, symbolSize:3, data: shareCo }
      ]
    }, true);

    topRestChart?.setOption({
      grid: { left: 44, right: 44, top: 40, bottom: 34, containLabel: true },
      tooltip: {
        trigger:"axis",
        axisPointer:{ type:"shadow" },
        formatter:(params)=>{
          const i = params[0].dataIndex;
          return `<b>${s.x[i]}</b><br/>Top10 ${fmtKRW(s.top10[i])}<br/>Rest ${fmtKRW(s.rest[i])}<br/>Top10 Share ${s.topShare[i].toFixed(1)}%`;
        }
      },
      legend: { top: 6, left: 0, itemWidth: 14, itemHeight: 8, data: ["Top10","Rest","Top10 Share %"] },
      xAxis: { type:"category", data:s.x, axisLabel:{ rotate:(s.x.length>10?25:0) } },
      yAxis: [
        { type:"value", name:"KRW" },
        { type:"value", name:"%", min:0, max:100, splitLine:{ show:false } }
      ],
      series: [
        { name:"Top10", type:"bar", stack:"t", data: s.top10, barWidth: 16 },
        { name:"Rest", type:"bar", stack:"t", data: s.rest, barWidth: 16 },
        { name:"Top10 Share %", type:"line", yAxisIndex:1, smooth:true, symbolSize:6, data: s.topShare }
      ]
    }, true);

    // ✅ Kimchi Score chart (range에 맞춰 같이 갱신)
    if (kimchiScoreChart && Array.isArray(KIMCHI_HIST) && KIMCHI_HIST.length){
      const kHist = sliceByDays(KIMCHI_HIST, rangeDays);
      const kx = kHist.map(h => h.timestamp_label);
      const ks = kHist.map(h => num(h.smart_kimchi?.score_v1));
      kimchiScoreChart.setOption({
        grid: { left: 44, right: 18, top: 30, bottom: 36, containLabel: true },
        tooltip: { trigger:"axis" },
        xAxis: { type:"category", data:kx, axisLabel:{ rotate:(kx.length>10?25:0) } },
        yAxis: { type:"value", min:0, max:100, name:"Score" },
        series: [{ type:"line", smooth:true, symbolSize:6, data: ks }]
      }, true);
    }
  }


   // ✅ Kimchi Premium chart (BTC/ETH/COMBO + ΔCOMBO)
    if (kimchiPremChart && Array.isArray(KIMCHI_HIST) && KIMCHI_HIST.length){
      const kHist = sliceByDays(KIMCHI_HIST, rangeDays);
      const kx = kHist.map(h => h.timestamp_label);
    
      const kb = kHist.map(h => num(h.kimchi_premium_pct?.BTC));
      const ke = kHist.map(h => num(h.kimchi_premium_pct?.ETH));
      const kc = kHist.map(h => num(h.kimchi_premium_pct?.COMBO));
      const kd = kc.map((v,i)=> i===0 ? null : (num(v) - num(kc[i-1]))); // ΔCOMBO (p)
    
      kimchiPremChart.setOption({
        grid: { left: 44, right: 18, top: 30, bottom: 36, containLabel: true },
        tooltip: {
          trigger:"axis",
          formatter:(params)=>{
            const i = params[0].dataIndex;
            const d = kd[i];
            const dText = (d===null) ? "-" : ((d>=0?"+":"") + d.toFixed(2) + "p");
            return `<b>${kx[i]}</b><br/>BTC ${fmtPct(kb[i])}<br/>ETH ${fmtPct(ke[i])}<br/>COMBO ${fmtPct(kc[i])}<br/>ΔCOMBO ${dText}`;
          }
        },
        legend: { top: 6, left: 0, itemWidth: 14, itemHeight: 8, data: ["BTC","ETH","COMBO","ΔCOMBO"] },
        xAxis: { type:"category", data:kx, axisLabel:{ rotate:(kx.length>10?25:0) } },
        yAxis: [
          { type:"value", name:"%", axisLabel:{ formatter:(v)=> Number(v).toFixed(1) } },
          { type:"value", name:"Δp", splitLine:{ show:false }, axisLabel:{ formatter:(v)=> Number(v).toFixed(1) } }
        ],
        series: [
          { name:"BTC", type:"line", smooth:true, symbolSize:5, data: kb },
          { name:"ETH", type:"line", smooth:true, symbolSize:5, data: ke },
          { name:"COMBO", type:"line", smooth:true, symbolSize:6, lineStyle:{ width:3 }, data: kc },
          { name:"ΔCOMBO", type:"bar", yAxisIndex:1, barWidth: 12, data: kd }
        ]
      }, true);
    }
 
  
  function fillTopList(elId, arr){
    const el = document.getElementById(elId);
    if (!el) return;
    el.innerHTML = "";
    (arr || []).slice(0,5).forEach((c, idx) => {
      const sym = (c.symbol || "").replace("KRW-","");
      const li = document.createElement("li");
      li.innerHTML = `<span>${idx+1}. ${sym}</span><span>${fmtKRW(c.value)}</span>`;
      el.appendChild(li);
    });
  }

  // ✅ 김치 코멘트 생성기
  function buildKimchiComment(latest, history, kimchiLatest){
    const ts = (latest?.timestamp_label || "-");
    const t = latest?.totals || {};
    const top = latest?.top10 || {};
    const st = latest?.stablecoins || {};

    const total = num(t.combined_24h);
    const topShare = num(top.top10_share_pct);
    const stableDom = num(st.stable_dominance_pct);

    const kl = kimchiLatest || {};
    const kPrem = kl.kimchi_premium_pct || {};
    const combo = num(kPrem.COMBO);
    const btc = num(kPrem.BTC);
    const eth = num(kPrem.ETH);

    const kType = (kl.smart_kimchi?.type || "-");
    const kScore = num(kl.smart_kimchi?.score_v1);

    const heat =
      total >= 4e12 ? "거래대금이 4조원대까지 올라 판이 과열 쪽으로 기운다" :
      total >= 2e12 ? "유동성이 2조원대에서 유지되며 리스크온/리스크오프가 교차한다" :
      "거래대금이 낮아지며 방향성이 약해진 구간";

    const crowd =
      topShare >= 70 ? "상위 10종목 쏠림이 강해 테마 장세 성격이 짙다" :
      topShare >= 60 ? "쏠림이 유지되지만 확산 여지도 남는다" :
      "쏠림이 약해지며 종목 확산이 진행된다";

    const stable =
      stableDom >= 10 ? "스테이블 비중이 높아 대기성 유동성이 두껍다" :
      stableDom >= 5 ? "스테이블 비중은 중간 수준" :
      "스테이블 비중이 낮아 현물 알트 쪽으로 자금이 더 기운다";

    const head = `COMBO ${combo.toFixed(2)}% · ${kType} (${kScore.toFixed(1)}점)`;
    const body = `${ts} 기준, BTC ${btc.toFixed(2)}%·ETH ${eth.toFixed(2)}%로 집계됐다. ${heat}. ${crowd}. ${stable}.`;

    return { head, body };
  }

  async function refreshData(){
    const u = urls();

    const [latest, history, kimchiLatest, kimchiHist] = await Promise.all([
      loadJSON(u.latest),
      loadJSON(u.hist),
      loadJSON(u.kimchiLatest),
      loadJSON(u.kimchiHist),
    ]);

    LATEST = latest;
    HISTORY = Array.isArray(history) ? history : [];
    KIMCHI_LATEST = kimchiLatest;
    KIMCHI_HIST = Array.isArray(kimchiHist) ? kimchiHist : [];

    // KPI
    const t = latest.totals || {};
    const top = latest.top10 || {};
    document.getElementById("kpiTotal").textContent = fmtKRW(t.combined_24h);
    document.getElementById("kpiTs").textContent = `업데이트: ${latest.timestamp_label || "-"}`;
    document.getElementById("kpiTop10").textContent = `${fmtPct1(top.top10_share_pct)} (Top10)`;
    document.getElementById("kpiTop10Note").textContent = `Top10 ${fmtKRW(top.top10_total_24h)} · Rest ${fmtKRW(top.rest_total_24h)}`;

    const combined = num(t.combined_24h);
    const upShare = combined > 0 ? (num(t.upbit_24h) / combined * 100) : 0;
    const btShare = combined > 0 ? (num(t.bithumb_24h) / combined * 100) : 0;
    const coShare = combined > 0 ? (num(t.coinone_24h) / combined * 100) : 0;
    document.getElementById("kpiEx").textContent = `업비트 ${upShare.toFixed(1)}%`;
    document.getElementById("kpiExNote").textContent = `빗썸 ${btShare.toFixed(1)}% · 코인원 ${coShare.toFixed(1)}%`;

    const st = latest.stablecoins || {};
    const stPct = num(st.stable_dominance_pct);
    const stVol = num(st.total_stable_vol_24h);
    document.getElementById("kpiStable").textContent = `${stPct.toFixed(1)}%`;
    const by = st.by_asset || {};
    const byText = Object.keys(by).length
      ? Object.entries(by).sort((a,b)=> num(b[1]) - num(a[1])).map(([k,v])=> `${k} ${fmtKRW(v)}`).join(" · ")
      : "데이터 없음";
    document.getElementById("kpiStableNote").textContent = `합계 ${fmtKRW(stVol)} · ${byText}`;

    // Top10 list + treemap
    const coins = (top.coins || []);
    const list = document.getElementById("top10List");
    list.innerHTML = "";
    coins.forEach((c, idx) => {
      const li = document.createElement("li");
      const sym = (c.symbol || "").replace("KRW-","");
      li.innerHTML = `<span>${idx+1}. ${sym}</span><span>${fmtKRW(c.value)} · ${num(c.share_pct).toFixed(1)}%</span>`;
      list.appendChild(li);
    });

    document.getElementById("pillNow").textContent = `현재판: ${latest.timestamp_label || "-"}`;
    const topPct = num(top.top10_share_pct);
    const signal = topPct >= 70 ? "쏠림 강함" : (topPct >= 60 ? "쏠림" : "확산");
    document.getElementById("pillSignal").textContent = `신호: ${signal}`;

    treemap?.setOption({
      tooltip: {
        formatter: (p) => {
          const d = p.data || {};
          return `<b>${d.name}</b><br/>${fmtKRW(d.value)}<br/>${num(d.share_pct).toFixed(1)}%`;
        }
      },
      series: [{
        type: "treemap",
        roam: false,
        nodeClick: false,
        breadcrumb: { show: false },
        label: { show: true, formatter: "{b}" },
        upperLabel: { show: false },
        itemStyle: { borderColor: "#fff", borderWidth: 2 },
        data: coins.map(c => ({
          name: (c.symbol || "").replace("KRW-",""),
          value: num(c.value),
          share_pct: num(c.share_pct)
        }))
      }]
    });

    // Exchange Top5
    const exTop = latest.by_exchange_top || {};
    fillTopList("upTop5", exTop.upbit_top5);
    fillTopList("btTop5", exTop.bithumb_top5);
    fillTopList("coTop5", exTop.coinone_top5);

    // ✅ 김치 코멘트 + pill 업데이트
    const c = buildKimchiComment(LATEST, HISTORY, KIMCHI_LATEST);
    document.getElementById("kimchiCommentHead").textContent = c.head;
    document.getElementById("kimchiCommentBody").textContent = c.body;

    const kType = (KIMCHI_LATEST?.smart_kimchi?.type || "-");
    const kScore = num(KIMCHI_LATEST?.smart_kimchi?.score_v1);
    const combo = num(KIMCHI_LATEST?.kimchi_premium_pct?.COMBO);

    document.getElementById("kimchiTypePill").textContent = `Type: ${kType}`;
    document.getElementById("kimchiScorePill").textContent = `Score: ${kScore.toFixed(1)} / 100`;
    document.getElementById("kimchiPremPill").textContent = `COMBO: ${fmtPct(combo)}`;

    render(CURRENT_RANGE);
  }

  (async function init(){
    try{
      treemap = echarts.init(document.getElementById("treemap"));
      totalChart = echarts.init(document.getElementById("totalChart"));
      shareChart = echarts.init(document.getElementById("shareChart"));
      topRestChart = echarts.init(document.getElementById("topRestChart"));
      stableChart = echarts.init(document.getElementById("stableChart"));

      kimchiScoreChart = echarts.init(document.getElementById("kimchiScoreChart"));
      kimchiPremChart  = echarts.init(document.getElementById("kimchiPremChart"));

      document.getElementById("btn1d")?.addEventListener("click", ()=> render(1));
      document.getElementById("btn3d")?.addEventListener("click", ()=> render(3));
      document.getElementById("btn7d")?.addEventListener("click", ()=> render(7));

      await refreshData();
      setInterval(refreshData, 60*1000);

      window.addEventListener("resize", ()=>{
        treemap?.resize();
        totalChart?.resize();
        shareChart?.resize();
        topRestChart?.resize();
        stableChart?.resize();
        kimchiScoreChart?.resize();
        kimchiPremChart?.resize();
      });
    }catch(err){
      console.error(err);
      alert("JSON 로딩 실패: /bm/out/history/*.json 경로/배포를 확인하세요.");
    }
  })();
</script>

</body>
</html>
