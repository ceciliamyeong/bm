<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>Spot Top5 — Upbit Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
  <style>
    :root{--bg:#0b1020;--card:#11172a;--muted:#8aa0b5;--text:#e8f0ff;--up:#2E7D32;--down:#C62828;--brand:#1A237E;--accent:#4c74f2;}
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans}
    a{color:#aecdff;text-decoration:none} a:hover{text-decoration:underline}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .h{font-weight:800;letter-spacing:.2px}
    .mini{font-size:12px;color:var(--muted)}
    .card{background:var(--card);border:1px solid #26354a;border-radius:14px;padding:16px;box-shadow:0 8px 28px rgba(0,0,0,.3)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){.grid2{grid-template-columns:1fr}}
    .tbl{width:100%;border-collapse:collapse;margin-top:10px}
    .tbl th,.tbl td{border-bottom:1px solid #223449;padding:10px 8px;text-align:left}
    .tbl th{color:#a8bdd6;font-weight:600}
    header{position:sticky;top:0;background:linear-gradient(180deg,rgba(17,23,42,.95),rgba(17,23,42,.75));backdrop-filter:saturate(1.2) blur(8px);z-index:10;border-bottom:1px solid #233}
    nav{display:flex;gap:18px;align-items:center}
    .brand{display:flex;gap:10px;align-items:center}
    .brand .dot{width:12px;height:12px;border-radius:50%;background:var(--accent);box-shadow:0 0 18px var(--accent)}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid #2b3d59;border-radius:999px;padding:6px 10px;background:rgba(22,28,48,.6)}
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;justify-content:space-between;align-items:center;">
      <div class="brand"><span class="dot"></span><div>
        <div class="h">Spot Top5 Dashboard</div>
        <div class="mini">Upbit 거래대금 기반 · JSON→클라이언트 렌더</div>
      </div></div>
      <nav>
        <a href="../index.html">← BM 메인</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <!-- 스냅샷(파이 + 테이블) -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:baseline;gap:12px">
        <div class="h">Top5 거래대금 스냅샷</div>
        <div class="pill"><span id="asof">—</span></div>
      </div>

      <div class="grid2" style="margin-top:12px">
        <div id="pie" style="height:360px"></div>
        <div>
          <table class="tbl" id="tbl">
            <thead><tr><th>Symbol</th><th>Price (KRW)</th><th>Turnover 24h (KRW)</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="mini">데이터: assets/top5/top5_snapshot.json</div>
        </div>
      </div>
    </section>

    <!-- 교체: 일봉 30일 스택 -->
    <section class="card" style="margin-top:16px">
      <div class="h">Top5 Daily Composition — 30D (Stacked)</div>
      <div id="stack30d" style="height:360px;margin-top:12px"></div>
      <div class="mini">데이터: assets/top5/top5_stack_daily.json</div>
    </section>
  </main>

  <script>
  // Base path auto-detect: if site is under /bm/, use that; else root.
  const base = (location.pathname.startsWith('/bm/')) ? '/bm' : '';
  const SNAP = base + '/assets/top5/top5_snapshot.json';
  const STACK= base + '/assets/top5/top5_stack_daily.json';

  const styles = getComputedStyle(document.documentElement);
  const textColor = styles.getPropertyValue('--text')?.trim() || '#e8f0ff';
  const gridLine  = '#2b3d59';

  async function loadJSON(u){ const r = await fetch(u, {cache:'no-store'}); if(!r.ok) throw new Error(u+' '+r.status); return r.json(); }

  (async () => {
    /* ===== 스냅샷 + 파이 + 테이블 ===== */
    try {
      const snap = await loadJSON(SNAP);
      document.getElementById('asof').textContent = `기준: ${snap.as_of_kst}`;

      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = snap.top5.map(o => `
        <tr>
          <td><b>${o.symbol}</b></td>
          <td>${Number(o.price).toLocaleString()}</td>
          <td>${Number(o.turnover_24h).toLocaleString()}</td>
        </tr>
      `).join('');

      const pie = echarts.init(document.getElementById('pie'));
      pie.setOption({
        tooltip: { trigger:'item', valueFormatter: v => Number(v).toLocaleString() + ' KRW' },
        legend: { bottom: 0, textStyle:{color:textColor} },
        series: [{
          type: 'pie',
          radius: ['36%','70%'],
          label: { color: textColor },
          data: snap.top5.map(d => ({name:d.symbol, value:d.turnover_24h}))
        }]
      });
      addEventListener('resize', ()=> pie.resize());
    } catch(e) {
      console.warn('snapshot err', e);
      document.getElementById('pie').innerHTML = '<div class="mini">스냅샷을 불러오지 못했습니다.</div>';
    }

    /* ===== 30D 스택(일봉 Top5+Others, %) ===== */
    try {
      const j = await loadJSON(STACK);

      // 날짜 & 심볼(등장 빈도 순). Others는 마지막에 고정.
      const dates = j.days.map(d => d.date);
      const counts = {};
      j.days.forEach(d => d.series.forEach(s => counts[s.symbol]=(counts[s.symbol]||0)+1));
      const symbols = Object.keys(counts).sort((a,b)=>counts[b]-counts[a]);
      const oi = symbols.indexOf('Others'); if (oi>=0){ symbols.splice(oi,1); symbols.push('Others'); }

      const palette = ['#4c74f2','#00bfa5','#ffd54f','#ef5350','#ab47bc','#26c6da','#ff7043','#66bb6a','#8d6e63','#7e57c2'];
      const series = symbols.map((sym,i)=>({
        name: sym,
        type: 'bar',
        stack: 'total',
        itemStyle: { color: palette[i % palette.length] },
        emphasis: { focus: 'series' },
        data: j.days.map(d => {
          const f = d.series.find(s => s.symbol===sym);
          return f ? f.pct : 0;
        })
      }));

      const chart = echarts.init(document.getElementById('stack30d'));
      chart.setOption({
        tooltip: { trigger:'axis', axisPointer:{type:'shadow'}, valueFormatter:v => (v!=null? Number(v).toFixed(2):'0')+'%' },
        legend: { textStyle:{color:textColor} },
        grid: { left: 50, right: 20, top: 40, bottom: 40 },
        xAxis: { type:'category', data: dates, axisLabel:{color:textColor, interval: 2} },
        yAxis: { type:'value', max:100, axisLabel:{formatter:v=>v+'%', color:textColor},
                 splitLine:{lineStyle:{color:gridLine}} },
        series,
        animation: true
      });
      addEventListener('resize', ()=> chart.resize());
    } catch(e) {
      console.warn('stack err', e);
      document.getElementById('stack30d').innerHTML = '<div class="mini">데이터를 불러오지 못했습니다: '+STACK+'</div>';
    }
  })();
  </script>
</body>
</html>
