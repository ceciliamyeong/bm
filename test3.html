<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KRW Rolling 24h Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>

  <style>
    :root{
      --bg:#f8fafc;
      --panel:#ffffff;
      --border:#e5e7eb;
      --text:#0f172a;
      --muted:#64748b;

      --shadow:0 1px 2px rgba(15,23,42,.06);
      --radius:14px;

      --accent:#2563eb;
      --accent-2:#7c3aed;

      --sidebar:#0b1220;
      --sidebarText:#e2e8f0;
      --sidebarMuted:#94a3b8;

      --chip:#f1f5f9;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif;
    }
     
    /* Layout */
    .app{
      display:grid;
      grid-template-columns: 260px 1fr;
      min-height:100vh;
    }
    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
    }

    /* Sidebar */
    .sidebar{
      background:var(--sidebar);
      padding:18px 14px;
      position:sticky;
      top:0;
      height:100vh;
      overflow:auto;
      border-right:1px solid rgba(255,255,255,.06);
    }
    @media (max-width: 980px){
      .sidebar{
        position:relative;
        height:auto;
      }
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 10px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      margin-bottom:14px;
    }
    .logo{
      width:32px; height:32px;
      border-radius:10px;
      background:linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow:0 6px 18px rgba(37,99,235,.25);
    }
    .brand h1{
      margin:0;
      font-size:14px;
      color:var(--sidebarText);
      letter-spacing:-0.2px;
    }
    .brand p{
      margin:2px 0 0;
      font-size:12px;
      color:var(--sidebarMuted);
    }

    .navsec{
      margin:14px 0;
    }
    .navtitle{
      font-size:11px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:rgba(226,232,240,.7);
      padding:0 10px;
      margin:0 0 8px;
    }
    .nav a{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border-radius:10px;
      color:var(--sidebarText);
      text-decoration:none;
      font-size:13px;
      transition: background .15s ease;
    }
    .nav a:hover{ background:rgba(255,255,255,.06); }
    .nav a .tag{
      font-size:11px;
      color:var(--sidebarMuted);
      background:rgba(255,255,255,.06);
      padding:2px 8px;
      border-radius:999px;
      white-space:nowrap;
    }

    /* Main */
    .main{
      padding:18px 18px 34px;
    }
    .topbar{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
      margin-bottom:14px;
    }
    .topbar .title h2{
      margin:0;
      font-size:20px;
      letter-spacing:-0.3px;
    }
    .topbar .title p{
      margin:6px 0 0;
      font-size:13px;
      color:var(--muted);
      max-width:820px;
      line-height:1.45;
    }
    .topbar .meta{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .chip{
      background:var(--chip);
      border:1px solid var(--border);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color:#334155;
      white-space:nowrap;
    }
    .chip b{ font-weight:700; }

    /* Cards / widgets */
    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    
    .kpiGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-bottom:14px;
    }
    @media (min-width: 980px){
      .kpiGrid{ grid-template-columns: repeat(4, 1fr); }
    }
    .kpi{
      padding:12px 12px;
      min-width:0;
    }
    .kpi .label{ color:var(--muted); font-size:12px; margin:0 0 6px; }
    .kpi .value{ font-size:20px; font-weight:800; letter-spacing:-0.3px; margin:0; }
    .kpi .note{ color:var(--muted); font-size:12px; margin-top:6px; }

    /* Section header */
    .section{
      margin-top:16px;
    }
    .sectionHead{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin:0 0 10px;
    }
    .sectionHead h3{
      margin:0;
      font-size:14px;
      letter-spacing:-0.2px;
    }
    .sectionHead p{
      margin:6px 0 0;
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
    }
    .sectionHead .right{
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }

    /* Widget grid (The Block-like) */
    .widgets{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 1100px){
      .widgets{ grid-template-columns: repeat(2, 1fr); }
    }

    .widget{
      padding:12px;
      min-width:0;
    }
    
    .widgetHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .wTitle{
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .wIcon{
      width:28px; height:28px;
      border-radius:10px;
      background:#eef2ff;
      border:1px solid #e0e7ff;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#3730a3;
      font-weight:800;
      font-size:12px;
      flex:0 0 auto;
    }
    .wTitle h4{
      margin:0;
      font-size:13px;
      letter-spacing:-0.2px;
    }
    .wTitle .desc{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }
    .wMeta{
      text-align:right;
      color:var(--muted);
      font-size:11px;
      white-space:nowrap;
    }

    /* Chart areas */
    .chart{
      width:100%;
      height:320px;
    }
    #totalChart{ height:360px; }
    #treemap{ height:360px; }
    #stableChart{ height:220px; }

    /* Controls */
    .toolbar{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .btn{
      border:1px solid var(--border);
      background:#fff;
      color:#334155;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
    }
    .btn.active{
      border-color:#0f172a;
      color:#0f172a;
      font-weight:800;
    }

    /* Lists */
    .list{ margin:0; padding:0; list-style:none; }
    .list li{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:9px 2px;
      border-top:1px solid var(--border);
      font-size:12.5px;
      color:#0f172a;
    }
    .list li:first-child{ border-top:none; }
    .pill{
      font-size:11px;
      color:#334155;
      background:var(--chip);
      border:1px solid var(--border);
      padding:3px 8px;
      border-radius:999px;
      white-space:nowrap;
    }
    .footnote{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
    }
    code{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .footerDisclaimer{
      margin-top:24px;
      background:#ffffff;
      border:1px solid #e5e7eb;
      border-radius:16px;
      padding:16px;
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    
    .footerDisclaimer .icon{
      width:34px;
      height:34px;
      border-radius:12px;
      background:#eef2ff;
      border:1px solid #e0e7ff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
    }
    
    .footerDisclaimer .title{
      margin:0;
      font-size:14px;
      font-weight:700;
    }
    
    .footerDisclaimer .sub{
      margin:4px 0 0;
      font-size:12px;
      color:#64748b;
    }
    
    .footerDisclaimer .body{
      margin:10px 0 0;
      font-size:13px;
      line-height:1.55;
      color:#475569;
    }

    /* ===== KPI v2 (mini charts + thermometer) ===== */
    .kpiTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; }
    .kpiMiniChart{ width:100%; height:64px; }
    .kpiAccent{ border-color:#e2e8f0; background:#f0f9ff; }
    .kpiDanger{ border-left:6px solid #ef4444; background:#fff; }

    .thermoWrap{ display:flex; flex-direction:column; gap:8px; }
    .thermoHead{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .thermoValue{
      font-size:12px;
      color:#334155;
      background:var(--chip);
      border:1px solid var(--border);
      padding:4px 8px;
      border-radius:999px;
      white-space:nowrap;
    }
    .thermoBar{
      position:relative;
      height:12px;
      border-radius:999px;
      overflow:hidden;
      border:1px solid var(--border);
      background:
        linear-gradient(90deg,
          rgba(239,68,68,.85) 0%,
          rgba(239,68,68,.45) 20%,
          rgba(234,179,8,.55) 40%,
          rgba(148,163,184,.55) 50%,
          rgba(34,197,94,.45) 80%,
          rgba(34,197,94,.85) 100%);
    }
    .thermoMarker{
      position:absolute;
      top:50%;
      transform:translate(-50%,-50%);
      width:2px;
      height:18px;
      background:#0f172a;
      border-radius:2px;
      box-shadow:0 1px 2px rgba(2,6,23,.25);
    }
    .thermoDot{
      position:absolute;
      top:50%;
      transform:translate(-50%,-50%);
      width:10px;
      height:10px;
      border-radius:999px;
      background:#0f172a;
      border:2px solid #fff;
      box-shadow:0 2px 6px rgba(2,6,23,.25);
    }
    .thermoScale{
      display:flex;
      justify-content:space-between;
      font-size:11px;
      color:var(--muted);
    }
/* ===== Trends single-block panel ===== */
    .trendGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      padding: 8px 2px 2px;
    }
    @media (min-width: 980px){
      .trendGrid{ grid-template-columns: 1fr 1fr; }
    }
    .trendBlock{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px 12px 8px;
      background: rgba(2,6,23,.015);
    }
    .trendLabel{
      font-size:13px;
      font-weight:800;
      letter-spacing:-.2px;
      color:#0f172a;
      margin-bottom:4px;
    }
    .trendDesc{
      font-size:12px;
      color:var(--muted);
      margin-bottom:8px;
    }
    .trendChart{ height:240px; }
/* ===== Trends section block (keeps inside content, avoids sidebar overlap) ===== */
    .sectionBlock{
      max-width: 1120px;
      margin: 18px auto 0;
      padding: 0 16px;
    }
    .sectionHeader{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin: 0 0 10px;
    }
    .sectionHeader h3{
      margin:0;
      font-size:18px;
      font-weight:900;
      letter-spacing:-0.4px;
      color: var(--text);
    }
    .sectionHeader .sub{
      color: var(--muted);
      font-size: 13px;
    }
    .widgetsWide{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 980px){
      .widgetsWide{ grid-template-columns: 1fr 1fr; }
    }
    #kshareChart, #fngChart{ height:280px; }
    /* ===== FNG meta pill ===== */
    .pill.isFear{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.08); color:#b91c1c; }
    .pill.isNeutral{ border-color: rgba(148,163,184,.35); background: rgba(148,163,184,.10); color:#334155; }
    .pill.isGreed{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10); color:#166534; }


  </style>
</head>

<body>
<div class="app">

  <!-- LEFT SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>KRW Market Board</h1>
        <p>Rolling 24h Â· 8h snapshot</p>
      </div>
    </div>

    <div class="navsec">
      <div class="navtitle">Markets</div>
      <nav class="nav">
        <a href="#sec-overview">Overview <span class="tag">KRW</span></a>
        <a href="#sec-flows">Flows & Share <span class="tag">EX</span></a>
        <a href="#sec-concentration">Concentration <span class="tag">Top10</span></a>
        <a href="#sec-stables">Stablecoins <span class="tag">K-Safety</span></a>
        <a href="#sec-trends">Trends <span class="tag">Trend</span></a>
      </nav>
    </div>

    <div class="navsec">
      <div class="navtitle">K-Intelligence</div>
      <nav class="nav">
        <a href="#sec-topcoins">Top Coins <span class="tag">Heat</span></a>
        <a href="#sec-extop">Exchange Top5 <span class="tag">Up/BT/CO</span></a>
        <a href="#sec-kimchi">Smart Kimchi <span class="tag">Premium</span></a>
      </nav>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">

    <div class="topbar">
      <div class="title">
        <h2>KRW Rolling 24h Dashboard</h2>
        <p>â€œìµœê·¼ 24ì‹œê°„(rolling) ê±°ë˜ëŒ€ê¸ˆâ€ì„ ì£¼ê¸°ì ìœ¼ë¡œ ê°±ì‹ , í•œêµ­ KRW ì‹œì¥ í˜„í™©ì„ í™•ì¸í•©ë‹ˆë‹¤.</p>
      </div>
      <div class="meta">
        <span class="chip" id="metaUpdated">UPDATED: -</span>
        <span class="chip" id="metaSignal">SIGNAL: -</span>
      </div>
    </div>

    <!-- KPI -->
    <section id="sec-overview" class="kpiGrid">
      <div class="panel kpi">
        <p class="label">ì´ ê±°ë˜ëŒ€ê¸ˆ(rolling 24h)</p>
        <p class="value" id="kpiTotal">-</p>
        <div class="note" id="kpiTs">-</div>
      </div>
      <div class="panel kpi">
        <p class="label">Top10 ì§‘ì¤‘ë„(%) (ìµœê·¼ 24h)</p>
        <p class="value" id="kpiTop10">-</p>
        <div class="note" id="kpiTop10Note">-</div>
      </div>
      <div class="panel kpi">
        <p class="label">ê±°ë˜ì†Œ ë¹„ì¤‘(%) (ìµœê·¼ 24h)</p>
        <p class="value" id="kpiEx">-</p>
        <div class="note" id="kpiExNote">-</div>
      </div>
      <div class="panel kpi" style="border-color:#bfdbfe;">
        <p class="label" style="color:#1d4ed8;">K-Safety (ìŠ¤í…Œì´ë¸”ì½”ì¸ ë¹„)</p>
        <p class="value" id="kpiStable">-</p>
        <div class="note" id="kpiStableNote">-</div>
      </div>

      <!-- í•œêµ­ ì‹œì¥ ì ìœ ìœ¨: mini chart í¬í•¨ -->
      <div class="panel kpi kpiAccent">
        <div class="kpiTop">
          <div>
            <p class="label" style="color:#0369a1; font-weight:700; margin:0;">í•œêµ­ ì‹œì¥ ì ìœ ìœ¨ (Global)</p>
            <p class="note" style="margin:6px 0 0;">ì „ ì„¸ê³„ ê±°ë˜ëŸ‰ ëŒ€ë¹„ ë¹„ì¤‘</p>
          </div>
          <span class="pill">ìµœê·¼ 14D</span>
        </div>
        <p class="value" id="kpiKShare" style="font-size:24px; font-weight:900; margin:0;">-</p>
        <canvas id="kshareSpark" class="kpiMiniChart" height="64"></canvas>
      </div>

      <!-- ê³µí¬Â·íƒìš•: ê°€ë¡œ ì˜¨ë„ê³„(thermometer) -->
      <div class="panel kpi kpiDanger">
        <div class="thermoWrap">
          <div class="thermoHead">
            <div>
              <p class="label" style="color:#be123c; font-weight:700; margin:0;">ê¸€ë¡œë²Œ ì‹œì¥ ì‹¬ë¦¬</p>
              <p class="note" id="fngStatusText" style="margin:6px 0 0;">-</p>
            </div>
            <span class="thermoValue" id="fngValueNote">ì‹¬ë¦¬ ì ìˆ˜: - / 100</span>
          </div>

          <div class="thermoBar" aria-label="Fear & Greed gauge">
            <div class="thermoMarker" id="fngMarker" style="left:50%;"></div>
            <div class="thermoDot" id="fngDot" style="left:50%;"></div>
          </div>

          <div class="thermoScale">
            <span>ê·¹ë„ì˜ ê³µí¬</span><span>ì¤‘ë¦½</span><span>ê·¹ë„ì˜ íƒìš•</span>
          </div>
        </div>
      </div>

      </section>

    <!-- TOTAL (big) -->
    <section class="section" id="sec-flows">
      <div class="sectionHead">
        <div>
          <h3>Flow</h3>
          <p>ì´ ê±°ë˜ëŒ€ê¸ˆ ìˆ˜ì¤€(ë¼ì¸) + ì§ì „ ëŒ€ë¹„ ë³€í™”(ë§‰ëŒ€)ë¡œ â€œì‹œì¥ ì˜¨ë„â€ë¥¼ ë´…ë‹ˆë‹¤.</p>
          <div class="toolbar">
            <button class="btn" id="btn1d">1D</button>
            <button class="btn active" id="btn3d">3D</button>
            <button class="btn" id="btn7d">7D</button>
            <span class="pill">rolling 24h Â· overlaps ok</span>
          </div>
        </div>
        <div class="right">Snapshot cadence: 8h</div>
      </div>

      <div class="panel widget">
        <div class="widgetHead">
          <div class="wTitle">
            <div class="wIcon">Î£</div>
            <div>
              <h4>ì´ ê±°ë˜ëŒ€ê¸ˆ ì¶”ì´ (Rolling 24h)</h4>
              <div class="desc">Step line(ìˆ˜ì¤€) + Î” bar(ì§ì „ ëŒ€ë¹„) </div>
            </div>
          </div>
          <div class="wMeta" id="wTotalMeta">UPDATED: -</div>
        </div>
        <div id="totalChart" class="chart"></div>
      </div>

      <!-- share + top10 vs rest  -->
      <div class="widgetsWide">
        <div class="panel widget" id="sec-concentration">
          <div class="widgetHead">
            <div class="wTitle">
              <div class="wIcon">%</div>
              <div>
                <h4>ê±°ë˜ì†Œ ì ìœ ìœ¨(%) ì¶”ì´</h4>
                <div class="desc">ì—…ë¹„íŠ¸Â·ë¹—ì¸Â·ì½”ì¸ì› ë¹„ì¤‘ ì´ë™</div>
              </div>
            </div>
            <div class="wMeta"><span>Source: BLOCKMEDIA</span></div>
          </div>
          <div id="shareChart" class="chart"></div>
        </div>

        <div class="panel widget">
          <div class="widgetHead">
            <div class="wTitle">
              <div class="wIcon">10</div>
              <div>
                <h4>Top10 vs Rest (ì§‘ì¤‘/í™•ì‚°)</h4>
                <div class="desc">Top10/Rest + Top10 ì ìœ ìœ¨ ë¼ì¸</div>
              </div>
            </div>
            <div class="wMeta">Source: BLOCKMEDIA</div>
          </div>
          <div id="topRestChart" class="chart"></div>
        </div>
      </div>



  
  
  
  <section id="sec-trends" class="sectionBlock">
    <div class="sectionHeader">
      <h3>Trends</h3>
      <div class="sub">ìƒë‹¨ KPI ì¹´ë“œ ì§€í‘œë¥¼ ë…ë¦½ ì°¨íŠ¸ë¡œ ì¶”ì í•©ë‹ˆë‹¤.</div>
    </div>

    <div class="widgetsWide">
      <div class="panel widget">
        <div class="widgetHead">
          <div class="wTitle">
            <div class="wIcon">KR</div>
            <div>
              <h4>í•œêµ­ ì‹œì¥ ì ìœ ìœ¨(%) ì¶”ì´ (Global)</h4>
              <div class="desc">ì „ ì„¸ê³„ ê±°ë˜ëŸ‰ ëŒ€ë¹„ í•œêµ­ ë¹„ì¤‘ Â· Rolling 24h</div>
            </div>
          </div>
          <div class="wMeta">Source: BLOCKMEDIA</div>
        </div>
        <div id="kshareChart" class="chart"></div>
      </div>

      <div class="panel widget">
        <div class="widgetHead">
          <div class="wTitle">
            <div class="wIcon">FG</div>
            <div>
              <h4>íƒìš•Â·ê³µí¬ ì§€ìˆ˜ ì¶”ì´</h4>
              <div class="desc">0~100 Â· êµ¬ê°„(ê³µí¬/ì¤‘ë¦½/íƒìš•)ìœ¼ë¡œ í•´ì„</div>
            </div>
          </div>
          <div class="wMeta">Source: BLOCKMEDIA</div>
        </div>
        <div id="fngChart" class="chart"></div>
      </div>
    </div>
  </section>




    <!-- Right-side style blocks: Top coins, stable, exchange top, kimchi -->
    <section class="section" id="sec-topcoins">
      <div class="sectionHead">
        <div>
          <h3>Top Coins</h3>
          <p>â€œì–´ë–¤ ì•ŒíŠ¸ì— ì ë ¸ëŠ”ì§€â€ë¥¼ í•œ ëˆˆì— í™•ì¸í•©ë‹ˆë‹¤.</p>
        </div>
        <div class="right">
          <span class="pill" id="pillNow">-</span>
          <span class="pill" id="pillSignal">-</span>
        </div>
      </div>

      <div class="widgets">
        <div class="panel widget">
          <div class="widgetHead">
            <div class="wTitle">
              <div class="wIcon">T</div>
              <div>
                <h4>Top10 Treemap</h4>
                <div class="desc">ê·œëª¨(ê±°ë˜ëŒ€ê¸ˆ) ê¸°ì¤€ ì‹œê°í™”</div>
              </div>
            </div>
            <div class="wMeta">VIEW: 24h</div>
          </div>
          <div id="treemap" class="chart"></div>

          <ul class="list" id="top10List" style="margin-top:8px;"></ul>
        </div>

        <div class="panel widget" id="sec-stables">
          <div class="widgetHead">
            <div class="wTitle">
              <div class="wIcon">S</div>
              <div>
                <h4>Stable Dominance</h4>
                <div class="desc">KRW ì‹œì¥ â€œì•ˆì „ì„ í˜¸/ëŒ€ê¸°ìê¸ˆâ€ ì‹ í˜¸</div>
              </div>
            </div>
            <div class="wMeta">K-Safety</div>
          </div>
          <div id="stableChart" class="chart"></div>

          <div class="footnote">
            KPIì˜ <b>K-Safety</b>ì™€ ë™ì¼í•œ ë°ì´í„°(ìŠ¤í…Œì´ë¸” ê±°ë˜ëŒ€ê¸ˆ/ë¹„ì¤‘) ê¸°ë°˜ì…ë‹ˆë‹¤.
          </div>
        </div>
      </div>
    </section>

    <section class="section" id="sec-extop">
      <div class="sectionHead">
        <div>
          <h3>Exchange Top5</h3>
          <p>ê±°ë˜ì†Œë³„ë¡œ â€œìƒìœ„ ì½”ì¸â€ì„ ë´…ë‹ˆë‹¤.</p>
        </div>
        <div class="right">Upbit Â· Bithumb Â· Coinone</div>
      </div>

      <div class="widgets">
        <div class="panel widget">
          <div class="widgetHead">
            <div class="wTitle">
              <div class="wIcon">U</div>
              <div>
                <h4>Upbit Top5</h4>
                <div class="desc">ìµœê·¼ 24h ê±°ë˜ëŒ€ê¸ˆ ê¸°ì¤€</div>
              </div>
            </div>
            <div class="wMeta">KRW pairs</div>
          </div>
          <ul class="list" id="upTop5"></ul>
        </div>

        <div class="panel widget">
          <div class="widgetHead">
            <div class="wTitle">
              <div class="wIcon">B</div>
              <div>
                <h4>Bithumb Top5</h4>
                <div class="desc">ìµœê·¼ 24h ê±°ë˜ëŒ€ê¸ˆ ê¸°ì¤€</div>
              </div>
            </div>
            <div class="wMeta">KRW pairs</div>
          </div>
          <ul class="list" id="btTop5"></ul>
        </div>
      </div>

      <div class="panel widget" style="margin-top:12px;">
        <div class="widgetHead">
          <div class="wTitle">
            <div class="wIcon">C</div>
            <div>
              <h4>Coinone Top5</h4>
              <div class="desc">ìµœê·¼ 24h ê±°ë˜ëŒ€ê¸ˆ ê¸°ì¤€</div>
            </div>
          </div>
          <div class="wMeta">KRW pairs</div>
        </div>
        <ul class="list" id="coTop5"></ul>
      </div>
    </section>

    <section class="section" id="sec-kimchi">
      <div class="sectionHead">
        <div>
          <h3>Smart Kimchi</h3>
          <p>BTC/ETH/XRP ê¹€í”„ ì¶”ì´ + Kimchi Type/Scoreë¡œ â€œì§€ê¸ˆ ê¹€í”„ì˜ ì„±ê²©â€ì„ ë´…ë‹ˆë‹¤.</p>
        </div>
        <div class="right" id="kimchiUpdated">UPDATED: -</div>
      </div>

      <div class="widgets">
        <div class="panel widget">
          <div class="widgetHead">
            <div class="wTitle">
              <div class="wIcon">%</div>
              <div>
                <h4>Kimchi Premium % (BTC / ETH / XRP)</h4>
                <div class="desc">êµ­ë‚´(Upbit KRW) vs ê¸€ë¡œë²Œ(USD) * í™˜ì‚°</div>
              </div>
            </div>
            <div class="wMeta">v1</div>
          </div>
          <div id="kimchiPremChart" class="chart"></div>
        </div>

        <div class="panel widget">
          <div class="widgetHead">
            <div class="wTitle">
              <div class="wIcon">K</div>
              <div>
                <h4>Kimchi Type & Score</h4>
                <div class="desc">Retail/Constraint/Neutral ë¶„ë¥˜ + score</div>
              </div>
            </div>
            <div class="wMeta">v1</div>
          </div>
          <div id="kimchiScoreChart" class="chart"></div>

          <div style="margin-top:10px;">
            <div class="pill" style="display:inline-block; margin-bottom:8px;">Kimchi Comment</div>
            <div style="font-size:14px; line-height:1.55;">
              <div id="kimchiCommentHead" style="font-weight:700;">-</div>
              <div id="kimchiCommentBody" class="sub" style="margin:6px 0 0;">-</div>
            </div>
          </div>

          <div style="margin-top:10px;">
            <div class="pill" style="display:inline-block; margin-bottom:6px;">FX Context</div>
            <div id="fxComment" class="sub" style="font-size:13px; line-height:1.5;">
              -
            </div>
          </div>
          
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
            <span class="pill" id="kimchiTypePill">-</span>
            <span class="pill" id="kimchiScorePill">-</span>
            <span class="pill" id="kimchiPremPill">-</span>
          </div>
        </div>
      </div>
    </section>

    <footer class="footerDisclaimer" role="note" aria-label="disclaimer">
  <div class="icon">i</div>
  <div>
    <div class="head">
      <p class="title">Disclaimer</p>
      <p class="sub">Information Purpose Only</p>
    </div>
    <p class="body">
      ë³¸ ì§€ìˆ˜ ë° ëŒ€ì‹œë³´ë“œì— ì œê³µë˜ëŠ” ì •ë³´ëŠ” ì‹œì¥ ë™í–¥ íŒŒì•…ì„ ìœ„í•œ ì°¸ê³  ìë£Œì´ë©°,
      íŠ¹ì • ë””ì§€í„¸ ìì‚°ì— ëŒ€í•œ íˆ¬ì ê¶Œìœ  ë˜ëŠ” ì¬ë¬´ì  ì¡°ì–¸ì„ êµ¬ì„±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
      íˆ¬ì ê²°ì •ì€ ê° íˆ¬ììì˜ íŒë‹¨ê³¼ ì±…ì„ í•˜ì— ì´ë£¨ì–´ì ¸ì•¼ í•©ë‹ˆë‹¤.
    </p>
  </div>
</footer>

  </main>
</div>
  
<script>
  
  const EX_COLORS = {
    upbit:   "#2563eb", // íŒŒë‘
    bithumb:"#16a34a", // ì´ˆë¡
    coinone:"#7c3aed", // ë³´ë¼
  };
  
  const AXIS_UNIT = 1e12;      // 1ì¡°ì› ë‹¨ìœ„
  const AXIS_UNIT_LABEL = "ì¡°ì›";

  function fmtAxis(v){
    if (!Number.isFinite(v)) return "";
    return (v / AXIS_UNIT).toFixed(1);   // 5.23 ì´ëŸ° ì‹ìœ¼ë¡œ
  }

  // ===== Responsive layout helpers (mobile-tight axes to avoid narrow plots) =====
  function isMobile(){
    return window.innerWidth < 768;
  }

  // Apply common mobile tightening: slimmer grid, smaller axis labels, hide right y-axis labels on mobile (dualY charts)
  function applyMobileTight(opt, cfg){
    cfg = cfg || {};
    const dualY = !!cfg.dualY;
    const mobile = isMobile();
    if(!opt) return opt;

    // grid
    if(opt.grid){
      const g = Array.isArray(opt.grid) ? opt.grid[0] : opt.grid;
      opt.grid = {
        ...g,
        left:  mobile ? 40 : (g.left  ?? 56),
        right: mobile ? 12 : (g.right ?? 18),
        containLabel: (g.containLabel ?? true),
      };
    }

    const slimAxis = (a) => {
      if(!a) return a;
      const ax = { ...a };
      ax.axisLabel = { ...(ax.axisLabel || {}) };
      if(mobile){
        ax.axisLabel.fontSize = ax.axisLabel.fontSize ?? 10;
        ax.axisLabel.margin = ax.axisLabel.margin ?? 6;
        ax.axisLabel.hideOverlap = true;
        if(ax.name) ax.name = ""; // save space
      }
      return ax;
    };

    if(opt.xAxis){
      opt.xAxis = Array.isArray(opt.xAxis) ? opt.xAxis.map(slimAxis) : slimAxis(opt.xAxis);
    }
    if(opt.yAxis){
      if(Array.isArray(opt.yAxis)){
        opt.yAxis = opt.yAxis.map((y, idx) => {
          const yy = slimAxis(y);
          if(dualY && mobile && idx === 1){
            yy.axisLabel = { ...(yy.axisLabel || {}), show:false };
            yy.axisTick = { ...(yy.axisTick || {}), show:false };
            yy.axisLine = { ...(yy.axisLine || {}), show:false };
            yy.splitLine = { ...(yy.splitLine || {}), show:false };
          }
          return yy;
        });
      }else{
        opt.yAxis = slimAxis(opt.yAxis);
      }
    }

    if(opt.legend && mobile){
      const l = Array.isArray(opt.legend) ? opt.legend[0] : opt.legend;
      opt.legend = {
        ...l,
        itemWidth: 12,
        itemHeight: 8,
        textStyle: { ...(l.textStyle || {}), fontSize: (l.textStyle && l.textStyle.fontSize) ? l.textStyle.fontSize : 10 }
      };
    }

    return opt;
  }


  
  function num(x){
    const n = Number(x);
    return Number.isFinite(n) ? n : 0;
  }
  function fmtKRW(n){
    n = num(n);
    const abs = Math.abs(n);
    if (abs >= 1e12) return (n/1e12).toFixed(2) + "ì¡°ì›";
    if (abs >= 1e8)  return (n/1e8).toFixed(0) + "ì–µì›";
    return n.toLocaleString("ko-KR") + "ì›";
  }

  function drawSparkline(canvas, values){
    if(!canvas) return;
    const ctx = canvas.getContext("2d");
    const w = canvas.width = canvas.clientWidth || 240;
    const h = canvas.height = canvas.getAttribute("height") ? Number(canvas.getAttribute("height")) : 64;

    ctx.clearRect(0,0,w,h);

    const arr = (Array.isArray(values) ? values : []).filter(v => Number.isFinite(v));
    if(arr.length < 2){
      ctx.globalAlpha = 0.6;
      ctx.beginPath();
      ctx.moveTo(0, h*0.6);
      ctx.lineTo(w, h*0.6);
      ctx.lineWidth = 1;
      ctx.strokeStyle = "#94a3b8";
      ctx.stroke();
      ctx.globalAlpha = 1;
      return;
    }

    const min = Math.min(...arr);
    const max = Math.max(...arr);
    const pad = 6;
    const denom = (max - min) || 1;

    const xStep = (w - pad*2) / (arr.length - 1);

    ctx.beginPath();
    arr.forEach((v,i)=>{
      const x = pad + i*xStep;
      const y = pad + (h - pad*2) * (1 - (v - min)/denom);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.lineWidth = 2;
    ctx.strokeStyle = "#2563eb";
    ctx.stroke();

    const last = arr[arr.length-1];
    const lx = pad + (arr.length-1)*xStep;
    const ly = pad + (h - pad*2) * (1 - (last - min)/denom);

    ctx.beginPath();
    ctx.arc(lx, ly, 3, 0, Math.PI*2);
    ctx.fillStyle = "#0f172a";
    ctx.fill();

    ctx.beginPath();
    ctx.arc(lx, ly, 5, 0, Math.PI*2);
    ctx.strokeStyle = "#ffffff";
    ctx.lineWidth = 2;
    ctx.stroke();
  }

  function nowKST(){
  const d = new Date();
  const utc = d.getTime() + d.getTimezoneOffset() * 60000;
  const kst = new Date(utc + 9 * 60 * 60000);

  const MM = String(kst.getMonth() + 1).padStart(2, "0");
  const DD = String(kst.getDate()).padStart(2, "0");
  const hh = String(kst.getHours()).padStart(2, "0");
  const mm = String(kst.getMinutes()).padStart(2, "0");

  return `${MM}/${DD} ${hh}:${mm} KST`;
  }

  function fmtPct(p){
    if (p === null || p === undefined || Number.isNaN(p)) return "-";
    const sign = p > 0 ? "+" : "";
    return sign + Number(p).toFixed(2) + "%";
  }
  function fmtPct1(p){
    if (p === null || p === undefined || Number.isNaN(p)) return "-";
    const sign = p > 0 ? "+" : "";
    return sign + Number(p).toFixed(1) + "%";
  }
  async function loadJSON(url){
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error("Failed to load: " + url + " (" + res.status + ")");
    return await res.json();
  }

  function urls(){
    const bust = "v=" + Date.now();
    return {
      latest: "/out/history/krw_24h_latest.json?" + bust,
      hist:   "/out/history/krw_24h_snapshots.json?" + bust,
      kimchiLatest: "/out/history/kimchi_latest.json?" + bust,
      kimchiHist:   "/out/history/kimchi_snapshots.json?" + bust,
      fxLatest: "/out/history/fx_latest.json?" + bust,
      bm20History: "/data/bm20_history.json?" + bust
    };
  }

  let treemap, totalChart, shareChart, topRestChart, stableChart, kimchiPremChart, kimchiScoreChart, kshareChart, fngChart;
  let HISTORY = [], LATEST = null;
  let BM20_HIST = [];
  let KIMCHI_HIST = [], KIMCHI_LATEST = null;
  let CURRENT_RANGE = 3;
  let FX_LATEST = null;

  function setActive(range){
    document.getElementById("btn1d")?.classList.toggle("active", range === 1);
    document.getElementById("btn3d")?.classList.toggle("active", range === 3);
    document.getElementById("btn7d")?.classList.toggle("active", range === 7);
  }

  function sliceByDays(history, days){
    const need = days * 3;
    const arr = Array.isArray(history) ? history : [];
    return arr.slice(-Math.max(need, 2));
  }


  function sliceBm20(hist, days){
    // bm20_historyëŠ” ì£¼ê¸°ê°€ ë‹¤ë¥¼ ìˆ˜ ìˆì–´ days*3 ì •ë„ë¡œ ë„‰ë„‰íˆ ì¡ê³ , ìµœì†Œ 2í¬ì¸íŠ¸ í™•ë³´
    const need = days * 3;
    const arr = Array.isArray(hist) ? hist : [];
    return arr.slice(-Math.max(need, 2));
  }

  function parseDateAny(d){
    const t = d?.ts || d?.time || d?.datetime || d?.date || d?.timestamp;
    const dt = t ? new Date(t) : null;
    return (dt && !isNaN(dt.getTime())) ? dt : null;
  }

  function fmtMDHM(dt){
    const mm = String(dt.getMonth()+1).padStart(2,"0");
    const dd = String(dt.getDate()).padStart(2,"0");
    const hh = String(dt.getHours()).padStart(2,"0");
    const mi = String(dt.getMinutes()).padStart(2,"0");
    return `${mm}/${dd} ${hh}:${mi} KST`;
  }

  function renderBm20(rangeDays){
    if(!kshareChart && !fngChart) return;
    if(!Array.isArray(BM20_HIST) || BM20_HIST.length < 2) return;

    const h = sliceBm20(BM20_HIST, rangeDays);
    const xs = h.map(d=>{
      const dt = parseDateAny(d);
      return dt ? fmtMDHM(dt) : "-";
    });

    const kSeries = h.map(d => Number(d?.k_market?.k_share_percent) || 0);
    const fSeries = h.map(d => Number(d?.sentiment?.value) );

    // í•œêµ­ ì ìœ ìœ¨(%) ë¼ì¸
    if(kshareChart){
      const vals = kSeries.filter(v=>Number.isFinite(v));
      const lo = vals.length ? Math.min(...vals) : 0;
      const hi = vals.length ? Math.max(...vals) : 5;
      const pad = Math.max(0.2, (hi-lo)*0.25);

      kshareChart.setOption(applyMobileTight({
        grid:{ left:52, right:18, top:32, bottom:44, containLabel:true },
        tooltip:{
          trigger:"axis",
          confine:true,
          borderWidth:1,
          backgroundColor:"#ffffff",
          textStyle:{ color:"#0f172a" },
          extraCssText:"box-shadow:0 8px 24px rgba(2,6,23,.12); border-radius:12px; padding:10px 12px;",
          formatter:(ps)=>{
            const i = ps[0].dataIndex;
            const v = kSeries[i];
            const vv = Number.isFinite(v) ? v.toFixed(2) : "-";
            return `<div style="font-weight:800; margin-bottom:4px;">${xs[i]}</div>
                    <div>í•œêµ­ ì ìœ ìœ¨ <b>${vv}%</b></div>`;
          }
        },
        xAxis:{
          type:"category",
          data:xs,
          boundaryGap:false,
          axisLine:{ lineStyle:{ color:"rgba(2,6,23,.10)" } },
          axisTick:{ show:false },
          axisLabel:{ rotate:(xs.length>10?25:0), color:"rgba(15,23,42,.60)" }
        },
        yAxis:{
          type:"value",
          min: Math.max(0, Math.floor((lo-pad)*100)/100),
          max: Math.ceil((hi+pad)*100)/100,
          splitNumber:4,
          axisLine:{ show:false },
          axisTick:{ show:false },
          axisLabel:{ color:"rgba(15,23,42,.60)", formatter:(v)=> v.toFixed(2)+"%" },
          splitLine:{ lineStyle:{ color:"rgba(2,6,23,.06)" } }
        },
        series:[{
          name:"K Share",
          type:"line",
          smooth:true,
          symbol:"circle",
          symbolSize:6,
          showSymbol:false,
          data:kSeries,
          lineStyle:{ width:3 },
          emphasis:{ focus:"series", scale:true },
          areaStyle:{ opacity:0.10 }
        }]
      }, { dualY:false }), true);
    }

    // ê³µí¬/íƒìš• ì§€ìˆ˜(0~100) ë¼ì¸ + êµ¬ê°„ í•´ì„
    if(fngChart){
      fngChart.setOption(applyMobileTight({
        grid:{ left:52, right:18, top:32, bottom:44, containLabel:true },
        tooltip:{
          trigger:"axis",
          confine:true,
          borderWidth:1,
          backgroundColor:"#ffffff",
          textStyle:{ color:"#0f172a" },
          extraCssText:"box-shadow:0 8px 24px rgba(2,6,23,.12); border-radius:12px; padding:10px 12px;",
          formatter:(ps)=>{
            const i = ps[0].dataIndex;
            const v = fSeries[i];
            const vv = Number.isFinite(v) ? v : null;
            let label = "-";
            if(vv!=null){
              if(vv<25) label="ê·¹ë„ì˜ ê³µí¬";
              else if(vv<50) label="ê³µí¬";
              else if(vv<75) label="íƒìš•";
              else label="ê·¹ë„ì˜ íƒìš•";
            }
            return `<div style="font-weight:800; margin-bottom:4px;">${xs[i]}</div>
                    <div>ì‹¬ë¦¬ ì ìˆ˜ <b>${vv!=null? vv: "-"} / 100</b></div>
                    <div style="color:rgba(15,23,42,.65); margin-top:2px;">${label}</div>`;
          }
        },
        xAxis:{
          type:"category",
          data:xs,
          boundaryGap:false,
          axisLine:{ lineStyle:{ color:"rgba(2,6,23,.10)" } },
          axisTick:{ show:false },
          axisLabel:{ rotate:(xs.length>10?25:0), color:"rgba(15,23,42,.60)" }
        },
        yAxis:{
          type:"value",
          min:0,
          max:100,
          interval:25,
          axisLine:{ show:false },
          axisTick:{ show:false },
          axisLabel:{ color:"rgba(15,23,42,.60)" },
          splitLine:{ lineStyle:{ color:"rgba(2,6,23,.06)" } }
        },
        series:[{
          name:"Fear&Greed",
          type:"line",
          smooth:true,
          symbol:"circle",
          symbolSize:6,
          showSymbol:false,
          data:fSeries,
          connectNulls:true,
          lineStyle:{ width:3 },
          emphasis:{ focus:"series", scale:true },
          areaStyle:{ opacity:0.10 },

          // êµ¬ê°„ ë°´ë“œ(ê³µí¬/ì¤‘ë¦½/íƒìš•)
          markArea:{
            silent:true,
            itemStyle:{ opacity:0.10 },
            data:[
              [{ yAxis:0,  itemStyle:{ color:"rgba(239,68,68,.35)" } }, { yAxis:25 }],
              [{ yAxis:25, itemStyle:{ color:"rgba(239,68,68,.20)" } }, { yAxis:50 }],
              [{ yAxis:50, itemStyle:{ color:"rgba(34,197,94,.18)" } }, { yAxis:75 }],
              [{ yAxis:75, itemStyle:{ color:"rgba(34,197,94,.30)" } }, { yAxis:100 }]
            ]
          },

          // ê¸°ì¤€ì„ (25/50/75) ê°•ì¡°
          markLine:{
            silent:true,
            symbol:["none","none"],
            lineStyle:{ color:"rgba(2,6,23,.16)", type:"dashed", width:1 },
            label:{ color:"rgba(15,23,42,.55)", formatter:(p)=> p.value },
            data:[{ yAxis:25 }, { yAxis:50 }, { yAxis:75 }]
          }
        }]
      }, { dualY:false }), true);

      // ìµœê·¼ê°’ ë¼ë²¨ pill(íŠ¸ë Œë“œ ì¹´ë“œ)
      const last = fSeries.slice().reverse().find(v=>Number.isFinite(v));
      const pill = document.getElementById("fngTrendPill");
      if(pill){
        let label = "-";
        pill.classList.remove("isFear","isNeutral","isGreed");
        if(Number.isFinite(last)){
          if(last<25){ label="Extreme Fear"; pill.classList.add("isFear"); }
          else if(last<50){ label="Fear"; pill.classList.add("isFear"); }
          else if(last<75){ label="Greed"; pill.classList.add("isGreed"); }
          else { label="Extreme Greed"; pill.classList.add("isGreed"); }
        }
        pill.textContent = label;
      }
    }
  }

  function buildSeries(hist){
    const x = hist.map(h => h.timestamp_label);
    const total = hist.map(h => num(h.totals?.combined_24h));
    const up = hist.map(h => num(h.totals?.upbit_24h));
    const bt = hist.map(h => num(h.totals?.bithumb_24h));
    const co = hist.map(h => num(h.totals?.coinone_24h));
    const top10 = hist.map(h => num(h.top10?.top10_total_24h));
    const rest = hist.map(h => num(h.top10?.rest_total_24h));
    const topShare = hist.map(h => num(h.top10?.top10_share_pct));
    const delta = total.map((v,i)=> i===0 ? null : (v - total[i-1]));
    return { x, total, delta, up, bt, co, top10, rest, topShare };
  }

  function render(rangeDays){
  CURRENT_RANGE = rangeDays;
  setActive(rangeDays);

  const hist = sliceByDays(HISTORY, rangeDays);
  const s = buildSeries(hist);

 // ===== TOTAL (Exchange stacked absolute bars) =====
totalChart?.setOption(applyMobileTight({

    animationDuration: 2400,
    animationEasing: "quarticInOut",
  
    grid: { left: 72, right: 18, top: 44, bottom: 44, containLabel: true },
  
    tooltip: {
      trigger: "axis",
      axisPointer: { type: "shadow" },
      formatter: (params) => {
        const i = params[0].dataIndex;
  
        const up = s.up[i] || 0;
        const bt = s.bt[i] || 0;
        const co = s.co[i] || 0;
  
        const total = (s.total && s.total[i] != null) ? s.total[i] : (up + bt + co);
  
        return `<b>${s.x[i]}</b>` +
               `<br/>ì´ ${fmtKRW(total)}` +
               `<br/>ì—…ë¹„íŠ¸ ${fmtKRW(up)}` +
               `<br/>ë¹—ì¸ ${fmtKRW(bt)}` +
               `<br/>ì½”ì¸ì› ${fmtKRW(co)}`;
      }
    },
  
    legend: { top: 0, left: 0, data: ["Upbit", "Bithumb", "Coinone"] },
  
    xAxis: {
      type: "category",
      data: s.x,
      axisLabel: { color: "#6b7280", rotate: (s.x.length > 10 ? 25 : 0) }
    },
  
    yAxis: {
      type: "value",
      name: "(ì¡°ì›)",
      axisLabel: {
        formatter: (v) => (v / 1e12).toFixed(2)
      }
    },
  
    series: [
      {
        name: "Upbit",
        type: "bar",
        stack: "total",
        barWidth: 12,
        barGap: "20%",               // ğŸ‘ˆ ì—¬ê¸°
        itemStyle: { color: EX_COLORS.upbit },
        data: s.up
      },
      {
        name: "Bithumb",
        type: "bar",
        stack: "total",
        barWidth: 12,
        itemStyle: { color: EX_COLORS.bithumb },
        data: s.bt
      },
      {
        name: "Coinone",
        type: "bar",
        stack: "total",
        barWidth: 12,
        itemStyle: { color: EX_COLORS.coinone },
        data: s.co
      }
    ]
  }, { dualY:false }), true);
    

  // ===== STABLE =====
  if (stableChart){
    const stablePct = hist.map(h => num(h.stablecoins?.stable_dominance_pct));
    const stableVol = hist.map(h => num(h.stablecoins?.total_stable_vol_24h));

    // âœ… auto range (data-driven) with padding
    const vals = stablePct.filter(v => Number.isFinite(v));
    const lo = vals.length ? Math.min(...vals) : 0;
    const hi = vals.length ? Math.max(...vals) : 100;
  
    const pad = Math.max(2, (hi - lo) * 0.25); // ìµœì†Œ 2%p ì—¬ìœ 
    const ymin = Math.max(0, Math.floor((lo - pad) * 10) / 10);
    const ymax = Math.min(100, Math.ceil((hi + pad) * 10) / 10);
    
    stableChart.setOption(applyMobileTight({
      grid: { left: 56, right: 18, top: 22, bottom: 36 },
      tooltip: {
        trigger: "axis",
        formatter: (params) => {
          const i = params[0].dataIndex;
          return `<b>${s.x[i]}</b><br/>Stable Dom ${stablePct[i].toFixed(1)}%<br/>Stable Vol ${fmtKRW(stableVol[i])}`;
        }
      },
      xAxis: { type: "category", data: s.x, axisLabel:{ rotate:(s.x.length>10?25:0) } },
      yAxis: { type: "value", min: ymin, max: ymax },
      series: [{ type: "line", smooth: true, symbolSize: 6, data: stablePct }]
    }, { dualY:false }), true);
  }

  // ===== SHARE =====
  const shareUp = s.total.map((_,i)=> s.total[i] ? s.up[i]/s.total[i]*100 : 0);
  const shareBt = s.total.map((_,i)=> s.total[i] ? s.bt[i]/s.total[i]*100 : 0);
  const shareCo = s.total.map((_,i)=> s.total[i] ? s.co[i]/s.total[i]*100 : 0);
  shareChart?.setOption(applyMobileTight({
    grid: { left: 44, right: 14, top: 34, bottom: 34, containLabel: true },
    tooltip: {
      trigger:"axis",
      formatter:(params)=>{
        const i = params[0].dataIndex;
        return `<b>${s.x[i]}</b><br/>ì—…ë¹„íŠ¸ ${shareUp[i].toFixed(1)}%<br/>ë¹—ì¸ ${shareBt[i].toFixed(1)}%<br/>ì½”ì¸ì› ${shareCo[i].toFixed(1)}%`;
      }
    },
    legend: { top: 6, left: 0, itemWidth: 14, itemHeight: 8, data: ["Upbit","Bithumb","Coinone"] },
    xAxis: { type:"category", data:s.x, axisLabel:{ rotate:(s.x.length>10?25:0) } },
    yAxis: { type:"value", min:0, max:100 },
    series: [
      { name:"Upbit", type:"line", stack:"s", areaStyle:{}, smooth:true, symbolSize:3, data: shareUp },
      { name:"Bithumb", type:"line", stack:"s", areaStyle:{}, smooth:true, symbolSize:3, data: shareBt },
      { name:"Coinone", type:"line", stack:"s", areaStyle:{}, smooth:true, symbolSize:3, data: shareCo }
    ]
  }, { dualY:false }), true);

  // ===== TOP10 vs REST =====
  topRestChart?.setOption(applyMobileTight({
    grid: { left: 56, right: 44, top: 40, bottom: 34, containLabel: true },
    tooltip: {
      trigger:"axis",
      axisPointer:{ type:"shadow" },
      formatter:(params)=>{
        const i = params[0].dataIndex;
        return `<b>${s.x[i]}</b><br/>Top10 ${fmtKRW(s.top10[i])}<br/>Rest ${fmtKRW(s.rest[i])}<br/>Top10 Share ${s.topShare[i].toFixed(1)}%`;
      }
    },
    legend: { top: 6, left: 0, itemWidth: 14, itemHeight: 8, data: ["Top10","Rest","Top10 Share %"] },
    xAxis: { type:"category", data:s.x, axisLabel:{ rotate:(s.x.length>10?25:0) } },
    yAxis: [
      {
        type: "value",
        name: "(ì¡°ì›)",
        axisLabel: {
          formatter: (v) => (v / 1e12).toFixed(1)
        }
      },
      { type:"value", min:0, max:100 }
    ],

    series: [
      { name:"Top10", type:"bar", stack:"t", data: s.top10, barWidth: 16 },
      { name:"Rest", type:"bar", stack:"t", data: s.rest, barWidth: 16 },
      { name:"Top10 Share %", type:"line", yAxisIndex:1, smooth:true, symbolSize:6, data: s.topShare }
    ]
  }, { dualY:true }), true);

  // ===== KIMCHI SCORE =====
  if (kimchiScoreChart && Array.isArray(KIMCHI_HIST) && KIMCHI_HIST.length){
    const kHist = sliceByDays(KIMCHI_HIST, rangeDays);
    const kx = kHist.map(h => h.timestamp_label);
    const ks = kHist.map(h => num(h.smart_kimchi?.score_v1));
      // ë‹¤ì´ë‚˜ë¯¹ ì¶•(Bì•ˆ): ìµœê·¼ êµ¬ê°„ ê°’ì— ë§ì¶° yì¶•ì„ ìë™ í™•ëŒ€ (í•„ìš”ì‹œ ìŒìˆ˜ë„ í‘œì‹œ)
  const vals = ks.filter(v => Number.isFinite(v));
  const lo = vals.length ? Math.min(...vals) : 0;
  const hi = vals.length ? Math.max(...vals) : 100;
  const pad = Math.max(5, (hi - lo) * 0.40);
  const ymin = Math.floor((lo - pad));
  const ymax = Math.ceil((hi + pad));

  kimchiScoreChart.setOption(applyMobileTight({
    grid: { left: 44, right: 18, top: 30, bottom: 36, containLabel: true },
    tooltip: { trigger:"axis", confine:true },
    xAxis: { type:"category", data:kx, axisLabel:{ rotate:(kx.length>10?25:0) } },
    yAxis: {
      type:"value",
      min: ymin,
      max: ymax,
      name:"Score",
      splitLine:{ lineStyle:{ color:"rgba(2,6,23,.06)" } }
    },
    series: [{
      name:"Kimchi Score",
      type:"line",
      smooth:true,
      symbol:"circle",
      symbolSize:6,
      showSymbol:false,
      data: ks,
      lineStyle:{ width:3 },
      areaStyle:{ opacity:0.10 },

      // ê¸°ì¤€ì„ (0/100): ìŠ¤ì½”ì–´ ìŠ¤ì¼€ì¼ ê°ê° ìœ ì§€
      markLine:{
        silent:true,
        symbol:["none","none"],
        lineStyle:{ color:"rgba(2,6,23,.14)", type:"dashed", width:1 },
        label:{ show:false },
        data:[{ yAxis:0 }, { yAxis:100 }]
      },

      // í•´ì„ êµ¬ê°„(ë°´ë“œ): ê³µí†µ ê¸°ì¤€ì€ ìœ ì§€í•˜ë˜ ì¶•ì´ í™•ëŒ€ë˜ì–´ë„ ì°¸ê³ ì„  ì—­í• 
      markArea:{
        silent:true,
        itemStyle:{ opacity:0.08 },
        data:[
          [{ yAxis:0,  itemStyle:{ color:"rgba(148,163,184,.45)" } }, { yAxis:30 }],
          [{ yAxis:30, itemStyle:{ color:"rgba(234,179,8,.35)" } }, { yAxis:60 }],
          [{ yAxis:60, itemStyle:{ color:"rgba(34,197,94,.30)" } }, { yAxis:80 }],
          [{ yAxis:80, itemStyle:{ color:"rgba(239,68,68,.25)" } }, { yAxis:100 }]
        ]
      }
    }]
  }), true);
}

  // ===== KIMCHI PREMIUM =====
  if (kimchiPremChart && Array.isArray(KIMCHI_HIST) && KIMCHI_HIST.length){
    const kHist = sliceByDays(KIMCHI_HIST, rangeDays);
    const kx = kHist.map(h=>h.timestamp_label);

    const kb = kHist.map(h=>num(h.kimchi_premium_pct?.BTC));
    const ke = kHist.map(h=>num(h.kimchi_premium_pct?.ETH));
    const kxrp = kHist.map(h=>num(h.kimchi_premium_pct?.XRP));
    
    // Î”Kimchi = |Î”BTC| + |Î”ETH| + |Î”XRP|
    const kd = kb.map((_, i) => {
      if (i === 0) return null;
      return Math.abs(kb[i]-kb[i-1]) +
             Math.abs(ke[i]-ke[i-1]) +
             Math.abs(kxrp[i]-kxrp[i-1]);
    });

    // %ì¶• ìë™ ë²”ìœ„(ìµœê·¼ êµ¬ê°„ ê¸°ì¤€) - ë‹¤ì´ë‚˜ë¯¹í•˜ê²Œ í™•ëŒ€
  const pctAll = [...kb, ...ke, ...kxrp].filter(v=>Number.isFinite(v));
  const lo = pctAll.length ? Math.min(...pctAll) : -2;
  const hi = pctAll.length ? Math.max(...pctAll) :  2;
  const pad = Math.max(0.3, (hi - lo) * 0.35);
  const ymin = Math.floor((lo - pad) * 10) / 10;
  const ymax = Math.ceil((hi + pad) * 10) / 10;

  kimchiPremChart.setOption(applyMobileTight({
    grid: { left: 44, right: 18, top: 30, bottom: 36, containLabel: true },
    tooltip: {
      trigger:"axis",
      confine:true,
      formatter:(params)=>{
        const i = params[0].dataIndex;
        const d = kd[i];
        const dText = (d===null) ? "-" : (d.toFixed(2) + "p");
        return `<b>${kx[i]}</b>` +
               `<br/>BTC ${fmtPct(kb[i])}` +
               `<br/>ETH ${fmtPct(ke[i])}` +
               `<br/>XRP ${fmtPct(kxrp[i])}` +
               `<br/>Î”Kimchi ${dText}`;
      }
    },
    legend: { top: 6, left: 0, itemWidth: 14, itemHeight: 8, data: ["BTC","ETH","XRP","Î”Kimchi"] },
    xAxis:{ type:"category", data:kx, axisLabel:{ rotate:(kx.length>10?25:0) } },
    yAxis:[
      { type:"value", name:"%", min:ymin, max:ymax, axisLabel:{ formatter:(v)=> Number(v).toFixed(1) } },
      { type:"value", name:"Î”p", splitLine:{ show:false }, axisLabel:{ formatter:(v)=> Number(v).toFixed(1) } }
    ],
    series:[
      { name:"BTC", type:"line", smooth:true, symbol:"circle", symbolSize:5, showSymbol:false, data: kb, lineStyle:{ width:3 } },
      { name:"ETH", type:"line", smooth:true, symbol:"circle", symbolSize:5, showSymbol:false, data: ke, lineStyle:{ width:3 } },
      { name:"XRP", type:"line", smooth:true, symbol:"circle", symbolSize:5, showSymbol:false, data: kxrp, lineStyle:{ width:3 } },
      {
        name:"Î”Kimchi",
        type:"bar",
        yAxisIndex:1,
        barWidth: (isMobile() ? 8 : 12),
        itemStyle:{ opacity: (isMobile() ? 0.35 : 0.9) },
        data: kd
      }
    ]
  }, { dualY:true }), true);
}
  
  }

  
  function fillTopList(elId, arr){
    const el = document.getElementById(elId);
    if (!el) return;
    el.innerHTML = "";
    (arr || []).slice(0,5).forEach((c, idx) => {
      const sym = (c.symbol || "").replace("KRW-","");
      const li = document.createElement("li");
      li.innerHTML = `<span>${idx+1}. ${sym}</span><span>${fmtKRW(c.value)}</span>`;
      el.appendChild(li);
    });
  }

  // âœ… ê¹€ì¹˜ ì½”ë©˜íŠ¸ ìƒì„±ê¸°
  function buildKimchiComment(latest, history, kimchiLatest){
    const ts = (latest?.timestamp_label || "-");
    const t = latest?.totals || {};
    const top = latest?.top10 || {};
    const st = latest?.stablecoins || {};

    const total = num(t.combined_24h);
    const topShare = num(top.top10_share_pct);
    const stableDom = num(st.stable_dominance_pct);

    const kl = kimchiLatest || {};
    const kPrem = kl.kimchi_premium_pct || {};
    
    const btc = num(kPrem.BTC);
    const eth = num(kPrem.ETH);
    const xrp  = num(kPrem.XRP);

    const kType = (kl.smart_kimchi?.type || "-");
    const kScore = num(kl.smart_kimchi?.score_v1);

    const heat =
      total >= 4e12 ? "ê±°ë˜ëŒ€ê¸ˆì´ 4ì¡°ì›ëŒ€ë¥¼ ìœ ì§€í•˜ê³  ìˆìœ¼ë©° ê³¼ì—´ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤" :
      total >= 2e12 ? "ìœ ë™ì„±ì´ 2ì¡°ì›ëŒ€ì—ì„œ ìœ ì§€ë˜ê³  ìˆìœ¼ë©° ë¦¬ìŠ¤í¬ì˜¨/ë¦¬ìŠ¤í¬ì˜¤í”„ê°€ êµì°¨í•˜ëŠ” ìƒí™©ì…ë‹ˆë‹¤" :
      "ê±°ë˜ëŒ€ê¸ˆì´ ë‚®ì•„ì§€ë©° ë°©í–¥ì„±ì´ ì•½í•´ì§„ êµ¬ê°„";

    const crowd =
      topShare >= 70 ? "ì¢…ëª©ë³„ë¡œëŠ” ìƒìœ„ 10ì¢…ëª© ì ë¦¼ì´ ê°•í•œ ì‹œì¥ìœ¼ë¡œ í…Œë§ˆ ì¥ì„¸ ì„±ê²©ì´ ì§™ìŠµë‹ˆë‹¤" :
      topShare >= 60 ? "ì¢…ëª©ë³„ë¡œëŠ” ìƒìœ„ 10ì¢…ëª© ì ë¦¼ì´ ìœ ì§€ë˜ê³  ìˆì§€ë§Œ ê·¸ ê°•ë„ëŠ” ë‘”í™”í•˜ê³  ìˆìŠµë‹ˆë‹¤" :
      "ì¢…ëª©ë³„ ì ë¦¼ì´ ì•½í•´ì§€ë©° ì¢…ëª© í™•ì‚°ì´ ì§„í–‰ë˜ê³  ìˆìŠµë‹ˆë‹¤";

    const stable =
      stableDom >= 10 ? "ê±°ë˜ì†Œ ë‚´ ìŠ¤í…Œì´ë¸” ë¹„ì¤‘ì€ ë†’ì€ ìˆ˜ì¤€ìœ¼ë¡œ ì‹œì¥ ê´€ë§ì„¸ê°€ ì§™ì–´ì§€ê³  ìˆìŠµë‹ˆë‹¤" :
      stableDom >= 5 ? "ê±°ë˜ì†Œ ë‚´ ìŠ¤í…Œì´ë¸” ë¹„ì¤‘ì€ ì¤‘ë¦½ìœ¼ë¡œ ëŒ€ê¸°ìê¸ˆê³¼ íˆ¬ììê¸ˆì´ ê³µì¡´í•˜ê³  ìˆìŠµë‹ˆë‹¤" :
      "í˜„ì¬ ê±°ë˜ì†Œ ë‚´ ìŠ¤í…Œì´ë¸” ë¹„ì¤‘ì´ ë‚®ìœ¼ë©° í˜„ë¬¼ ì•ŒíŠ¸ ìª½ìœ¼ë¡œ ìê¸ˆì´ ì›€ì§ì´ê³  ìˆìŠµë‹ˆë‹¤";

    const head = `Kimchi ${kType} (${kScore.toFixed(1)}ì )`;
    const body = `${ts} ê¸°ì¤€, BTC ${btc.toFixed(2)}%Â·ETH ${eth.toFixed(2)}%Â·XRP ${xrp.toFixed(2)}%ë¡œ ì§‘ê³„ëë‹¤. ${heat}. ${crowd}. ${stable}.`;

    return { head, body };
  }

  function attachAutoResize(charts){
  const ro = new ResizeObserver(() => {
    requestAnimationFrame(() => charts.forEach(c => c?.resize()));
  });
  charts.forEach(c => c && ro.observe(c.getDom()));

  // íƒ­ ì „í™˜/ë°±ê·¸ë¼ìš´ë“œ ë³µê·€ ì‹œ ê¹¨ì§ ë°©ì§€
  document.addEventListener("visibilitychange", () => {
    if (!document.hidden) setTimeout(() => charts.forEach(c => c?.resize()), 50);
  });

  // í°íŠ¸ ë¡œë”©ìœ¼ë¡œ ë ˆì´ì•„ì›ƒ ë°”ë€ŒëŠ” ì¼€ì´ìŠ¤ ë°©ì§€
  if (document.fonts && document.fonts.ready) {
    document.fonts.ready.then(() =>
      setTimeout(() => charts.forEach(c => c?.resize()), 50)
    );
  }

  // ëª¨ë°”ì¼ íšŒì „ ëŒ€ì‘
  window.addEventListener("orientationchange", () => {
    setTimeout(() => charts.forEach(c => c?.resize()), 200);
  });
}
  
  async function refreshData(){
    const u = urls();

    const [latest, history, kimchiLatest, kimchiHist, fxLatest, bm20Hist] = 
      await Promise.all([
      loadJSON(u.latest),
      loadJSON(u.hist),
      loadJSON(u.kimchiLatest),
      loadJSON(u.kimchiHist),
      loadJSON(u.fxLatest), 
      loadJSON(u.bm20History)
    ]);

    LATEST = latest;
    HISTORY = Array.isArray(history) ? history : [];
    BM20_HIST = Array.isArray(bm20Hist) ? bm20Hist : [];
    KIMCHI_LATEST = kimchiLatest;
    KIMCHI_HIST = Array.isArray(kimchiHist) ? kimchiHist : [];

    FX_LATEST = fxLatest;

    if (FX_LATEST){
      const official = FX_LATEST.usdkrw_official;
      const market   = FX_LATEST.usdtkrw_market;
      const gap = market - official;
    
      const fxText =
        gap > 15
          ? `ì‹œì¥ í™˜ìœ¨(${market.toFixed(1)}ì›)ì´ ê³µì‹ í™˜ìœ¨(${official.toFixed(1)}ì›)ë³´ë‹¤ í¬ê²Œ ë†’ì€ ìˆ˜ì¤€ìœ¼ë¡œ ì‹œì¥ ëŒ€ê¸°ìê¸ˆ ìœ ì…ìœ¼ë¡œ ê¹€í”„ê°€ í˜•ì„±ë˜ê³  ìˆë‹¤.`
          : gap > 5
            ? `êµ­ë‚´ ê±°ë˜ì†Œ í™˜ìœ¨ì´ ê³µì‹ í™˜ìœ¨ ëŒ€ë¹„ ì†Œí­ ë†’ì€ ìˆ˜ì¤€ì´ë‚˜ ê·¸ ê°•ë„ëŠ” ë‘”í™”í•˜ê³  ìˆìŠµë‹ˆë‹¤.`
            : `ì‹œì¥Â·ê³µì‹ í™˜ìœ¨ ê´´ë¦¬ê°€ í¬ì§€ ì•Šì€ ìƒí™©ìœ¼ë¡œ, í˜„ì¬ ê¹€í”„ëŠ” ê°œë³„ ì½”ì¸ì˜ ìˆ˜ê¸‰ ìš”ì¸ì— ë”°ë¼ ì˜í–¥ì„ ë°›ê³  ìˆìŠµë‹ˆë‹¤.`;
    
      document.getElementById("fxComment").textContent = fxText;
    }


    // ì‹ ê·œ ë°ì´í„° í™”ë©´ ì£¼ì… ë¶€ë¶„
    if (bm20Hist && bm20Hist.length > 0) {
    const bLatest = bm20Hist[bm20Hist.length - 1];
    
    // 1. í•œêµ­ ì ìœ ìœ¨ ì¹´ë“œ ì—…ë°ì´íŠ¸
    const kShare = bLatest.k_market?.k_share_percent || 0;
    document.getElementById("kpiKShare").textContent = kShare + "%";

    // í•œêµ­ ì ìœ ìœ¨ mini chart (ìµœê·¼ 14ì¼)
    const kSeries = (Array.isArray(bm20Hist) ? bm20Hist : [])
      .slice(-14)
      .map(d => Number(d?.k_market?.k_share_percent) || 0);
    drawSparkline(document.getElementById("kshareSpark"), kSeries);
    
    // 2. ê³µí¬ íƒìš• ì§€ìˆ˜ ì¹´ë“œ ì—…ë°ì´íŠ¸ (í•œê¸€í™” í¬í•¨)
    const fng = bLatest.sentiment || {};
    const fngEl = document.getElementById("fngStatusText");
    const fngNote = document.getElementById("fngValueNote");
    
    const statusMap = {
        "Extreme Fear": "ê·¹ë„ì˜ ê³µí¬",
        "Fear": "ê³µí¬",
        "Neutral": "ì¤‘ë¦½",
        "Greed": "íƒìš•",
        "Extreme Greed": "ê·¹ë„ì˜ íƒìš•"
    };
    
    const korStatus = statusMap[fng.status] || fng.status || "-";
    fngEl.textContent = korStatus;
        fngNote.textContent = `ì‹¬ë¦¬ ì ìˆ˜: ${fng.value || '-'} / 100`;

    // ì˜¨ë„ê³„(0~100) ìœ„ì¹˜ ì—…ë°ì´íŠ¸: ê°’ì´ ë‚®ì„ìˆ˜ë¡ ì™¼ìª½, ë†’ì„ìˆ˜ë¡ ì˜¤ë¥¸ìª½
    const v = Number(fng.value);
    const pct = Number.isFinite(v) ? Math.max(0, Math.min(100, v)) : 50;
    const marker = document.getElementById("fngMarker");
    const dot = document.getElementById("fngDot");
    if(marker) marker.style.left = pct + "%";
    if(dot) dot.style.left = pct + "%";
// ìƒíƒœë³„ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë³€ê²½
    if (fng.value <= 25) fngEl.style.color = "#dc2626";
    else if (fng.value >= 75) fngEl.style.color = "#16a34a";
    else fngEl.style.color = "#2563eb";
    }
    

    // KPI
    const t = latest.totals || {};
    const top = latest.top10 || {};
    document.getElementById("kpiTotal").textContent = fmtKRW(t.combined_24h);
    document.getElementById("kpiTs").textContent =  `í˜„ì¬ ì‹œê°: ${nowKST()}`;
    document.getElementById("kpiTop10").textContent = `${fmtPct1(top.top10_share_pct)} (Top10)`;
    document.getElementById("kpiTop10Note").textContent = `Top10 ${fmtKRW(top.top10_total_24h)} Â· Rest ${fmtKRW(top.rest_total_24h)}`;

    const combined = num(t.combined_24h);
    const upShare = combined > 0 ? (num(t.upbit_24h) / combined * 100) : 0;
    const btShare = combined > 0 ? (num(t.bithumb_24h) / combined * 100) : 0;
    const coShare = combined > 0 ? (num(t.coinone_24h) / combined * 100) : 0;
    document.getElementById("kpiEx").textContent = `ì—…ë¹„íŠ¸ ${upShare.toFixed(1)}%`;
    document.getElementById("kpiExNote").textContent = `ë¹—ì¸ ${btShare.toFixed(1)}% Â· ì½”ì¸ì› ${coShare.toFixed(1)}%`;

    const st = latest.stablecoins || {};
    const stPct = num(st.stable_dominance_pct);
    const stVol = num(st.total_stable_vol_24h);
    document.getElementById("kpiStable").textContent = `${stPct.toFixed(1)}%`;
    const by = st.by_asset || {};
    const byText = Object.keys(by).length
      ? Object.entries(by).sort((a,b)=> num(b[1]) - num(a[1])).map(([k,v])=> `${k} ${fmtKRW(v)}`).join(" Â· ")
      : "ë°ì´í„° ì—†ìŒ";
    document.getElementById("kpiStableNote").textContent = `í•©ê³„ ${fmtKRW(stVol)} Â· ${byText}`;

    // Top10 list + treemap
    const coins = (top.coins || []);
    const list = document.getElementById("top10List");
    list.innerHTML = "";
    coins.forEach((c, idx) => {
      const li = document.createElement("li");
      const sym = (c.symbol || "").replace("KRW-","");
      li.innerHTML = `<span>${idx+1}. ${sym}</span><span>${fmtKRW(c.value)} Â· ${num(c.share_pct).toFixed(1)}%</span>`;
      list.appendChild(li);
    });

    document.getElementById("pillNow").textContent = `í˜„ì¬íŒ: ${latest.timestamp_label || "-"}`;
    const topPct = num(top.top10_share_pct);
    const signal = topPct >= 70 ? "ì ë¦¼ ê°•í•¨" : (topPct >= 60 ? "ì ë¦¼" : "í™•ì‚°");
    document.getElementById("pillSignal").textContent = `ì‹ í˜¸: ${signal}`;

    treemap?.setOption({
      tooltip: {
        formatter: (p) => {
          const d = p.data || {};
          return `<b>${d.name}</b><br/>${fmtKRW(d.value)}<br/>${num(d.share_pct).toFixed(1)}%`;
        }
      },
      series: [{
        type: "treemap",
        roam: false,
        nodeClick: false,
        breadcrumb: { show: false },
        label: { show: true, formatter: "{b}" },
        upperLabel: { show: false },
        itemStyle: { borderColor: "#fff", borderWidth: 2 },
        data: coins.map(c => ({
          name: (c.symbol || "").replace("KRW-",""),
          value: num(c.value),
          share_pct: num(c.share_pct)
        }))
      }]
    });

    // Exchange Top5
    const exTop = latest.by_exchange_top || {};
    fillTopList("upTop5", exTop.upbit_top5);
    fillTopList("btTop5", exTop.bithumb_top5);
    fillTopList("coTop5", exTop.coinone_top5);

    // âœ… ê¹€ì¹˜ ì½”ë©˜íŠ¸ + pill ì—…ë°ì´íŠ¸
    const c = buildKimchiComment(LATEST, HISTORY, KIMCHI_LATEST);
    document.getElementById("kimchiCommentHead").textContent = c.head;
    document.getElementById("kimchiCommentBody").textContent = c.body;

    const kType = (KIMCHI_LATEST?.smart_kimchi?.type || "-");
    const kScore = num(KIMCHI_LATEST?.smart_kimchi?.score_v1);
    const btcPrem = num(KIMCHI_LATEST?.kimchi_premium_pct?.BTC);
    
    document.getElementById("kimchiTypePill").textContent = `Type: ${kType}`;
    document.getElementById("kimchiScorePill").textContent = `Score: ${kScore.toFixed(1)} / 100`;
    document.getElementById("kimchiPremPill").textContent = `BTC Kimchi: ${fmtPct(btcPrem)}`;

    console.log("FX_LATEST", FX_LATEST);
    console.log("fxEl", document.getElementById("fxComment"));

    // âœ… FX ì½”ë©˜íŠ¸ (ê¹€ì¹˜ pill ë‹¤ìŒ, render ì´ì „)
    const fxEl = document.getElementById("fxComment");
    if (FX_LATEST && fxEl){
      const official = num(FX_LATEST.usdkrw_official);
      const market   = num(FX_LATEST.usdtkrw_market);
      const gap = market - official;
    
      const fxText =
        gap > 15
          ? `ì‹œì¥ í™˜ìœ¨(${market.toFixed(1)}ì›)ì´ ê³µì‹ í™˜ìœ¨(${official.toFixed(1)}ì›)ë³´ë‹¤ ë†’ì€ ìˆ˜ì¤€ìœ¼ë¡œ í™˜ìœ¨ ë³€ë™ì— ë”°ë¼ ê°€ê²© ë³€ë™ì´ ì»¤ì§€ê³  ìˆìŠµë‹ˆë‹¤.`
          : gap > 5
            ? `ì‹œì¥ í™˜ìœ¨ì´ ê³µì‹ í™˜ìœ¨ ëŒ€ë¹„ ì†Œí­ ë†’ì€ ìˆ˜ì¤€ìœ¼ë¡œ, ê¹€í”„ì— í™˜ìœ¨ ìš”ì¸ì´ ì¼ë¶€ ë°˜ì˜ë¼ ìˆìŠµë‹ˆë‹¤.`
            : `ì‹œì¥Â·ê³µì‹ í™˜ìœ¨ ê´´ë¦¬ê°€ í¬ì§€ ì•Šì•„, í˜„ì¬ ê¹€í”„ëŠ” ê°œë³„ ì½”ì¸ì˜ ìˆ˜ê¸‰ì— ë”°ë¼ ì˜í–¥ì„ ë°›ê³  ìˆìŠµë‹ˆë‹¤.`;
    
      fxEl.textContent = fxText;
    }

    render(CURRENT_RANGE);
    renderBm20(CURRENT_RANGE);
  }

  (async function init(){
    try{
      treemap = echarts.init(document.getElementById("treemap"));
      totalChart = echarts.init(document.getElementById("totalChart"));
      shareChart = echarts.init(document.getElementById("shareChart"));
      kshareChart = echarts.init(document.getElementById("kshareChart"));
      fngChart = echarts.init(document.getElementById("fngChart"));
      topRestChart = echarts.init(document.getElementById("topRestChart"));
      stableChart = echarts.init(document.getElementById("stableChart"));

      kimchiScoreChart = echarts.init(document.getElementById("kimchiScoreChart"));
      kimchiPremChart  = echarts.init(document.getElementById("kimchiPremChart"));
      
      const allCharts = [treemap, totalChart, shareChart, topRestChart, stableChart, kshareChart, fngChart, kimchiScoreChart, kimchiPremChart].filter(Boolean);
      attachAutoResize(allCharts);


      document.getElementById("btn1d")?.addEventListener("click", ()=> render(1));
      document.getElementById("btn3d")?.addEventListener("click", ()=> render(3));
      document.getElementById("btn7d")?.addEventListener("click", ()=> render(7));

      await refreshData();
      setInterval(refreshData, 60*1000);

      window.addEventListener("resize", ()=>{
        treemap?.resize();
        totalChart?.resize();
        shareChart?.resize();
        kshareChart?.resize();
        fngChart?.resize();
        topRestChart?.resize();
        stableChart?.resize();
        kimchiScoreChart?.resize();
        kimchiPremChart?.resize();
      });
    }catch(err){
      console.error(err);
      alert("JSON ë¡œë”© ì‹¤íŒ¨: /out/history/*.json ê²½ë¡œ/ë°°í¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
    }
  })();
</script>

</body>
</html>
