<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BM Index</title>
  <meta name="description" content="BM Index — Google Sheets CSV 데이터를 차트로 시각화" />
  <style>
    :root { --card-w: 1040px; }
    * { box-sizing: border-box; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin:24px; background:#fafafa; }
    .card { max-width:var(--card-w); margin:0 auto; padding:16px 18px; border-radius:16px; background:#fff; box-shadow:0 8px 28px rgba(0,0,0,.08); }
    .row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between; }
    .muted { color:#666; font-size:12px; }
    .controls { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    select, button { border:1px solid #ddd; background:#fff; padding:6px 10px; border-radius:8px; font-size:13px; }
    button.active { border-color:#000; }
    .err { color:#b00020; font-size:13px; margin-top:6px; }
    .warn { color:#8a5a00; font-size:12px; margin-top:6px; }
  </style>
</head>
<body>
  <div class="card">
    <div class="row" style="margin-bottom:8px">
      <div>
        <h2 style="margin:0">BM Index</h2>
        <div class="muted">source: Google Sheets (CSV)</div>
      </div>
      <div class="controls">
        <span class="muted">범위</span>
        <button data-range="ALL" class="active">ALL</button>
        <button data-range="YTD">YTD</button>
        <button data-range="1Y">1Y</button>
        <button data-range="3Y">3Y</button>
        <span class="muted" style="margin-left:8px">Rebase</span>
        <select id="rebase">
          <option value="first">표시 구간 첫날 = 100</option>
          <option value="2018">2018-01-01 = 100</option>
        </select>
        <button id="download">CSV 다운로드</button>
      </div>
    </div>

    <canvas id="chart" height="360"></canvas>
    <div id="meta" class="muted" style="margin-top:8px"></div>
    <div id="warn" class="warn"></div>
    <div id="error" class="err"></div>
  </div>
<!-- ECharts CDN -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>

<!-- 차트 영역 + 메타 -->
<div id="bm20" style="height:380px; max-width: 1000px; margin: 24px auto;"></div>
<div id="bm20-meta" style="max-width:1000px;margin:6px auto 20px;font:12px/1.6 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:#666;"></div>

<script>
// ① CSV 엔드포인트 (네가 준 링크)
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTndyrPd3WWwFtfzv2CZxJeDcH-l8ibQIdO5ouYS4HsaGpbeXQQbs6WEr9qPqqZbRoT6cObdFxJpief/pub?gid=720141148&single=true&output=csv";

// ② CSV 가져오기 (캐시 무효화용 v 파라미터 추가)
async function fetchCsv() {
  const url = CSV_URL + (CSV_URL.includes("?") ? "&" : "?") + "v=" + Date.now();
  const res = await fetch(url, { cache: "no-store" });
  if (!res.ok) throw new Error("CSV fetch failed: " + res.status);
  return res.text();
}

// ③ 아주 심플한 CSV 파서 (열: date,index,flag,updated_at 가정)
function parseCsv(text) {
  const lines = text.trim().split(/\r?\n/);
  const header = lines.shift().split(",");
  const idxDate = header.indexOf("date");
  const idxIndex = header.indexOf("index");
  const idxUpdated = header.indexOf("updated_at");

  const rows = lines.map(line => {
    // 값에 콤마가 들어갈 일이 거의 없으니 단순 split 사용 (필요시 Papaparse로 교체 가능)
    const cells = line.split(",");
    const vRaw = cells[idxIndex]?.trim().replace(/"/g, "");
    const v = parseFloat(vRaw);
    return {
      date: cells[idxDate],
      value: Number.isFinite(v) ? v : null,
      updated: idxUpdated >= 0 ? cells[idxUpdated] : null
    };
  }).filter(r => r.value !== null);

  return rows;
}

// ④ 차트 렌더
function renderChart(rows) {
  const el = document.getElementById("bm20");
  const chart = echarts.init(el, null, { renderer: "canvas" });

  const data = rows.map(r => [r.date, r.value]);

  chart.setOption({
    title: { text: "BM20 Index", left: "center", top: 0 },
    tooltip: {
      trigger: "axis",
      valueFormatter: v => (typeof v === "number" ? v.toFixed(2) : v)
    },
    grid: { left: 48, right: 24, top: 48, bottom: 56 },
    xAxis: { type: "time" },
    yAxis: { type: "value", scale: true, name: "Index" },
    dataZoom: [
      { type: "inside" },
      { type: "slider", bottom: 18 }
    ],
    series: [{
      name: "BM20",
      type: "line",
      showSymbol: false,
      smooth: true,
      data
    }]
  });

  // 메타 정보: 최신값/업데이트 시각/간단 수익률
  const last = rows[rows.length - 1];
  const metaEl = document.getElementById("bm20-meta");

  // 간단 수익률 계산 (1M/3M/1Y) — 데이터가 충분할 때만
  function periodReturn(days) {
    if (rows.length <= days) return null;
    const prev = rows[rows.length - 1 - days].value;
    return prev ? (last.value / prev - 1) : null;
  }
  const ret1m = periodReturn(21);
  const ret3m = periodReturn(63);
  const ret1y = periodReturn(252);

  metaEl.innerHTML = `
    <b>Last</b>: ${last?.date ?? "-"} &nbsp; | &nbsp;
    <b>Index</b>: ${last?.value?.toFixed(2) ?? "-"} &nbsp; | &nbsp;
    <b>Updated</b>: ${last?.updated ?? "-"}
    ${ret1m!==null ? ` &nbsp; | &nbsp; <b>1M</b>: ${(ret1m*100).toFixed(2)}%` : ""}
    ${ret3m!==null ? ` &nbsp; | &nbsp; <b>3M</b>: ${(ret3m*100).toFixed(2)}%` : ""}
    ${ret1y!==null ? ` &nbsp; | &nbsp; <b>1Y</b>: ${(ret1y*100).toFixed(2)}%` : ""}
  `;

  // 반응형
  window.addEventListener("resize", () => chart.resize());
}

// ⑤ 실행
fetchCsv().then(parseCsv).then(renderChart).catch(err => {
  console.error(err);
  document.getElementById("bm20-meta").textContent = "데이터 로드 실패: " + err.message;
});
</script>

</body>
</html>
