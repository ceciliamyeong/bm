<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BM Index</title>
  <meta name="description" content="BM Index — Google Sheets CSV 데이터를 차트로 시각화" />
  <style>
    :root { --card-w: 1040px; }
    * { box-sizing: border-box; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin:24px; background:#fafafa; }
    .card { max-width:var(--card-w); margin:0 auto; padding:16px 18px; border-radius:16px; background:#fff; box-shadow:0 8px 28px rgba(0,0,0,.08); }
    .row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between; }
    .muted { color:#666; font-size:12px; }
    .controls { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    select, button { border:1px solid #ddd; background:#fff; padding:6px 10px; border-radius:8px; font-size:13px; }
    button.active { border-color:#000; }
    .err { color:#b00020; font-size:13px; margin-top:6px; }
    .warn { color:#8a5a00; font-size:12px; margin-top:6px; }
  </style>
</head>
<body>
  <div class="card">
    <div class="row" style="margin-bottom:8px">
      <div>
        <h2 style="margin:0">BM Index</h2>
        <div class="muted">source: Google Sheets (CSV)</div>
      </div>
      <div class="controls">
        <span class="muted">범위</span>
        <button data-range="ALL" class="active">ALL</button>
        <button data-range="YTD">YTD</button>
        <button data-range="1Y">1Y</button>
        <button data-range="3Y">3Y</button>
        <span class="muted" style="margin-left:8px">Rebase</span>
        <select id="rebase">
          <option value="first">표시 구간 첫날 = 100</option>
          <option value="2018">2018-01-01 = 100</option>
        </select>
        <button id="download">CSV 다운로드</button>
      </div>
    </div>

    <canvas id="chart" height="360"></canvas>
    <div id="meta" class="muted" style="margin-top:8px"></div>
    <div id="warn" class="warn"></div>
    <div id="error" class="err"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
  // ────────────────────── 설정 ──────────────────────
  // output=csv 로 끝나는 네 BM CSV 링크로 바꿔도 됨
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTCY4gVE1R52KBlm7rC8RmI2odz8DtCiIQUo9HbACLT_kM_Sr8KM4-KjwlgI6cerR1Z4BkNZAo2bjm7/pub?gid=0&single=true&output=csv";
  const HARD_BASE = "2018-01-01"; // 고정 기준일 옵션 값
  const AUTO_REFRESH_MS = 10 * 60 * 1000; // 10분마다 자동 새로고침
  // ────────────────────────────────────────────────

  // 따옴표 처리까지 되는 CSV 파서
  function parseCSV(text) {
    const rows = [];
    let i=0, cur=[], field="", inQ=false;
    while (i < text.length) {
      const ch = text[i++];
      if (inQ) {
        if (ch === '"') { if (text[i] === '"') { field += '"'; i++; } else inQ = false; }
        else field += ch;
      } else {
        if (ch === '"') inQ = true;
        else if (ch === ',') { cur.push(field); field=""; }
        else if (ch === '\n') { cur.push(field); rows.push(cur); cur=[]; field=""; }
        else if (ch !== '\r') field += ch;
      }
    }
    if (field.length || cur.length) { cur.push(field); rows.push(cur); }
    return rows;
  }

  async function fetchCSV(url) {
    const res = await fetch(url + "&v=" + Date.now(), { cache: "no-store" });
    if (!res.ok) throw new Error("fetch 실패: " + res.status);
    return res.text();
  }

  function buildSeries(text) {
    const rows = parseCSV(text);
    if (!rows.length) return [];
    const H = rows[0].map(s => s.trim().toLowerCase());
    const di = H.indexOf("date"), ii = H.indexOf("index"), fi = H.indexOf("flag");
    if (di < 0 || ii < 0) throw new Error("CSV에 date/index 컬럼이 없습니다.");
    return rows.slice(1).map(r => ({
      date: r[di],
      index: Number(r[ii]),
      flag: ((r[fi] || "backtest")+"").toLowerCase()
    })).filter(d => d.date && Number.isFinite(d.index));
  }

  function sliceRange(src, range) {
    if (range === "ALL") return src;
    const to = new Date(); let from = new Date(0);
    if (range === "YTD") from = new Date(new Date().getFullYear(), 0, 1);
    else if (range === "1Y") { from = new Date(to); from.setFullYear(to.getFullYear()-1); }
    else if (range === "3Y") { from = new Date(to); from.setFullYear(to.getFullYear()-3); }
    return src.filter(d => new Date(d.date) >= from);
  }

  function rebase(series, mode) {
    if (!series.length) return series;
    let baseVal = series[0].index;
    if (mode === "2018") {
      const base = series.find(d => d.date === HARD_BASE);
      baseVal = base ? base.index : series[0].index;
    }
    return series.map(d => ({ ...d, index: (d.index / baseVal) * 100 }));
  }

  // 핵심 렌더러
  let chart;
function render(series, range="ALL", rebaseMode="first") {
  const sliced = sliceRange(series, range);
  const data   = rebase(sliced, rebaseMode==="2018" ? "2018" : "first");

  const labels = data.map(d => d.date);
  const values = data.map(d => d.index);

  // 마지막 값/전일 대비
  const meta = document.getElementById("meta");
  if (!data.length) {
    meta.textContent = "데이터 없음";
  } else {
    const last = data[data.length-1];
    const prev = data[data.length-2] || last;
    const perf = (((last.index/data[0].index)-1)*100).toFixed(2);
    const dchg = ((last.index/prev.index-1)*100);
    const sign = dchg >= 0 ? "+" : "";
    meta.textContent = `표시 구간: ${data[0].date} → ${last.date} · 누적: ${perf}% · 오늘: ${sign}${dchg.toFixed(2)}%`;
  }

  // live 포인트(있으면)
  const live = [...sliced].reverse().find(d => d.flag === "live");
  const livePoint = live ? [{x: live.date, y: (rebaseMode==="2018"
                        ? (live.index / (data.find(d=>d.date==="2018-01-01")?.index || data[0].index) * 100)
                        : (live.index / data[0].index * 100))}] : [];

  if (chart) chart.destroy();
  chart = new Chart(document.getElementById("chart"), {
    type: "line",
    data: {
      labels,
      datasets: [
        { label: "BM", data: values, tension: 0.25, pointRadius: 0, borderWidth: 2 },
        { label: "live", data: livePoint, type: "scatter", pointRadius: 4, showLine: false }
      ]
    },
    options: {
      plugins: { legend: { display: false },
        tooltip: { callbacks: { label: (ctx) => `Index: ${Number(ctx.parsed.y).toFixed(2)}` } } },
      scales: { x: { display: false }, y: { beginAtZero: false } }
    }
  });
}

  // 부팅
  (async () => {
    const errEl  = document.getElementById("error");
    const rangeBtns = Array.from(document.querySelectorAll("button[data-range]"));
    const rebaseSel = document.getElementById("rebase");
    const dlBtn = document.getElementById("download");

    try {
      const text = await fetchCSV(CSV_URL);
      let series = buildSeries(text);

      // 초기 렌더
      render(series, "ALL", "first");

      // 컨트롤
      rangeBtns.forEach(b => b.addEventListener("click", () => {
        rangeBtns.forEach(x => x.classList.toggle("active", x===b));
        render(series, b.dataset.range, rebaseSel.value);
      }));
      rebaseSel.addEventListener("change", () => {
        const active = document.querySelector("button[data-range].active")?.dataset.range || "ALL";
        render(series, active, rebaseSel.value);
      });
      dlBtn.addEventListener("click", () => { location.href = CSV_URL; });

      // 자동 새로고침
      setInterval(async () => {
        try {
          const refreshed = await fetchCSV(CSV_URL);
          series = buildSeries(refreshed);
          const active = document.querySelector("button[data-range].active")?.dataset.range || "ALL";
          render(series, active, rebaseSel.value);
        } catch(_) {}
      }, AUTO_REFRESH_MS);

    } catch (e) {
      errEl.textContent = e.message || String(e);
    }
  })();
  </script>
</body>
</html>
