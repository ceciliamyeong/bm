<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Non-USD Support Exchange Volume — BM20</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
  <style>
    :root { --fg:#111; --muted:#666; --card:#fff; --bg:#f7f8fa; }
    html,body{height:100%}
    body{margin:0; font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,"Apple SD Gothic Neo","Noto Sans KR",sans-serif; color:var(--fg); background:var(--bg);} 
    header{padding:16px 20px 8px; background:var(--card); position:sticky; top:0; z-index:10; box-shadow:0 1px 0 rgba(0,0,0,.06)}
    h1{font-size:20px; margin:0 0 4px}
    .sub{color:var(--muted); font-size:12px}
    .wrap{max-width:1100px; margin:0 auto}
    .controls{display:flex; gap:8px; flex-wrap:wrap; padding:10px 20px}
    .btn{border:1px solid #ddd; background:#fff; padding:6px 10px; border-radius:10px; cursor:pointer}
    .btn.active{border-color:#333; font-weight:600}
    #chart{height:520px; width:100%; background:#fff;}
    footer{padding:12px 20px; color:var(--muted); font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>No USD Support Exchange Volume</h1>
      <div class="sub">Source: BM/Exchange Aggregation · Updated: <span id="updated">—</span></div>
    </div>
  </header>

  <div class="wrap">
    <div class="controls">
      <button class="btn" data-range="ALL">ALL</button>
      <button class="btn" data-range="YTD">YTD</button>
      <button class="btn active" data-range="12M">12M</button>
    </div>
    <div id="chart"></div>
    <footer>
      Tip: 막대 위로 마우스를 올리면 총합과 거래소별 비중(%)이 표시됩니다. 범례에서 항목을 토글할 수 있습니다.
    </footer>
  </div>

<script>
(async function(){
  // 1) 데이터 로딩: 우선순위 파일들 (존재하는 첫 파일을 사용)
  async function fetchFirst(urls){
    for(const u of urls){
      try{ const r = await fetch(u,{cache:'no-store'}); if(r.ok) return await r.json(); }catch(e){}
    }
    return null;
  }

  // 스키마: [{month:"2024-08", Binance: 540_000_000_000, Bybit:..., Others:...}, ...]
  // 업데이트 시각은 {updated:"YYYY-MM-DD"} 형태로 포함 가능
  const data = await fetchFirst([
    'api/exchange_volume_nonusd.json',
    'bm/api/exchange_volume_nonusd.json',
    'bm/bm/api/exchange_volume_nonusd.json'
  ]) || sampleData();

  const updatedLabel = (data && data.meta && data.meta.updated) ? data.meta.updated : new Date().toISOString().slice(0,10);
  document.getElementById('updated').textContent = updatedLabel;

  const seriesKeys = ['Binance','Bybit','Bitget','OKX','HTX','Others'];
  const allRows = data.rows || data; // rows 배열 또는 루트 배열 모두 허용

  // 날짜 범위 필터링
  function filterRange(range){
    const rows = [...allRows];
    if(range==='ALL') return rows;

    // 파싱
    const parse = s=>{const [y,m]=s.split('-').map(Number); return new Date(y, m-1, 1)};
    const last = parse(rows[rows.length-1].month);
    let start;
    if(range==='YTD'){
      start = new Date(last.getFullYear(), 0, 1);
    } else { // 12M
      start = new Date(last.getFullYear(), last.getMonth()-11, 1);
    }
    return rows.filter(r=>parse(r.month) >= start);
  }

  // 수치 포맷터
  const fmtMoney = (v)=>{
    if(v>=1e12) return '$'+(v/1e12).toFixed(2)+'t';
    if(v>=1e9)  return '$'+(v/1e9).toFixed(1)+'b';
    if(v>=1e6)  return '$'+(v/1e6).toFixed(1)+'m';
    return '$'+(v|0).toLocaleString();
  };

  const el = document.getElementById('chart');
  const chart = echarts.init(el, null, {renderer:'canvas'});

  function render(range){
    const rows = filterRange(range);
    const months = rows.map(r=>r.month);
    const totals = rows.map(r=>seriesKeys.reduce((s,k)=>s+(+r[k]||0),0));

    const series = seriesKeys.map((k)=>({
      name:k, type:'bar', stack:'vol', emphasis:{focus:'series'},
      data: rows.map(r=>+r[k]||0),
    }));

    chart.setOption({
      grid:{left:60,right:20,top:30,bottom:60},
      tooltip:{
        trigger:'axis', axisPointer:{type:'shadow'},
        formatter: (params)=>{
          const idx = params[0].dataIndex;
          const items = params.map(p=>({name:p.seriesName, val:p.value})).filter(i=>i.val>0);
          const total = totals[idx];
          let html = `<div><b>${months[idx]}</b><br/>Total: ${fmtMoney(total)}</div>`;
          html += items.map(i=>{
            const pct = total>0 ? (i.val/total*100).toFixed(1) : 0;
            return `<div>${i.name}: ${fmtMoney(i.val)} (${pct}%)</div>`;
          }).join('');
          return html;
        }
      },
      legend:{top:0},
      xAxis:{type:'category', data:months, axisLabel:{rotate:45}},
      yAxis:{type:'value', axisLabel:{formatter:v=>{
        if(v>=1e12) return '$'+(v/1e12)+'t';
        if(v>=1e9) return '$'+(v/1e9)+'b';
        return '$'+v;
      }}},
      series,
      toolbox:{feature:{saveAsImage:{}}}
    });
  }

  // 버튼 이벤트
  const btns = document.querySelectorAll('.btn');
  btns.forEach(b=>b.addEventListener('click', ()=>{
    btns.forEach(x=>x.classList.remove('active')); b.classList.add('active');
    render(b.dataset.range);
    chart.resize();
  }));

  render('12M');
  window.addEventListener('resize', ()=>chart.resize());

  // 샘플 데이터 (API 없을 때 데모용)
  function sampleData(){
    const months = [
      '2024-08','2024-09','2024-10','2024-12','2025-01','2025-02','2025-03','2025-04','2025-05','2025-06','2025-07','2025-08'
    ];
    const rand = (b)=>b*Math.random()*0.2; // ±20%
    const base = {Binance:5.0e11, Bybit:1.6e11, Bitget:9e10, OKX:7.5e10, HTX:6e10, Others:2.2e11};
    const rows = months.map((m,i)=>({
      month:m,
      Binance: base.Binance + rand(base.Binance),
      Bybit:   base.Bybit  + rand(base.Bybit),
      Bitget:  base.Bitget + rand(base.Bitget),
      OKX:     base.OKX    + rand(base.OKX),
      HTX:     base.HTX    + rand(base.HTX),
      Others:  base.Others + rand(base.Others),
    }));
    return {meta:{updated:new Date().toISOString().slice(0,10)}, rows};
  }
})();
</script>
</body>
</html>
