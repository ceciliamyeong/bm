<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BM20 Weekly Dashboard</title>
  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    :root {
      --bg:#ffffff;
      --card:#ffffff;
      --border:#e5e7eb;
      --text:#111827;
      --muted:#6b7280;
    }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px;}
    .header{display:flex;justify-content:space-between;align-items:flex-end;gap:16px;margin-bottom:16px;}
    .title{font-size:22px;font-weight:800;}
    .subtitle{color:var(--muted);font-size:13px;margin-top:6px;line-height:1.4;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px 14px 8px;}
    .card h3{margin:0 0 10px;font-size:15px;font-weight:750;color:var(--text);}
    .note{color:var(--muted);font-size:12px;margin-top:8px;}
    @media (max-width:980px){.grid{grid-template-columns:1fr;}}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div>
        <div class="title" id="hdrTitle">BM20 Weekly Dashboard</div>
        <div class="subtitle" id="hdrPeriod">-</div>
      </div>
      <div class="subtitle" id="hdrNote"></div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>① KOSPI (좌) vs BTC (우) · 상대변화(%)</h3>
        <div id="chart_left_kospi_right_btc" style="height:320px;"></div>
        <div class="note">각 시계열의 시작일 종가 대비 변동률(%) · 좌축 KOSPI / 우축 BTC</div>
      </div>
      <div class="card">
        <h3>② NASDAQ (좌) vs BM20 (우) · 상대변화(%)</h3>
        <div id="chart_left_nasdaq_right_bm20" style="height:320px;"></div>
        <div class="note">각 시계열의 시작일 종가 대비 변동률(%) · 좌축 NASDAQ / 우축 BM20</div>
      </div>
    </div>

    <div class="grid" style="margin-top:16px;">
      <div class="card">
        <h3>③-1 Weekly Contribution · Best 3</h3>
        <div id="chart_contrib_best" style="height:260px;"></div>
        <div class="note">단위: 지수 기여(%p) · weight × 1W return</div>
      </div>
      <div class="card">
        <h3>③-2 Weekly Contribution · Worst 3</h3>
        <div id="chart_contrib_worst" style="height:260px;"></div>
        <div class="note">단위: 지수 기여(%p) · 음수만 표시</div>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <h3>④ Sector Index Performance (1W)</h3>
      <div id="chart_sector" style="height:340px;"></div>
      <div class="note">섹터는 BM20 전용 수동 맵 기준(권장) · 산출은 섹터 내 동일가중 평균</div>
    </div>
  </div>

  <script>
    google.charts.load('current', { packages: ['corechart','bar'] });
    google.charts.setOnLoadCallback(init);

    let R = null;

    async function init() {
      // ✅ 실데이터 고정 (GitHub Pages baseurl=/bm 기준)
      const res = await fetch('/bm/assets/weekly/weekly_report.json', { cache: 'no-store' });
      R = await res.json();

      document.getElementById('hdrTitle').textContent = R.meta?.title ?? 'BM20 Weekly Dashboard';
      document.getElementById('hdrPeriod').textContent =
        `${R.meta?.week_start ?? '-'} – ${R.meta?.week_end ?? '-'} (KST)`;
      document.getElementById('hdrNote').textContent = R.meta?.timezone_note ?? '';

      drawAll();
      window.addEventListener('resize', drawAll);
    }

    const baseChartArea = { left: 56, right: 56, top: 18, bottom: 42 };

    const baseHAxis = {
      textStyle: { color: '#374151', fontSize: 11 },
      gridlines: { color: '#e5e7eb' },
      baselineColor: '#d1d5db'
    };

    const baseVAxis = {
      textStyle: { color: '#374151', fontSize: 11 },
      gridlines: { color: '#e5e7eb' },
      baselineColor: '#d1d5db'
    };

    const baseLegend = {
      textStyle: { color: '#374151', fontSize: 12 }
    };

    // ✅ 레벨(종가) → 시작일 대비 상대변화율(%) 변환
    function toPctChange(arr) {
      const base = arr?.[0];
      if (base == null || base === 0) return (arr || []).map(_ => null);
      return (arr || []).map(v => (v == null ? null : ((v / base) - 1) * 100));
    }

    function drawAll() {
      if (!R) return;

      // ✅ 필수: weekly_report.json에 btc 배열이 있어야 함
      // ① 좌 KOSPI, 우 BTC (상대변화 %)
      drawDualAxisRelativePercent(
        'chart_left_kospi_right_btc',
        'KOSPI', R.kospi,
        'BTC', R.btc
      );

      // ② 좌 NASDAQ, 우 BM20 (상대변화 %)
      drawDualAxisRelativePercent(
        'chart_left_nasdaq_right_bm20',
        'NASDAQ', R.nasdaq,
        'BM20', R.bm20
      );

      drawHBar('chart_contrib_best', R.contrib_best3);
      drawHBar('chart_contrib_worst', R.contrib_worst3);
      drawSector('chart_sector', R.sectors);
    }

    // ✅ 듀얼축 상대변화(%) 라인차트
    function drawDualAxisRelativePercent(el, leftLabel, leftSeries, rightLabel, rightSeries) {
      const leftPct = toPctChange(leftSeries);
      const rightPct = toPctChange(rightSeries);

      const data = new google.visualization.DataTable();
      data.addColumn('string', 'Date');
      data.addColumn('number', `${leftLabel} (Δ%)`);
      data.addColumn('number', `${rightLabel} (Δ%)`);

      (R.dates || []).forEach((d, i) => data.addRow([d, leftPct[i], rightPct[i]]));

      const options = {
        backgroundColor: 'transparent',
        chartArea: baseChartArea,
        legend: baseLegend,
        series: {
          0: { targetAxisIndex: 0, lineWidth: 2 },
          1: { targetAxisIndex: 1, lineWidth: 2 }
        },
        hAxis: baseHAxis,
        vAxes: {
          0: { ...baseVAxis, title: `${leftLabel} (Δ% from start)`, titleTextStyle: { color: '#6b7280' } },
          1: { ...baseVAxis, title: `${rightLabel} (Δ% from start)`, titleTextStyle: { color: '#6b7280' } }
        }
      };

      new google.visualization.LineChart(document.getElementById(el)).draw(data, options);
    }

    function drawHBar(el, rows) {
      const data = new google.visualization.DataTable();
      data.addColumn('string', 'Asset');
      data.addColumn('number', 'Contribution (%p)');
      (rows || []).forEach(r => data.addRow(r));

      const options = {
        backgroundColor: 'transparent',
        chartArea: { left: 90, right: 30, top: 12, bottom: 36 },
        legend: { position: 'none' },
        hAxis: { ...baseHAxis, title: '%p', titleTextStyle: { color: '#6b7280' } },
        vAxis: { ...baseVAxis },
        bars: 'horizontal'
      };

      new google.charts.Bar(document.getElementById(el)).draw(
        data,
        google.charts.Bar.convertOptions(options)
      );
    }

    function drawSector(el, rows) {
      const data = new google.visualization.DataTable();
      data.addColumn('string', 'Sector');
      data.addColumn('number', '1W Return (%)');
      (rows || []).forEach(r => data.addRow(r));

      const options = {
        backgroundColor: 'transparent',
        chartArea: { left: 60, right: 20, top: 12, bottom: 70 },
        legend: { position: 'none' },
        hAxis: { ...baseHAxis, slantedText: true, slantedTextAngle: 35 },
        vAxis: { ...baseVAxis, title: '%', titleTextStyle: { color: '#6b7280' } }
      };

      new google.visualization.ColumnChart(document.getElementById(el)).draw(data, options);
    }
  </script>
</body>
</html>
