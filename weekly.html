<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BM20 Weekly Dashboard</title>
  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    :root {
      --bg:#ffffff;
      --card:#ffffff;
      --border:#e5e7eb;
      --text:#111827;
      --muted:#6b7280;
    }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px;}
    .header{display:flex;justify-content:space-between;align-items:flex-end;gap:16px;margin-bottom:16px;}
    .title{font-size:22px;font-weight:800;}
    .subtitle{color:var(--muted);font-size:13px;margin-top:6px;line-height:1.4;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px 14px 8px;}
    .card h3{margin:0 0 10px;font-size:15px;font-weight:750;color:rgba(255,255,255,0.86);}
    .note{color:var(--muted);font-size:12px;margin-top:8px;}
    @media (max-width:980px){.grid{grid-template-columns:1fr;}}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div>
        <div class="title" id="hdrTitle">BM20 Weekly Dashboard</div>
        <div class="subtitle" id="hdrPeriod">-</div>
      </div>
      <div class="subtitle" id="hdrNote"></div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>① BM20 vs KOSPI (Dual Axis)</h3>
        <div id="chart_bm20_kospi" style="height:320px;"></div>
        <div class="note">왼쪽 축: BM20 · 오른쪽 축: KOSPI</div>
      </div>
      <div class="card">
        <h3>② BM20 vs NASDAQ (Dual Axis)</h3>
        <div id="chart_bm20_nasdaq" style="height:320px;"></div>
        <div class="note">왼쪽 축: BM20 · 오른쪽 축: NASDAQ</div>
      </div>
    </div>

    <div class="grid" style="margin-top:16px;">
      <div class="card">
        <h3>③-1 Weekly Contribution · Best 3</h3>
        <div id="chart_contrib_best" style="height:260px;"></div>
        <div class="note">단위: 지수 기여(%p) · weight × 1W return</div>
      </div>
      <div class="card">
        <h3>③-2 Weekly Contribution · Worst 3</h3>
        <div id="chart_contrib_worst" style="height:260px;"></div>
        <div class="note">단위: 지수 기여(%p) · 음수만 표시</div>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <h3>④ Sector Index Performance (1W)</h3>
      <div id="chart_sector" style="height:340px;"></div>
      <div class="note">섹터는 BM20 전용 수동 맵 기준(권장) · 산출은 섹터 내 동일가중 평균</div>
    </div>
  </div>

  <script>
    google.charts.load('current', { packages: ['corechart','bar'] });
    google.charts.setOnLoadCallback(init);

    let R = null;

    async function init() {
      // 경로만 네 프로젝트 구조에 맞춰 조정
      const res = await fetch('assets/weekly/weekly_report_mock.json', { cache: 'no-store' });
      R = await res.json();

      document.getElementById('hdrTitle').textContent = R.meta?.title ?? 'BM20 Weekly Dashboard';
      document.getElementById('hdrPeriod').textContent =
        `${R.meta.week_start} – ${R.meta.week_end} (KST)`;
      document.getElementById('hdrNote').textContent = R.meta?.timezone_note ?? '';

      drawAll();
      window.addEventListener('resize', drawAll);
    }

    const baseChartArea = { left: 56, right: 56, top: 18, bottom: 42 };
    const baseHAxis = {
      textStyle: { color: 'rgba(255,255,255,0.70)', fontSize: 11 },
      gridlines: { color: 'rgba(255,255,255,0.08)' },
      baselineColor: 'rgba(255,255,255,0.10)'
    };
    const baseVAxis = {
      textStyle: { color: 'rgba(255,255,255,0.70)', fontSize: 11 },
      gridlines: { color: 'rgba(255,255,255,0.08)' },
      baselineColor: 'rgba(255,255,255,0.10)'
    };
    const baseLegend = { textStyle: { color: 'rgba(255,255,255,0.75)', fontSize: 12 } };

    function drawAll() {
      if (!R) return;
      drawDualAxis('chart_bm20_kospi', 'KOSPI', R.kospi);
      drawDualAxis('chart_bm20_nasdaq', 'NASDAQ', R.nasdaq);
      drawHBar('chart_contrib_best', R.contrib_best3);
      drawHBar('chart_contrib_worst', R.contrib_worst3);
      drawSector('chart_sector', R.sectors);
    }

    function drawDualAxis(el, labelRight, seriesRight) {
      const data = new google.visualization.DataTable();
      data.addColumn('string', 'Date');
      data.addColumn('number', 'BM20');
      data.addColumn('number', labelRight);

      R.dates.forEach((d, i) => data.addRow([d, R.bm20[i], seriesRight[i]]));

      const options = {
        backgroundColor: 'transparent',
        chartArea: baseChartArea,
        legend: baseLegend,
        series: {
          0: { targetAxisIndex: 0, lineWidth: 2 },
          1: { targetAxisIndex: 1, lineWidth: 2 }
        },
        hAxis: baseHAxis,
        vAxes: {
          0: { ...baseVAxis, title: 'BM20', titleTextStyle: { color: 'rgba(255,255,255,0.65)' } },
          1: { ...baseVAxis, title: labelRight, titleTextStyle: { color: 'rgba(255,255,255,0.65)' } }
        }
      };

      new google.visualization.LineChart(document.getElementById(el)).draw(data, options);
    }

    function drawHBar(el, rows) {
      const data = new google.visualization.DataTable();
      data.addColumn('string', 'Asset');
      data.addColumn('number', 'Contribution (%p)');
      rows.forEach(r => data.addRow(r));

      const options = {
        backgroundColor: 'transparent',
        chartArea: { left: 90, right: 30, top: 12, bottom: 36 },
        legend: { position: 'none' },
        hAxis: { ...baseHAxis, title: '%p', titleTextStyle: { color: 'rgba(255,255,255,0.65)' } },
        vAxis: { ...baseVAxis },
        bars: 'horizontal'
      };

      new google.charts.Bar(document.getElementById(el)).draw(data, google.charts.Bar.convertOptions(options));
    }

    function drawSector(el, rows) {
      const data = new google.visualization.DataTable();
      data.addColumn('string', 'Sector');
      data.addColumn('number', '1W Return (%)');
      rows.forEach(r => data.addRow(r));

      const options = {
        backgroundColor: 'transparent',
        chartArea: { left: 60, right: 20, top: 12, bottom: 70 },
        legend: { position: 'none' },
        hAxis: { ...baseHAxis, slantedText: true, slantedTextAngle: 35 },
        vAxis: { ...baseVAxis, title: '%', titleTextStyle: { color: 'rgba(255,255,255,0.65)' } }
      };

      new google.visualization.ColumnChart(document.getElementById(el)).draw(data, options);
    }
  </script>
</body>
</html>
