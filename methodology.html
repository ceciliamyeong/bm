<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BM20 Methodology & Components</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<style>
  :root{--fg:#111;--muted:#666;--bd:#e5e9f0;--link:#1A237E;--bg:#fafbfc}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.7 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR","Malgun Gothic",sans-serif}
  .wrap{max-width:960px;margin:0 auto;padding:22px}
  .card{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:22px;margin-bottom:16px}
  h1{margin:0 0 14px 0;font-size:22px}
  h2{margin:18px 0 8px 0;font-size:16px;color:var(--link)}
  ul,ol{margin:8px 0 16px 20px}
  code,pre{background:#f6f8fa;border:1px solid #eaeef2;border-radius:6px}
  code{padding:0 4px}
  .nav{display:flex;gap:10px;flex-wrap:wrap;margin:0 0 14px 0}
  .nav a{display:inline-block;padding:8px 10px;border:1px solid var(--bd);border-radius:8px;text-decoration:none;color:var(--link);background:#fff}
  .muted{color:var(--muted)}
  hr{border:none;border-top:1px solid var(--bd);margin:18px 0}
  table{border-collapse:collapse;width:100%;font-size:14px}
  th,td{border:1px solid var(--bd);padding:8px}
  thead th{background:#f3f6ff}
  .grid{display:flex;flex-wrap:wrap;gap:24px}
  .col{flex:1;min-width:320px}
</style>
</head>
<body>
  <div class="wrap">
    <nav class="nav">
      <a href="index.html">Home</a>
      <a href="latest.html">Latest</a>
      <a href="performance.html">Performance</a>
      <a href="methodology.html"><strong>Methodology + Components</strong></a>
      <a href="about.html">About</a>
    </nav>

    <!-- Methodology -->
    <div class="card" id="methodology">
      <h1>BM20 산정기준 (Methodology)</h1>

      <h2>지수 기본</h2>
      <ul>
        <li><strong>기준 통화:</strong> USD</li>
        <li><strong>기준일/베이스:</strong> 2018-01-01 = 100</li>
        <li><strong>리밸런싱 주기:</strong> 분기(Quarterly) — 분기 내 가중치 고정</li>
        <li><strong>편입 대상:</strong> 시총/거래대금 상위, 스테이블 제외, 편집 스냅샷으로 확정</li>
      </ul>

      <h2>가중치 책정</h2>
      <p class="muted">우선순위(분기별):</p>
      <ol>
        <li><strong>시총(Market Cap)</strong> – CoinGecko (API 가용 범위: 최근 1년)</li>
        <li><strong>폴백:</strong> <em>달러거래대금</em> = Σ(일별 <code>Close × Volume</code>) (야후 파이낸스)</li>
        <li><strong>최종 폴백:</strong> 편집 스냅샷(<code>bm20_constituents.weight</code>)</li>
      </ol>
      <p class="muted">보정:</p>
      <ul>
        <li><strong>KR 보너스:</strong> 국내 상장(<code>listed_in_kr3</code>) 및 <code>kr_bonus_applied=True</code> → × <strong>1.3</strong></li>
        <li><strong>상한(Cap):</strong> BTC 30%, ETH 15%, XRP 5%, 기타 15% (초과분은 잔여 종목에 <em>비례 재분배</em>)</li>
        <li><strong>상장 전 분기:</strong> 가중치 0</li>
      </ul>

      <h2>지수 산출</h2>
      <ul>
        <li><strong>가격:</strong> yfinance USD 종가</li>
        <li><strong>일간 수익률:</strong> <code>r_t = P_t / P_{t-1} − 1</code></li>
        <li><strong>지수:</strong> <code>Index_t = Base × ∏ (1 + r_i · w_i)</code> (분기 내 고정 가중치)</li>
      </ul>

      <h2>운영/감리</h2>
      <ul>
        <li>분기마다 <strong>소스 선택(시총/거래대금/스냅샷)</strong> 로그 기록</li>
        <li>산출/배포 이력은 “데이터”와 GitHub Actions 로그로 관리</li>
      </ul>
    </div>

    <!-- Components (Table + Treemap) -->
    <div class="card" id="components">
      <h1>BM20 구성 (Components)</h1>
      <p class="muted">구성/비중은 분기 리밸런싱에 따라 고정되며, 데이터는 공개 스프레드시트 CSV를 사용합니다.</p>

      <div class="grid">
        <div class="col">
          <h2>Constituents</h2>
          <table id="bm20-table">
            <thead>
              <tr><th>Symbol</th><th>Name</th><th style="text-align:right">Market Cap (USD)</th><th style="text-align:right">Weight %</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="col">
          <h2>Weights Treemap</h2>
          <div id="bm20-weights-heatmap" style="height:560px;"></div>
        </div>
      </div>
    </div>

    <p class="muted" style="text-align:center">© Blockmedia · Data: Google Sheets (public CSV)</p>
  </div>

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
  <script>
  (async function(){
    // ▼ CSV 주소(gid)는 구성/시총 탭에 맞게 유지
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTndyrPd3WWwFtfzv2CZxJeDcH-l8ibQIdO5ouYS4HsaGpbeXQQbs6WEr9qPqqZbRoT6cObdFxJpief/pub?gid=352245628&single=true&output=csv";

    // fetch CSV (cache bust)
    async function fetchCSV(url){
      const r = await fetch(url + (url.includes('?')?'&':'?') + 't=' + Date.now(), {cache:'no-store'});
      if(!r.ok) throw new Error('CSV HTTP '+r.status);
      return r.text();
    }
    function splitCsvRow(row){
      const out=[]; let cur="", q=false;
      for(let i=0;i<row.length;i++){
        const ch=row[i];
        if(ch === '"'){ q=!q; continue; }
        if(ch === ',' && !q){ out.push(cur); cur=""; continue; }
        cur += ch;
      }
      out.push(cur); return out.map(s=>s.trim());
    }

    let text;
    try{
      text = await fetchCSV(CSV_URL);
    }catch(e){
      console.error('CSV load failed', e);
      document.querySelector('#bm20-weights-heatmap').innerHTML =
        '<div style="padding:12px;color:#c00;background:#fee;border:1px solid #fcc;border-radius:8px;">구성 CSV를 불러오지 못했습니다.</div>';
      return;
    }

    const lines = text.trim().split(/\r?\n/);
    const header = splitCsvRow(lines.shift()).map(h=>h.toLowerCase());
    const iSym = header.indexOf("symbol");
    const iCap = header.indexOf("market cap");
    const iName= header.indexOf("name");

    // rows: [{symbol, name, cap}]
    let rows=[];
    for(const l of lines){
      if(!l.trim()) continue;
      const c = splitCsvRow(l);
      const sym  = (c[iSym]||"").toUpperCase();
      const name = c[iName] || sym;
      const cap  = parseFloat((c[iCap]||"0").replace(/,/g,""));
      if(Number.isFinite(cap)) rows.push({symbol:sym, name, cap});
    }

    // weight % 계산 및 정렬
    const sum = rows.reduce((a,b)=>a+b.cap,0)||1;
    rows = rows.map(r => ({...r, weight: r.cap/sum*100})).sort((a,b)=>b.weight - a.weight);

    // 테이블 렌더
    const tbody = document.querySelector('#bm20-table tbody');
    tbody.innerHTML = rows.map(r => `
      <tr>
        <td>${r.symbol}</td>
        <td>${r.name}</td>
        <td style="text-align:right">${Math.round(r.cap).toLocaleString()}</td>
        <td style="text-align:right">${r.weight.toFixed(2)}%</td>
      </tr>`).join('');

    // 트리맵 렌더
    const data = rows.map(r => ({
      name: r.symbol,
      value: +r.weight.toFixed(4),
      label: { formatter: r.symbol + "\\n" + r.weight.toFixed(1) + "%" }
    }));
    const chart = echarts.init(document.getElementById('bm20-weights-heatmap'));
    chart.setOption({
      tooltip: { formatter: p => `${p.name}: ${p.value.toFixed(2)}%` },
      series: [{
        type: 'treemap',
        data,
        roam: false,
        label: { show: true, position: 'inside', fontSize: 12 },
        levels: [{ itemStyle: { borderColor:'#fff', borderWidth:2, gapWidth:2 } }]
      }]
    });
    window.addEventListener('resize', ()=>chart.resize());
  })();
  </script>
</body>
</html>
