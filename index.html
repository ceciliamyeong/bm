<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BM20 Index — BLOCKMEDIA</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>

  <style>
    :root{
      --bg:#f8fafc;
      --panel:#ffffff;
      --border:#e5e7eb;
      --text:#0f172a;
      --muted:#64748b;

      --shadow:0 1px 2px rgba(15,23,42,.06);
      --radius:14px;

      --accent:#2563eb;
      --accent2:#7c3aed;

      --chip:#f1f5f9;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif;
    }
    a{ color:inherit; }

    .wrap{
      max-width: 1120px;
      margin: 0 auto;
      padding: 18px 18px 48px;
    }

    /* Header (The Block-like) */
    .topbar{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
      margin-bottom:14px;
    }
    .brand{
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .logo{
      width:34px;height:34px;border-radius:12px;
      background:linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow:0 10px 22px rgba(37,99,235,.18);
      flex:0 0 auto;
    }
    .title h1{ margin:0; font-size:20px; letter-spacing:-0.3px; }
    .title p{
      margin:6px 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.45;
      max-width: 760px;
    }
    .meta{
      display:flex; gap:8px; flex-wrap:wrap;
      justify-content:flex-end; align-items:center;
    }
    .chip{
      background:var(--chip);
      border:1px solid var(--border);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color:#334155;
      white-space:nowrap;
    }

    /* Panels */
    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }

    .kpiGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-bottom:14px;
    }
    @media (min-width: 980px){
      .kpiGrid{ grid-template-columns: repeat(5, 1fr); }
    }
    .kpi{
      padding:12px 12px;
      min-width:0;
    }
    .kpi .label{ color:var(--muted); font-size:12px; margin:0 0 6px; }
    .kpi .value{ font-size:20px; font-weight:800; letter-spacing:-0.3px; margin:0; }
    .kpi .note{ color:var(--muted); font-size:12px; margin-top:6px; }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (min-width: 1100px){
      .grid{ grid-template-columns: 2fr 1fr; }
    }

    .widget{ padding:12px; }
    .widgetHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .wTitle{ display:flex; gap:10px; align-items:flex-start; }
    .wIcon{
      width:28px; height:28px;
      border-radius:10px;
      background:#eef2ff;
      border:1px solid #e0e7ff;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#3730a3;
      font-weight:800;
      font-size:12px;
      flex:0 0 auto;
    }
    .wTitle h4{ margin:0; font-size:13px; letter-spacing:-0.2px; }
    .wTitle .desc{ margin-top:4px; font-size:12px; color:var(--muted); line-height:1.35; }
    .wMeta{
      text-align:right;
      color:var(--muted);
      font-size:11px;
      white-space:nowrap;
    }

    .chart{
      width:100%;
      height:380px;
    }

    .toolbar{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:8px;
    }
    .btn{
      border:1px solid var(--border);
      background:#fff;
      color:#334155;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
    }
    .btn.active{
      border-color:#0f172a;
      color:#0f172a;
      font-weight:800;
    }

    .list{ margin:0; padding:0; list-style:none; }
    .list li{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:9px 2px;
      border-top:1px solid var(--border);
      font-size:12.5px;
      color:#0f172a;
    }
    .list li:first-child{ border-top:none; }
    .sub{ color:var(--muted); font-size:12px; }

    .source{
      margin-top:10px;
      color: var(--muted);
      font-size: 12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- Header -->
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div class="title">
          <h1>BM20 Index</h1>
          <p>BLOCKMEDIA가 정의한 상위 20 코인 바스켓 지수. (리밸런싱/가중치 룰은 Methodology 기준)</p>
        </div>
      </div>
      <div class="meta">
        <span class="chip" id="metaUpdated">UPDATED: -</span>
        <span class="chip" id="metaLevel">INDEX: -</span>
      </div>
    </div>

    <!-- KPI -->
   <section class="kpiGrid">
      <div class="panel kpi">
        <p class="label">현재 지수(Level)</p>
        <div class="row">
          <p class="value" id="kpiLevel">-</p>
          <span class="delta flat" id="kpiLevelDelta">-</span>
        </div>
        <div class="note" id="kpiLevelNote">-</div>
      </div>
    
      <div class="panel kpi">
        <p class="label">1D</p>
        <div class="row">
          <p class="value" id="kpi1d">-</p>
          <span class="delta flat" id="kpi1dDelta">-</span>
        </div>
        <div class="note sub" id="kpi1dNote">return</div>
      </div>
    
      <div class="panel kpi">
        <p class="label">7D</p>
        <div class="row">
          <p class="value" id="kpi7d">-</p>
          <span class="delta flat" id="kpi7dDelta">-</span>
        </div>
        <div class="note sub" id="kpi7dNote">return</div>
      </div>
    
      <div class="panel kpi">
        <p class="label">30D</p>
        <div class="row">
          <p class="value" id="kpi30d">-</p>
          <span class="delta flat" id="kpi30dDelta">-</span>
        </div>
        <div class="note sub" id="kpi30dNote">return</div>
      </div>
    
      <div class="panel kpi">
        <p class="label">YTD</p>
        <div class="row">
          <p class="value" id="kpiYtd">-</p>
          <span class="delta flat" id="kpiYtdDelta">-</span>
        </div>
        <div class="note sub" id="kpiYtdNote">return</div>
      </div>
    </section>


    <section class="grid">
      <!-- Main chart -->
      <div class="panel widget">
        <div class="widgetHead">
          <div class="wTitle">
            <div class="wIcon">Σ</div>
            <div>
              <h4>BM20 Index Level</h4>
              <div class="desc">지수 레벨 추이 + 구간 선택(1M/3M/12M/ALL)</div>
              <div class="toolbar">
                <button class="btn" id="z1m">1M</button>
                <button class="btn" id="z3m">3M</button>
                <button class="btn active" id="z12m">12M</button>
                <button class="btn" id="zall">ALL</button>
              </div>
            </div>
          </div>
          <div class="wMeta" id="wChartMeta">UPDATED: -</div>
        </div>
        <div id="bm20Chart" class="chart"></div>

        <div class="source">
          <div><b>SOURCE: BLOCKMEDIA</b></div>
          <div id="sourceUpdated">UPDATED: -</div>
        </div>
      </div>

      <!-- Components -->
      <div class="panel widget">
        <div class="widgetHead">
          <div class="wTitle">
            <div class="wIcon">C</div>
            <div>
              <h4>Components</h4>
              <div class="desc">현재 편입 코인/가중치(가능하면 latest JSON 기반)</div>
            </div>
          </div>
          <div class="wMeta">WEIGHTS</div>
        </div>

        <ul class="list" id="compList"></ul>

        <div class="source" style="justify-content:flex-start;">
          <div class="sub">Data paths: <code>/bm/bm20_latest.json</code> · <code>/bm/bm20_series.json</code></div>
        </div>
      </div>
    </section>

  </div>

<script>

  /* KPI: The Block-like (big value + small delta) */
  .kpi .row{
    display:flex;
    align-items:baseline;
    justify-content:space-between;
    gap:10px;
  }
  .kpi .delta{
    font-size:12px;
    font-weight:800;
    white-space:nowrap;
  }
  .kpi .delta.up{ color:#16a34a; }   /* green */
  .kpi .delta.down{ color:#dc2626; } /* red */
  .kpi .delta.flat{ color:#64748b; } /* muted */

  
  
  function num(x){
    const n = Number(x);
    return Number.isFinite(n) ? n : 0;
  }
  function fmtPct(p, d=2){
    if (p === null || p === undefined || Number.isNaN(p)) return "-";
    const sign = p > 0 ? "+" : "";
    return sign + Number(p).toFixed(d) + "%";
  }
  function fmtLevel(v){
    const n = num(v);
    if (!Number.isFinite(n)) return "-";
    return n.toFixed(2);
  }
  async function loadJSON(url){
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error("Failed: " + url + " (" + res.status + ")");
    return await res.json();
  }

  function fmtDeltaPct(p){
    if (p === null || p === undefined || Number.isNaN(p)) return "-";
    const v = Number(p);
    const arrow = v > 0 ? "▲" : (v < 0 ? "▼" : "•");
    return `${arrow} ${Math.abs(v).toFixed(2)}%`;
  }
  
  function setDelta(elId, pct){
    const el = document.getElementById(elId);
    if (!el) return;
    const v = (pct === null || pct === undefined) ? NaN : Number(pct);
  
    el.classList.remove("up","down","flat");
    if (!Number.isFinite(v) || v === 0) el.classList.add("flat");
    else if (v > 0) el.classList.add("up");
    else el.classList.add("down");
  
    el.textContent = fmtDeltaPct(v);
  }

  
  function urls(){
    const bust = "v=" + Date.now();
    // 여러 후보 경로를 순서대로 시도 (네 repo 구조가 바뀌어도 최대한 버티게)
    return {
      latestCandidates: [
        "/bm/bm20_latest.json?" + bust,
        "/bm/out/bm20_latest.json?" + bust
      ],
      seriesCandidates: [
        "/bm/bm20_series.json?" + bust,
        "/bm/out/bm20_series.json?" + bust
      ]
    };
  }

  async function loadFirstOk(candidates){
    let lastErr = null;
    for (const u of candidates){
      try{ return await loadJSON(u); }
      catch(e){ lastErr = e; }
    }
    throw lastErr || new Error("No candidate URL works");
  }

  // ---- series normalize (유연하게 파싱) ----
  function normalizeSeries(raw){
    // 허용: [{date, value}] / [{t, v}] / {points:[...]} / {series:[...]}
    const arr =
      Array.isArray(raw) ? raw :
      Array.isArray(raw?.points) ? raw.points :
      Array.isArray(raw?.series) ? raw.series :
      Array.isArray(raw?.data) ? raw.data :
      [];

    return arr
      .map(p=>{
        const t = p.date || p.d || p.timestamp || p.time || p.t;
        const v = p.value ?? p.level ?? p.index ?? p.v;
        if (!t) return null;
        return { t: String(t), v: num(v) };
      })
      .filter(Boolean);
  }

  // ---- UI fill ----
  function setText(id, text){
    const el = document.getElementById(id);
    if (el) el.textContent = text;
  }

  function fillComponents(latest){
    const el = document.getElementById("compList");
    if (!el) return;
    el.innerHTML = "";

    const comps =
      Array.isArray(latest?.components) ? latest.components :
      Array.isArray(latest?.weights) ? latest.weights :
      Array.isArray(latest?.universe) ? latest.universe :
      [];

    if (!comps.length){
      const li = document.createElement("li");
      li.innerHTML = `<span>Components</span><span class="sub">데이터 없음</span>`;
      el.appendChild(li);
      return;
    }

    // {symbol, weight} 형태 가정 (weight가 0~1 또는 0~100)
    comps.slice(0, 25).forEach((c)=>{
      const sym = (c.symbol || c.ticker || c.code || "-").toUpperCase();
      let w = (c.weight ?? c.w ?? c.weight_pct ?? null);
      w = (w === null) ? null : num(w);
      const wPct = (w === null) ? "-" : (w <= 1 ? (w*100).toFixed(2) : w.toFixed(2)) + "%";

      const li = document.createElement("li");
      li.innerHTML = `<span>${sym}</span><span>${wPct}</span>`;
      el.appendChild(li);
    });
  }

  // ---- chart ----
  let chart;
  let SERIES_ALL = [];
  let ZOOM = "12m";

  function sliceByZoom(points){
    if (!points.length) return points;
    if (ZOOM === "all") return points;

    // 날짜 문자열이라도 그냥 "최근 N개"로 자르기 (데이터 주기가 일정치 않아도 안전)
    const n =
      (ZOOM === "1m") ? 30 :
      (ZOOM === "3m") ? 90 :
      (ZOOM === "12m") ? 365 :
      365;
    return points.slice(-Math.max(n, 20));
  }

  function renderChart(){
    if (!chart) return;
    const pts = sliceByZoom(SERIES_ALL);
    const x = pts.map(p=>p.t);
    const y = pts.map(p=>p.v);

    chart.setOption({
      grid: { left: 56, right: 18, top: 28, bottom: 44 },
      tooltip: {
        trigger:"axis",
        axisPointer:{ type:"cross" },
        formatter:(params)=>{
          const i = params?.[0]?.dataIndex ?? 0;
          return `<b>${x[i] || "-"}</b><br/>BM20 ${fmtLevel(y[i])}`;
        }
      },
      xAxis: {
        type:"category",
        data:x,
        axisLabel:{ color:"#6b7280", rotate:(x.length>10?25:0) }
      },
      yAxis: {
        type:"value",
        axisLabel:{ color:"#6b7280" },
        splitLine:{ show:true }
      },
      series: [{
        name:"BM20",
        type:"line",
        smooth:true,
        symbolSize:6,
        data:y
      }]
    }, true);

    chart.resize();
  }

  function setZoom(z){
    ZOOM = z;
    document.getElementById("z1m")?.classList.toggle("active", z==="1m");
    document.getElementById("z3m")?.classList.toggle("active", z==="3m");
    document.getElementById("z12m")?.classList.toggle("active", z==="12m");
    document.getElementById("zall")?.classList.toggle("active", z==="all");
    renderChart();
  }

  async function refresh(){
    const u = urls();

    const latest = await loadFirstOk(u.latestCandidates);
    const seriesRaw = await loadFirstOk(u.seriesCandidates);

    SERIES_ALL = normalizeSeries(seriesRaw);
    // --- series 기반으로 "직전 대비" 계산 (레벨 Δ%)
    const last = SERIES_ALL.length ? SERIES_ALL[SERIES_ALL.length - 1] : null;
    const prev = SERIES_ALL.length >= 2 ? SERIES_ALL[SERIES_ALL.length - 2] : null;
    
    const levelNow = (last && last.v) ? last.v : num(level);
    const levelPrev = prev ? prev.v : null;
    const levelDeltaPct = (levelPrev && levelPrev !== 0) ? ((levelNow - levelPrev) / levelPrev * 100) : null;
    
    // 기존 텍스트
    setText("kpiLevel", level===null ? "-" : fmtLevel(levelNow));
    setText("kpiLevelNote", "as of " + updated);
    
    // ✅ 큰 숫자 옆의 작은 변화(▲/▼)
    setDelta("kpiLevelDelta", levelDeltaPct);
    
    // returns(이미 latest에 있던 값)도 ▲/▼로 같이 표시
    setText("kpi1d",  fmtPct(r1d, 2));
    setText("kpi7d",  fmtPct(r7d, 2));
    setText("kpi30d", fmtPct(r30d, 2));
    setText("kpiYtd", fmtPct(rytd, 2));
    
    setDelta("kpi1dDelta",  r1d);
    setDelta("kpi7dDelta",  r7d);
    setDelta("kpi30dDelta", r30d);
    setDelta("kpiYtdDelta", rytd);


    
    // timestamps
    const updated =
      latest?.updated_at ||
      latest?.timestamp_label ||
      latest?.timestamp ||
      latest?.asof ||
      "-";

    // level/returns (유연 처리)
    const level = latest?.index_level ?? latest?.level ?? latest?.index ?? latest?.value ?? null;

    // returns: {r1d, r7d, r30d, rytd} or {returns:{...}} etc
    const R = latest?.returns || latest?.performance || latest || {};
    const r1d  = R.r1d  ?? R.ret_1d  ?? R.return_1d  ?? null;
    const r7d  = R.r7d  ?? R.ret_7d  ?? R.return_7d  ?? null;
    const r30d = R.r30d ?? R.ret_30d ?? R.return_30d ?? null;
    const rytd = R.rytd ?? R.ret_ytd ?? R.return_ytd ?? null;

    setText("metaUpdated", "UPDATED: " + updated);
    setText("metaLevel", "INDEX: " + (level===null ? "-" : fmtLevel(level)));

    setText("wChartMeta", "UPDATED: " + updated);
    setText("sourceUpdated", "UPDATED: " + updated);

    setText("kpiLevel", level===null ? "-" : fmtLevel(level));
    setText("kpiLevelNote", "as of " + updated);

    setText("kpi1d",  fmtPct(r1d, 2));
    setText("kpi7d",  fmtPct(r7d, 2));
    setText("kpi30d", fmtPct(r30d, 2));
    setText("kpiYtd", fmtPct(rytd, 2));

    setText("kpi1dNote",  "return");
    setText("kpi7dNote",  "return");
    setText("kpi30dNote", "return");
    setText("kpiYtdNote", "return");

    fillComponents(latest);
    renderChart();
  }

  (async function init(){
    try{
      chart = echarts.init(document.getElementById("bm20Chart"));

      document.getElementById("z1m")?.addEventListener("click", ()=>setZoom("1m"));
      document.getElementById("z3m")?.addEventListener("click", ()=>setZoom("3m"));
      document.getElementById("z12m")?.addEventListener("click", ()=>setZoom("12m"));
      document.getElementById("zall")?.addEventListener("click", ()=>setZoom("all"));

      await refresh();
      setInterval(refresh, 60*1000);

      window.addEventListener("resize", ()=> chart?.resize());
    }catch(err){
      console.error(err);
      alert("BM20 JSON 로딩 실패: /bm/out/history/bm20_latest.json, bm20_series.json 경로/배포를 확인하세요.");
    }
  })();
</script>

</body>
</html>
