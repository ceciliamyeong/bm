<!doctype html>
<html lang="ko">
<head>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="bm-baseurl" content="{{ site.baseurl }}">
  <title>BM20 Index — Latest</title>
  <style>
  :root{--bg:#0b1020;--card:#11172a;--muted:#8aa0b5;--text:#e8f0ff;--up:#2E7D32;--down:#C62828;--brand:#1A237E;--accent:#4c74f2;}
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Apple Color Emoji,Segoe UI Emoji}
  a{color:#aecdff;text-decoration:none}
  a:hover{text-decoration:underline}
  header{position:sticky;top:0;background:linear-gradient(180deg,rgba(17,23,42,.95),rgba(17,23,42,.75));backdrop-filter:saturate(1.2) blur(8px);z-index:10;border-bottom:1px solid #233}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .brand{display:flex;gap:10px;align-items:center}
  .brand .dot{width:12px;height:12px;border-radius:50%;background:var(--accent);box-shadow:0 0 18px var(--accent)}
  nav{display:flex;gap:18px;align-items:center}
  .rows{display:grid;grid-template-columns:1fr;gap:16px;margin-top:16px}
  @media (min-width:900px){.rows{grid-template-columns:2fr 1fr}}
  .card{background:var(--card);border:1px solid #26354a;border-radius:14px;padding:16px;box-shadow:0 8px 28px rgba(0,0,0,.3)}
  .cards{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  @media (min-width:700px){.cards{grid-template-columns:repeat(6,1fr)}}
  .stat{padding:12px;border:1px solid #2b3d59;border-radius:12px;background:rgba(22,28,48,.6)}
  .k{color:var(--muted);font-size:12px}
  .v{font-size:22px;font-weight:700}
  .delta.up{color:var(--up)} .delta.down{color:var(--down)}
  .flex{display:flex;gap:14px;align-items:center;justify-content:space-between}
  .h{font-weight:700;letter-spacing:.2px}
  .mini{font-size:12px;color:var(--muted)}
  .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid #2b3d59;border-radius:999px;padding:6px 10px;background:rgba(22,28,48,.6)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:700px){.grid2{grid-template-columns:1fr}}
  .section{margin-top:18px}
  .table-wrap{overflow:auto}
  .tbl{width:100%;border-collapse:collapse}
  .tbl th,.tbl td{border-bottom:1px solid #223449;padding:10px 8px;text-align:left}
  .tbl th{color:#a8bdd6;font-weight:600}
  .chart img,.chart canvas{display:block;width:100%;height:auto;object-fit:contain}
  .chart.aspect-16x9{aspect-ratio:16/9}
  .chart.aspect-4x3{aspect-ratio:4/3}
  .svgwrap{height:100%;width:100%;border-radius:12px;border:1px solid #2b3d59;background:rgba(22,28,48,.6);overflow:hidden}
  .svgwrap svg{width:100%;height:100%;display:block}
  footer{color:#92a7be;margin:40px 0 60px}
  .hide{display:none}
  .btn{border:1px solid #2b3d59;background:#121a2d;color:#cfe1ff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn:hover{filter:brightness(1.1)}
  .list{display:grid;gap:8px}
  .code{white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;background:#0c1326;border:1px solid #26354a;border-radius:10px;padding:12px;max-height:420px;overflow:auto}
  .charts{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
  .bm-wrap{max-width:1100px;margin:0 auto}
  .bm-grid{display:grid;grid-template-columns:3fr 2fr;gap:16px}
  .bm-card{background:linear-gradient(180deg,#11183a 0%,#0f152b 100%);border:1px solid rgba(255,255,255,.06);border-radius:18px;padding:18px;box-shadow:0 12px 30px rgba(0,0,0,.35)}
  .bm-title{font-size:20px;font-weight:800;margin-bottom:10px;color:#dfe5ff}
  .bm-head{font-size:22px;font-weight:900;margin:6px 0 10px}
  .bm-lead{font-size:16px;color:#d9e3ff;margin-bottom:10px}
  .bm-pill{display:inline-block;border:1px solid rgba(255,255,255,.14);padding:6px 10px;border-radius:999px;font-size:12px;color:#a7b0c0;margin-right:8px}
  .bm-kicker{color:#a7b0c0;font-size:12px;letter-spacing:.2px}
  .bm-bars{margin-top:8px}
  .bm-row{display:grid;grid-template-columns:50px 1fr 70px;align-items:center;gap:10px;margin:6px 0}
  .bm-shell{background:rgba(255,255,255,.08);height:18px;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,.08)}
  .bm-bar{height:100%;background:#2E7D32}
  .bm-pct{text-align:right;font-variant-numeric:tabular-nums;color:#e6f5ea;font-weight:700}
  .bm-ticker{font-weight:700;color:#e9edf7;text-align:center}
  .bm-legend{display:flex;gap:10px;margin-top:6px;color:#dfe5ff;font-size:12px}
  </style>
</head>

<body>
  <header>
    <div class="wrap flex">
      <div class="brand"><span class="dot"></span><div>
        <div style="font-weight:800">BM20 Index</div>
        <div class="mini">Blockmedia Large-Cap Crypto 20</div>
      </div></div>
      <nav>
        <a href="https://ceciliamyeong.github.io/bm/">Home</a>
        <a href="https://ceciliamyeong.github.io/bm/latest.html">Latest</a>
        <a href="https://ceciliamyeong.github.io/bm/indices/performance/">Charts</a>
        <a href="https://ceciliamyeong.github.io/bm/indices/">Data</a>
        <a href="https://ceciliamyeong.github.io/bm/what-is-bm20.html">About</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <!-- LATEST -->
    <section id="latest" class="card">
      <div class="flex">
        <div>
          <div class="h">오늘의 BM20</div>
          <div class="mini" id="asof">—</div>
        </div>
        <div class="pill"><span id="deltaBadge">—</span></div>
      </div>

      <div class="cards section">
        <div class="stat"><div class="k">지수 레벨</div><div class="v" id="level">—</div></div>
        <div class="stat"><div class="k">1D</div><div class="v" id="r1d">—</div></div>
        <div class="stat"><div class="k">7D</div><div class="v" id="r7d">—</div></div>
        <div class="stat"><div class="k">30D</div><div class="v" id="r30d">—</div></div>
        <div class="stat"><div class="k">1Y</div><div class="v" id="r1y">—</div></div>
        <div class="stat"><div class="k">YTD</div><div class="v" id="rytd">—</div></div>
      </div>

      <div class="grid2 section">
        <div>
          <div class="mini">김치 프리미엄</div>
          <div class="v" id="kimchi">—</div>
        </div>
        <div>
          <div class="mini">펀딩비(선물)</div>
          <div class="v" id="funding">—</div>
        </div>
      </div>

      <div class="section list mini">
        <div>빠른 링크: 
          <a id="lnkSeries" href="#" target="_blank">series.json</a> ·
          <a id="lnkLatest" href="#" target="_blank">bm20_latest.json</a> ·
          <a id="newsLink" class="hide" href="#" target="_blank">news</a>
        </div>
      </div>
    </section>

    <!-- CHARTS -->
    <section id="charts" class="rows">
      <div class="card">
        <div class="flex"><div class="h">BM20 시계열</div><button class="btn" id="btnZoom">범위: 1Y ▾</button></div>
        <div class="svgwrap" id="svgHost"><svg></svg></div>
        <div class="mini">※ bm20_series.json을 읽어 단순 라인 차트로 그립니다. 이미지가 있으면 아래에 표시합니다.</div>
      </div>
      <div class="card">
        <div class="h">이미지 차트(있을 경우만)</div>
        <div class="grid2 section">
          <div>
            <div class="mini">1D Performance Bar</div>
            <img id="imgBar" alt="1D Bar" style="max-width:100%;border:1px solid #2b3d59;border-radius:10px"/>
          </div>
        </div>
      </div>
    </section>

    <!-- PERF -->
    <section id="perf" class="card">
      <div class="h">글로벌 기여도 (1D, pp)</div>
      <div id="perfBar" style="height:320px;margin-top:8px"></div>
      <div class="mini" id="perfNote">※ <code>contrib_top.json</code> 기준. 1일 지수 기여도 절대값 상위 20 (단위: pp).</div>
    </section>

    <!-- DATA (debug toggle) -->
    <section id="data" class="rows section hide">
      <div class="card">
        <div class="flex"><div class="h">bm20_latest.json</div><button class="btn" id="btnToggleLatest">접기</button></div>
        <pre id="latestDump" class="code">—</pre>
      </div>
      <div class="card">
        <div class="flex"><div class="h">bm20_series.json (마지막 20행)</div><button class="btn" id="btnToggleSeries">접기</button></div>
        <pre id="seriesDump" class="code">—</pre>
      </div>
    </section>

    <!-- NEWS PREVIEW -->
    <section class="section">
      <div class="bm-wrap">
        <div class="bm-kicker">BM20 데일리 허브 · 프리뷰</div>
        <h2 class="h">뉴스 & 퍼포먼스</h2>
        <div class="bm-grid">
          <section class="bm-card">
            <div class="bm-title">코인별 기여도 (1D)</div>
            <div class="bm-bars" aria-label="1일 기여도 막대"></div>
          </section>
          <section class="bm-card">
            <div class="bm-title">BM20 데일리 뉴스</div>
            <div class="bm-head" id="newsHead">—</div>
            <div class="bm-lead" id="newsLead">—</div>
            <p class="mini" id="newsMeta" style="line-height:1.75;margin:6px 0 0;"></p>
            <div style="margin-top:10px;">
              <a id="newsOpen" class="btn hide" href="#" target="_blank">뉴스 전문 보기</a>
            </div>
          </section>
        </div>
      </div>
    </section>

    <section id="about" class="card section">
      <div class="h">What is BM20?</div>
      <p class="mini">글로벌 암호화폐 시장을 대표하는 대형 코인 20개로 구성한 블록미디어 고유 지수입니다. 한국 3대 거래소 상장 코인은 1.3× 보정 가중치를 적용하며, 분기 1회 정기 리밸런싱(1·4·7·10월)합니다. 지수 기준일은 2018-01-01(100)입니다.</p>
    </section>

    <footer class="mini">
      <div>© Blockmedia · Generated client-side from <code>bm20_latest.json</code> & <code>bm20_series.json</code>. 파일이 없으면 자동 폴백/숨김.</div>
    </footer>
  </main>

<!-- ========= SCRIPTS ========= -->
<script>
<script>
// ---------- 공통 유틸 (교체본) ----------
const qs = (s, el=document) => el.querySelector(s);
const fmtPct = v => (v==null||isNaN(v)) ? "—" : ((v>0?"+":"") + (Math.round(v*1000)/10).toFixed(1) + "%");
const fmtNum = v => (v==null||isNaN(v)) ? "—" : new Intl.NumberFormat('en-US',{maximumFractionDigits:2}).format(v);

// 1) PREFIX 자동 감지: Jekyll 미적용, 서브폴더(/bm/) 모두 대응
const PREFIX = (() => {
  const meta = document.querySelector('meta[name="bm-baseurl"]')?.content || '';
  if (meta && !meta.includes('{')) return meta.replace(/\/?$/, '/'); // Jekyll이 렌더된 경우
  const parts = location.pathname.split('/').filter(Boolean);
  if (location.hostname.endsWith('github.io') && parts.length) return '/' + parts[0] + '/'; // project pages → /repo/
  return '/'; // 그 외: 도메인 루트
})();

// 2) 경로 합성 헬퍼: 이미 절대경로(/로 시작)면 PREFIX 중복 방지
function withPrefix(path){
  if (/^https?:\/\//.test(path) || path.startsWith('/')) return path;
  return PREFIX + path;
}

// 3) 안전 fetch: 캐시 무력화 + 폴백 시도
async function tryFetch(path){
  const url = withPrefix(path) + (path.includes('?') ? '' : ('?v=' + Date.now()));
  try {
    const r = await fetch(url, { cache: 'no-store' });
    if (r.ok) return { url, json: await r.json() };
  } catch (e) {}
  return null;
}
async function fetchAny(paths){
  for (const p of paths){
    const res = await tryFetch(p);
    if (res) { console.log('[OK]', res.url); return res; }
    console.warn('[MISS]', withPrefix(p));
  }
  throw new Error('no json found');
}

// 4) 나머지 유틸
function setDeltaBadge(pct){ const el=qs('#deltaBadge'); if(pct==null||isNaN(pct)){ el.textContent='—'; el.className=''; return; } el.textContent=(pct>=0?'▲ ':'▼ ')+fmtPct(pct); el.className='delta '+(pct>=0?'up':'down'); }
function setImg(id, src){ const img=qs(id); if(!img) return; img.src=withPrefix(src); img.onerror=()=>img.closest('div')?.classList.add('hide'); }
function deepFind(obj, keys){ const st=[obj]; while(st.length){ const cur=st.pop(); if(cur && typeof cur==='object'){ for(const k of keys){ if(Object.prototype.hasOwnProperty.call(cur,k)){ let v=cur[k]; if(v&&typeof v==='object') v=v.premium??v.pct??v.value; return v; } } for(const v of Object.values(cur)) if(v&&typeof v==='object') st.push(v); } } return undefined; }
function formatFunding(f){ if(f==null) return '—'; if(typeof f==='number') return fmtPct(f); if(typeof f==='string') return f; if(typeof f==='object'){ const p=x=>(typeof x==='number')?fmtPct(x):(x??'—'); const btc=f.btc??f.BTC, eth=f.eth??f.ETH; return `BTC ${p(btc)}, ETH ${p(eth)}`; } return '—'; }
</script>

const fmtPct = v => (v==null||isNaN(v)) ? "—" : ((v>0?"+":"") + (Math.round(v*1000)/10).toFixed(1) + "%");
const fmtNum = v => (v==null||isNaN(v)) ? "—" : new Intl.NumberFormat('en-US',{maximumFractionDigits:2}).format(v);
async function tryFetch(path){
  try{ const url = PREFIX + path + '?v=' + Date.now(); const r = await fetch(url,{cache:'no-store'}); if(r.ok) return {url,json:await r.json()}; }catch(e){}
  return null;
}
async function fetchAny(paths){ for(const p of paths){ const res=await tryFetch(p); if(res) return res; } throw new Error('no json found'); }
function setDeltaBadge(pct){ const el=qs('#deltaBadge'); if(pct==null||isNaN(pct)){ el.textContent='—'; el.className=''; return; } el.textContent=(pct>=0?'▲ ':'▼ ')+fmtPct(pct); el.className='delta '+(pct>=0?'up':'down'); }
function setImg(id, src){ const img=qs(id); if(!img) return; img.src=src; img.onerror=()=>img.closest('div')?.classList.add('hide'); }
function deepFind(obj, keys){ const st=[obj]; while(st.length){ const cur=st.pop(); if(cur && typeof cur==='object'){ for(const k of keys){ if(Object.prototype.hasOwnProperty.call(cur,k)){ let v=cur[k]; if(v&&typeof v==='object') v=v.premium??v.pct??v.value; return v; } } for(const v of Object.values(cur)) if(v&&typeof v==='object') st.push(v); } } return undefined; }
function formatFunding(f){ if(f==null) return '—'; if(typeof f==='number') return fmtPct(f); if(typeof f==='string') return f; if(typeof f==='object'){ const p=x=>(typeof x==='number')?fmtPct(x):(x??'—'); const btc=f.btc??f.BTC, eth=f.eth??f.ETH; return `BTC ${p(btc)}, ETH ${p(eth)}`; } return '—'; }
</script>

<script>
// 최신 스냅샷 (bm20_latest.json 최우선)
async function loadLatest(){
  try{
    const {url, json:j} = await fetchAny([
      'bm20_latest.json','api/bm20_latest.json','bm/api/bm20_latest.json','bm/bm/api/bm20_latest.json',
      'latest.json','api/latest.json','bm/api/latest.json','bm/bm/api/latest.json'
    ]);

    // 링크 표시
    const lnkLatest = qs('#lnkLatest'); if (lnkLatest) lnkLatest.href = url;

    const asof = (j.asof||j.asOf||j.market_date||j.date||'').toString().slice(0,10);
    if (asof) qs('#asof').textContent = `기준: ${asof} (NY)`;

    const level = j.bm20Level ?? j.level ?? j.index ?? j.value;
    qs('#level').textContent = fmtNum(level);

    const R = j.returns || j.ret || {};
    const r1 = j.bm20ChangePct ?? R['1D'];
    qs('#r1d').textContent  = fmtPct(r1);
    qs('#r7d').textContent  = fmtPct(R['7D']);
    qs('#r30d').textContent = fmtPct(R['30D']);
    qs('#rytd').textContent = fmtPct(R['YTD']);
    qs('#r1y').textContent  = fmtPct(R['1Y']);
    setDeltaBadge(r1);

    // 김치/펀딩
    let kimchi = deepFind(j,['kimchi_premium','kimchi','krw_premium','kimchiPct','kimchiPremium']);
    if (typeof kimchi==='string') kimchi=parseFloat(kimchi);
    if (!Number.isFinite(kimchi)){
      const s = await fetchAny(['stats.json','api/stats.json','bm/api/stats.json','bm/bm/api/stats.json']).catch(()=>null);
      if (s){ kimchi = deepFind(s.json,['kimchi_premium','kimchi','krw_premium','kimchiPct','kimchiPremium']); if (typeof kimchi==='string') kimchi=parseFloat(kimchi); }
    }
    const funding = deepFind(j,['funding_rate','funding','funding_bps','fundingRate','funding_pct']);
    qs('#kimchi').textContent  = Number.isFinite(kimchi) ? fmtPct(Math.abs(kimchi)<=1?kimchi:kimchi/100) : '—';
    qs('#funding').textContent = formatFunding(funding);

    attachNewsLinkFromLatest({asof});
    qs('#latestDump').textContent = JSON.stringify(j,null,2);
  }catch(e){
    qs('#latestDump').textContent = 'bm20_latest.json을 불러오지 못했습니다.';
  }
}
</script>

<script>
// 시계열 (bm20_series.json 최우선)
async function loadSeries(){
  const host=qs('#svgHost'); const svg=qs('svg', host);
  try{
    const {url, json:arr} = await fetchAny([
      'bm20_series.json','api/bm20_series.json','bm/api/bm20_series.json','bm/bm/api/bm20_series.json',
      'series.json','api/series.json','bm/api/series.json','bm/bm/api/series.json'
    ]);
    const lnkSeries = qs('#lnkSeries'); if (lnkSeries) lnkSeries.href = url;

    const points = (Array.isArray(arr)?arr:[]).map(d=>({
      t:new Date((d.date||d.day||d.asof||d.asOf||d[0]||Date.now())),
      v:+((d.level||d.index||d.value||d.close||d.bm20Level||d[1]))
    })).filter(x=>isFinite(x.v)).sort((a,b)=>a.t-b.t);

    qs('#seriesDump').textContent = `${url}\n`+JSON.stringify(points.slice(-20),null,2);

    let mode=0;
    const compute=()=>{ if(mode===1){ const y0=new Date(new Date().getFullYear(),0,1); return points.filter(p=>p.t>=y0); }
                        if(mode===0){ const d=new Date(); d.setFullYear(d.getFullYear()-1); return points.filter(p=>p.t>=d); }
                        return points; };

    function draw(data){
      svg.innerHTML=''; const pad=24, W=svg.clientWidth||host.clientWidth, H=svg.clientHeight||host.clientHeight;
      const minX=+data[0].t,maxX=+data[data.length-1].t,minV=Math.min(...data.map(p=>p.v)),maxV=Math.max(...data.map(p=>p.v));
      const x=t=> pad+((t-minX)/(maxX-minX))*(W-2*pad), y=v=> H-pad-((v-minV)/(maxV-minV||1))*(H-2*pad);
      const axes=document.createElementNS('http://www.w3.org/2000/svg','path'); axes.setAttribute('d',`M${pad} ${pad}V${H-pad}H${W-pad}`); axes.setAttribute('stroke','#2b3d59'); axes.setAttribute('fill','none'); svg.appendChild(axes);
      const path=document.createElementNS('http://www.w3.org/2000/svg','path'); let d=''; data.forEach((p,i)=>{d+=(i?'L':'M')+x(+p.t)+' '+y(p.v)+' ';}); path.setAttribute('d',d.trim()); path.setAttribute('fill','none'); path.setAttribute('stroke',getComputedStyle(document.documentElement).getPropertyValue('--accent')); path.setAttribute('stroke-width','2'); svg.appendChild(path);
      const last=data[data.length-1]; const dot=document.createElementNS('http://www.w3.org/2000/svg','circle'); dot.setAttribute('cx',x(+last.t)); dot.setAttribute('cy',y(last.v)); dot.setAttribute('r','3.5'); dot.setAttribute('fill','white'); dot.setAttribute('stroke',getComputedStyle(document.documentElement).getPropertyValue('--accent')); svg.appendChild(dot);
    }
    const doDraw=()=>{ const d=compute(); if(d.length>1) draw(d); }; doDraw();
    qs('#btnZoom').addEventListener('click',()=>{ mode=(mode+1)%3; qs('#btnZoom').textContent=['범위: 1Y ▾','범위: YTD ▾','범위: ALL ▾'][mode]; doDraw(); });
  }catch(e){
    qs('#seriesDump').textContent='bm20_series.json을 불러오지 못했습니다.';
  }
}
</script>

<script>
// 퍼포먼스(기여도) — contrib_top.json 루트 우선
async function loadContrib(){
  const res = await fetchAny([
    'contrib_top.json','api/contrib_top.json','bm/api/contrib_top.json','bm/bm/api/contrib_top.json'
  ]).catch(()=>null);
  if (!res) return;
  const data = res.json;
  if (!data?.d1) return;

  const top = Array.isArray(data.d1.top) ? data.d1.top : [];
  const bottom = Array.isArray(data.d1.bottom) ? data.d1.bottom : [];

  const best3 = top.slice(0,3).map(r => (r.symbol||r.coin_id||'').toUpperCase()).join(' · ');
  const worst3 = bottom.slice(0,3).map(r => (r.symbol||r.coin_id||'').toUpperCase()).join(' · ');
  const bestEl = document.getElementById('best3'), worstEl = document.getElementById('worst3');
  if (bestEl) bestEl.textContent = best3 || '—';
  if (worstEl) worstEl.textContent = worst3 || '—';

  const rowsAbs = [...top, ...bottom]
    .filter(r => typeof r.contrib === 'number')
    .sort((a,b) => Math.abs(b.contrib) - Math.abs(a.contrib));
  const topN = rowsAbs.slice(0,12);
  const maxAbs = Math.max(...topN.map(r => Math.abs(r.contrib||0))) || 1;

  const host = document.querySelector('.bm-bars');
  if (host){
    host.innerHTML = topN.map(r=>{
      const sym = (r.symbol||r.coin_id||'').toUpperCase();
      const pp  = (r.contrib||0)*100;
      const w   = Math.max(2, Math.round(Math.abs(pp)/maxAbs*100));
      const neg = pp<0;
      return `
        <div class="bm-row">
          <div class="bm-ticker">${sym}</div>
          <div class="bm-shell"><div class="bm-bar" style="width:${w}%;${neg?'background:#C62828':''}"></div></div>
          <div class="bm-pct" style="${neg?'color:#ffd1d1':'color:#9ef3b4'}">${pp>=0?'+':''}${pp.toFixed(2)}pp</div>
        </div>`;
    }).join('');
  }

  const el = document.getElementById('perfBar');
  if (el && rowsAbs.length && window.echarts) {
    const top20 = rowsAbs.slice(0, 20);
    const chart = echarts.init(el);
    chart.setOption({
      grid: { left: 8, right: 12, top: 10, bottom: 20, containLabel: true },
      xAxis: { type: 'value', axisLabel: { formatter: v => v.toFixed(0) + 'pp' } },
      yAxis: { type: 'category', data: top20.map(r => (r.symbol||r.coin_id||'').toUpperCase()).reverse() },
      series: [{ type: 'bar', data: top20.map(r => +(((r.contrib||0)*100).toFixed(2))).reverse() }],
      tooltip: { trigger: 'axis', valueFormatter: v => v.toFixed(2) + 'pp' }
    });
    window.addEventListener('resize', () => chart.resize());
  }
  const note = document.getElementById('perfNote');
  if (note) note.innerHTML = '※ <code>contrib_top.json</code> 기준. 1일 지수 기여도 절대값 상위 20 (단위: pp).';
}
</script>

<script>
// 뉴스 링크 (bm/out/YYYY-MM-DD/…)
async function attachNewsLinkFromLatest({asof}){
  const a = document.getElementById('newsLink'); if (!a) return;
  const d = (asof||'').slice(0,10);
  const paths=[];
  if(d){
    paths.push(`bm/out/${d}/bm20_daily_${d}.html`);
    paths.push(`bm/out/${d}/bm20_daily_${d}.txt`);
    paths.push(`out/${d}/bm20_daily_${d}.html`);
    paths.push(`out/${d}/bm20_daily_${d}.txt`);
  }
  paths.push('latest.html');
  for(const p of paths){
    const r = await fetch(PREFIX + p + '?v=' + Date.now(), {method:'HEAD', cache:'no-store'}).catch(()=>null);
    if(r && r.ok){ a.href = PREFIX + p; a.classList.remove('hide'); return; }
  }
  a.classList.add('hide');
}
</script>

<script>
// 이미지 존재 시만 노출, 디버그 토글, 부팅
function tryImages(){ setImg('#imgBar','bm20_bar_latest.png'); }
document.getElementById('btnToggleLatest').addEventListener('click',()=>qs('#latestDump').classList.toggle('hide'));
document.getElementById('btnToggleSeries').addEventListener('click',()=>qs('#seriesDump').classList.toggle('hide'));
loadLatest(); loadSeries(); loadContrib(); tryImages();
</script>

</body>
</html>
