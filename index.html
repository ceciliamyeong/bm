<!doctype html>
<html lang="ko">
<head>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>BM20 Index — Latest</title>

  <style>
  :root{
    --bg:#ffffff;
    --card:#ffffff;

    --text:#111827;
    --muted:#6b7280;

    --border:#e5e7eb;
    --divider:#f1f5f9;

    --brand:#1A237E;
    --accent:#2563eb;

    --up:#2E7D32;
    --down:#C62828;

    --shadow:0 4px 14px rgba(0,0,0,.04);
  }

  *{box-sizing:border-box}
  html,body{
    margin:0;height:100%;
    background:var(--bg);
    color:var(--text);
    font:15px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Apple Color Emoji,Segoe UI Emoji;
  }

  a{color:var(--accent);text-decoration:none}
  a:hover{text-decoration:underline}

  header{
    position:sticky;top:0;background:#fff;z-index:10;
    border-bottom:1px solid var(--border);
  }

  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .flex{display:flex;gap:14px;align-items:center;justify-content:space-between}

  .brand{display:flex;gap:10px;align-items:center}
  .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--brand)}
  nav{display:flex;gap:18px;align-items:center;flex-wrap:wrap}

  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:14px;
    padding:16px;
    box-shadow:var(--shadow);
  }

  .section{margin-top:18px}
  .h{font-weight:800;letter-spacing:.2px}
  .mini{font-size:12px;color:var(--muted)}
  .hide{display:none}
  .list{display:grid;gap:8px}

  /* stats */
  .cards{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  @media (min-width:700px){.cards{grid-template-columns:repeat(6,1fr)}}

  .stat{
    padding:12px;
    border:1px solid var(--border);
    border-radius:12px;
    background:#fafafa;
  }
  .k{color:var(--muted);font-size:12px}
  .v{font-size:22px;font-weight:900}

  .delta.up{color:var(--up);font-weight:900}
  .delta.down{color:var(--down);font-weight:900}

  .pill{
    display:inline-flex;gap:8px;align-items:center;
    border:1px solid var(--border);
    border-radius:999px;
    padding:6px 10px;
    background:#f3f4f6;
  }

  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:700px){.grid2{grid-template-columns:1fr}}

  /* buttons / code */
  .btn{
    border:1px solid var(--border);
    background:#ffffff;
    color:var(--text);
    border-radius:10px;
    padding:8px 12px;
    cursor:pointer;
  }
  .btn:hover{background:#f9fafb}

  .code{
    white-space:pre-wrap;
    font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
    background:#f8fafc;
    border:1px solid var(--border);
    border-radius:10px;
    padding:12px;
    max-height:420px;
    overflow:auto;
  }

  /* charts area: 항상 1컬럼 + 메인 차트 크게 */
  .rows{display:grid;grid-template-columns:1fr;gap:16px;margin-top:16px}
  #charts.rows{grid-template-columns:1fr !important;}

  .svgwrap{
    width:100%;
    height:360px;              /* ✅ 데스크톱 메인 차트 크게 */
    border-radius:12px;
    border:1px solid var(--border);
    background:#ffffff;
    overflow:hidden;
  }
  @media (max-width:700px){
    .svgwrap{height:260px;}
  }
  .svgwrap svg{width:100%;height:100%;display:block}

  /* BM preview cards */
  .bm-wrap{max-width:1100px;margin:0 auto}
  .bm-grid{display:grid;grid-template-columns:3fr 2fr;gap:16px}
  @media (max-width:900px){.bm-grid{grid-template-columns:1fr}}

  .bm-card{
    background:#ffffff;
    border:1px solid var(--border);
    border-radius:14px;
    padding:18px;
    box-shadow:var(--shadow);
  }
  .bm-title{font-size:18px;font-weight:900;margin-bottom:10px;color:var(--text)}
  .bm-head{font-size:20px;font-weight:900;margin:6px 0 10px;color:var(--text)}
  .bm-lead{font-size:14px;color:var(--muted);margin-bottom:10px}
  .bm-kicker{color:var(--muted);font-size:12px;letter-spacing:.2px}
  .bm-bars{margin-top:8px}

  .bm-row{display:grid;grid-template-columns:56px 1fr 78px;align-items:center;gap:10px;margin:8px 0}
  .bm-shell{
    background:#f1f5f9;
    height:18px;border-radius:10px;overflow:hidden;
    border:1px solid var(--divider);
  }
  .bm-bar{height:100%;background:var(--up)}
  .bm-pct{text-align:right;font-variant-numeric:tabular-nums;color:var(--text);font-weight:900}
  .bm-ticker{font-weight:900;color:var(--text);text-align:center}

  footer{
    color:var(--muted);
    margin:40px 0 60px;
    border-top:1px solid var(--divider);
    padding-top:12px;
  }
  </style>
</head>

<body>
  <header>
    <div class="wrap flex">
      <div class="brand">
        <span class="dot"></span>
        <div>
          <div style="font-weight:900">BM20 Index</div>
          <div class="mini">Blockmedia Large-Cap Crypto 20</div>
        </div>
      </div>
      <nav>
        <a href="https://ceciliamyeong.github.io/bm/">Home</a>
        <a href="https://ceciliamyeong.github.io/bm/latest.html">Latest</a>
        <a href="https://ceciliamyeong.github.io/bm/performance.html">Charts</a>
        <a href="https://ceciliamyeong.github.io/bm/methodology.html">Data</a>
        <a href="https://ceciliamyeong.github.io/bm/what-is-bm20.html">About</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <!-- LATEST -->
    <section id="latest" class="card">
      <div class="flex">
        <div>
          <div class="h">오늘의 BM20</div>
          <div class="mini" id="asof">—</div>
        </div>
        <div class="pill"><span id="deltaBadge">—</span></div>
      </div>

      <div class="cards section">
        <div class="stat"><div class="k">지수 레벨</div><div class="v" id="level">—</div></div>
        <div class="stat"><div class="k">1D</div><div class="v" id="r1d">—</div></div>
        <div class="stat"><div class="k">7D</div><div class="v" id="r7d">—</div></div>
        <div class="stat"><div class="k">30D</div><div class="v" id="r30d">—</div></div>
        <div class="stat"><div class="k">1Y</div><div class="v" id="r1y">—</div></div>
        <div class="stat"><div class="k">YTD</div><div class="v" id="rytd">—</div></div>
      </div>

      <div class="grid2 section">
        <div>
          <div class="mini">김치 프리미엄</div>
          <div class="v" id="kimchi">—</div>
        </div>
        <div>
          <div class="mini">펀딩비(선물)</div>
          <div class="v" id="funding">—</div>
        </div>
      </div>

      <div class="section list mini">
        <div>빠른 링크:
          <a href="bm20_series.json" target="_blank">bm20_series.json</a> ·
          <a href="bm20_latest.json" target="_blank">bm20_latest.json</a> ·
          <a id="newsLink" class="hide" href="#" target="_blank">bm20_news.txt</a>
        </div>
      </div>
    </section>

    <!-- CHARTS (✅ 한 줄 꽉 / 이미지카드 제거) -->
    <section id="charts" class="rows section">
      <div class="card" style="padding:14px 14px 16px">
        <div class="flex">
          <div class="h">BM20 시계열</div>
          <button class="btn" id="btnZoom">범위: 1Y ▾</button>
        </div>
        <div class="svgwrap" id="svgHost"><svg></svg></div>
        <div class="mini">※ series.json을 읽어 단순 라인 차트로 그립니다.</div>
        <div class="mini" id="seriesStatus" style="margin-top:6px">—</div>
      </div>
    </section>

    <!-- 글로벌 퍼포먼스 -->
    <section id="perf" class="card section">
      <div class="h">글로벌 퍼포먼스 (1D, %)</div>
      <div id="perfBar" style="height:320px;margin-top:8px"></div>
      <div class="mini">※ <code>out/YYYY-MM-DD/bm20_daily_data_YYYY-MM-DD.csv</code> 기준.</div>
    </section>

   <!-- BM20 INTERPRETATION -->
<section class="card section">
  <div class="h">BM20 오늘의 해석</div>
  <p class="mini" style="line-height:1.8;margin-top:8px">
    BM20 지수는 전일 대비 <b id="bmTrend">—</b> 흐름을 보이며 시장 전반의 방향성을 반영했다.
    메이저 자산 중심의 움직임이 이어지는 가운데, 단기 레버리지 지표와 현물 프리미엄은
    과열 신호 없이 안정적인 구간을 유지하고 있다.
    <br><br>
    이는 현재 시장이 추세적 랠리보다는 가격 탐색 국면에 있음을 시사하며,
    단기 변동성보다는 종목별 차별화가 두드러지는 환경으로 해석된다.
  </p>
</section>

    <!-- 뉴스 카드 프리뷰 -->
    <section class="section">
      <div class="bm-wrap">
        <div class="bm-kicker">BM20 데일리 허브 · 프리뷰</div>
        <h2 class="h">뉴스 & 퍼포먼스</h2>

        <div class="bm-grid">
          <section class="bm-card">
            <div class="bm-title">코인별 퍼포먼스 (1D, USD)</div>
            <div class="bm-bars" aria-label="1일 수익률 막대"><!-- JS로 채움 --></div>
          </section>


    <section id="about" class="card section">
      <div class="h">What is BM20?</div>
      <p class="mini">글로벌 암호화폐 시장을 대표하는 대형 코인 20개로 구성한 블록미디어 고유 지수입니다. 한국 3대 거래소 상장 코인은 1.3× 보정 가중치, 분기 1회 정기 리밸런싱(1·4·7·10월). 지수 기준일 2018-01-01(100).</p>
    </section>

    <footer class="mini">
      <div>© Blockmedia · Generated client-side from <code>bm20_latest.json</code> & <code>bm20_series.json</code>.</div>
    </footer>
  </main>

<script>
// ===== 공통 유틸 =====
const qs = (s, el=document) => el.querySelector(s);
const fmtPct = v => (v===null||v===undefined||isNaN(v))?"—":(v>0?"+":"") + (Math.round(v*1000)/10).toFixed(1) + "%";
const fmtNum = v => (v===null||v===undefined||isNaN(v))?"—": new Intl.NumberFormat('en-US',{maximumFractionDigits:2}).format(v);
const findKey = (obj, candidates=[]) => { for (const k of candidates){ if (obj && Object.hasOwn(obj,k)) return obj[k]; } };
async function fetchAny(urls){
  for (const u of urls){
    try{
      const r=await fetch(u, {cache:'no-store'});
      if(r.ok) return {url:u,json:await r.json()};
    }catch(e){}
  }
  throw new Error('no json found');
}
function setDeltaBadge(pct){
  const el=qs('#deltaBadge');
  if(pct==null||isNaN(pct)){ el.textContent='데이터 없음'; return; }
  el.textContent=(pct>0?'▲ ':'▼ ')+fmtPct(pct);
  el.className='delta '+(pct>=0?'up':'down');
}
function formatFunding(f){
  if(f==null) return '—';
  if(typeof f==='number') return fmtPct(f);
  if(typeof f==='string') return f;
  if(typeof f==='object'){
    const btc=f.btc??f.BTC??f.Btc, eth=f.eth??f.ETH??f.Eth;
    const p=x=>(typeof x==='number')?fmtPct(x):(x??'—');
    return `BTC ${p(btc)}, ETH ${p(eth)}`;
  }
  return '—';
}

// ===== 김치/CSV 로더 유틸 =====
async function fetchJsonTry(u, tag=''){
  try{
    const r = await fetch(u+`?v=${Date.now()}`, {cache:'no-store'});
    if (r.ok) return await r.json();
  }catch(e){}
}
async function fetchTextTry(u, tag=''){
  try{
    const r = await fetch(u+`?v=${Date.now()}`, {cache:'no-store'});
    if (r.ok) return await r.text();
  }catch(e){}
}
function ymdFrom(asof, offsetDays=0){
  const t = asof ? new Date(asof) : new Date();
  if (offsetDays) t.setDate(t.getDate()+offsetDays);
  const y=t.getFullYear(), m=String(t.getMonth()+1).padStart(2,'0'), d=String(t.getDate()).padStart(2,'0');
  return `${y}-${m}-${d}`;
}
function extractKimchi(obj){
  if (obj==null) return null;
  if (typeof obj==='number') return obj;
  if (typeof obj==='string'){ const v=parseFloat(obj); return isFinite(v)?v:null; }
  let v = findKey(obj, ['kimchi','kimchi_premium_pct','premium','pct','value']);
  if (typeof v==='string') v=parseFloat(v);
  if (typeof v==='number'&&isFinite(v)) return v;
  if (v && typeof v==='object'){
    let vv = findKey(v, ['pct','value','premium']);
    if (typeof vv==='string') vv=parseFloat(vv);
    if (typeof vv==='number'&&isFinite(vv)) return vv;
  }
  return null;
}
async function getKimchiFromOut(asof){
  const dates = [ ymdFrom(asof,0), ymdFrom(null,0), ymdFrom(asof,-1) ];
  for (const d of dates){
    const url = `out/${d}/kimchi_${d}.json`;
    const j = await fetchJsonTry(url);
    const v = extractKimchi(j);
    if (v!=null) return v;
  }
  for (const d of dates){
    const url = `bm/out/${d}/kimchi_${d}.json`;
    const j = await fetchJsonTry(url);
    const v = extractKimchi(j);
    if (v!=null) return v;
  }
  return null;
}
async function loadPerfFromCSV(asof){
  const d = ymdFrom(asof);
  const main = `out/${d}/bm20_daily_data_${d}.csv`;
  const csv = await fetchTextTry(main);
  if (csv) return csv;
  return await fetchTextTry(`bm/out/${d}/bm20_daily_data_${d}.csv`);
}

// ===== 페이지 로드 =====
async function loadLatest(){
  try{
    const { json: j } = await fetchAny(['bm20_latest.json','latest.json','bm/bm20_latest.json','bm/latest.json']);

    const asof = j.asOf || j.as_of || j.date || j.day || '';
    if (asof) qs('#asof').textContent = `기준: ${asof}`;

    const level = j.bm20Level ?? j.level ?? j.index ?? j.value;
    qs('#level').textContent = fmtNum(level);

    const R = j.returns || {};
    const r1 = j.bm20ChangePct ?? R['1D'];
    qs('#r1d').textContent = fmtPct(r1);
    if (qs('#r7d'))  qs('#r7d').textContent  = fmtPct(R['7D']);
    if (qs('#r30d')) qs('#r30d').textContent = fmtPct(R['30D']);
    if (qs('#rytd')) qs('#rytd').textContent = fmtPct(R['YTD']);
    if (qs('#r1y'))  qs('#r1y').textContent  = fmtPct(R['1Y']);
    setDeltaBadge(r1);

    const funding = findKey(j, ['funding_rates','funding','funding_bps','fundingRate']);
    let kimchi = await getKimchiFromOut(asof);
    if (kimchi == null) {
      const kLatest = findKey(j, ['kimchi_2025','kimchi_premium_pct','kimchi_premium_latest']);
      kimchi = extractKimchi(kLatest);
    }
    qs('#kimchi').textContent  = kimchi!=null ? fmtPct(kimchi) : '—';
    qs('#funding').textContent = formatFunding(funding);

    const news = j.news_file || j.news_path || j.news;
    if (news && typeof news === 'string') {
      const a = qs('#newsLink'); a.href = news; a.classList.remove('hide');
    }

    qs('#latestDump').textContent = JSON.stringify(j, null, 2);
  } catch(e) {
    qs('#latestDump').textContent = 'latest.json을 불러오지 못했습니다.';
  }
}

async function loadSeries(){
  const host=qs('#svgHost');
  const svg=qs('svg', host);
  const statusEl = qs('#seriesStatus');

  try{
    const { url, json: arr } = await fetchAny(['bm20_series.json','series.json','bm/bm20_series.json','bm/series.json']);

    const points = arr.map(d=>({
        t:new Date((d.date||d.day||d.asof||d.asOf||d[0]||Date.now())),
        v:+((d.level||d.index||d.value||d.close||d.bm20Level||d[1]))
      }))
      .filter(x=>isFinite(x.v))
      .sort((a,b)=>a.t-b.t);

    statusEl.textContent = `series: ${url} · points: ${points.length}`;

    if (!points.length){
      svg.innerHTML = '';
      return;
    }

    let mode=0;
    const compute=()=>{
      if(mode===1){
        const y0=new Date(new Date().getFullYear(),0,1);
        return points.filter(p=>p.t>=y0);
      }
      if(mode===0){
        const d=new Date(); d.setFullYear(d.getFullYear()-1);
        return points.filter(p=>p.t>=d);
      }
      return points;
    };

    function draw(data){
      svg.innerHTML='';
      const pad=16; // ✅ 좌우 여백 줄임
      const W=svg.clientWidth||host.clientWidth;
      const H=svg.clientHeight||host.clientHeight;

      const minX=+data[0].t, maxX=+data[data.length-1].t;
      const minV=Math.min(...data.map(p=>p.v));
      const maxV=Math.max(...data.map(p=>p.v));

      const x=t=> pad+((t-minX)/(maxX-minX||1))*(W-2*pad);
      const y=v=> H-pad-((v-minV)/(maxV-minV||1))*(H-2*pad);

      const axes=document.createElementNS('http://www.w3.org/2000/svg','path');
      axes.setAttribute('d',`M${pad} ${pad}V${H-pad}H${W-pad}`);
      axes.setAttribute('stroke',getComputedStyle(document.documentElement).getPropertyValue('--border'));
      axes.setAttribute('stroke-width','1');
      axes.setAttribute('fill','none');
      svg.appendChild(axes);

      const path=document.createElementNS('http://www.w3.org/2000/svg','path');
      let d='';
      data.forEach((p,i)=>{ d+=(i?'L':'M')+x(+p.t)+' '+y(p.v)+' '; });
      path.setAttribute('d',d.trim());
      path.setAttribute('fill','none');
      path.setAttribute('stroke',getComputedStyle(document.documentElement).getPropertyValue('--accent'));
      path.setAttribute('stroke-width','2');
      svg.appendChild(path);

      const last=data[data.length-1];
      const dot=document.createElementNS('http://www.w3.org/2000/svg','circle');
      dot.setAttribute('cx',x(+last.t));
      dot.setAttribute('cy',y(last.v));
      dot.setAttribute('r','4');
      dot.setAttribute('fill','#ffffff');
      dot.setAttribute('stroke',getComputedStyle(document.documentElement).getPropertyValue('--accent'));
      svg.appendChild(dot);
    }

    const doDraw=()=>{ const d=compute(); if(d.length>1) draw(d); };
    doDraw();

    qs('#btnZoom').addEventListener('click',()=>{
      mode=(mode+1)%3;
      qs('#btnZoom').textContent=['범위: 1Y ▾','범위: YTD ▾','범위: ALL ▾'][mode];
      doDraw();
    });

  } catch(e){
    statusEl.textContent = 'series.json을 불러오지 못했습니다. (파일 경로/배포 경로 확인 필요)';
    qs('#seriesDump').textContent = String(e);
  }
}

// ===== 글로벌 퍼포먼스 (CSV 기반) =====
async function loadComponentsAndRenderBars(){
  let asof = null;
  try{
    const j = await (await fetch('bm20_latest.json', {cache:'no-store'})).json();
    asof = j.asOf || j.as_of || j.date || j.day || null;
  }catch(e){}

  const csv = await loadPerfFromCSV(asof);
  if (!csv) return;

  const [head, ...lines] = csv.trim().split(/\r?\n/);
  const keyIdx = Object.fromEntries(head.split(',').map((h,i)=>[h.trim(), i]));

  const rows = lines.map(line=>{
    const c = line.split(',').map(s=>s.trim());
    const pctRaw = parseFloat(c[keyIdx.price_change_pct]);
    const ret = isFinite(pctRaw) ? pctRaw / 100 : null;
    return {
      symbol: (c[keyIdx.symbol]||'').toUpperCase(),
      ret_1d: ret,
      contrib: parseFloat(c[keyIdx.contribution]||'')
    };
  }).filter(r=>r.symbol && r.ret_1d!=null);

  rows.sort((a,b)=>b.ret_1d - a.ret_1d);

  const bestEl = document.getElementById('best3');
  const worstEl = document.getElementById('worst3');
  if (bestEl) bestEl.textContent = rows.slice(0,3).map(r=>r.symbol).join(' · ') || '—';
  if (worstEl) worstEl.textContent = rows.slice(-3).reverse().map(r=>r.symbol).join(' · ') || '—';

  const host = document.querySelector('.bm-bars');
  if (host) {
    const topN = rows.slice(0, 12);
    const maxAbs = Math.max(...topN.map(r => Math.abs(r.ret_1d || 0))) || 1;

    host.innerHTML = topN.map(r => {
      const ratio = Math.abs(r.ret_1d) / maxAbs;
      const pct   = r.ret_1d * 100;
      const width = Math.max(2, Math.round(ratio * 100));

      const isUp = r.ret_1d >= 0;
      const hue = isUp ? 120 : 0;
      const light = 65 - Math.round(ratio * 30);
      const barColor = `hsl(${hue} 60% ${light}%)`;
      const textColor = isUp ? '#166534' : '#991b1b';

      return `
        <div class="bm-row">
          <div class="bm-ticker">${r.symbol}</div>
          <div class="bm-shell">
            <div class="bm-bar" style="width:${width}%; background:${barColor};"></div>
          </div>
          <div class="bm-pct" style="color:${textColor}">${pct>=0?'+':''}${pct.toFixed(2)}%</div>
        </div>
      `;
    }).join('');
  }

  const topN = rows.slice(0,20);
  const dom = document.getElementById('perfBar');
  if (!dom) return;

  const chart = echarts.init(dom, null, {renderer:'canvas'});
  chart.setOption({
    grid: {left: 8, right: 16, top: 20, bottom: 8, containLabel: true},
    tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' }, valueFormatter: v => (v>0?'+':'')+(v*100).toFixed(2)+'%' },
    xAxis: {
      type: 'value',
      axisLabel: { formatter: v => (v>0?'+':'')+(v*100).toFixed(0)+'%' },
      splitLine:{show:true, lineStyle:{color:'#e5e7eb'}}
    },
    yAxis: { type: 'category', data: topN.map(r=>r.symbol), axisTick:{show:false} },
    series: [{ type: 'bar', data: topN.map(r=>r.ret_1d), label:{show:true,position:'right',formatter:p=>(p.value>=0?'+':'')+(p.value*100).toFixed(2)+'%'} }],
    animation: true
  });

  window.addEventListener('resize', ()=> chart.resize());
}

// ===== 이벤트 바인딩 & 실행 =====
(function safeBindToggles(){
  const a = qs('#btnToggleLatest');
  const b = qs('#btnToggleSeries');
  if (a && qs('#latestDump')) a.addEventListener('click',()=>qs('#latestDump').classList.toggle('hide'));
  if (b && qs('#seriesDump')) b.addEventListener('click',()=>qs('#seriesDump').classList.toggle('hide'));
})();

loadLatest();
loadSeries();
loadComponentsAndRenderBars();
</script>
</body>
</html>

