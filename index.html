<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BM20 Index — Latest</title>
  <style>
    :root{--bg:#0b1020;--card:#11172a;--muted:#8aa0b5;--text:#e8f0ff;--up:#2E7D32;--down:#C62828;--brand:#1A237E;--accent:#4c74f2;}
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Apple Color Emoji,Segoe UI Emoji}
    a{color:#aecdff;text-decoration:none}
    a:hover{text-decoration:underline}
    header{position:sticky;top:0;background:linear-gradient(180deg,rgba(17,23,42,.95),rgba(17,23,42,.75));backdrop-filter:saturate(1.2) blur(8px);z-index:10;border-bottom:1px solid #233}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .brand{display:flex;gap:10px;align-items:center}
    .brand .dot{width:12px;height:12px;border-radius:50%;background:var(--accent);box-shadow:0 0 18px var(--accent)}
    nav{display:flex;gap:18px;align-items:center}
    .rows{display:grid;grid-template-columns:1fr;gap:16px;margin-top:16px}
    @media(min-width:900px){.rows{grid-template-columns:1.1fr .9fr}}
    .card{background:var(--card);border:1px solid #26354a;border-radius:14px;padding:16px;box-shadow:0 8px 28px rgba(0,0,0,.3)}
    .cards{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media(min-width:700px){.cards{grid-template-columns:repeat(6,1fr)}}
    .stat{padding:12px;border:1px solid #2b3d59;border-radius:12px;background:rgba(22,28,48,.6)}
    .k{color:var(--muted);font-size:12px}
    .v{font-size:22px;font-weight:700}
    .delta.up{color:var(--up)}
    .delta.down{color:var(--down)}
    .flex{display:flex;gap:14px;align-items:center;justify-content:space-between}
    .h{font-weight:700;letter-spacing:.2px}
    .mini{font-size:12px;color:var(--muted)}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid #2b3d59;border-radius:999px;padding:6px 10px;background:rgba(22,28,48,.6)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .section{margin-top:18px}
    .tbl{width:100%;border-collapse:collapse}
    .tbl th,.tbl td{border-bottom:1px solid #223449;padding:10px 8px;text-align:left}
    .tbl th{color:#a8bdd6;font-weight:600}
    .svgwrap{height:260px;width:100%;border-radius:12px;border:1px solid #2b3d59;background:rgba(22,28,48,.6);overflow:hidden}
    .svgwrap svg{width:100%;height:100%;display:block}
    footer{color:#92a7be;margin:40px 0 60px}
    .hide{display:none}
    .btn{border:1px solid #2b3d59;background:#121a2d;color:#cfe1ff;border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .list{display:grid;gap:8px}
    .code{white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;background:#0c1326;border:1px solid #26354a;border-radius:10px;padding:12px;max-height:420px;overflow:auto}
  </style>
</head>
<body>
  <header>
    <div class="wrap flex">
      <div class="brand"><span class="dot"></span><div>
        <div style="font-weight:800">BM20 Index</div>
        <div class="mini">Blockmedia Large‑Cap Crypto 20</div>
      </div></div>
      <nav>
        <a href="#latest">Latest</a>
        <a href="#charts">Charts</a>
        <a href="#data">Data</a>
        <a href="#about">About</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <!-- LATEST -->
    <section id="latest" class="card">
      <div class="flex">
        <div>
          <div class="h">오늘의 BM20</div>
          <div class="mini" id="asof">—</div>
        </div>
        <div class="pill"><span id="deltaBadge">—</span></div>
      </div>

      <div class="cards section">
        <div class="stat"><div class="k">지수 레벨</div><div class="v" id="level">—</div></div>
        <div class="stat"><div class="k">1D</div><div class="v" id="r1d">—</div></div>
        <div class="stat"><div class="k">7D</div><div class="v" id="r7d">—</div></div>
        <div class="stat"><div class="k">30D</div><div class="v" id="r30d">—</div></div>
        <div class="stat"><div class="k">MTD</div><div class="v" id="rmtd">—</div></div>
        <div class="stat"><div class="k">1Y</div><div class="v" id="r1y">—</div></div>
        <div class="stat"><div class="k">YTD</div><div class="v" id="rytd">—</div></div>
      </div>

      <div class="grid2 section">
        <div>
          <div class="mini">김치 프리미엄</div>
          <div class="v" id="kimchi">—</div>
        </div>
        <div>
          <div class="mini">펀딩비(선물)</div>
          <div class="v" id="funding">—</div>
        </div>
      </div>

      <div class="section list mini">
        <div>빠른 링크: 
          <a href="series.json" target="_blank">series.json</a> ·
          <a href="latest.json" target="_blank">latest.json</a> ·
          <a id="newsLink" class="hide" href="#" target="_blank">news.txt</a>
        </div>
      </div>
    </section>

    <!-- CHARTS -->
    <section id="charts" class="rows">
      <div class="card">
        <div class="flex"><div class="h">BM20 시계열</div><button class="btn" id="btnZoom">범위: 1Y ▾</button></div>
        <div class="svgwrap" id="svgHost"><svg></svg></div>
        <div class="mini">※ series.json을 읽어 단순 라인 차트로 그립니다. 이미지가 있으면 아래에 표시합니다.</div>
      </div>
      <div class="card">
        <div class="h">이미지 차트(있을 경우만)</div>
        <div class="grid2 section">
          <div>
            <div class="mini">1D Performance Bar</div>
            <img id="imgBar" alt="1D Bar" style="max-width:100%;border:1px solid #2b3d59;border-radius:10px"/>
          </div>
          <div>
            <div class="mini">BTC & ETH 7D Trend</div>
            <img id="imgTrend" alt="7D Trend" style="max-width:100%;border:1px solid #2b3d59;border-radius:10px"/>
          </div>
        </div>
      </div>
    </section>

    <!-- DATA / JSON VIEW -->
    <section id="data" class="rows section">
      <div class="card">
        <div class="flex"><div class="h">latest.json</div><button class="btn" id="btnToggleLatest">접기</button></div>
        <pre id="latestDump" class="code">—</pre>
      </div>
      <div class="card">
        <div class="flex"><div class="h">series.json (마지막 20행)</div><button class="btn" id="btnToggleSeries">접기</button></div>
        <pre id="seriesDump" class="code">—</pre>
      </div>
    </section>

    <!-- ABOUT -->
    <section id="about" class="card section">
      <div class="h">What is BM20?</div>
      <p class="mini">글로벌 암호화폐 시장을 대표하는 대형 코인 20개로 구성한 블록미디어 고유 지수입니다. 한국 3대 거래소(업비트·빗썸·코인원) 상장 코인은 1.3× 보정 가중치를 적용하며, 분기 1회 정기 리밸런싱(1·4·7·10월)합니다. 지수 기준일은 2018‑01‑01(100)이며, 포트폴리오 가치를 기준 가치로 나눠 산출합니다.</p>
      <ul class="mini">
        <li>코인 선정: 시가총액 상위 20종 (APT 제외, SUI 포함 가능)</li>
        <li>가중치 예시: BTC 30%, ETH 20%, XRP 5%, USDT 5%, BNB 5%, 나머지 15종에 균등 배분(총 35%)</li>
        <li>데이터 소스: 기본 코인게코, 이슈 시 야후 파이낸스 폴백</li>
        <li>활용: 일일 시황 코멘터리, 자동화 파이프라인, 향후 ETF/파생 벤치마크</li>
      </ul>
    </section>

    <footer class="mini">
      <div>© Blockmedia · Generated client‑side from <code>latest.json</code> & <code>series.json</code>. 이미지/뉴스 파일이 없으면 자동으로 숨겨집니다.</div>
    </footer>
  </main>

<script>
// -------- helpers --------
const qs = (s, el=document) => el.querySelector(s);
const fmtPct = v => (v===null||v===undefined||isNaN(v))?"—":(v>0?"+":"") + (Math.round(v*1000)/10).toFixed(1) + "%";
const fmtNum = v => (v===null||v===undefined||isNaN(v))?"—": new Intl.NumberFormat('en-US',{maximumFractionDigits:2}).format(v);
const findKey = (obj, candidates=[]) => {
  for (const k of candidates){ if (obj && Object.hasOwn(obj,k)) return obj[k]; }
  return undefined;
};

function setDeltaBadge(pct){
  const el = qs('#deltaBadge');
  if(pct===undefined||pct===null||isNaN(pct)){ el.textContent='데이터 없음'; return; }
  el.textContent = (pct>0? '▲ ':'▼ ') + fmtPct(pct);
  el.className = 'delta ' + (pct>=0? 'up':'down');
}

function setImg(id, src){
  const img = qs(id);
  img.src = src;
  img.onerror = () => img.closest('div').classList.add('hide');
}

// -------- load latest.json --------
function formatFunding(f){           // 펀딩 표시 예쁘게
  if (f==null) return '—';
  if (typeof f === 'number') return fmtPct(f);
  if (typeof f === 'string') return f;
  if (typeof f === 'object'){
    const btc = f.btc ?? f.BTC ?? f.Btc;
    const eth = f.eth ?? f.ETH ?? f.Eth;
    const p = x => (typeof x==='number') ? fmtPct(x) : (x ?? '—');
    return `BTC ${p(btc)}, ETH ${p(eth)}`;
  }
  return '—';
}

async function loadLatest(){
  try{
    // 여러 후보 경로 시도
    const cand = ['bm20_latest.json','bm/bm20_latest.json'];
    const j = await fetchAny(cand);

    // as-of date
    const asof = j.asOf || j.as_of || j.date || j.day || '';
    if(asof) qs('#asof').textContent = `기준: ${asof}`;

    // level
    const level = j.bm20Level ?? j.level ?? j.index ?? j.value;
    qs('#level').textContent = fmtNum(level);

    // returns
    const R = j.returns || {};
    let r1  = j.bm20ChangePct ?? R['1D'];
    const r7 = R['7D'], r30 = R['30D'], rMTD = R['MTD'], rYTD = R['YTD'], r1Y = R['1Y'];

    qs('#r1d').textContent  = fmtPct(r1);
    if (qs('#r7d'))  qs('#r7d').textContent  = fmtPct(r7);
    if (qs('#r30d')) qs('#r30d').textContent = fmtPct(r30);
    if (qs('#rmtd')) qs('#rmtd').textContent = fmtPct(rMTD);
    if (qs('#rytd')) qs('#rytd').textContent = fmtPct(rYTD);
    if (qs('#r1y'))  qs('#r1y').textContent  = fmtPct(r1Y);

    // 상승/하락 배지
    setDeltaBadge(r1);

    // extras
    const kimchi  = j.kimchi_premium ?? j.kimchi ?? j.krw_premium;
    const funding = j.funding_rate ?? j.fundingRate ?? j.funding;
    
    qs('#kimchi').textContent  = 
      (typeof kimchi==='number') ? fmtPct(kimchi) : (kimchi ?? '—');
    
    qs('#funding').textContent = formatFunding(funding);

    // news (optional)
    const news = j.news_file || j.news_path || j.news;
    if (news && typeof news === 'string'){
      const a = qs('#newsLink'); a.href = news; a.classList.remove('hide');
    } else {
      fetch('bm20_news_latest.txt').then(x=>{if(x.ok){const a=qs('#newsLink');a.href='bm20_news_latest.txt';a.classList.remove('hide');}});
    }

    // pretty dump
    qs('#latestDump').textContent = JSON.stringify(j,null,2);
  }catch(e){
    qs('#latestDump').textContent = 'latest.json을 불러오지 못했습니다.';
  }
}


// -------- load series.json + draw --------
async function loadSeries(){
  const host = qs('#svgHost');
  const svg = qs('svg', host);
  try{
    const cand = ['series.json','bm20_series.json','bm/series.json'];
    const {url, json:arr} = await fetchAny(cand);

    // Expect array of {date, level} or similar
    const points = arr.map(d=>({
      t: new Date(findKey(d,['date','day','asof','asOf'])||d[0]||Date.now()),
      v: +(findKey(d,['level','index','value','close','bm20Level']) ?? d.level ?? d[1])
    })).filter(x=>isFinite(x.v)).sort((a,b)=>a.t-b.t);

    // dump tail
    qs('#seriesDump').textContent = `${url}
` + JSON.stringify(points.slice(-20), null, 2);

    let domain = points;
    let mode = 0; // 1Y -> YTD -> ALL
    const computeDomain = () => {
      if (mode === 1){
        const y0 = new Date(new Date().getFullYear(),0,1);
        return points.filter(p=>p.t>=y0);
      } else if (mode === 0){
        const d = new Date(); d.setFullYear(d.getFullYear()-1);
        return points.filter(p=>p.t>=d);
      } else { return points; }
    };

    function draw(data){
      svg.innerHTML='';
      const pad=24, W=svg.clientWidth||host.clientWidth, H=svg.clientHeight||host.clientHeight;
      const minX = +data[0].t, maxX = +data[data.length-1].t;
      const minV = Math.min(...data.map(p=>p.v)), maxV = Math.max(...data.map(p=>p.v));
      const x = t=> pad + ( (t-minX)/(maxX-minX) ) * (W-2*pad);
      const y = v=> H-pad - ( (v-minV)/(maxV-minV||1) ) * (H-2*pad);
      const g = document.createElementNS('http://www.w3.org/2000/svg','g');
      const axes = document.createElementNS('http://www.w3.org/2000/svg','path');
      axes.setAttribute('d',`M${pad} ${pad}V${H-pad}H${W-pad}`);
      axes.setAttribute('stroke','#2b3d59'); axes.setAttribute('fill','none');
      g.appendChild(axes);
      const path = document.createElementNS('http://www.w3.org/2000/svg','path');
      let d = '';
      data.forEach((p,i)=>{ d += (i? 'L':'M') + x(+p.t) + ' ' + y(p.v) + ' '; });
      path.setAttribute('d', d.trim());
      path.setAttribute('fill','none');
      path.setAttribute('stroke', getComputedStyle(document.documentElement).getPropertyValue('--accent'));
      path.setAttribute('stroke-width','2');
      svg.appendChild(g); svg.appendChild(path);
      const last = data[data.length-1];
      const dot = document.createElementNS('http://www.w3.org/2000/svg','circle');
      dot.setAttribute('cx', x(+last.t)); dot.setAttribute('cy', y(last.v)); dot.setAttribute('r','3.5');
      dot.setAttribute('fill', 'white');
      dot.setAttribute('stroke', getComputedStyle(document.documentElement).getPropertyValue('--accent'));
      svg.appendChild(dot);
    }

    const doDraw = ()=>{ const d = computeDomain(); if(d.length>1) draw(d); };
    doDraw();
    qs('#btnZoom').addEventListener('click',()=>{ mode = (mode+1)%3; qs('#btnZoom').textContent = ['범위: 1Y ▾','범위: YTD ▾','범위: ALL ▾'][mode]; doDraw(); });

  }catch(e){
    qs('#seriesDump').textContent = 'series.json을 불러오지 못했습니다.';
  }
}

async function loadSeries(){
  const host = qs('#svgHost');
  const svg = qs('svg', host);
  try{
    const r = await fetch('series.json');
    if (!r.ok) throw new Error('no series.json');
    const arr = await r.json();

    // Expect array of {date, level} or similar
    const points = arr.map(d=>({
      t: new Date(findKey(d,['date','day','asof'])||d[0]||Date.now()),
      v: +(findKey(d,['level','index','value','close']) ?? d.level ?? d[1])
    })).filter(x=>isFinite(x.v)).sort((a,b)=>a.t-b.t);

    // dump tail
    qs('#seriesDump').textContent = JSON.stringify(points.slice(-20), null, 2);

    let domain = points;
    // simple zoom cycles: 1Y -> YTD -> ALL
    let mode = 0;
    const computeDomain = () => {
      if (mode === 1){
        // YTD
        const y0 = new Date(new Date().getFullYear(),0,1);
        return points.filter(p=>p.t>=y0);
      } else if (mode === 0){
        // 1Y
        const d = new Date(); d.setFullYear(d.getFullYear()-1);
        return points.filter(p=>p.t>=d);
      } else {
        return points;
      }
    };

    function draw(data){
      svg.innerHTML='';
      const pad=24, W=svg.clientWidth||host.clientWidth, H=svg.clientHeight||host.clientHeight;
      const minX = +data[0].t, maxX = +data[data.length-1].t;
      const minV = Math.min(...data.map(p=>p.v)), maxV = Math.max(...data.map(p=>p.v));
      const x = t=> pad + ( (t-minX)/(maxX-minX) ) * (W-2*pad);
      const y = v=> H-pad - ( (v-minV)/(maxV-minV||1) ) * (H-2*pad);

      // grid
      const g = document.createElementNS('http://www.w3.org/2000/svg','g');
      const axes = document.createElementNS('http://www.w3.org/2000/svg','path');
      axes.setAttribute('d',`M${pad} ${pad}V${H-pad}H${W-pad}`);
      axes.setAttribute('stroke','#2b3d59'); axes.setAttribute('fill','none');
      g.appendChild(axes);

      // path
      const path = document.createElementNS('http://www.w3.org/2000/svg','path');
      let d = '';
      data.forEach((p,i)=>{ d += (i? 'L':'M') + x(+p.t) + ' ' + y(p.v) + ' '; });
      path.setAttribute('d', d.trim());
      path.setAttribute('fill','none');
      path.setAttribute('stroke', getComputedStyle(document.documentElement).getPropertyValue('--accent'));
      path.setAttribute('stroke-width','2');
      svg.appendChild(g); svg.appendChild(path);

      // last dot
      const last = data[data.length-1];
      const dot = document.createElementNS('http://www.w3.org/2000/svg','circle');
      dot.setAttribute('cx', x(+last.t)); dot.setAttribute('cy', y(last.v)); dot.setAttribute('r','3.5');
      dot.setAttribute('fill', 'white');
      dot.setAttribute('stroke', getComputedStyle(document.documentElement).getPropertyValue('--accent'));
      svg.appendChild(dot);
    }

    const doDraw = ()=>{ domain = computeDomain(); if(domain.length>1) draw(domain); };
    doDraw();

    qs('#btnZoom').addEventListener('click',()=>{ mode = (mode+1)%3; qs('#btnZoom').textContent = ['범위: 1Y ▾','범위: YTD ▾','범위: ALL ▾'][mode]; doDraw(); });

  }catch(e){
    qs('#seriesDump').textContent = 'series.json을 불러오지 못했습니다.';
  }
}

// -------- images (optional, hide if missing) --------
function tryImages(){
  setImg('#imgBar','bm20_bar_latest.png');
  setImg('#imgTrend','bm20_trend_latest.png');
}

// -------- toggles --------
qs('#btnToggleLatest').addEventListener('click',()=>qs('#latestDump').classList.toggle('hide'));
qs('#btnToggleSeries').addEventListener('click',()=>qs('#seriesDump').classList.toggle('hide'));

// -------- init --------
loadLatest();
loadSeries();
tryImages();
</script>
</body>
</html>
