<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BM20 Index — Latest (Live)</title>
  <style>
    :root{--bg:#0b1020;--card:#11172a;--muted:#8aa0b5;--text:#e8f0ff;--up:#2E7D32;--down:#C62828;--accent:#4c74f2;}
    *{box-sizing:border-box} html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto}
    a{color:#aecdff;text-decoration:none} a:hover{text-decoration:underline}
    header{position:sticky;top:0;background:linear-gradient(180deg,rgba(17,23,42,.95),rgba(17,23,42,.75));backdrop-filter:saturate(1.2) blur(8px);z-index:10;border-bottom:1px solid #233}
    .wrap{max-width:1100px;margin:0 auto;padding:16px} .flex{display:flex;gap:14px;align-items:center;justify-content:space-between}
    .card{background:#11172a;border:1px solid #26354a;border-radius:14px;padding:16px;box-shadow:0 8px 28px rgba(0,0,0,.3)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px} .rows{display:grid;grid-template-columns:1fr;gap:16px;margin-top:16px}
    @media(min-width:900px){.rows{grid-template-columns:1.1fr .9fr}} .mini{font-size:12px;color:#8aa0b5} .h{font-weight:700}
    .stat{padding:12px;border:1px solid #2b3d59;border-radius:12px;background:rgba(22,28,48,.6)} .v{font-size:22px;font-weight:700}
    .delta.up{color:#2E7D32} .delta.down{color:#C62828} .btn{border:1px solid #2b3d59;background:#121a2d;color:#cfe1ff;border-radius:10px;padding:8px 12px;cursor:pointer}
    .code{white-space:pre-wrap;font-family:ui-monospace,Consolas,monospace;background:#0c1326;border:1px solid #26354a;border-radius:10px;padding:12px;max-height:420px;overflow:auto}
    /* BM20 카드 */
    .bm-grid{display:grid;grid-template-columns:3fr 2fr;gap:16px} .bm-card{background:linear-gradient(180deg,#11183a 0%,#0f152b 100%);border:1px solid rgba(255,255,255,.06);border-radius:18px;padding:18px;box-shadow:0 12px 30px rgba(0,0,0,.35)}
    .bm-title{font-size:20px;font-weight:800;margin-bottom:10px;color:#dfe5ff} .bm-head{font-size:22px;font-weight:900;margin:6px 0 10px} .bm-lead{font-size:16px;color:#d9e3ff;margin-bottom:10px}
    .bm-bars{margin-top:8px} .bm-row{display:grid;grid-template-columns:50px 1fr 70px;align-items:center;gap:10px;margin:6px 0} .bm-shell{background:rgba(255,255,255,.08);height:18px;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,.08)}
    .bm-bar{height:100%;background:#2E7D32} .bm-pct{text-align:right;font-variant-numeric:tabular-nums;color:#e6f5ea;font-weight:700} .bm-ticker{font-weight:700;color:#e9edf7;text-align:center}
    .svgwrap{height:260px;width:100%;border-radius:12px;border:1px solid #2b3d59;background:rgba(22,28,48,.6);overflow:hidden} .svgwrap svg{width:100%;height:100%;display:block}
    .warn{background:#241a1a;border:1px solid #5b2b2b;color:#f4d7d7;border-radius:10px;padding:10px;margin-top:8px;font-size:12px}
  </style>
</head>
<body>
  <header><div class="wrap flex"><div class="h">BM20 Index</div><nav class="mini"><a href="#data">Data</a></nav></div></header>
  <main class="wrap">
    <section class="card">
      <div class="flex"><div><div class="h">오늘의 BM20</div><div class="mini" id="asof">—</div></div><div class="mini"><span id="deltaBadge">—</span></div></div>
      <div class="grid2" style="margin-top:12px">
        <div class="stat"><div class="mini">지수 레벨</div><div class="v" id="level">—</div></div>
        <div class="stat"><div class="mini">1D</div><div class="v" id="r1d">—</div></div>
      </div>
    </section>

    <section class="rows">
      <div class="card">
        <div class="h">BM20 시계열</div>
        <div class="svgwrap" id="svgHost"><svg></svg></div>
      </div>
      <div class="card">
        <div class="h">뉴스 & 퍼포먼스</div>
        <div class="bm-grid" style="margin-top:10px">
          <section class="bm-card">
            <div class="bm-title">코인별 퍼포먼스 (1D)</div>
            <div class="bm-bars"></div>
          </section>
          <section class="bm-card">
            <div class="bm-title">BM20 데일리 뉴스</div>
            <div class="bm-head">—</div>
            <div class="bm-lead">—</div>
            <p class="mini" id="bmNewsSummary"></p>
            <div style="margin-top:10px" id="bmTopBottom"></div>
          </section>
        </div>
      </div>
    </section>

    <section id="data" class="rows" style="margin-top:16px">
      <div class="card"><div class="h">latest.json</div><pre id="latestDump" class="code">—</pre></div>
      <div class="card"><div class="h">series.json (마지막 20행)</div><pre id="seriesDump" class="code">—</pre></div>
    </section>
  </main>

<script>
const qs = (s, el=document) => el.querySelector(s);
const fmtPct = v => (v==null||isNaN(v))?"—":(v>0?"+":"")+(Math.round(v*1000)/10).toFixed(1)+"%";
const fmtNum = v => (v==null||isNaN(v))?"—": new Intl.NumberFormat('en-US',{maximumFractionDigits:2}).format(v);
async function fetchAny(urls){ for(const u of urls){ try{ const r=await fetch(u,{cache:'no-store'}); if(r.ok) return {url:u,json:await r.json()}; }catch(e){} } throw new Error('no json found'); }
function setDeltaBadge(p){ const el=qs('#deltaBadge'); el.textContent=(p>0?'▲ ':'▼ ')+fmtPct(p); el.className='delta '+(p>=0?'up':'down'); }

async function loadLatest(){
  const {url,json:j}=await fetchAny(['bm20_latest.json','latest.json','bm/bm20_latest.json','bm/latest.json']);
  const asof=j.asOf||j.as_of||j.date||j.day||''; if(asof) qs('#asof').textContent=`기준: ${asof}`;
  const level=j.bm20Level??j.level??j.index??j.value; qs('#level').textContent=fmtNum(level);
  const R=j.returns||{}; const r1=j.bm20ChangePct??R['1D']; qs('#r1d').textContent=fmtPct(r1); setDeltaBadge(r1);
  qs('#latestDump').textContent=JSON.stringify(j,null,2);

  // bars
  const bars=qs('.bm-bars'); bars.innerHTML='';
  const coins=(j.coins||[]).map(c=>({symbol:c.symbol||c.ticker||'?', change1d:+(c.change1d??c.pct_1d??0)}))
    .filter(c=>c.symbol && !isNaN(c.change1d)).sort((a,b)=>Math.abs(b.change1d)-Math.abs(a.change1d)).slice(0,12);
  coins.forEach(c=>{
    const width=Math.min(Math.abs(c.change1d*100),100), color=c.change1d>=0?'#2E7D32':'#C62828', pct=(c.change1d*100).toFixed(2)+'%';
    bars.insertAdjacentHTML('beforeend', `<div class="bm-row"><div class="bm-ticker">${c.symbol}</div><div class="bm-shell"><div class="bm-bar" style="width:${width}%;background:${color}"></div></div><div class="bm-pct" style="color:${color}">${c.change1d>=0?'+':''}${pct}</div></div>`);
  });

  // news
  const up=j.upCount??j.market_up, down=j.downCount??j.market_down;
  const nr=j.newsReport||{};
  qs('.bm-head').textContent = nr.headline || `BM20 ${fmtPct(r1)} ${r1>=0?'상승':'하락'}`;
  qs('.bm-lead').textContent = nr.lead || `${asof?asof+' ':''}BM20 지수는 전일 대비 ${fmtPct(r1)} ${r1>=0?'오르며':'내리며'} ${fmtNum(level)}pt.`;
  qs('#bmNewsSummary').textContent = nr.context || (up!=null&&down!=null?`상승 ${up} · 하락 ${down}.`:'');

  // top/bottom
  let best3=j.best3, worst3=j.worst3;
  if((!best3||!worst3) && j.coins){ const s=[...j.coins].sort((a,b)=>(b.change1d??0)-(a.change1d??0)); best3=s.slice(0,3).map(x=>x.symbol); worst3=s.slice(-3).map(x=>x.symbol); }
  const tb=qs('#bmTopBottom'); tb.innerHTML=''; 
  if(best3) tb.insertAdjacentHTML('beforeend', `<span class="mini" style="border:1px solid #2b3d59;border-radius:999px;padding:6px 10px;margin-right:6px;display:inline-block">Best 3: ${best3.join(' · ')}</span>`);
  if(worst3) tb.insertAdjacentHTML('beforeend', `<span class="mini" style="border:1px solid #2b3d59;border-radius:999px;padding:6px 10px;display:inline-block">Worst 3: ${worst3.join(' · ')}</span>`);
}

async function loadSeries(){
  const host=qs('#svgHost'); const svg=host.querySelector('svg');
  const {url,json:arr}=await fetchAny(['bm20_series.json','series.json','bm/bm20_series.json','bm/series.json']);
  const pts=arr.map(d=>({t:new Date(d.date||d.day||d.asOf||d.asof||d[0]), v:+(d.level||d.index||d.value||d.close||d[1])})).filter(p=>isFinite(p.v)).sort((a,b)=>a.t-b.t);
  qs('#seriesDump').textContent=`${url}\n`+JSON.stringify(pts.slice(-20),null,2);
  svg.innerHTML=''; const pad=24, W=svg.clientWidth||host.clientWidth, H=svg.clientHeight||host.clientHeight;
  const minX=+pts[0].t, maxX=+pts[pts.length-1].t, minV=Math.min(...pts.map(p=>p.v)), maxV=Math.max(...pts.map(p=>p.v));
  const x=t=>pad+((t-minX)/(maxX-minX))*(W-2*pad), y=v=>H-pad-((v-minV)/(maxV-minV||1))*(H-2*pad);
  const axes=document.createElementNS('http://www.w3.org/2000/svg','path'); axes.setAttribute('d',`M${pad} ${pad}V${H-pad}H${W-pad}`); axes.setAttribute('stroke','#2b3d59'); axes.setAttribute('fill','none'); svg.appendChild(axes);
  const path=document.createElementNS('http://www.w3.org/2000/svg','path'); let d=''; pts.forEach((p,i)=>{d+=(i?'L':'M')+x(+p.t)+' '+y(p.v)+' ';}); path.setAttribute('d',d.trim()); path.setAttribute('fill','none'); path.setAttribute('stroke',getComputedStyle(document.documentElement).getPropertyValue('--accent')); path.setAttribute('stroke-width','2'); svg.appendChild(path);
}
loadLatest(); loadSeries();
</script>
</body>
</html>
