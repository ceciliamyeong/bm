name: BM20 Daily (Yahoo, 2024-base)

on:
  schedule:
    - cron: "10 23 * * *"   # ë§¤ì¼ 08:10 KST (UTC 23:10)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Seoul
      OUT_DIR: out
      BM20_BASE_DATE: "2024-01-01"
      BM20_BASE_EXCLUDE_CONSISTENT: "0"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install requests pandas matplotlib python-dateutil reportlab yfinance

      - name: Install Korean fonts (Nanum + Noto CJK)
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-nanum fonts-noto-cjk fontconfig
          sudo fc-cache -f -v

      # í•„ìš” ì‹œ ê¸°ì¤€ì¼ ë°”ê¿€ ë•Œ ìºì‹œ ì´ˆê¸°í™” (ì˜µì…˜)
      - name: Reset base cache (optional)
        run: rm -f out/base_cache.json || true

      - name: Debug â€” find downCount
        run: |
          echo "Searching for downCount..."
          grep -n "{downCount}" bm20_daily.py || true
          grep -nE '\bdownCount\b' bm20_daily.py || true

      - name: Run BM20 daily
        run: |
          set -euo pipefail
          if [ ! -f bm20_daily.py ]; then
            echo "::error::bm20_daily.py not found at repo root."
            exit 1
          fi
          python bm20_daily.py

      # âœ… BM20 vs BTC/ETH ë¹„êµ ì§€ìˆ˜/ì°¨íŠ¸ ìƒì„±
      - name: Build BM20 vs BTC/ETH charts
        run: |
          set -euo pipefail
          python -m scripts.bm20_vs_bench

      # âœ… ê¹€ì¹˜/í€ë”© ì¶”ê°€
      - name: Enrich latest.json (kimchi & funding)
        run: |
          set -euo pipefail
          python augment_latest.py || echo "enrich failed; keep going"

      - name: Build contrib + perf (Yahoo)
        run: |
          set -euo pipefail
          python contrib_report.py \
            --map bm20_map_btc30.csv \
            --out-json bm/bm/api/contrib_top.json

          echo "---- after contrib ----"
          ls -l bm/bm/api || true
       
      - name: Normalize JSON filenames (BM20 canonical + aliases)
        run: |
          set -euo pipefail
          mkdir -p bm bm/api

          # ì†ŒìŠ¤ ì„ íƒ(bm/api ìš°ì„ , ê³¼ê±° ê²½ë¡œ í´ë°±)
          pick() { for f in "$@"; do [ -f "$f" ] && { echo "$f"; return; }; done; }
          LATEST_SRC=$(pick bm/api/latest.json site/bm20_latest.json site/latest.json latest.json bm20_latest.json)
          SERIES_SRC=$(pick bm/api/series.json site/bm20_series.json site/series.json series.json bm20_series.json)
          STATS_SRC=$(pick  bm/api/stats.json  site/bm20_stats.json  site/stats.json  stats.json  bm20_stats.json)

          # ì •ì‹ íŒŒì¼ëª… â†’ bm/bm20_*.json (ë©”ì¸ì´ ì´ê±¸ ì½ìŒ)
          [ -n "${LATEST_SRC:-}" ] && cp -f "$LATEST_SRC" bm/bm20_latest.json
          [ -n "${SERIES_SRC:-}" ] && cp -f "$SERIES_SRC" bm/bm20_series.json
          [ -n "${STATS_SRC:-}"  ] && cp -f "$STATS_SRC"  bm/bm20_stats.json

          # ë³„ì¹­(API) â†’ bm/api/*.json (ì™¸ë¶€/ë‹¤ë¥¸ ì†Œë¹„ììš©)
          [ -f bm/bm20_latest.json ] && cp -f bm/bm20_latest.json bm/api/latest.json
          [ -f bm/bm20_series.json ] && cp -f bm/bm20_series.json bm/api/series.json
          [ -f bm/bm20_stats.json  ] && cp -f bm/bm20_stats.json  bm/api/stats.json

          # í¼í¬ë¨¼ìŠ¤/ê¸°ì—¬ë„ë„ APIâ†’bm ë³„ì¹­ ì œê³µ
          for j in perf_up.json perf_down.json contrib_top.json; do
            [ -f "bm/api/$j" ] && cp -f "bm/api/$j" "bm/$j"
          done

          echo "Aliased:"
          ls -l bm/bm20_*.json bm/*.json bm/api/*.json || true



      - name: Prepare site artifacts to root/  # rootëŠ” í”„ë¦¬ë·°/ë³´ê¸°ìš©ë§Œ
        run: |
          set -euo pipefail

          SITE_SRC="."
          mkdir -p "$SITE_SRC"

          copy_if_present () {
            src="$1"; dest="$2"
            if [ -f "$src" ]; then
              cp -f "$src" "$SITE_SRC/$dest"
              echo "copied: $src -> $SITE_SRC/$dest"
            fi
          }

          # âœ… API í‘œì¤€ ìœ„ì¹˜: bm/api ì—ì„œ ë¨¼ì € ê°€ì ¸ì˜¤ê¸°
          copy_if_present bm/api/latest.json  latest.json
          copy_if_present bm/api/series.json  series.json
          copy_if_present bm/api/stats.json   stats.json
          copy_if_present bm/api/contrib_top.json contrib_top.json
          copy_if_present bm/api/perf_up.json    perf_up.json
          copy_if_present bm/api/perf_down.json  perf_down.json

          # (í´ë°±) ê³¼ê±° ê²½ë¡œë“¤ì—ì„œ ìˆìœ¼ë©´ë§Œ ë®ì–´ì“°ê¸°
          copy_if_present site/latest.json latest.json
          copy_if_present site/series.json series.json
          LATEST_IN_OUT=$(find out -maxdepth 2 -type f -name "latest.json" -o -name "bm20_latest.json" | sort | tail -n1 || true)
          [ -n "${LATEST_IN_OUT:-}" ] && copy_if_present "$LATEST_IN_OUT" latest.json

          SERIES_IN_OUT=$(find out -maxdepth 2 -type f -name "series.json" -o -name "bm20_index_history.json" -o -name "bm20_series.json" | sort | tail -n1 || true)
          [ -n "${SERIES_IN_OUT:-}" ] && copy_if_present "$SERIES_IN_OUT" series.json

          echo "---- present at repo root ----"
          ls -l latest.json series.json stats.json contrib_top.json perf_up.json perf_down.json || true


      - name: Debug â€” tree (top 2 levels)
        run: |
          echo "PWD=$(pwd)"
          find . -maxdepth 2 -type f | sort | sed -n '1,200p'

      - name: Publish latest.html (ë‰´ìŠ¤ë¦¬í¬íŠ¸)
        run: |
          set -euo pipefail
          python scripts/generate_report.py

      - name: Archive latest report
        run: |
          set -euo pipefail
          DATE=$(TZ=Asia/Seoul date +%F)

          # 1) latest.html ìŠ¤ëƒ…ìƒ· ë³´ê´€
          mkdir -p archive
          if [ -f latest.html ]; then
            cp -f latest.html "archive/${DATE}.html"
          fi

          # 2) (ì„ íƒ) ì°¨íŠ¸/CSVë„ ë‚ ì§œ í´ë”ë¡œ ë³´ê´€
          mkdir -p "archive/${DATE}"
          for f in bm20_btc_eth_line.png bm20_over_btc.png bm20_over_eth.png bm20_vs_bench.csv; do
            [ -f "$f" ] && cp -f "$f" "archive/${DATE}/" || true
          done

      
      - name: Ensure perf files exist
        run: |
          set -e
          test -f bm/bm/api/perf_up.json && test -f bm/bm/api/perf_down.json || \
          (echo "::error::perf_up/down.json not created"; exit 1)
      
      - name: Show git status (debug)
        run: |
          git status --porcelain
          echo "---- staged ----"
          git diff --cached --name-only || true



      - name: Commit & Push outputs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          DATE=$(TZ=Asia/Seoul date +%F)
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
          # ğŸŸ¢ ì•„ì¹´ì´ë¸Œ ì‚°ì¶œë¬¼ì„ í‘œì¤€ ì´ë¦„ìœ¼ë¡œ ë³µì‚¬ (latest.json ë“±)
          # JSON
          [ -f "bm/api/latest.json" ] && cp -f "bm/api/latest.json" latest.json
          [ -f "bm/api/series.json" ] && cp -f "bm/api/series.json" series.json
          [ -f "bm/api/contrib_top.json" ] && cp -f "bm/api/contrib_top.json" contrib_top.json
          [ -f "bm/api/perf_up.json" ] && cp -f "bm/api/perf_up.json" perf_up.json
          [ -f "bm/api/perf_down.json" ] && cp -f "bm/api/perf_down.json" perf_down.json
      
          # PNG (ì°¨íŠ¸ ì´ë¯¸ì§€)
          [ -f "bm/bm20_bar_latest.png" ] && cp -f "bm/bm20_bar_latest.png" bm20_bar_latest.png
          [ -f "bm/bm20_trend_latest.png" ] && cp -f "bm/bm20_trend_latest.png" bm20_trend_latest.png
      
          # HTML (ë¦¬í¬íŠ¸)
          [ -f "out/${DATE}/bm20_daily_${DATE}.html" ] && cp -f "out/${DATE}/bm20_daily_${DATE}.html" latest.html && cp -f latest.html bm/latest.html
      
          # ì´ì œ git add
          git add \
            bm/bm20_*.json bm/*.json bm/api/*.json \
            latest.json series.json contrib_top.json perf_up.json perf_down.json \
            bm20_vs_bench.csv \
            bm20_btc_eth_line.png bm20_over_btc.png bm20_over_eth.png \
            latest.html bm/latest.html \
            bm20_bar_latest.png bm20_trend_latest.png \
            "out/${DATE}" || true
      
          git add archive/*.html || true
          if [ -d "archive/${DATE}" ]; then
            git add "archive/${DATE}"/* || true
          fi
      
          git commit -m "BM20 daily: normalize filenames + aliases" || echo "No changes"
          git push
      


          git commit -m "BM20 daily: normalize filenames + aliases" || echo "No changes"
          git push

