name: BM20 Daily (dashboard minimal, 4h + daily snapshot)

on:
  schedule:
    - cron: "0 */4 * * *"   # UTC 기준 매 4시간 (KST: 09/13/17/21/01/05시)
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: bm20_daily-${{ github.ref }}
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Seoul

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Set DATE / OUT_DIR
        run: |
          DATE=$(TZ=Asia/Seoul date +%F)
          echo "DATE=${DATE}" >> "$GITHUB_ENV"
          echo "OUT_DIR=out" >> "$GITHUB_ENV"
          mkdir -p "out/${DATE}"

      - name: Set DAILY_SNAPSHOT flag (00:00 UTC only)
        run: |
          HOUR_UTC=$(date -u +%H)
          if [ "$HOUR_UTC" = "00" ]; then
            echo "DAILY_SNAPSHOT=1" >> "$GITHUB_ENV"
          else
            echo "DAILY_SNAPSHOT=0" >> "$GITHUB_ENV"
          fi
          echo "HOUR_UTC=${HOUR_UTC}" >> "$GITHUB_ENV"
          echo "DAILY_SNAPSHOT=${DAILY_SNAPSHOT}"

      # === 1) 데이터 생성 (항상 실행: intraday 포함) ===
      - name: Run BM20 daily
        run: python bm20_daily.py

      - name: Enrich (kimchi & funding)
        run: python augment_latest.py || true

      # === 2) intraday: 대시보드 고정 엔드포인트만 갱신 ===
      - name: Publish fixed JSON endpoints (intraday)
        run: |
          set -e
          mkdir -p bm

          # 파이썬이 루트에 최신 JSON을 만든 경우 -> 그대로 배포 엔드포인트로 갱신
          [ -f "bm20_latest.json" ] && cp -f "bm20_latest.json" "bm/bm20_latest.json"
          [ -f "bm20_series.json" ] && cp -f "bm20_series.json" "bm/bm20_series.json"

      # === 3) daily snapshot(UTC 00:00만): out/YYYY-MM-DD로 아카이브 + out/latest 갱신 ===
      - name: Collect minimal outputs into out/${{ env.DATE }} (daily snapshot)
        if: env.DAILY_SNAPSHOT == '1'
        run: |
          set -e
          D="out/${DATE}"
          mkdir -p "$D"

          # JSON 아카이브(날짜 붙여 저장)
          [ -f "bm20_latest.json" ] && cp -f "bm20_latest.json" "${D}/bm20_latest_${DATE}.json"
          [ -f "bm20_series.json" ] && cp -f "bm20_series.json" "${D}/bm20_series_${DATE}.json"

          # CSV (Top movers/heatmap 용) - 루트에 있을 때만
          [ -f "bm20_daily_data_${DATE}.csv" ] && cp -f "bm20_daily_data_${DATE}.csv" "${D}/"

          # News TXT (선택) - 루트에 있을 때만
          [ -f "bm20_news_${DATE}.txt" ] && cp -f "bm20_news_${DATE}.txt" "${D}/"

      - name: Update out/latest alias (daily snapshot)
        if: env.DAILY_SNAPSHOT == '1'
        run: |
          rm -rf out/latest
          cp -r "out/${DATE}" out/latest

      - name: Create fixed aliases in out/latest (daily snapshot)
        if: env.DAILY_SNAPSHOT == '1'
        run: |
          set -e
          DATE="${DATE}"

          # out/latest 안에 고정 alias 생성
          [ -f "out/latest/bm20_latest_${DATE}.json" ] && cp -f "out/latest/bm20_latest_${DATE}.json" "out/latest/bm20_latest.json"
          [ -f "out/latest/bm20_series_${DATE}.json" ] && cp -f "out/latest/bm20_series_${DATE}.json" "out/latest/bm20_series.json"

          # (옵션) 혹시 대시보드가 out/latest 고정 alias를 참고할 경우 대비
          [ -f "out/latest/bm20_latest.json" ] && cp -f "out/latest/bm20_latest.json" "bm/bm20_latest.json"
          [ -f "out/latest/bm20_series.json" ] && cp -f "out/latest/bm20_series.json" "bm/bm20_series.json"

      # === 4) Commit & Push ===
      - name: Commit & Push (intraday: bm only)
        if: env.DAILY_SNAPSHOT != '1'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          git config --global safe.directory "$GITHUB_WORKSPACE"
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add bm/ || true
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "BM20 intraday: update fixed endpoints (UTC ${HOUR_UTC})"

          BRANCH="${GITHUB_REF_NAME:-main}"
          git fetch origin "$BRANCH"
          git push origin "HEAD:${BRANCH}" --force-with-lease

      - name: Commit & Push (daily snapshot: out + bm)
        if: env.DAILY_SNAPSHOT == '1'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          git config --global safe.directory "$GITHUB_WORKSPACE"
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add out/ bm/ || true
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "BM20 daily snapshot: ${DATE} + update fixed endpoints"

          BRANCH="${GITHUB_REF_NAME:-main}"
          git fetch origin "$BRANCH"
          git push origin "HEAD:${BRANCH}" --force-with-lease
