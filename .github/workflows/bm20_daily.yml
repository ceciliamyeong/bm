name: BM20 Daily (Yahoo, 2024-base)

on:
  schedule:
    - cron: "10 23 * * *"   # 매일 08:10 KST (UTC 23:10)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Seoul
      OUT_DIR: out
      # ✅ 기준일: 코드가 os.getenv("BM20_BASE_DATE", "2024-01-01") 읽음
      BM20_BASE_DATE: "2024-01-01"
      # 옵션: 기준가에서 제외된 코인을 분자(당일/전일)에서도 제외하려면 "1"
      BM20_BASE_EXCLUDE_CONSISTENT: "0"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install requests pandas matplotlib reportlab

      - name: Install Korean fonts (Nanum + Noto CJK)
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-nanum fonts-noto-cjk fontconfig
          sudo fc-cache -f -v

      - name: Reset base cache (when bumping base date)
        run: rm -f out/base_cache.json

      # ⚠️ 레포 루트에 bm20_daily_2024base.py를 커밋해둔 가정
      - name: Run BM20 generator (Yahoo 2024-base)
        run: |
          set -euo pipefail
          python bm20_daily.py

      - name: Debug — where am I?
        run: |
          echo "PWD=$(pwd)"
          echo "Repo tree (top 2 levels):"
          find . -maxdepth 2 -type f | sort | sed -n '1,200p'
      
      - name: Reset base cache (when bumping base date)
        run: rm -f out/base_cache.json || true
      
      - name: Run BM20 generator (auto-pick script)
        env:
          OUT_DIR: out
          TZ: Asia/Seoul
          BM20_BASE_DATE: "2024-01-01"
          BM20_BASE_EXCLUDE_CONSISTENT: "0"
        shell: bash
        run: |
          set -euo pipefail
      
          # 1) 스크립트 후보 자동 탐색 (루트 기준)
          CANDIDATES=("bm20_daily.py" "bm20_daily_2024base.py" "scripts/bm20_daily.py" "src/bm20_daily.py")
          FOUND=""
          for p in "${CANDIDATES[@]}"; do
            if [ -f "$p" ]; then
              FOUND="$p"; break
            fi
          done
      
          if [ -z "$FOUND" ]; then
            echo "::error::bm20_daily 스크립트를 찾지 못했습니다. 리포 루트에 bm20_daily.py 를 커밋했는지 확인하세요."
            exit 1
          fi
      
          echo "[INFO] Running: python $FOUND"
          python "$FOUND"


      # 선택: 산출물 커밋 (site/**, out/** 중 최신 날짜)
      - name: Commit & Push outputs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          DATE=$(TZ=Asia/Seoul date +%F)
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A site out/${DATE}
          git commit -m "BM20 daily (base=${BM20_BASE_DATE}) ${DATE}" || echo "No changes"
          git push
