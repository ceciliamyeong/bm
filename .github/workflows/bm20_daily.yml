name: BM20 Daily (Yahoo, 2024-base)

on:
  schedule:
    - cron: "10 23 * * *"   # ë§¤ì¼ 08:10 KST (UTC 23:10)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Seoul
      OUT_DIR: out
      # âœ… ê¸°ì¤€ì¼: ì½”ë“œê°€ os.getenv("BM20_BASE_DATE", "2024-01-01") ì½ìŒ
      BM20_BASE_DATE: "2024-01-01"
      # ì˜µì…˜: ê¸°ì¤€ê°€ì—ì„œ ì œì™¸ëœ ì½”ì¸ì„ ë¶„ì(ë‹¹ì¼/ì „ì¼)ì—ì„œë„ ì œì™¸í•˜ë ¤ë©´ "1"
      BM20_BASE_EXCLUDE_CONSISTENT: "0"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ğŸ”’ ë ˆí¬ ë‚´ ë‚¨ì•„ìˆëŠ” '2024base' ë¬¸ìì—´ì„ ë°©ì§€ (ì›Œí¬í”Œë¡œ í˜¼ë™ ì°¨ë‹¨)
      - name: Guard â€” no leftover "2024base" refs
        run: |
          if grep -R "2024base" .github/workflows/ >/dev/null 2>&1; then
            echo "::error::Found forbidden string '2024base' in workflow files."
            grep -R --line-number "2024base" .github/workflows/ || true
            exit 1
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install requests pandas matplotlib python-dateutil reportlab

      - name: Install Korean fonts (Nanum + Noto CJK)
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-nanum fonts-noto-cjk fontconfig
          sudo fc-cache -f -v

      # í•„ìš” ì‹œ ê¸°ì¤€ì¼ ë°”ê¿€ ë•Œ ìºì‹œ ì´ˆê¸°í™” (ìˆ˜ë™ ì‹¤í–‰ ì‹œë§Œ ì¼œëŠ” ê±¸ ê¶Œì¥)
      # - name: Reset base cache (optional)
      #   run: rm -f out/base_cache.json || true

      - name: Run BM20 generator
        run: |
          set -euo pipefail
          if [ ! -f bm20_daily.py ]; then
            echo "::error::bm20_daily.py not found at repo root."
            echo "Tip: ì»¤ë°‹ ëˆ„ë½ ì—¬ë¶€ì™€ íŒŒì¼ ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”."
            exit 1
          fi
          python bm20_daily.py

      - name: Debug â€” tree (top 2 levels)
        run: |
          echo "PWD=$(pwd)"
          find . -maxdepth 2 -type f | sort | sed -n '1,200p'

      - name: Commit & Push outputs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          DATE=$(TZ=Asia/Seoul date +%F)
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A site out/${DATE}
          git commit -m "BM20 daily (base=${BM20_BASE_DATE}) ${DATE}" || echo "No changes"
          git pull --rebase
          git push
