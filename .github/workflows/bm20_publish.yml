name: BM20 Publish JSON to Pages

on:
  workflow_dispatch:
  schedule:
    - cron: "20 23 * * *"   # 매일 08:20 KST (23:20 UTC)

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # ← 최신 out/ 폴더 포함해 히스토리 가져오기

      - name: Debug — tree out/
        run: |
          echo "---- out/ tree ----"
          ls -R out || true

      - name: Copy latest output to docs/
        run: |
          set -euo pipefail
          SITE_SRC="docs"
          mkdir -p "$SITE_SRC"

          # YYYY-MM-DD 형태만 대상
          LAST_DIR=$(ls -d out/* 2>/dev/null | grep -E 'out/[0-9]{4}-[0-9]{2}-[0-9]{2}$' | sort -r | head -n 1 || true)
          if [ -z "${LAST_DIR:-}" ] || [ ! -d "$LAST_DIR" ]; then
            echo "::error::No dated directory found under out/"; exit 1
          fi
          echo "Found latest output dir: $LAST_DIR"

          copy_if_exists () { [ -f "$1" ] && cp "$1" "$SITE_SRC/$2" && echo "✓ $1 -> $SITE_SRC/$2" || echo "… missing: $1"; }

          copy_if_exists "$LAST_DIR/latest.json"            latest.json
          copy_if_exists "$LAST_DIR/bm20_latest.json"       latest.json
          copy_if_exists "$LAST_DIR/series.json"            series.json
          copy_if_exists "$LAST_DIR/bm20_series.json"       series.json
          copy_if_exists "$LAST_DIR/bm20_index_history.json" series.json
          copy_if_exists "$LAST_DIR/contrib_top.json"       contrib_top.json
          copy_if_exists "$LAST_DIR/bm20_contrib_top.json"  contrib_top.json

          for f in bm20_bar_latest.png bm20_trend_latest.png; do
            [ -f "$LAST_DIR/$f" ] && cp "$LAST_DIR/$f" "$SITE_SRC/$f" && echo "✓ $LAST_DIR/$f -> $SITE_SRC/$f"
          done

          echo "Published files in $SITE_SRC/:"
          ls -l "$SITE_SRC"/*.json || true

      - name: Commit & Push
        run: |
          set -euo pipefail
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add docs/
          git commit -m "Publish BM20 JSON to docs/" || echo "No changes"
          git push
