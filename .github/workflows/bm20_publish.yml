name: BM20 Publish JSON to Pages

on:
  workflow_dispatch:        # ìˆ˜ë™ ì‹¤í–‰
  schedule:
    - cron: "20 23 * * *"   # ë§¤ì¼ 08:20 KST (23:20 UTC)
  workflow_run:
    workflows: ["BM20 Daily (Yahoo, 2024-base)"]  # Daily ì´ë¦„ê³¼ ì •í™•ížˆ ì¼ì¹˜
    types: [completed]

permissions:
  contents: write
  actions: read   # â† ë‹¤ë¥¸ ì›Œí¬í”Œë¡œìš° ì•„í‹°íŒ©íŠ¸ ì½ê¸° ìœ„í•´ í•„ìš”

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ðŸ”½ Dailyì—ì„œ ì˜¬ë¦° ìµœì‹  ì•„í‹°íŒ©íŠ¸ë¥¼ ë°›ì•„ì„œ out/ì— í‘¼ë‹¤
      - name: Download latest bm20-out artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: bm20_daily.yml              # Daily íŒŒì¼ëª…ì´ ì´ê±°ë©´ ê·¸ëŒ€ë¡œ, ë‹¤ë¥´ë©´ íŒŒì¼ëª…ìœ¼ë¡œ êµì²´
          workflow_conclusion: success
          branch: main                          # ê¸°ë³¸ ë¸Œëžœì¹˜ê°€ mainì´ ì•„ë‹ ê²½ìš° êµì²´(ex: master)
          name: bm20-out                        # Dailyì—ì„œ ì—…ë¡œë“œí•œ ì•„í‹°íŒ©íŠ¸ ì´ë¦„ê³¼ ì¼ì¹˜í•´ì•¼ í•¨
          path: out                             # ë‹¤ìš´ë°›ì€ íŒŒì¼ì„ out/ë¡œ í’€ê¸°

      - name: Debug â€” tree out/
        run: |
          echo "---- out/ tree ----"
          ls -R out || true

      - name: Copy latest output to docs/
        run: |
          set -euo pipefail
          SITE_SRC="docs"
          mkdir -p "$SITE_SRC"

          # 'YYYY-MM-DD' í˜•íƒœì˜ ë‚ ì§œ ë””ë ‰í„°ë¦¬ë§Œ ëŒ€ìƒìœ¼ë¡œ
          LAST_DIR=$(ls -d out/* 2>/dev/null | grep -E 'out/[0-9]{4}-[0-9]{2}-[0-9]{2}$' | sort -r | head -n 1 || true)
          if [ -z "${LAST_DIR:-}" ] || [ ! -d "$LAST_DIR" ]; then
            echo "::error::No dated directory found under out/"; exit 1
          fi
          echo "Found latest output dir: $LAST_DIR"

          copy_if_exists () {
            SRC="$1"; DST="$2"
            if [ -f "$SRC" ]; then
              cp "$SRC" "$SITE_SRC/$DST"
              echo "âœ“ $SRC -> $SITE_SRC/$DST"
            else
              echo "â€¦ missing: $SRC"
            fi
          }

          # latest
          copy_if_exists "$LAST_DIR/latest.json" latest.json
          copy_if_exists "$LAST_DIR/bm20_latest.json" latest.json

          # series
          copy_if_exists "$LAST_DIR/series.json" series.json
          copy_if_exists "$LAST_DIR/bm20_series.json" series.json
          copy_if_exists "$LAST_DIR/bm20_index_history.json" series.json

          # contrib (ì˜µì…˜)
          copy_if_exists "$LAST_DIR/contrib_top.json" contrib_top.json
          copy_if_exists "$LAST_DIR/bm20_contrib_top.json" contrib_top.json

          # (ì˜µì…˜) ìµœì‹  PNG
          for f in bm20_bar_latest.png bm20_trend_latest.png; do
            if [ -f "$LAST_DIR/$f" ]; then
              cp "$LAST_DIR/$f" "$SITE_SRC/$f"
              echo "âœ“ $LAST_DIR/$f -> $SITE_SRC/$f"
            fi
          done

          echo "Published files in $SITE_SRC/:"
          ls -l "$SITE_SRC"/*.json || true

      - name: Commit & Push
        run: |
          set -euo pipefail
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add docs/
          git commit -m "Publish BM20 JSON to docs/" || echo "No changes"
          git push
