<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BM20 Lab — Real Data Demo</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
  <style>
    :root { --bg:#0b0f19; --card:#111827; --fg:#e5e7eb; --muted:#9ca3af; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    .wrap{max-width:1120px;margin:24px auto;padding:0 16px;}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    h1{margin:0 0 6px;font-size:22px}
    h2{margin:0 0 10px;font-size:16px;color:var(--muted);font-weight:600}
    .grid{height:420px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px;border-bottom:1px solid #1f2937}
    th{color:#9ca3af;text-align:left}
    .up{color:#34d399}.down{color:#f87171}
    .pill{display:inline-block;padding:.2rem .5rem;border-radius:999px;background:#1f2937;color:#d1d5db;font-size:.8rem}
    .meta{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
    a{color:#93c5fd;text-decoration:none}
    .toolbar{display:flex;gap:8px;align-items:center;margin:10px 0 0;flex-wrap:wrap}
    .input{background:#0f172a;border:1px solid #1f2937;border-radius:10px;padding:8px 10px;color:#e5e7eb;min-width:360px}
    .btn{background:#1f2937;border:1px solid #334155;border-radius:10px;color:#e5e7eb;padding:8px 12px;cursor:pointer}
    .btn:hover{filter:brightness(1.05)}
    .note{color:#9ca3af;font-size:12px;margin-top:6px}
    .err{color:#fca5a5}
  </style>
</head>
<body>
<div class="wrap">
  <h1>BM20 Lab <span class="pill">Real Data</span></h1>
  <div class="meta">
    <span id="asof" class="pill">기준: -</span>
    <a id="srcLink" target="_blank" rel="noopener">원본 JSON</a>
  </div>

  <div class="toolbar">
    <input id="endpoint" class="input" placeholder="JSON 엔드포인트 URL을 입력하세요" />
    <button id="load" class="btn">로드</button>
    <button id="save" class="btn">URL 저장</button>
    <span id="status" class="note"></span>
  </div>
  <div class="note">예: https://ceciliamyeong.github.io/bm/bm20_latest.json 또는 아카이브 JSON의 절대경로</div>

  <div class="row">
    <div class="card">
      <h2>1) 일간 성과 (BM20 구성)</h2>
      <div id="bar" class="grid"></div>
    </div>
    <div class="card">
      <h2>2) BTC / ETH 7D 추이</h2>
      <div id="trend" class="grid"></div>
    </div>
  </div>

  <div class="row">
    <div class="card" style="grid-column:1 / -1">
      <h2>3) Best 3 / Worst 3</h2>
      <table id="bw"><thead><tr>
        <th style="width:30%">자산</th><th style="width:20%">1D%</th><th>메모</th>
      </tr></thead><tbody></tbody></table>
    </div>
  </div>
</div>

<script>
const DEFAULT_CANDIDATES = [
  "https://ceciliamyeong.github.io/bm/bm20_latest.json",
  "https://ceciliamyeong.github.io/bm/bm/api/bm20_latest.json",
  "https://ceciliamyeong.github.io/bm/latest.json",
  "https://ceciliamyeong.github.io/bm/bm20_latest.json"
];

function $(id){ return document.getElementById(id); }
function setStatus(msg, ok=true){ const s=$('status'); s.textContent=msg; s.className = 'note' + (ok?'':' err'); }

async function fetchJSON(url){
  const res = await fetch(url + (url.includes('?') ? '' : '?v=' + Date.now()), {cache:'no-store'});
  if(!res.ok) throw new Error('HTTP ' + res.status);
  return await res.json();
}

async function fetchAny(urls){
  let lastErr;
  for (const u of urls){
    try{
      const j = await fetchJSON(u);
      return {url: u, json: j};
    }catch(e){ lastErr = e; }
  }
  throw lastErr || new Error('No JSON found from candidates');
}

function normalize(j){
  // asof
  const asof = j.asof || j.date || j.timestamp || null;

  // bar
  const barArr = (j.bar || j.components || j.assets || []).map(o=>({
    symbol: o.symbol || o.ticker || o.name || o.id || '?',
    pct_1d: Number(o.pct_1d ?? o.change_1d ?? o.d1 ?? o.pct ?? 0)
  }));

  // trend
  const tr = j.trend || j.lines || {};
  const dates = tr.dates || tr.labels || [];
  const btc = tr.btc || tr.BTC || tr.series?.BTC || tr.series?.btc || [];
  const eth = tr.eth || tr.ETH || tr.series?.ETH || tr.series?.eth || [];

  // top/bottom
  let top3 = j.top3 || [];
  let bottom3 = j.bottom3 || [];
  if ((!top3?.length || !bottom3?.length) && barArr.length){
    const sorted = [...barArr].sort((a,b)=>b.pct_1d - a.pct_1d);
    top3 = sorted.slice(0,3);
    bottom3 = sorted.slice(-3).reverse();
  }

  return { asof, barArr, trend:{dates, btc, eth}, top3, bottom3 };
}

function render({asof, barArr, trend, top3, bottom3}, srcUrl){
  $('asof').textContent = '기준: ' + (asof || '-');
  $('srcLink').href = srcUrl;

  // BAR
  const barEl = echarts.init($('bar'));
  barEl.setOption({
    backgroundColor: 'transparent',
    tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' },
      valueFormatter: v => (v>0?'+':'')+Number(v).toFixed(2)+'%' },
    grid: { left: 48, right: 24, top: 24, bottom: 36 },
    xAxis: { type:'category', data: barArr.map(o=>o.symbol),
      axisLine:{lineStyle:{color:'#374151'}}, axisLabel:{color:'#d1d5db'} },
    yAxis: { type:'value', axisLine:{lineStyle:{color:'#374151'}}, axisLabel:{color:'#9ca3af'}, splitLine:{lineStyle:{color:'#1f2937'}} },
    series: [{ type:'bar', data: barArr.map(o=>o.pct_1d), barMaxWidth:22 }]
  });

  // TREND
  const trendEl = echarts.init($('trend'));
  trendEl.setOption({
    backgroundColor: 'transparent',
    tooltip: { trigger: 'axis' },
    legend: { data:['BTC','ETH'], textStyle:{color:'#d1d5db'} },
    grid: { left: 48, right: 24, top: 36, bottom: 36 },
    xAxis: { type:'category', data: trend.dates, axisLine:{lineStyle:{color:'#374151'}}, axisLabel:{color:'#9ca3af'} },
    yAxis: { type:'value', axisLine:{lineStyle:{color:'#374151'}}, axisLabel:{color:'#9ca3af'}, splitLine:{lineStyle:{color:'#1f2937'}} },
    series: [
      { name:'BTC', type:'line', data: trend.btc, smooth:true },
      { name:'ETH', type:'line', data: trend.eth, smooth:true }
    ]
  });

  // BEST/WORST
  const tbody = document.querySelector('#bw tbody');
  tbody.innerHTML = '';
  [...top3.map(o=>({...o,_tag:'best'})), ...bottom3.map(o=>({...o,_tag:'worst'}))].forEach(o=>{
    const tr = document.createElement('tr');
    const val = Number(o.pct_1d||0);
    tr.innerHTML = `<td>${o.symbol}</td>
      <td class="${val>=0?'up':'down'}">${(val>0?'+':'')+val.toFixed(2)}%</td>
      <td>${o.note||''}</td>`;
    tbody.appendChild(tr);
  });

  // handle resize
  window.addEventListener('resize', () => { barEl.resize(); trendEl.resize(); }, { passive:true });
}

async function run(){
  try{
    setStatus('로딩 중…');
    const manual = $('endpoint').value?.trim();
    let result;
    if (manual){
      const j = await fetchJSON(manual);
      result = {url: manual, json: j};
    }else{
      result = await fetchAny(DEFAULT_CANDIDATES);
    }
    const data = normalize(result.json);
    render(data, result.url);
    setStatus('완료 ✓');
  }catch(e){
    console.error(e);
    setStatus('실패: ' + (e?.message||e), false);
    alert('데이터 로드 실패: ' + (e?.message||e));
  }
}

(function init(){
  // restore saved url
  const saved = localStorage.getItem('bm20_lab_url');
  if (saved) $('endpoint').value = saved;
  $('load').addEventListener('click', run);
  $('save').addEventListener('click', ()=>{
    const v = $('endpoint').value.trim();
    if (v){ localStorage.setItem('bm20_lab_url', v); setStatus('URL 저장됨 ✓'); }
  });
  // auto-run first time
  run();
})();
</script>
</body>
</html>
