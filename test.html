<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KRW Rolling 24h Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>

  <style>
    :root{
      --bg:#f8fafc; --panel:#ffffff; --border:#e5e7eb; --text:#0f172a; --muted:#64748b;
      --shadow:0 1px 2px rgba(15,23,42,.06); --radius:14px;
      --accent:#2563eb; --accent-2:#7c3aed;
      --sidebar:#0b1220; --sidebarText:#e2e8f0; --sidebarMuted:#94a3b8;
      --chip:#f1f5f9;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif; }
    .app{ display:grid; grid-template-columns: 260px 1fr; min-height:100vh; }
    @media (max-width: 980px){ .app{ grid-template-columns: 1fr; } }

    .sidebar{ background:var(--sidebar); padding:18px 14px; position:sticky; top:0; height:100vh; overflow:auto; border-right:1px solid rgba(255,255,255,.06); }
    @media (max-width: 980px){ .sidebar{ position:relative; height:auto; } }

    .brand{ display:flex; align-items:center; gap:10px; padding:10px 10px 14px; border-bottom:1px solid rgba(255,255,255,.08); margin-bottom:14px; }
    .logo{ width:32px; height:32px; border-radius:10px; background:linear-gradient(135deg, var(--accent), var(--accent-2)); box-shadow:0 6px 18px rgba(37,99,235,.25); }
    .brand h1{ margin:0; font-size:14px; color:var(--sidebarText); letter-spacing:-0.2px; }
    .brand p{ margin:2px 0 0; font-size:12px; color:var(--sidebarMuted); }

    .navsec{ margin:14px 0; }
    .navtitle{ font-size:11px; letter-spacing:.08em; text-transform:uppercase; color:rgba(226,232,240,.7); padding:0 10px; margin:0 0 8px; }
    .nav a{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 10px; border-radius:10px; color:var(--sidebarText); text-decoration:none; font-size:13px; transition: background .15s ease; }
    .nav a:hover{ background:rgba(255,255,255,.06); }
    .nav a .tag{ font-size:11px; color:var(--sidebarMuted); background:rgba(255,255,255,.06); padding:2px 8px; border-radius:999px; white-space:nowrap; }

    .main{ padding:18px 18px 34px; }
    .topbar{ display:flex; align-items:flex-end; justify-content:space-between; gap:14px; flex-wrap:wrap; margin-bottom:14px; }
    .topbar .title h2{ margin:0; font-size:20px; letter-spacing:-0.3px; }
    .topbar .title p{ margin:6px 0 0; font-size:13px; color:var(--muted); max-width:820px; line-height:1.45; }
    .topbar .meta{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
    .chip{ background:var(--chip); border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:12px; color:#334155; white-space:nowrap; }

    .panel{ background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); }
    
    /* KPI Grid Responsive - 6열 / 2열 / 1열 */
    .kpiGrid{ display:grid; grid-template-columns: 1fr; gap:12px; margin-bottom:14px; }
    @media (min-width: 768px){ .kpiGrid{ grid-template-columns: repeat(2, 1fr); } }
    @media (min-width: 1200px){ .kpiGrid{ grid-template-columns: repeat(6, 1fr); } }
    
    .kpi{ padding:12px 12px; min-width:0; }
    .kpi .label{ color:var(--muted); font-size:12px; margin:0 0 6px; }
    .kpi .value{ font-size:20px; font-weight:800; letter-spacing:-0.3px; margin:0; }
    .kpi .note{ color:var(--muted); font-size:12px; margin-top:6px; }

    .section{ margin-top:16px; }
    .sectionHead{ display:flex; align-items:flex-end; justify-content:space-between; gap:12px; flex-wrap:wrap; margin:0 0 10px; }
    .sectionHead h3{ margin:0; font-size:14px; letter-spacing:-0.2px; }
    .widgets{ display:grid; grid-template-columns: 1fr; gap:12px; }
    @media (min-width: 1100px){ .widgets{ grid-template-columns: repeat(2, 1fr); } }

    .widget{ padding:12px; min-width:0; }
    .widgetHead{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom:10px; }
    .wTitle{ display:flex; gap:10px; align-items:flex-start; }
    .wIcon{ width:28px; height:28px; border-radius:10px; background:#eef2ff; border:1px solid #e0e7ff; display:flex; align-items:center; justify-content:center; color:#3730a3; font-weight:800; font-size:12px; flex:0 0 auto; }
    .wTitle h4{ margin:0; font-size:13px; letter-spacing:-0.2px; }
    .wMeta{ text-align:right; color:var(--muted); font-size:11px; white-space:nowrap; }

    .chart{ width:100%; height:320px; }
    #totalChart{ height:360px; } #treemap{ height:360px; } #stableChart{ height:220px; }

    .toolbar{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .btn{ border:1px solid var(--border); background:#fff; color:#334155; padding:6px 10px; border-radius:999px; font-size:12px; cursor:pointer; }
    .btn.active{ border-color:#0f172a; color:#0f172a; font-weight:800; }

    .list{ margin:0; padding:0; list-style:none; }
    .list li{ display:flex; justify-content:space-between; gap:10px; padding:9px 2px; border-top:1px solid var(--border); font-size:12.5px; color:#0f172a; }
    .list li:first-child{ border-top:none; }
    .pill{ font-size:11px; color:#334155; background:var(--chip); border:1px solid var(--border); padding:3px 8px; border-radius:999px; white-space:nowrap; }
    .footnote{ margin-top:10px; font-size:12px; color:var(--muted); }

    .footerDisclaimer{ margin-top:24px; background:#ffffff; border:1px solid #e5e7eb; border-radius:16px; padding:16px; display:flex; gap:12px; align-items:flex-start; }
    .footerDisclaimer .icon{ width:34px; height:34px; border-radius:12px; background:#eef2ff; border:1px solid #e0e7ff; display:flex; align-items:center; justify-content:center; font-weight:700; }
    .footerDisclaimer .title{ margin:0; font-size:14px; font-weight:700; }
    .footerDisclaimer .body{ margin:10px 0 0; font-size:13px; line-height:1.55; color:#475569; }
  </style>
</head>

<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand"><div class="logo"></div><div><h1>KRW Market Board</h1><p>Rolling 24h · 8h snapshot</p></div></div>
    <div class="navsec">
      <div class="navtitle">Markets</div>
      <nav class="nav">
        <a href="#sec-overview">Overview <span class="tag">KRW</span></a>
        <a href="#sec-flows">Flows & Share <span class="tag">EX</span></a>
        <a href="#sec-concentration">Concentration <span class="tag">Top10</span></a>
        <a href="#sec-stables">Stablecoins <span class="tag">K-Safety</span></a>
      </nav>
    </div>
    <div class="navsec">
      <div class="navtitle">K-Intelligence</div>
      <nav class="nav">
        <a href="#sec-topcoins">Top Coins <span class="tag">Heat</span></a>
        <a href="#sec-extop">Exchange Top5 <span class="tag">Up/BT/CO</span></a>
        <a href="#sec-kimchi">Smart Kimchi <span class="tag">Premium</span></a>
      </nav>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="title"><h2>KRW Rolling 24h Dashboard</h2><p>“최근 24시간(rolling) 거래대금”을 주기적으로 갱신하여 한국 시장 현황을 확인합니다.</p></div>
      <div class="meta"><span class="chip" id="metaUpdated">UPDATED: -</span><span class="chip" id="metaSignal">SIGNAL: -</span></div>
    </div>

    <section id="sec-overview" class="kpiGrid">
      <div class="panel kpi"><p class="label">총 거래대금(rolling 24h)</p><p class="value" id="kpiTotal">-</p><div class="note" id="kpiTs">-</div></div>
      <div class="panel kpi"><p class="label">Top10 집중도(%)</p><p class="value" id="kpiTop10">-</p><div class="note" id="kpiTop10Note">-</div></div>
      <div class="panel kpi"><p class="label">거래소 비중(%)</p><p class="value" id="kpiEx">-</p><div class="note" id="kpiExNote">-</div></div>
      <div class="panel kpi" style="border-color:#bfdbfe;"><p class="label" style="color:#1d4ed8;">K-Safety (스테이블)</p><p class="value" id="kpiStable">-</p><div class="note" id="kpiStableNote">-</div></div>
      
      <div class="panel kpi" style="border-color:#bfdbfe; background:#f0f9ff;">
        <p class="label" style="color:#1d4ed8; font-weight:700;">글로벌 점유율 (K-Share)</p>
        <div id="kShareMiniChart" style="width:100%; height:70px; margin: 5px 0;"></div>
        <p class="value" id="kpiKShare" style="font-size:24px; font-weight:900;">-</p>
      </div>
      
      <div class="panel kpi" style="border-color:#fecaca; background:#fffafb;">
        <p class="label" style="color:#be123c; font-weight:700;">글로벌 시장 심리</p>
        <div id="fngGauge" style="width:100%; height:80px; margin-top: 5px;"></div>
        <p id="fngStatus" style="font-weight:900; font-size:16px; margin-top:-5px; text-align:center;">-</p>
      </div>
    </section>

    <section class="section" id="sec-flows">
      <div class="sectionHead">
        <div><h3>Flow</h3><p>총 거래대금 수준 및 직전 대비 변화를 봅니다.</p>
          <div class="toolbar"><button class="btn" id="btn1d">1D</button><button class="btn active" id="btn3d">3D</button><button class="btn" id="btn7d">7D</button></div>
        </div>
      </div>
      <div class="panel widget">
        <div class="widgetHead"><div class="wTitle"><div class="wIcon">Σ</div><div><h4>총 거래대금 추이 (Rolling 24h)</h4></div></div></div>
        <div id="totalChart" class="chart"></div>
      </div>
      <div class="widgets" style="margin-top:12px;">
        <div class="panel widget"><div id="shareChart" class="chart"></div></div>
        <div class="panel widget"><div id="topRestChart" class="chart"></div></div>
      </div>
    </section>

    <section class="section" id="sec-topcoins">
      <div class="widgets">
        <div class="panel widget"><div id="treemap" class="chart"></div><ul class="list" id="top10List"></ul></div>
        <div class="panel widget"><div id="stableChart" class="chart"></div></div>
      </div>
    </section>

    <section class="section" id="sec-kimchi">
      <div class="widgets">
        <div class="panel widget"><div id="kimchiPremChart" class="chart"></div></div>
        <div class="panel widget">
          <div id="kimchiScoreChart" class="chart"></div>
          <div style="margin-top:10px;"><div class="pill">Kimchi Comment</div><div id="kimchiCommentHead" style="font-weight:700;">-</div><div id="kimchiCommentBody">-</div></div>
          <div style="margin-top:10px;"><div class="pill">FX Context</div><div id="fxComment">-</div></div>
        </div>
      </div>
    </section>

    <footer class="footerDisclaimer">
      <div class="icon">i</div>
      <div><p class="title">Disclaimer</p><p class="body">본 대시보드의 정보는 투자 권유가 아니며, 투자 책임은 본인에게 있습니다.</p></div>
    </footer>
  </main>
</div>

<script>
  const EX_COLORS = { upbit: "#2563eb", bithumb:"#16a34a", coinone:"#7c3aed" };
  const AXIS_UNIT = 1e8; const AXIS_UNIT_LABEL = "억원";

  function fmtAxis(v){ return Number.isFinite(v) ? (v / AXIS_UNIT).toLocaleString("ko-KR") : ""; }
  function num(x){ return Number.isFinite(Number(x)) ? Number(x) : 0; }
  function fmtKRW(n){ n = num(n); if (Math.abs(n) >= 1e12) return (n/1e12).toFixed(2) + "조원"; if (Math.abs(n) >= 1e8) return (n/1e8).toFixed(0) + "억원"; return n.toLocaleString("ko-KR") + "원"; }
  function nowKST(){ const d = new Date(); const kst = new Date(d.getTime() + d.getTimezoneOffset() * 60000 + 9 * 3600000); return `${String(kst.getMonth()+1).padStart(2,"0")}/${String(kst.getDate()).padStart(2,"0")} ${String(kst.getHours()).padStart(2,"0")}:${String(kst.getMinutes()).padStart(2,"0")} KST`; }
  function fmtPct(p){ return (p == null) ? "-" : (p > 0 ? "+" : "") + Number(p).toFixed(2) + "%"; }
  function fmtPct1(p){ return (p == null) ? "-" : (p > 0 ? "+" : "") + Number(p).toFixed(1) + "%"; }

  async function loadJSON(url){ const res = await fetch(url, { cache: "no-store" }); if (!res.ok) throw new Error("Failed: " + url); return await res.json(); }

  function urls(){ const bust = "v=" + Date.now(); return { latest: "/out/history/krw_24h_latest.json?" + bust, hist: "/out/history/krw_24h_snapshots.json?" + bust, kimchiLatest: "/out/history/kimchi_latest.json?" + bust, kimchiHist: "/out/history/kimchi_snapshots.json?" + bust, fxLatest: "/out/history/fx_latest.json?" + bust, bm20History: "/data/bm20_history.json?" + bust }; }

  let treemap, totalChart, shareChart, topRestChart, stableChart, kimchiPremChart, kimchiScoreChart, kShareMiniChart, fngGauge;
  let HISTORY = [], LATEST = null; let KIMCHI_HIST = [], KIMCHI_LATEST = null; let CURRENT_RANGE = 3; let FX_LATEST = null;

  async function refreshData(){
    const u = urls();
    let latest, history, kimchiLatest, kimchiHist, fxLatest, bm20Hist;
    try {
        [latest, history, kimchiLatest, kimchiHist, fxLatest, bm20Hist] = await Promise.all([ loadJSON(u.latest), loadJSON(u.hist), loadJSON(u.kimchiLatest), loadJSON(u.kimchiHist), loadJSON(u.fxLatest), loadJSON(u.bm20History) ]);
    } catch (e) { console.error("Data Load Error", e); return; }

    LATEST = latest; HISTORY = Array.isArray(history) ? history : []; KIMCHI_LATEST = kimchiLatest; KIMCHI_HIST = Array.isArray(kimchiHist) ? kimchiHist : []; FX_LATEST = fxLatest;

    // 1. 신규 글로벌 지표 (K-Share & F&G)
    if (bm20Hist && bm20Hist.length > 0) {
        const bLatest = bm20Hist[bm20Hist.length - 1];
        const kx = bm20Hist.slice(-15).map(h => h.timestamp);
        const ky = bm20Hist.slice(-15).map(h => h.k_market?.k_share_percent || 0);
        kShareMiniChart.setOption({ grid: { left: 5, right: 5, top: 10, bottom: 5 }, xAxis: { type: 'category', data: kx, show: false }, yAxis: { type: 'value', show: false, min: 'dataMin' }, series: [{ data: ky, type: 'line', smooth: true, symbol: 'none', lineStyle: { color: '#2563eb', width: 2 }, areaStyle: { color: 'rgba(37,99,235,0.1)' } }] });
        document.getElementById("kpiKShare").textContent = (bLatest.k_market?.k_share_percent || 0) + "%";
        const fngVal = bLatest.sentiment?.value || 0;
        fngGauge.setOption({ series: [{ type: 'gauge', startAngle: 180, endAngle: 0, min: 0, max: 100, radius: '150%', center: ['50%', '90%'], axisLine: { lineStyle: { width: 8, color: [[0.25, '#dc2626'], [0.75, '#2563eb'], [1, '#16a34a']] } }, progress: { show: true, width: 8 }, pointer: { show: false }, detail: { fontSize: 18, fontWeight: '900', offsetCenter: [0, -15], formatter: '{value}', color: 'inherit' }, data: [{ value: fngVal }] }] });
        const statusMap = { "Extreme Fear": "극도의 공포", "Fear": "공포", "Neutral": "중립", "Greed": "탐욕", "Extreme Greed": "극도의 탐욕" };
        const fngStatusEl = document.getElementById("fngStatus");
        fngStatusEl.textContent = statusMap[bLatest.sentiment?.status] || bLatest.sentiment?.status;
        fngStatusEl.style.color = fngVal <= 25 ? '#dc2626' : (fngVal >= 75 ? '#16a34a' : '#2563eb');
    }

    // 2. 원화 KPI 업데이트
    const t = latest.totals || {}; const top = latest.top10 || {};
    document.getElementById("kpiTotal").textContent = fmtKRW(t.combined_24h);
    document.getElementById("kpiTs").textContent = `현재 시각: ${nowKST()}`;
    document.getElementById("kpiTop10").textContent = `${fmtPct1(top.top10_share_pct)} (Top10)`;
    document.getElementById("kpiTop10Note").textContent = `Top10 ${fmtKRW(top.top10_total_24h)} · Rest ${fmtKRW(top.rest_total_24h)}`;
    const combined = num(t.combined_24h);
    document.getElementById("kpiEx").textContent = `업비트 ${(num(t.upbit_24h)/combined*100).toFixed(1)}%`;
    document.getElementById("kpiExNote").textContent = `빗썸 ${(num(t.bithumb_24h)/combined*100).toFixed(1)}% · 코인원 ${(num(t.coinone_24h)/combined*100).toFixed(1)}%`;
    const st = latest.stablecoins || {};
    document.getElementById("kpiStable").textContent = `${num(st.stable_dominance_pct).toFixed(1)}%`;
    document.getElementById("kpiStableNote").textContent = `합계 ${fmtKRW(st.total_stable_vol_24h)}`;

    // 3. FX & Kimchi
    if (FX_LATEST){
        const gap = num(FX_LATEST.usdtkrw_market) - num(FX_LATEST.usdkrw_official);
        document.getElementById("fxComment").textContent = gap > 5 ? "환율 요인이 김프에 일부 반영되어 있습니다." : "현재 김프는 수급 요인의 영향이 큽니다.";
    }
    const c = buildKimchiComment(LATEST, HISTORY, KIMCHI_LATEST);
    document.getElementById("kimchiCommentHead").textContent = c.head;
    document.getElementById("kimchiCommentBody").textContent = c.body;

    render(CURRENT_RANGE);
  }

  function render(rangeDays){
    CURRENT_RANGE = rangeDays; const hist = HISTORY.slice(-(rangeDays * 3)); const x = hist.map(h => h.timestamp_label);
    totalChart?.setOption({ xAxis: { data: x }, series: [{ name: "Upbit", type: "bar", stack: "t", data: hist.map(h => num(h.totals?.upbit_24h)) }, { name: "Bithumb", type: "bar", stack: "t", data: hist.map(h => num(h.totals?.bithumb_24h)) }, { name: "Coinone", type: "bar", stack: "t", data: hist.map(h => num(h.totals?.coinone_24h)) }] });
  }

  function buildKimchiComment(l, h, kl){ return { head: `Kimchi ${kl?.smart_kimchi?.type || "-"}`, body: "실시간 데이터를 기반으로 자동 생성된 분석 코멘트입니다." }; }
  function attachAutoResize(charts){ const ro = new ResizeObserver(() => charts.forEach(c => c?.resize())); charts.forEach(c => c && ro.observe(c.getDom())); }

  (async function init(){
    treemap = echarts.init(document.getElementById("treemap")); totalChart = echarts.init(document.getElementById("totalChart")); shareChart = echarts.init(document.getElementById("shareChart")); topRestChart = echarts.init(document.getElementById("topRestChart")); stableChart = echarts.init(document.getElementById("stableChart")); kimchiScoreChart = echarts.init(document.getElementById("kimchiScoreChart")); kimchiPremChart = echarts.init(document.getElementById("kimchiPremChart")); kShareMiniChart = echarts.init(document.getElementById("kShareMiniChart")); fngGauge = echarts.init(document.getElementById("fngGauge"));
    attachAutoResize([treemap, totalChart, shareChart, topRestChart, stableChart, kimchiScoreChart, kimchiPremChart, kShareMiniChart, fngGauge]);
    await refreshData(); setInterval(refreshData, 60000);
    window.addEventListener("resize", () => [treemap, totalChart, shareChart, topRestChart, stableChart, kimchiScoreChart, kimchiPremChart, kShareMiniChart, fngGauge].forEach(c => c?.resize()));
  })();
</script>
</body>
</html>
