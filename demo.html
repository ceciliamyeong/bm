<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BM20 임시 데모</title>
  <style>
    :root { --bg:#0b1324; --card:#111a33; --fg:#e6ebff; --muted:#93a2d9; --up:#2E7D32; --down:#C62828; --navy:#1A237E; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:14px/1.5 system-ui,apple-system,Segoe UI,Roboto,Noto Sans KR,sans-serif}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    .headline{display:flex;gap:16px;align-items:end;flex-wrap:wrap;margin-bottom:16px}
    .h1{font-size:22px;font-weight:700}
    .muted{color:var(--muted)}
    .cards{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin:12px 0 24px}
    .card{background:var(--card);border-radius:16px;padding:14px 16px;box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .card h3{margin:0 0 8px;font-size:14px;color:#cfd7ff}
    .val{font-size:20px;font-weight:700}
    .grid-2{display:grid;grid-template-columns:2fr 1fr;gap:12px}
    #bm20-history{height:360px;background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0));border-radius:16px}
    .news{white-space:pre-line}
    a{color:#bcd3ff}
    .pill{display:inline-block;border-radius:999px;padding:2px 8px;font-weight:700}
    .pill.up{background:rgba(46,125,50,.2);color:#a8e6a9}
    .pill.down{background:rgba(198,40,40,.2);color:#ffb3b3}
    @media (max-width:960px){ .cards{grid-template-columns:1fr 1fr} .grid-2{grid-template-columns:1fr} }
    @media (max-width:640px){ .cards{grid-template-columns:1fr} }
  </style>
</head>
<body>
<div class="wrap">
  <div class="headline">
    <div class="h1">BM20 Latest</div>
    <div class="muted" id="asof">로딩 중…</div>
  </div>

  <!-- 요약 카드 -->
  <div class="cards">
    <div class="card">
      <h3>지수 레벨</h3>
      <div class="val" id="idx">—</div>
      <div class="muted" id="d1">전일 대비 —</div>
    </div>
    <div class="card">
      <h3>수익률</h3>
      <div class="muted" id="rets">1D — · 7D — · 30D — · MTD — · YTD —</div>
    </div>
    <div class="card">
      <h3>시장폭</h3>
      <span class="pill up" id="breadth-up">상승 0</span>&nbsp;
      <span class="pill down" id="breadth-down">하락 0</span>
      <div class="muted" style="margin-top:8px">Best/Worst는 본문에서</div>
    </div>
  </div>

  <!-- 본문: 시계열 + 뉴스 -->
  <div class="grid-2">
    <div class="card">
      <h3>BM20 시계열 (히스토리)</h3>
      <div id="bm20-history"></div>
    </div>
    <div class="card">
      <h3>데일리 뉴스(코멘터리)</h3>
      <div class="news" id="news">로딩 중…</div>
    </div>
  </div>

  <p class="muted" style="margin-top:18px">
    데이터 경로: <code>/bm20/data/bm20_history.csv</code> · <code>/bm20/bm20_latest.json</code> (둘 다 없어도 페이지는 뜹니다)
  </p>
</div>

<!-- ECharts + PapaParse -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
(async function(){
  // 0) 간단 헬퍼
  const $ = (id)=>document.getElementById(id);
  const safeFetch = (url)=>fetch(url,{cache:'no-store'}).then(r=>r.ok?r:Promise.reject(r));

  // 1) 시계열: CSV (/bm20/data/bm20_history.csv)
  const chart = echarts.init(document.getElementById('bm20-history'), null, {renderer:'svg'});
  function renderHistory(rows){
    const dates = rows.map(r=>r.date);
    const values = rows.map(r=>+r.index);
    chart.setOption({
      tooltip:{trigger:'axis'},
      grid:{left:40,right:20,top:10,bottom:28},
      xAxis:{type:'category',data:dates,axisLabel:{formatter:v=>v}},
      yAxis:{type:'value',name:'BM20',scale:true},
      series:[{type:'line',name:'BM20',data:values,showSymbol:false,smooth:true}]
    });
    window.addEventListener('resize',()=>chart.resize());
  }
  try{
    const res = await safeFetch('./data/bm20_history.csv');
    const parsed = await new Promise(ok => Papa.parse(res.url, {download:true,header:true,dynamicTyping:true,complete:ok}));
    const rows = (parsed.data||[]).filter(r=>r.date && r.index!=null).sort((a,b)=>new Date(a.date)-new Date(b.date));
    if(rows.length){ renderHistory(rows); $('asof').textContent = `히스토리: ${rows[0].date} ~ ${rows.at(-1).date}`; }
    else { $('asof').textContent = '히스토리: 데이터 없음'; }
  }catch(e){
    $('asof').textContent = '히스토리: 파일 없음 (data/bm20_history.csv 미배포)';
  }

  // 2) 요약/뉴스: latest JSON (/bm20/data/bm20_latest.json)
  try{
    const r = await safeFetch('./data/bm20_latest.json'); const j = await r.json();
    // 키 예시는 상황에 맞게 바꾸세요
    $('idx').textContent = j.index_level?.toFixed ? j.index_level.toFixed(1) : (j.index_level ?? '—');
    const d1 = j.return_1d ?? j.d1 ?? null;
    $('d1').textContent = (d1!=null?`전일 대비 ${(d1*100).toFixed(2)}%`:"전일 대비 —");
    const lens = (k)=> (j.returns && j.returns[k]!=null) ? (j.returns[k]*100).toFixed(2)+'%' : '—';
    $('rets').textContent = `1D ${lens('1D')} · 7D ${lens('7D')} · 30D ${lens('30D')} · MTD ${lens('MTD')} · YTD ${lens('YTD')}`;
    if(typeof j.upCount==='number') $('breadth-up').textContent = `상승 ${j.upCount}`;
    if(typeof j.downCount==='number') $('breadth-down').textContent = `하락 ${j.downCount}`;
    $('news').textContent = (j.news?.body || j.news_text || '뉴스 텍스트가 없습니다.');
  }catch(e){
    $('news').textContent = 'latest JSON이 없어서(news/body) 표시를 생략했습니다. (data/bm20_latest.json 미배포)';
  }
})();
</script>
</body>
</html>
