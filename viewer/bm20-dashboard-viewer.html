<!DOCTYPE html>
<html lang="ko" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BM20 Index Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root { color-scheme: dark; }
    .card { border-radius: 1rem; border: 1px solid rgb(42 50 67);
            background: rgb(17 19 23 / .92); box-shadow: 0 2px 16px rgba(0,0,0,.25); }
    .kpi{ font-size:1.5rem; font-weight:600; letter-spacing:-.01em; }
    .muted{ color: rgb(163 170 182); }
    .positive{ color: rgb(16 185 129); }
    .negative{ color: rgb(244 63 94); }
    .badge{ display:inline-flex; align-items:center; gap:.4rem; font-size:.75rem; padding:.25rem .5rem;
            border-radius:999px; border:1px solid currentColor; }
    .table th,.table td{ padding:.5rem .75rem; }
  </style>
</head>
<body class="bg-neutral-950 text-neutral-50">
  <div class="mx-auto max-w-7xl p-4 md:p-8">
    <div class="flex items-end justify-between mb-4 gap-3">
      <div>
        <h1 class="text-3xl font-semibold tracking-tight">BM20 Index</h1>
        <div id="updatedAt" class="muted text-sm mt-1">업데이트: -</div>
      </div>
      <div class="flex items-center gap-2">
        <select id="rangeSelect" class="border rounded-xl px-3 py-2 text-sm bg-neutral-900">
          <option value="3M">3M</option>
          <option value="6M" selected>6M</option>
          <option value="YTD">YTD</option>
          <option value="MAX">MAX</option>
        </select>
        <button id="shareBtn" class="border rounded-2xl px-3 py-2 text-sm">공유</button>
      </div>
    </div>

    <div id="rebalanceBanner" class="hidden mb-4 card px-4 py-3 text-amber-200 bg-amber-950/40">
      <span class="font-medium">정기 리밸런싱일</span>
      <span class="ml-2 text-sm opacity-80">(1, 4, 7, 10월 1일 적용)</span>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-6 gap-4 mb-6">
      <div class="card p-4"><div class="muted text-sm mb-1">Index</div><div class="kpi" id="kpiIndex">-</div></div>
      <div class="card p-4"><div class="muted text-sm mb-1">D1</div><div class="kpi" id="kpiD1">-</div></div>
      <div class="card p-4"><div class="muted text-sm mb-1">D7</div><div class="kpi" id="kpiD7">-</div></div>
      <div class="card p-4"><div class="muted text-sm mb-1">MTD</div><div class="kpi" id="kpiMTD">-</div></div>
      <div class="card p-4"><div class="muted text-sm mb-1">YTD</div><div class="kpi" id="kpiYTD">-</div></div>
      <div class="card p-4"><div class="muted text-sm mb-1">KR 상장 비중</div><div class="kpi" id="kpiKR">—</div></div>
    </div>

    <div class="grid grid-cols-1 xl:grid-cols-3 gap-4 mb-6">
      <div class="xl:col-span-2 card p-4">
        <div class="font-medium mb-2">BM20 Historical</div>
        <canvas id="lineChart" height="240"></canvas>
      </div>
      <div class="card p-4">
        <div class="font-medium mb-2">Coin Contributions (오늘)</div>
        <div id="contribEmpty" class="muted text-sm hidden">데이터 없음</div>
        <canvas id="barChart" height="240"></canvas>
        <div class="grid grid-cols-2 gap-4 mt-4">
          <div class="border rounded-2xl p-3">
            <div class="font-semibold mb-2">Best 3</div>
            <ul id="bestList" class="space-y-2 text-sm"></ul>
          </div>
          <div class="border rounded-2xl p-3">
            <div class="font-semibold mb-2">Worst 3</div>
            <ul id="worstList" class="space-y-2 text-sm"></ul>
          </div>
        </div>
      </div>
    </div>

    <div class="card p-4">
      <div class="flex items-center justify-between mb-2">
        <div class="font-medium">Constituents (20)</div>
        <div class="badge" id="rebalanceBadge">Rebalance</div>
      </div>
      <div class="muted text-sm mb-2" id="constituentsNote">구성 종목 데이터가 연결되면 여기에 표시됩니다.</div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm table">
          <thead>
            <tr class="text-neutral-400 border-b border-neutral-800">
              <th class="text-left">Symbol</th>
              <th class="text-left">Name</th>
              <th class="text-left">Weight</th>
              <th class="text-left">Price (USD)</th>
              <th class="text-left">24h</th>
              <th class="text-left">KR Listed</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <div class="text-xs muted text-center mt-3">
      데이터 소스: <code>series.json</code> (BM20), <code>latest.json</code> / <code>contrib_top.json</code> 있으면 자동 반영. Asia/Seoul 기준. 기준일 2018-01-01 (=100).
    </div>
  </div>

<script>
const fmtPct = (n) => `${n >= 0 ? "+" : ""}${(n*1).toFixed(1)}%`;
const isRebalanceDay = (iso) => {
  const d = new Date(iso + "T00:00:00Z");
  const m = d.getUTCMonth() + 1, day = d.getUTCDate();
  return day === 1 && [1,4,7,10].includes(m);
};
async function fetchMaybe(url){
  try{ const r = await fetch(url, {cache:"no-store"}); if(!r.ok) throw 0; return await r.json(); }catch(e){ return null; }
}

// Try multiple shapes: [{date,index}], {date:[], index:[]}, or {records:[{date, index}]}
function normalizeSeries(json){
  if(!json) return [];
  if(Array.isArray(json)){
    return json.map(row=>{
      const d = row.date || row.Date || row.D || row[0];
      const v = row.index ?? row.Index ?? row.close ?? row.value ?? row.V ?? row[1];
      return {date: String(d).slice(0,10), index: Number(v)};
    }).filter(x=>x.date && !Number.isNaN(x.index));
  }
  if(json.records && Array.isArray(json.records)){
    return normalizeSeries(json.records);
  }
  if(json.date && json.index && Array.isArray(json.date)){
    return json.date.map((d,i)=>({date: String(d).slice(0,10), index: Number((json.index||[])[i])})).filter(x=>x.date && !Number.isNaN(x.index));
  }
  const keys = Object.keys(json);
  if(keys.length>=2 && Array.isArray(json[keys[0]]) && Array.isArray(json[keys[1]])){
    return json[keys[0]].map((d,i)=>({date: String(d).slice(0,10), index: Number(json[keys[1]][i])})).filter(x=>x.date && !Number.isNaN(x.index));
  }
  return [];
}

function pct(a,b){ if(a==null || b==null) return null; return ((a/b)-1)*100; }

function firstOnOrAfter(series, yyyy_mm_dd_start){
  for(const p of series){ if(p.date >= yyyy_mm_dd_start) return p; }
  return null;
}

let LINE, BAR;
async function main(){
  // Load data (same directory)
  const seriesJson = await fetchMaybe("./series.json");
  const latestJson = await fetchMaybe("./latest.json");
  const contribJson = (await fetchMaybe("./contrib_top.json")) || (await fetchMaybe("./site/contrib_top.json"));

  const series = normalizeSeries(seriesJson).sort((a,b)=>a.date.localeCompare(b.date));
  if(series.length === 0){
    document.body.innerHTML = "<div class='mx-auto max-w-3xl p-8 text-center text-red-400'>series.json을 찾지 못했습니다. Actions가 out/series.json을 만들고 Stage에서 _site로 복사하는지 확인하세요.</div>";
    return;
  }

  const last = series[series.length-1];
  const prev = series[series.length-2];
  const d7idx = Math.max(0, series.length-8);
  const d7 = series[d7idx];
  const y = new Date(last.date+"T00:00:00Z");
  const ytdStr = `${y.getUTCFullYear()}-01-01`;
  const mtdStr = `${y.getUTCFullYear()}-${String(y.getUTCMonth()+1).padStart(2,"0")}-01`;
  const ytd0 = firstOnOrAfter(series, ytdStr) || series[0];
  const mtd0 = firstOnOrAfter(series, mtdStr) || series[0];

  const idx = last.index, idxPrev = prev?.index, idx7 = d7?.index, idxY0 = ytd0?.index, idxM0 = mtd0?.index;
  const d1Pct = pct(idx, idxPrev), d7Pct = pct(idx, idx7), ytdPct = pct(idx, idxY0), mtdPct = pct(idx, idxM0);

  // Header & KPIs
  document.getElementById("updatedAt").textContent = `업데이트: ${last.date}`;
  document.getElementById("kpiIndex").textContent = (idx ?? 0).toFixed(1);
  const setPct = (id, val) => {
    const el = document.getElementById(id);
    if(val===null || Number.isNaN(val)){ el.textContent = "—"; return; }
    el.textContent = fmtPct(val);
    el.classList.remove("positive","negative");
    el.classList.add(val>=0 ? "positive" : "negative");
  };
  setPct("kpiD1", d1Pct);
  setPct("kpiD7", d7Pct);
  setPct("kpiMTD", mtdPct);
  setPct("kpiYTD", ytdPct);
  document.getElementById("kpiKR").textContent = latestJson?.koreaListedSharePct ? `${latestJson.koreaListedSharePct}%` : "—";

  // Rebalance
  const isReb = isRebalanceDay(last.date);
  document.getElementById("rebalanceBanner").classList.toggle("hidden", !isReb);
  document.getElementById("rebalanceBadge").classList.toggle("hidden", !isReb);

  // Line chart
  const labels = series.map(p=>p.date);
  const values = series.map(p=>p.index);
  LINE = new Chart(document.getElementById("lineChart"), {
    type: "line",
    data: { labels, datasets: [{ label: "Index", data: values, tension: 0.25 }]},
    options: { plugins: { legend: { display: false } }, scales:{ x:{ ticks:{ autoSkip:true, maxRotation:0 }}}}
  });

  // Contributions (optional)
  if(contribJson && (contribJson.best || contribJson.worst || Array.isArray(contribJson))){
    const best = contribJson.best || (Array.isArray(contribJson) ? contribJson.slice(0,3) : []);
    const worst = contribJson.worst || (Array.isArray(contribJson) ? contribJson.slice(-3) : []);
    const norm = (arr)=>arr.map(d => ({
      symbol: d.symbol || d.sym || d[0] || "?",
      name: d.name || d.coin || d[1] || (d.symbol||"?"),
      pctContribution: Number(d.pctContribution ?? d.contrib ?? d[2] ?? 0)
    }));
    const pos = norm(best).sort((a,b)=>b.pctContribution-a.pctContribution).slice(0,3);
    const neg = norm(worst).sort((a,b)=>a.pctContribution-b.pctContribution).slice(0,3);
    const barData = [...pos, ...neg];
    BAR = new Chart(document.getElementById("barChart"), {
      type: "bar",
      data: { labels: barData.map(d=>d.symbol), datasets: [{ label: "기여도", data: barData.map(d=>d.pctContribution)}]},
      options: { plugins:{ legend:{ display:false }}}
    });
    document.getElementById("bestList").innerHTML = pos.map(d=>`<li class='flex justify-between'><span>${d.name} (${d.symbol})</span><span class='positive'>${fmtPct(d.pctContribution)}</span></li>`).join("");
    document.getElementById("worstList").innerHTML = neg.map(d=>`<li class='flex justify-between'><span>${d.name} (${d.symbol})</span><span class='negative'>${fmtPct(d.pctContribution)}</span></li>`).join("");
  } else {
    document.getElementById("contribEmpty").classList.remove("hidden");
  }

  // Constituents (optional: constituents.json)
  const constit = await fetchMaybe("./constituents.json");
  if(constit && Array.isArray(constit)){
    document.getElementById("constituentsNote").classList.add("hidden");
    document.getElementById("tableBody").innerHTML = constit.map(r=>`
      <tr class="border-b border-neutral-800 last:border-b-0">
        <td class="font-medium">${r.symbol||""}</td>
        <td>${r.name||""}</td>
        <td>${(r.weightPct??0).toFixed(2)}%</td>
        <td>${Number(r.priceUsd||0).toLocaleString()}</td>
        <td class="${(r.change24hPct??0)>=0 ? 'positive':'negative'}">${fmtPct(r.change24hPct??0)}</td>
        <td>${r.listedInKR ? 'Y':'N'}</td>
      </tr>
    `).join("");
  }

  // Range switch
  document.getElementById("rangeSelect").addEventListener("change", (e)=>{
    const val = e.target.value;
    let filtered = series;
    const lastDate = new Date(series[series.length-1].date+"T00:00:00Z");
    if(val==="3M"||val==="6M"){
      const months = val==="3M" ? 3 : 6;
      const start = new Date(Date.UTC(lastDate.getUTCFullYear(), lastDate.getUTCMonth()-months, lastDate.getUTCDate()));
      const startStr = start.toISOString().slice(0,10);
      filtered = series.filter(p=>p.date >= startStr);
    } else if(val==="YTD"){
      const ytdStr = `${lastDate.getUTCFullYear()}-01-01`;
      filtered = series.filter(p=>p.date >= ytdStr);
    } // MAX = all
    LINE.data.labels = filtered.map(p=>p.date);
    LINE.data.datasets[0].data = filtered.map(p=>p.index);
    LINE.update();
  });

  document.getElementById("shareBtn").addEventListener("click", async ()=>{
    try{ await navigator.clipboard.writeText(location.href); alert("주소를 복사했습니다."); }catch{ alert("복사 실패"); }
  });
}
main();
</script>
</body>
</html>
