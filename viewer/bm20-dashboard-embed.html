<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BM20 Index Dashboard (Embed)</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      color-scheme: light dark;
    }
    .card { @apply rounded-2xl border bg-white/90 dark:bg-neutral-900/80 shadow-sm;}
    .kpi  { @apply text-2xl font-semibold tracking-tight;}
    .muted{ @apply text-neutral-500;}
    .positive{ @apply text-emerald-600;}
    .negative{ @apply text-rose-600;}
    .badge  { @apply inline-flex items-center gap-2 text-xs px-2 py-1 rounded-full border; }
    .table th, .table td { @apply py-2 pr-3; }
  </style>
</head>
<body class="bg-neutral-50/60 dark:bg-neutral-950 text-neutral-900 dark:text-neutral-50">
  <div class="mx-auto max-w-7xl p-4 md:p-8">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3 mb-4">
      <div>
        <h1 class="text-3xl font-semibold tracking-tight">BM20 Index</h1>
        <div class="muted text-sm mt-1" id="updatedAt">업데이트: -</div>
      </div>
      <div class="flex items-center gap-2">
        <select id="rangeSelect" class="border rounded-xl px-3 py-2 text-sm bg-white dark:bg-neutral-900">
          <option value="3M">3M</option>
          <option value="6M" selected>6M</option>
          <option value="YTD">YTD</option>
        </select>
        <button id="shareBtn" class="border rounded-2xl px-3 py-2 text-sm">공유</button>
      </div>
    </div>

    <!-- Rebalance -->
    <div id="rebalanceBanner" class="hidden mb-4 card px-4 py-3 text-amber-700 dark:text-amber-200 bg-amber-50 dark:bg-amber-950/40">
      <span class="font-medium">정기 리밸런싱일</span>
      <span class="ml-2 text-sm opacity-80">(1, 4, 7, 10월 1일 적용)</span>
    </div>

    <!-- KPIs -->
    <div class="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-6 gap-4 mb-6">
      <div class="card p-4"><div class="muted text-sm mb-1">Index</div><div class="kpi" id="kpiIndex">-</div></div>
      <div class="card p-4"><div class="muted text-sm mb-1">D1</div><div class="kpi" id="kpiD1">-</div><div class="text-sm" id="kpiD1delta"></div></div>
      <div class="card p-4"><div class="muted text-sm mb-1">D7</div><div class="kpi" id="kpiD7">-</div><div class="text-sm" id="kpiD7delta"></div></div>
      <div class="card p-4"><div class="muted text-sm mb-1">MTD</div><div class="kpi" id="kpiMTD">-</div><div class="text-sm" id="kpiMTDdelta"></div></div>
      <div class="card p-4"><div class="muted text-sm mb-1">YTD</div><div class="kpi" id="kpiYTD">-</div><div class="text-sm" id="kpiYTDdelta"></div></div>
      <div class="card p-4"><div class="muted text-sm mb-1">KR 상장 비중</div><div class="kpi" id="kpiKR">-</div></div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-4 mb-6">
      <div class="xl:col-span-2 card p-4">
        <div class="font-medium mb-2">BM20 Historical</div>
        <canvas id="lineChart" height="240"></canvas>
      </div>
      <div class="card p-4">
        <div class="font-medium mb-2">Coin Contributions (오늘)</div>
        <canvas id="barChart" height="240"></canvas>
        <div class="grid grid-cols-2 gap-4 mt-4">
          <div class="border rounded-2xl p-3">
            <div class="font-semibold mb-2">Best 3</div>
            <ul id="bestList" class="space-y-2 text-sm"></ul>
          </div>
          <div class="border rounded-2xl p-3">
            <div class="font-semibold mb-2">Worst 3</div>
            <ul id="worstList" class="space-y-2 text-sm"></ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="card p-4">
      <div class="flex items-center justify-between mb-2">
        <div class="font-medium">Constituents (20)</div>
        <div class="badge" id="rebalanceBadge">Rebalance</div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm table">
          <thead>
            <tr class="muted border-b">
              <th class="text-left">Symbol</th>
              <th class="text-left">Name</th>
              <th class="text-left">Weight</th>
              <th class="text-left">Price (USD)</th>
              <th class="text-left">24h</th>
              <th class="text-left">KR Listed</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <div class="text-xs muted text-center mt-3">
      데이터 소스: CoinGecko (기본), Yahoo Finance (폴백). Asia/Seoul 기준. 지수 기준일 2018-01-01 (=100).
    </div>
  </div>

<script>
const fmtPct = (n) => `${n >= 0 ? "+" : ""}${n.toFixed(1)}%`;
const isRebalanceDay = (iso) => {
  const d = new Date(iso + "T00:00:00Z");
  const m = d.getUTCMonth() + 1, day = d.getUTCDate();
  return day === 1 && [1,4,7,10].includes(m);
};

// --- Mock Data (fallback) ---
const MOCK_SUMMARY = {
  date: "2025-08-21",
  indexValue: 134.2,
  d1Pct: 2.3, d7Pct: 5.8, mtdPct: 3.1, ytdPct: 18.6,
  koreaListedSharePct: 89
};
const MOCK_SERIES = Array.from({length: 180}).map((_, i) => {
  const base=120, noise=Math.sin(i/9)*2 + Math.cos(i/17)*1.2;
  const d = new Date(Date.UTC(2025,2,25+i)).toISOString().slice(0,10);
  return { date: d, index: Math.round((base + i*0.12 + noise)*10)/10 };
});
const MOCK_CONTRIB = [
  {symbol:"BTC", name:"Bitcoin", pctContribution:1.1},
  {symbol:"ETH", name:"Ethereum", pctContribution:0.7},
  {symbol:"SUI", name:"Sui", pctContribution:0.4},
  {symbol:"TON", name:"Toncoin", pctContribution:-0.2},
  {symbol:"XRP", name:"XRP", pctContribution:0.1},
  {symbol:"BNB", name:"BNB", pctContribution:0.2},
  {symbol:"DOGE", name:"Dogecoin", pctContribution:-0.1},
];
const MOCK_CONSTIT = [
  {symbol:"BTC",name:"Bitcoin",weightPct:30,priceUsd:65000,change24hPct:2.1,listedInKR:true},
  {symbol:"ETH",name:"Ethereum",weightPct:20,priceUsd:3200,change24hPct:2.8,listedInKR:true},
  {symbol:"XRP",name:"XRP",weightPct:5,priceUsd:0.64,change24hPct:1.2,listedInKR:true},
  {symbol:"USDT",name:"Tether",weightPct:5,priceUsd:1.0,change24hPct:0.0,listedInKR:true},
  {symbol:"BNB",name:"BNB",weightPct:5,priceUsd:590,change24hPct:1.4,listedInKR:true},
  {symbol:"DOGE",name:"Dogecoin",weightPct:2.33,priceUsd:0.18,change24hPct:3.4,listedInKR:true},
  {symbol:"TON",name:"Toncoin",weightPct:2.33,priceUsd:7.2,change24hPct:-0.8,listedInKR:true},
  {symbol:"SUI",name:"Sui",weightPct:2.33,priceUsd:1.6,change24hPct:4.1,listedInKR:false},
];

async function fetchJSON(url, fallback) {
  try {
    const ctrl = new AbortController();
    const timer = setTimeout(() => ctrl.abort(), 4000);
    const res = await fetch(url, { signal: ctrl.signal, cache: "no-store" });
    clearTimeout(timer);
    if (!res.ok) throw new Error("HTTP " + res.status);
    return await res.json();
  } catch (e) {
    return fallback;
  }
}

let lineChart, barChart;

async function loadData() {
  const today = new Date().toISOString().slice(0,10);
  const start6M = new Date(); start6M.setMonth(start6M.getMonth()-6);
  const startStr = start6M.toISOString().slice(0,10);

  const summary = await fetchJSON(`/api/bm20/summary?date=${today}`, MOCK_SUMMARY);
  const series  = await fetchJSON(`/api/bm20/series?start=${startStr}&end=${today}`, MOCK_SERIES);
  const contrib = await fetchJSON(`/api/bm20/contributions?date=${today}`, MOCK_CONTRIB);
  const constit = await fetchJSON(`/api/bm20/constituents?date=${today}`, MOCK_CONSTIT);

  // Header & KPI
  document.getElementById("updatedAt").textContent = `업데이트: ${summary.date}`;
  document.getElementById("kpiIndex").textContent = summary.indexValue.toFixed(1);
  const setPct = (id, val) => {
    const el = document.getElementById(id);
    el.textContent = fmtPct(val);
    el.classList.remove("positive","negative");
    el.classList.add(val>=0 ? "positive" : "negative");
  };
  setPct("kpiD1", summary.d1Pct); setPct("kpiD7", summary.d7Pct);
  setPct("kpiMTD", summary.mtdPct); setPct("kpiYTD", summary.ytdPct);
  document.getElementById("kpiKR").textContent = `${summary.koreaListedSharePct}%`;

  // Rebalance
  const isReb = isRebalanceDay(summary.date);
  document.getElementById("rebalanceBanner").classList.toggle("hidden", !isReb);
  document.getElementById("rebalanceBadge").classList.toggle("hidden", !isReb);

  // Line chart
  const labels = series.map(p=>p.date);
  const values = series.map(p=>p.index);
  if (lineChart) lineChart.destroy();
  lineChart = new Chart(document.getElementById("lineChart"), {
    type: "line",
    data: { labels, datasets: [{ label: "Index", data: values, tension: 0.25 }]},
    options: {
      responsive: true,
      plugins: { legend: { display: false }, tooltip: { callbacks: { title: items => `날짜: ${items[0].label}` } } },
      scales: { x: { ticks: { autoSkip: true, maxRotation: 0 } } }
    }
  });

  // Contributions
  const pos = contrib.filter(d=>d.pctContribution>=0).sort((a,b)=>b.pctContribution-a.pctContribution).slice(0,3);
  const neg = contrib.filter(d=>d.pctContribution<0).sort((a,b)=>a.pctContribution-b.pctContribution).slice(0,3);
  const barData = [...pos, ...neg];
  if (barChart) barChart.destroy();
  barChart = new Chart(document.getElementById("barChart"), {
    type: "bar",
    data: { labels: barData.map(d=>d.symbol), datasets: [{ label: "기여도", data: barData.map(d=>d.pctContribution) }]},
    options: { plugins: { legend: { display: false } } }
  });
  const bestList = document.getElementById("bestList");
  const worstList = document.getElementById("worstList");
  bestList.innerHTML = pos.map(d=>`<li class='flex justify-between'><span>${d.name} (${d.symbol})</span><span class='positive'>${fmtPct(d.pctContribution)}</span></li>`).join("");
  worstList.innerHTML = neg.map(d=>`<li class='flex justify-between'><span>${d.name} (${d.symbol})</span><span class='negative'>${fmtPct(d.pctContribution)}</span></li>`).join("");

  // Table
  const tb = document.getElementById("tableBody");
  tb.innerHTML = constit.map(r=>`
    <tr class="border-b last:border-b-0">
      <td class="font-medium">${r.symbol}</td>
      <td>${r.name}</td>
      <td>${r.weightPct.toFixed(2)}%</td>
      <td>${Number(r.priceUsd).toLocaleString()}</td>
      <td class="${r.change24hPct>=0 ? 'positive':'negative'}">${fmtPct(r.change24hPct)}</td>
      <td>${r.listedInKR ? 'Y' : 'N'}</td>
    </tr>
  `).join("");
}

// Range switch (simple: refetch series with different start dates)
document.getElementById("rangeSelect").addEventListener("change", async (e)=>{
  const today = new Date().toISOString().slice(0,10);
  let start = new Date();
  const val = e.target.value;
  if (val === "3M") start.setMonth(start.getMonth()-3);
  else if (val === "6M") start.setMonth(start.getMonth()-6);
  else { start = new Date(new Date().getFullYear(), 0, 1); } // YTD
  const startStr = start.toISOString().slice(0,10);
  const series = await fetchJSON(`/api/bm20/series?start=${startStr}&end=${today}`, MOCK_SERIES);
  const labels = series.map(p=>p.date);
  const values = series.map(p=>p.index);
  lineChart.data.labels = labels;
  lineChart.data.datasets[0].data = values;
  lineChart.update();
});

document.getElementById("shareBtn").addEventListener("click", async ()=>{
  const url = location.href;
  try {
    await navigator.clipboard.writeText(url);
    alert("현재 페이지 주소를 클립보드에 복사했습니다.");
  } catch (e) {
    alert("주소 복사 실패. 수동으로 복사해주세요.");
  }
});

loadData();
</script>
</body>
</html>
