<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BM20 Viewer — BM20 vs BTC + Dashboard</title>
  <style>
    :root { --bg:#0b0d12; --fg:#e8edf2; --muted:#93a1af; --card:#131722; --accent:#5ea0ff; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans,sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    h1{font-size:20px;margin:0 0 8px}
    h2{font-size:18px;margin:12px 0}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .btn{padding:6px 10px;border-radius:10px;border:1px solid #2a3243;background:#182032;color:var(--fg);cursor:pointer;text-decoration:none}
    .btn.active{background:var(--accent);color:#07101f;border-color:transparent}
    .card{background:var(--card);border:1px solid #1e2430;border-radius:14px;box-shadow:0 2px 16px rgba(0,0,0,.25)}
    .pad{padding:12px}
    #chart{width:100%;height:520px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
    .stat .k{color:var(--muted);font-size:12px}.stat .v{font-size:18px;font-weight:700}
    .muted{color:var(--muted)} .small{font-size:12px}
    .divider{margin:40px 0;border:none;border-top:1px solid #2a3243}
    .topbar{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,rgba(11,13,18,.95),rgba(11,13,18,.85));backdrop-filter:saturate(140%) blur(6px);padding:10px;border-bottom:1px solid #1e2430}
    .topbar .inner{max-width:1100px;margin:0 auto;display:flex;gap:8px;align-items:center;justify-content:space-between}
    .anchors{display:flex;gap:8px;flex-wrap:wrap}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
</head>
<body>

<!-- 상단 네비게이션 (앵커 링크) -->
<div class="topbar">
  <div class="inner">
    <div style="font-weight:700">BM20 Viewer</div>
    <nav class="anchors">
      <a class="btn active" href="#vsbtc">BM20 vs BTC</a>
      <a class="btn" href="#dashboard">BM20 Dashboard</a>
      <a class="btn" href="./bm20-vs-btc.html">비교(전체화면)</a>
      <a class="btn" href="./bm20-dashboard-viewer.html">대시보드(전체화면)</a>
      <a class="btn" href="./methodology.html">Methodology</a>
      <a class="btn" href="./data/">Data</a>
    </nav>
  </div>
</div>

  <!-- 섹션 1: BM20 vs BTC -->
  <section id="vsbtc">
    <div class="row">
      <h1>BM20 vs BTC</h1>
      <div class="row">
        <button class="btn" id="btnAll">All</button>
        <button class="btn" id="btn1Y">1Y</button>
        <button class="btn" id="btnYTD">YTD</button>
        <span style="width:8px"></span>
        <button class="btn" id="btnLinear">Linear</button>
        <button class="btn active" id="btnLog">Log</button>
      </div>
    </div>

    <div class="card pad"><div id="chart"></div></div>

    <div class="grid">
      <div class="card pad stat"><div class="k">Latest (BM20)</div><div class="v" id="statLatestBM20">-</div></div>
      <div class="card pad stat"><div class="k">MTD (BM20)</div><div class="v" id="statMTDBM20">-</div></div>
      <div class="card pad stat"><div class="k">YTD (BM20)</div><div class="v" id="statYTDBM20">-</div></div>
    </div>

    <div class="muted small" style="margin-top:10px">
      데이터: <code>series.json</code> (BM20), <code>btc_series.json</code> (BTC-USD 정규화). y축 로그 토글 권장.
    </div>
  </section>

  <!-- 구분선 -->
  <hr class="divider"/>

  <!-- 섹션 2: BM20 Dashboard (iframe 임베드) -->
  <section id="dashboard">
    <h2>BM20 Dashboard</h2>
    <!-- 높이는 필요에 따라 조정 -->
    <iframe
      src="./bm20-dashboard-viewer.html"
      width="100%" height="1200"
      style="border:0;border-radius:12px;background:#0b0d12">
    </iframe>
    <div class="muted small" style="margin-top:10px">
      대시보드가 보이지 않으면 <code>bm20-dashboard-viewer.html</code>이 <code>_site/</code>에 배포되었는지 확인하세요.
    </div>
  </section>

</div>

<script>
(async function(){
  const fmt = (n,d=2)=> (n==null||!isFinite(n) ? "-" : Number(n).toLocaleString(undefined,{maximumFractionDigits:d}));
  const pct = (x)=> (x==null||!isFinite(x) ? "-" : (x*100).toFixed(2)+"%");
  const clip = v => Math.max(v,1e-9);

  async function loadJSON(path){
    const r = await fetch(path, {cache:"no-store"});
    if(!r.ok) throw new Error(path+" HTTP "+r.status);
    const j = await r.json();
    // 허용 형태: [{date,index}] 또는 [[date, index]]
    return Array.isArray(j)
      ? j.map(row => Array.isArray(row) ? ({date:row[0], index:Number(row[1])}) : ({date:String(row.date), index:Number(row.index)}))
      : [];
  }

  let bm = [], btc = [];
  try {
    [bm, btc] = await Promise.all([loadJSON("./series.json"), loadJSON("./btc_series.json")]);
  } catch(e) {
    document.getElementById("chart").innerHTML = '<div class="muted">데이터 로드 실패: '+(e.message||e)+'</div>';
    return;
  }
  bm = bm.filter(d=>d && d.date && isFinite(d.index)).sort((a,b)=> new Date(a.date)-new Date(b.date));
  btc = btc.filter(d=>d && d.date && isFinite(d.index)).sort((a,b)=> new Date(a.date)-new Date(b.date));
  if(!bm.length){ document.getElementById("chart").innerHTML = '<div class="muted">BM20 데이터가 없습니다.</div>'; return; }

  const el = document.getElementById("chart");
  const chart = echarts.init(el, null, {renderer:'canvas'});

  function calcStats(arr){
    if(!arr.length) return {latest:null,mtd:null,ytd:null};
    const latest = arr[arr.length-1];
    const monthStart = new Date(latest.date); monthStart.setDate(1);
    const yearStart  = new Date(latest.date); yearStart.setMonth(0,1);
    const findClosest = (target) => {
      const t = target.getTime(); let best = arr[0], diff = Math.abs(new Date(best.date)-t);
      for(const x of arr){ const d = Math.abs(new Date(x.date)-t); if(d<diff){best=x; diff=d;} }
      return best;
    };
    const m0 = findClosest(monthStart), y0 = findClosest(yearStart);
    return { latest: latest.index, mtd: latest.index/m0.index - 1, ytd: latest.index/y0.index - 1 };
  }

  function render(range="all", yscale="log"){
    let startDate = bm[0].date;
    if(range==="1Y"){
      const d = new Date(bm[bm.length-1].date); d.setFullYear(d.getFullYear()-1); startDate = d.toISOString().slice(0,10);
    }else if(range==="YTD"){
      const d = new Date(bm[bm.length-1].date); d.setMonth(0,1); startDate = d.toISOString().slice(0,10);
    }
    const inRange = d => d.date >= startDate;
    const bmR = bm.filter(inRange), btcR = btc.filter(inRange);

    const dates = bmR.map(d=>d.date);
    const bmVals  = bmR.map(d=> yscale==="log" ? clip(d.index) : d.index);
    const btcVals = btcR.map(d=> yscale==="log" ? clip(d.index) : d.index);

    const yAxis = (yscale==="log")
      ? { type:'log', axisLabel:{color:'#b6c2d1'} }
      : { type:'value', axisLabel:{color:'#b6c2d1'} };

    chart.setOption({
      grid:{left:46,right:16,top:22,bottom:44},
      tooltip:{trigger:'axis', valueFormatter:v=>fmt(v)},
      legend:{data:['BM20','BTC'], top:0, textStyle:{color:'#cdd6e1'}},
      xAxis:{ type:'category', boundaryGap:false, data:dates, axisLabel:{color:'#b6c2d1'} },
      yAxis,
      series:[
        {name:'BM20', type:'line', showSymbol:false, lineStyle:{width:1.8}, data:bmVals, smooth:true, areaStyle:{opacity:0.06}},
        {name:'BTC',  type:'line', showSymbol:false, lineStyle:{width:1.4}, data:btcVals, smooth:true}
      ]
    });

    const st = calcStats(bmR);
    document.getElementById("statLatestBM20").textContent = fmt(st.latest);
    document.getElementById("statMTDBM20").textContent = pct(st.mtd);
    document.getElementById("statYTDBM20").textContent = pct(st.ytd);
  }

  // 초기 렌더
  render("all","log");

  // 버튼 바인딩
  const setActive = (ids, activeId) => ids.forEach(id => document.getElementById(id).classList.toggle("active", id===activeId));
  document.getElementById("btnAll").onclick   = ()=>{ setActive(["btnAll","btn1Y","btnYTD"],"btnAll"); render(currentRange="all",  currentScale); };
  document.getElementById("btn1Y").onclick    = ()=>{ setActive(["btnAll","btn1Y","btnYTD"],"btn1Y");  render(currentRange="1Y",   currentScale); };
  document.getElementById("btnYTD").onclick   = ()=>{ setActive(["btnAll","btn1Y","btnYTD"],"btnYTD"); render(currentRange="YTD",  currentScale); };
  document.getElementById("btnLinear").onclick= ()=>{ setActive(["btnLinear","btnLog"],"btnLinear");   render(currentRange, currentScale="linear"); };
  document.getElementById("btnLog").onclick   = ()=>{ setActive(["btnLinear","btnLog"],"btnLog");      render(currentRange, currentScale="log"); };

  let currentRange = "all", currentScale = "log";
  window.addEventListener("resize", ()=>chart.resize());
})();
</script>
</body>
</html>

