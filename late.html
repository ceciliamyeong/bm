<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BM20 데일리 PDF</title>
  <style>
    :root { --bar: 56px; }
    *{box-sizing:border-box}
    body{margin:0;background:#f5f6fa;color:#111;font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif}
    header{position:sticky;top:0;height:var(--bar);display:flex;align-items:center;gap:8px;padding:0 12px;background:#fff;border-bottom:1px solid #e5e9f0;z-index:10}
    header h1{font-size:15px;margin:0;font-weight:600}
    header .sp{flex:1}
    header a{padding:8px 12px;border:1px solid #d6d9e0;border-radius:10px;background:#fff;text-decoration:none;color:#111}
    #wrap{height:calc(100vh - var(--bar));}
    iframe, object{width:100%;height:100%;border:0;display:block}
    #fallback{display:none;height:100%;padding:20px}
    .card{max-width:760px;margin:0 auto;background:#fff;border:1px solid #e5e9f0;border-radius:12px;padding:18px}
    .muted{color:#666}
    code{background:#f0f3f8;border:1px solid #e1e6ef;border-radius:6px;padding:2px 6px}
  </style>
</head>
<body>
<header>
  <h1 id="title">BM20 데일리 PDF</h1>
  <div class="sp"></div>
  <a id="openNew" target="_blank" rel="noopener">새 탭</a>
  <a id="download" download>다운로드</a>
</header>

<div id="wrap">
  <object id="pdfObj" type="application/pdf"></object>
  <iframe id="pdfFrame" style="display:none"></iframe>

  <div id="fallback">
    <div class="card">
      <h2 style="margin:0 0 8px">PDF 미리보기를 사용할 수 없습니다</h2>
      <p class="muted" id="why">파일을 찾을 수 없거나 브라우저가 내장 PDF 뷰어를 지원하지 않습니다.</p>
      <p>
        <a id="fbOpen" target="_blank" rel="noopener">🗔 새 탭으로 열기</a>
        &nbsp;•&nbsp;
        <a id="fbDown" download>📥 다운로드</a>
      </p>
      <hr style="border:none;border-top:1px solid #e5e9f0;margin:16px 0" />
      <p class="muted" style="font-size:12px">
        특정 날짜를 보려면 <code>?date=YYYY-MM-DD</code>, 임의 파일은 <code>?pdf=/경로/파일.pdf</code> 를 사용하세요.
      </p>
    </div>
  </div>
</div>

<script>
(async () => {
  const qs = (s)=>document.querySelector(s);
  const usp = new URLSearchParams(location.search);
  const paramPdf  = usp.get('pdf');
  const paramDate = usp.get('date');

  // Asia/Seoul(KST, UTC+9) 기준 YYYY-MM-DD 문자열
  function todayKST(){
    const kst = new Date(Date.now() + 9*60*60*1000);
    return kst.toISOString().slice(0,10);
  }
  function ymd(d){ return d.toISOString().slice(0,10); }
  function dateFromYMD(s){
    const [y,m,dd] = s.split('-').map(Number);
    // UTC 자정으로 만들고 KST 보정은 경로 문자열에만 쓰므로 그대로 둡니다
    return new Date(Date.UTC(y, m-1, dd));
  }

  async function exists(url){
    try{
      const r = await fetch(url, { method:'HEAD', cache:'no-store' });
      return r.ok;
    }catch(_){ return false; }
  }

  // 1) 우선순위: ?pdf → 해당 경로
  let chosen = null;
  if (paramPdf){
    chosen = paramPdf;
  } else {
    // 2) ?date → 해당 날짜 경로, 없으면 어제 폴백
    // 3) 기본(오늘자) → 없으면 어제자 폴백
    const baseDate = paramDate || todayKST();
    const d0 = dateFromYMD(baseDate);
    const d1 = new Date(d0.getTime() - 24*60*60*1000);

    const candidates = [
      // primary (base date)
      `bm/out/${ymd(d0)}/bm20_daily_${ymd(d0)}.pdf`,
      // fallback (yesterday)
      `bm/out/${ymd(d1)}/bm20_daily_${ymd(d1)}.pdf`,
      // optional generic latest names (있다면 사용)
      'bm20_latest.pdf',
      'out/latest/bm20_daily.pdf'
    ];

    for (const u of candidates){
      if (u.toLowerCase().endsWith('.pdf') && await exists(u)){ chosen = u; break; }
    }
  }

  const obj = qs('#pdfObj'), frame = qs('#pdfFrame'), fallback = qs('#fallback');
  const openNew = qs('#openNew'), download = qs('#download');
  const fbOpen = qs('#fbOpen'), fbDown = qs('#fbDown');

  function wire(url){
    openNew.href = url; download.href = url;
    fbOpen.href = url; fbDown.href = url;
    document.title = `BM20 데일리 PDF — ${url.split('/').slice(-1)[0]}`;
    qs('#title').textContent = document.title;
  }
  function showFallback(msg){
    obj.style.display='none'; frame.style.display='none';
    fallback.style.display='block';
    if (msg) qs('#why').textContent = msg;
  }

  if (!chosen){
    showFallback('해당 규칙의 PDF를 찾지 못했습니다.');
    return;
  }
  wire(chosen);

  // 1차: object
  obj.data = chosen;

  let loaded = false;
  const t1 = setTimeout(()=> {
    if (!loaded){
      // 2차: iframe
      obj.style.display='none';
      frame.src = chosen;
      frame.style.display='block';

      const t2 = setTimeout(()=> {
        if (!frame.contentWindow) showFallback(); // 일부 iOS/Safari 케이스
      }, 1500);
      frame.addEventListener('load', ()=>{ clearTimeout(t2); loaded = true; }, { once:true });
    }
  }, 1000);

  obj.addEventListener?.('load', ()=>{ clearTimeout(t1); loaded = true; }, { once:true });
  obj.addEventListener?.('error', ()=> showFallback('브라우저가 object PDF 임베드를 지원하지 않습니다.'));
})();
</script>
</body>
</html>
