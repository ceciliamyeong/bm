<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BM20 데일리 PDF</title>
  <style>
    :root { --bar: 52px; }
    *{box-sizing:border-box}
    body{margin:0;background:#f5f6fa;color:#111;font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif}
    header{position:sticky;top:0;height:var(--bar);display:flex;align-items:center;gap:8px;padding:0 12px;background:#fff;border-bottom:1px solid #e5e9f0;z-index:10}
    header h1{font-size:15px;margin:0;font-weight:600}
    header .sp{flex:1}
    header a{padding:8px 12px;border:1px solid #d6d9e0;border-radius:10px;background:#fff;text-decoration:none;color:#111}
    #wrap{height:calc(100vh - var(--bar));}
    object, iframe{width:100%;height:100%;border:0;display:block}
    #fallback{display:none;height:100%;padding:20px}
    .card{max-width:760px;margin:0 auto;background:#fff;border:1px solid #e5e9f0;border-radius:12px;padding:18px}
    .muted{color:#666}
    code{background:#f0f3f8;border:1px solid #e1e6ef;border-radius:6px;padding:2px 6px}
  </style>
</head>
<body>
<header>
  <h1 id="title">BM20 데일리 PDF</h1>
  <div class="sp"></div>
  <a id="openNew" target="_blank" rel="noopener">새 탭</a>
  <a id="download" download>다운로드</a>
</header>

<div id="wrap">
  <!-- 1순위 임베드 -->
  <object id="pdfObj" type="application/pdf"></object>
  <!-- 2순위 임베드 -->
  <iframe id="pdfFrame" style="display:none"></iframe>
  <!-- 폴백 -->
  <div id="fallback">
    <div class="card">
      <h2 style="margin:0 0 8px">PDF 미리보기 불가</h2>
      <p class="muted" id="why">파일을 찾지 못했거나 브라우저가 내장 PDF 뷰어를 지원하지 않습니다.</p>
      <p>
        <a id="fbOpen" target="_blank" rel="noopener">🗔 새 탭으로 열기</a>
        &nbsp;•&nbsp;
        <a id="fbDown" download>📥 다운로드</a>
      </p>
      <hr style="border:none;border-top:1px solid #e5e9f0;margin:16px 0" />
      <p class="muted" style="font-size:12px">
        특정 파일: <code>?pdf=/경로/파일.pdf</code><br/>
        특정 날짜: <code>?date=YYYY-MM-DD</code>
      </p>
    </div>
  </div>
</div>

<script>
(async () => {
  const qs = s => document.querySelector(s);
  const usp = new URLSearchParams(location.search);
  const paramPdf  = usp.get('pdf');
  const paramDate = usp.get('date');

  // ✅ GitHub Pages(/bm 같은 baseurl)에서도 안전한 상대경로 사용
  const join = (...parts) => parts.filter(Boolean).map(p=>String(p).replace(/^\/+|\/+$/g,'')).join('/');

  // 오늘/어제 (KST)
  const now = new Date();
  const kstNow = new Date(now.getTime() + 9*60*60*1000);
  const toYMD = d => d.toISOString().slice(0,10);
  const baseDate = paramDate || toYMD(kstNow);
  const d0 = new Date(Date.UTC(...baseDate.split('-').map((n,i)=>i===1?Number(n)-1:Number(n)))); // UTC 자정
  const d1 = new Date(d0.getTime() - 24*60*60*1000);

  // 후보 경로 (상대경로만; HEAD 미리 안 때리고 바로 시도 → onload/onerror로 판별)
  const byDate = ymd => join('bm','out', ymd, `bm20_daily_${ymd}.pdf`);
  const candidates = [
    ...(paramPdf ? [paramPdf] : []),
    byDate(toYMD(d0)),
    byDate(toYMD(d1)),
    'bm20_latest.pdf',
    join('out','latest','bm20_daily.pdf')
  ];

  const obj = qs('#pdfObj'), frame = qs('#pdfFrame'), fallback = qs('#fallback');
  const openNew = qs('#openNew'), download = qs('#download');
  const fbOpen = qs('#fbOpen'), fbDown = qs('#fbDown');

  function wire(url){
    openNew.href = url; download.href = url;
    fbOpen.href = url; fbDown.href = url;
    const fname = url.split('/').pop();
    document.title = `BM20 데일리 PDF — ${fname}`;
    qs('#title').textContent = document.title;
  }
  function showFallback(msg){
    obj.style.display='none'; frame.style.display='none';
    fallback.style.display='block';
    if (msg) qs('#why').textContent = msg;
  }

  // 후보를 순차 시도: object → (실패시) iframe
  async function tryEmbed(urls){
    for (const url of urls){
      let solved = false;

      // 1) object
      obj.style.display = 'block';
      frame.style.display = 'none';
      obj.data = url; wire(url);

      solved = await new Promise(resolve => {
        let done = false;
        const ok = () => { if (!done){ done=true; resolve(true);} };
        const fail = () => { if (!done){ done=true; resolve(false);} };
        // 일부 브라우저는 object onload 미지원 → 타임아웃 보조
        const t = setTimeout(()=>{ if (!done){ done=true; resolve(false);} }, 900);
        obj.addEventListener?.('load', () => { clearTimeout(t); ok(); }, { once:true });
        obj.addEventListener?.('error', () => { clearTimeout(t); fail(); }, { once:true });
      });
      if (solved) return true;

      // 2) iframe
      obj.style.display = 'none';
      frame.src = url; frame.style.display = 'block';

      solved = await new Promise(resolve => {
        let done = false;
        const t = setTimeout(()=>{ if (!done){ done=true; resolve(false);} }, 1200);
        frame.addEventListener('load', ()=>{ if (!done){ clearTimeout(t); done=true; resolve(true);} }, { once:true });
      });
      if (solved){ wire(url); return true; }
    }
    return false;
  }

  const ok = await tryEmbed(candidates);
  if (!ok) showFallback('후보 경로에서 PDF를 열 수 없습니다.');
})();
</script>
</body>
</html>
