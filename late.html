<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BM20 ë°ì¼ë¦¬ PDF</title>
  <style>
    :root { --bar: 52px; }
    *{box-sizing:border-box}
    body{margin:0;background:#f5f6fa;color:#111;font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif}
    header{position:sticky;top:0;height:var(--bar);display:flex;align-items:center;gap:8px;padding:0 12px;background:#fff;border-bottom:1px solid #e5e9f0;z-index:10}
    header h1{font-size:15px;margin:0;font-weight:600}
    header .sp{flex:1}
    header a{padding:8px 12px;border:1px solid #d6d9e0;border-radius:10px;background:#fff;text-decoration:none;color:#111}
    #wrap{height:calc(100vh - var(--bar));}
    object, iframe{width:100%;height:100%;border:0;display:block}
    #fallback{display:none;height:100%;padding:20px}
    .card{max-width:760px;margin:0 auto;background:#fff;border:1px solid #e5e9f0;border-radius:12px;padding:18px}
    .muted{color:#666}
    code{background:#f0f3f8;border:1px solid #e1e6ef;border-radius:6px;padding:2px 6px}
  </style>
</head>
<body>
<header>
  <h1 id="title">BM20 ë°ì¼ë¦¬ PDF</h1>
  <div class="sp"></div>
  <a id="openNew" target="_blank" rel="noopener">ìƒˆ íƒ­</a>
  <a id="download" download>ë‹¤ìš´ë¡œë“œ</a>
</header>

<div id="wrap">
  <!-- 1ìˆœìœ„ ì„ë² ë“œ -->
  <object id="pdfObj" type="application/pdf"></object>
  <!-- 2ìˆœìœ„ ì„ë² ë“œ -->
  <iframe id="pdfFrame" style="display:none"></iframe>
  <!-- í´ë°± -->
  <div id="fallback">
    <div class="card">
      <h2 style="margin:0 0 8px">PDF ë¯¸ë¦¬ë³´ê¸° ë¶ˆê°€</h2>
      <p class="muted" id="why">íŒŒì¼ì„ ì°¾ì§€ ëª»í–ˆê±°ë‚˜ ë¸Œë¼ìš°ì €ê°€ ë‚´ì¥ PDF ë·°ì–´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
      <p>
        <a id="fbOpen" target="_blank" rel="noopener">ğŸ—” ìƒˆ íƒ­ìœ¼ë¡œ ì—´ê¸°</a>
        &nbsp;â€¢&nbsp;
        <a id="fbDown" download>ğŸ“¥ ë‹¤ìš´ë¡œë“œ</a>
      </p>
      <hr style="border:none;border-top:1px solid #e5e9f0;margin:16px 0" />
      <p class="muted" style="font-size:12px">
        íŠ¹ì • íŒŒì¼: <code>?pdf=/ê²½ë¡œ/íŒŒì¼.pdf</code><br/>
        íŠ¹ì • ë‚ ì§œ: <code>?date=YYYY-MM-DD</code>
      </p>
    </div>
  </div>
</div>

<script>
(async () => {
  const qs = s => document.querySelector(s);
  const usp = new URLSearchParams(location.search);
  const paramPdf  = usp.get('pdf');
  const paramDate = usp.get('date');

  // âœ… GitHub Pages(/bm ê°™ì€ baseurl)ì—ì„œë„ ì•ˆì „í•œ ìƒëŒ€ê²½ë¡œ ì‚¬ìš©
  const join = (...parts) => parts.filter(Boolean).map(p=>String(p).replace(/^\/+|\/+$/g,'')).join('/');

  // ì˜¤ëŠ˜/ì–´ì œ (KST)
  const now = new Date();
  const kstNow = new Date(now.getTime() + 9*60*60*1000);
  const toYMD = d => d.toISOString().slice(0,10);
  const baseDate = paramDate || toYMD(kstNow);
  const d0 = new Date(Date.UTC(...baseDate.split('-').map((n,i)=>i===1?Number(n)-1:Number(n)))); // UTC ìì •
  const d1 = new Date(d0.getTime() - 24*60*60*1000);

  // í›„ë³´ ê²½ë¡œ (ìƒëŒ€ê²½ë¡œë§Œ; HEAD ë¯¸ë¦¬ ì•ˆ ë•Œë¦¬ê³  ë°”ë¡œ ì‹œë„ â†’ onload/onerrorë¡œ íŒë³„)
  const byDate = ymd => join('bm','out', ymd, `bm20_daily_${ymd}.pdf`);
  const candidates = [
    ...(paramPdf ? [paramPdf] : []),
    byDate(toYMD(d0)),
    byDate(toYMD(d1)),
    'bm20_latest.pdf',
    join('out','latest','bm20_daily.pdf')
  ];

  const obj = qs('#pdfObj'), frame = qs('#pdfFrame'), fallback = qs('#fallback');
  const openNew = qs('#openNew'), download = qs('#download');
  const fbOpen = qs('#fbOpen'), fbDown = qs('#fbDown');

  function wire(url){
    openNew.href = url; download.href = url;
    fbOpen.href = url; fbDown.href = url;
    const fname = url.split('/').pop();
    document.title = `BM20 ë°ì¼ë¦¬ PDF â€” ${fname}`;
    qs('#title').textContent = document.title;
  }
  function showFallback(msg){
    obj.style.display='none'; frame.style.display='none';
    fallback.style.display='block';
    if (msg) qs('#why').textContent = msg;
  }

  // í›„ë³´ë¥¼ ìˆœì°¨ ì‹œë„: object â†’ (ì‹¤íŒ¨ì‹œ) iframe
  async function tryEmbed(urls){
    for (const url of urls){
      let solved = false;

      // 1) object
      obj.style.display = 'block';
      frame.style.display = 'none';
      obj.data = url; wire(url);

      solved = await new Promise(resolve => {
        let done = false;
        const ok = () => { if (!done){ done=true; resolve(true);} };
        const fail = () => { if (!done){ done=true; resolve(false);} };
        // ì¼ë¶€ ë¸Œë¼ìš°ì €ëŠ” object onload ë¯¸ì§€ì› â†’ íƒ€ì„ì•„ì›ƒ ë³´ì¡°
        const t = setTimeout(()=>{ if (!done){ done=true; resolve(false);} }, 900);
        obj.addEventListener?.('load', () => { clearTimeout(t); ok(); }, { once:true });
        obj.addEventListener?.('error', () => { clearTimeout(t); fail(); }, { once:true });
      });
      if (solved) return true;

      // 2) iframe
      obj.style.display = 'none';
      frame.src = url; frame.style.display = 'block';

      solved = await new Promise(resolve => {
        let done = false;
        const t = setTimeout(()=>{ if (!done){ done=true; resolve(false);} }, 1200);
        frame.addEventListener('load', ()=>{ if (!done){ clearTimeout(t); done=true; resolve(true);} }, { once:true });
      });
      if (solved){ wire(url); return true; }
    }
    return false;
  }

  const ok = await tryEmbed(candidates);
  if (!ok) showFallback('í›„ë³´ ê²½ë¡œì—ì„œ PDFë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
})();
</script>
</body>
</html>
