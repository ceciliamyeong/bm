<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BM20 ë°ì¼ë¦¬ PDF</title>
  <style>
    :root { --bar: 56px; }
    *{box-sizing:border-box}
    body{margin:0;background:#f5f6fa;color:#111;font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif}
    header{position:sticky;top:0;height:var(--bar);display:flex;align-items:center;gap:8px;padding:0 12px;background:#fff;border-bottom:1px solid #e5e9f0;z-index:10}
    header h1{font-size:15px;margin:0;font-weight:600}
    header .sp{flex:1}
    header a{padding:8px 12px;border:1px solid #d6d9e0;border-radius:10px;background:#fff;text-decoration:none;color:#111}
    #wrap{height:calc(100vh - var(--bar));}
    iframe, object{width:100%;height:100%;border:0;display:block}
    #fallback{display:none;height:100%;padding:20px}
    .card{max-width:760px;margin:0 auto;background:#fff;border:1px solid #e5e9f0;border-radius:12px;padding:18px}
    .muted{color:#666}
    code{background:#f0f3f8;border:1px solid #e1e6ef;border-radius:6px;padding:2px 6px}
  </style>
</head>
<body>
<header>
  <h1 id="title">BM20 ë°ì¼ë¦¬ PDF</h1>
  <div class="sp"></div>
  <a id="openNew" target="_blank" rel="noopener">ìƒˆ íƒ­</a>
  <a id="download" download>ë‹¤ìš´ë¡œë“œ</a>
</header>

<div id="wrap">
  <object id="pdfObj" type="application/pdf"></object>
  <iframe id="pdfFrame" style="display:none"></iframe>

  <div id="fallback">
    <div class="card">
      <h2 style="margin:0 0 8px">PDF ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h2>
      <p class="muted" id="why">íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ë¸Œë¼ìš°ì €ê°€ ë‚´ì¥ PDF ë·°ì–´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
      <p>
        <a id="fbOpen" target="_blank" rel="noopener">ğŸ—” ìƒˆ íƒ­ìœ¼ë¡œ ì—´ê¸°</a>
        &nbsp;â€¢&nbsp;
        <a id="fbDown" download>ğŸ“¥ ë‹¤ìš´ë¡œë“œ</a>
      </p>
      <hr style="border:none;border-top:1px solid #e5e9f0;margin:16px 0" />
      <p class="muted" style="font-size:12px">
        íŠ¹ì • ë‚ ì§œë¥¼ ë³´ë ¤ë©´ <code>?date=YYYY-MM-DD</code>, ì„ì˜ íŒŒì¼ì€ <code>?pdf=/ê²½ë¡œ/íŒŒì¼.pdf</code> ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
      </p>
    </div>
  </div>
</div>

<script>
(async () => {
  const qs = (s)=>document.querySelector(s);
  const usp = new URLSearchParams(location.search);
  const paramPdf  = usp.get('pdf');
  const paramDate = usp.get('date');

  // Asia/Seoul(KST, UTC+9) ê¸°ì¤€ YYYY-MM-DD ë¬¸ìì—´
  function todayKST(){
    const kst = new Date(Date.now() + 9*60*60*1000);
    return kst.toISOString().slice(0,10);
  }
  function ymd(d){ return d.toISOString().slice(0,10); }
  function dateFromYMD(s){
    const [y,m,dd] = s.split('-').map(Number);
    // UTC ìì •ìœ¼ë¡œ ë§Œë“¤ê³  KST ë³´ì •ì€ ê²½ë¡œ ë¬¸ìì—´ì—ë§Œ ì“°ë¯€ë¡œ ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤
    return new Date(Date.UTC(y, m-1, dd));
  }

  async function exists(url){
    try{
      const r = await fetch(url, { method:'HEAD', cache:'no-store' });
      return r.ok;
    }catch(_){ return false; }
  }

  // 1) ìš°ì„ ìˆœìœ„: ?pdf â†’ í•´ë‹¹ ê²½ë¡œ
  let chosen = null;
  if (paramPdf){
    chosen = paramPdf;
  } else {
    // 2) ?date â†’ í•´ë‹¹ ë‚ ì§œ ê²½ë¡œ, ì—†ìœ¼ë©´ ì–´ì œ í´ë°±
    // 3) ê¸°ë³¸(ì˜¤ëŠ˜ì) â†’ ì—†ìœ¼ë©´ ì–´ì œì í´ë°±
    const baseDate = paramDate || todayKST();
    const d0 = dateFromYMD(baseDate);
    const d1 = new Date(d0.getTime() - 24*60*60*1000);

    const candidates = [
      // primary (base date)
      `bm/out/${ymd(d0)}/bm20_daily_${ymd(d0)}.pdf`,
      // fallback (yesterday)
      `bm/out/${ymd(d1)}/bm20_daily_${ymd(d1)}.pdf`,
      // optional generic latest names (ìˆë‹¤ë©´ ì‚¬ìš©)
      'bm20_latest.pdf',
      'out/latest/bm20_daily.pdf'
    ];

    for (const u of candidates){
      if (u.toLowerCase().endsWith('.pdf') && await exists(u)){ chosen = u; break; }
    }
  }

  const obj = qs('#pdfObj'), frame = qs('#pdfFrame'), fallback = qs('#fallback');
  const openNew = qs('#openNew'), download = qs('#download');
  const fbOpen = qs('#fbOpen'), fbDown = qs('#fbDown');

  function wire(url){
    openNew.href = url; download.href = url;
    fbOpen.href = url; fbDown.href = url;
    document.title = `BM20 ë°ì¼ë¦¬ PDF â€” ${url.split('/').slice(-1)[0]}`;
    qs('#title').textContent = document.title;
  }
  function showFallback(msg){
    obj.style.display='none'; frame.style.display='none';
    fallback.style.display='block';
    if (msg) qs('#why').textContent = msg;
  }

  if (!chosen){
    showFallback('í•´ë‹¹ ê·œì¹™ì˜ PDFë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
    return;
  }
  wire(chosen);

  // 1ì°¨: object
  obj.data = chosen;

  let loaded = false;
  const t1 = setTimeout(()=> {
    if (!loaded){
      // 2ì°¨: iframe
      obj.style.display='none';
      frame.src = chosen;
      frame.style.display='block';

      const t2 = setTimeout(()=> {
        if (!frame.contentWindow) showFallback(); // ì¼ë¶€ iOS/Safari ì¼€ì´ìŠ¤
      }, 1500);
      frame.addEventListener('load', ()=>{ clearTimeout(t2); loaded = true; }, { once:true });
    }
  }, 1000);

  obj.addEventListener?.('load', ()=>{ clearTimeout(t1); loaded = true; }, { once:true });
  obj.addEventListener?.('error', ()=> showFallback('ë¸Œë¼ìš°ì €ê°€ object PDF ì„ë² ë“œë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'));
})();
</script>
</body>
</html>
