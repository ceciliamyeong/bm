<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>BM20 Index Factsheet</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>

  <style>
    :root{
      --bg:#f8fafc;
      --panel:#ffffff;
      --border:#e5e7eb;
      --text:#0f172a;
      --muted:#64748b;

      --shadow:0 1px 2px rgba(15,23,42,.06);
      --radius:14px;

      --accent:#2563eb;
      --accent-2:#7c3aed;

      --sidebar:#0b1220;
      --sidebarText:#e2e8f0;
      --sidebarMuted:#94a3b8;

      --chip:#f1f5f9;

      --up:#16a34a;
      --down:#dc2626;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif;
    }

    .app{
      display:grid;
      grid-template-columns: 260px 1fr;
      min-height:100vh;
    }
    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
    }

    .sidebar{
      background:var(--sidebar);
      padding:18px 14px;
      position:sticky;
      top:0;
      height:100vh;
      overflow:auto;
      border-right:1px solid rgba(255,255,255,.06);
    }
    @media (max-width: 980px){
      .sidebar{ position:relative; height:auto; }
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 10px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      margin-bottom:14px;
    }
    .logo{
      width:32px; height:32px;
      border-radius:10px;
      background:linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow:0 6px 18px rgba(37,99,235,.25);
    }
    .brand h1{
      margin:0;
      font-size:14px;
      color:var(--sidebarText);
      letter-spacing:-0.2px;
    }
    .brand p{
      margin:2px 0 0;
      font-size:12px;
      color:var(--sidebarMuted);
    }

    .navsec{ margin:14px 0; }
    .navtitle{
      font-size:11px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:rgba(226,232,240,.7);
      padding:0 10px;
      margin:0 0 8px;
    }
    .nav a{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border-radius:10px;
      color:var(--sidebarText);
      text-decoration:none;
      font-size:13px;
      transition: background .15s ease;
    }
    .nav a:hover{ background:rgba(255,255,255,.06); }
    .nav a .tag{
      font-size:11px;
      color:var(--sidebarMuted);
      background:rgba(255,255,255,.06);
      padding:2px 8px;
      border-radius:999px;
      white-space:nowrap;
    }

    .main{ padding:18px 18px 34px; }

    .topbar{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
      margin-bottom:14px;
    }
    .topbar .title h2{
      margin:0;
      font-size:20px;
      letter-spacing:-0.3px;
    }
    .topbar .title p{
      margin:6px 0 0;
      font-size:13px;
      color:var(--muted);
      max-width:920px;
      line-height:1.45;
    }
    .topbar .meta{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }

    .chip{
      background:var(--chip);
      border:1px solid var(--border);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color:#334155;
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .chip b{ font-weight:800; }
    .delta{
      font-weight:900;
      font-variant-numeric: tabular-nums;
    }
    .delta.up{ color:var(--up); }
    .delta.down{ color:var(--down); }

    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }

    .kpiGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-bottom:14px;
    }
    @media (min-width: 980px){
      .kpiGrid{ grid-template-columns: repeat(6, 1fr); }
    }
    .kpi{ padding:12px 12px; min-width:0; }
    .kpi .label{ color:var(--muted); font-size:12px; margin:0 0 6px; }
    .kpi .value{ font-size:20px; font-weight:900; letter-spacing:-0.3px; margin:0; }
    .kpi .note{ color:var(--muted); font-size:12px; margin-top:6px; }

    .section{ margin-top:16px; }
    .sectionHead{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin:0 0 10px;
    }
    .sectionHead h3{
      margin:0;
      font-size:14px;
      letter-spacing:-0.2px;
    }
    .sectionHead p{
      margin:6px 0 0;
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
    }
    .sectionHead .right{
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }

    .widgets{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 1100px){
      .widgets{ grid-template-columns: repeat(2, 1fr); }
    }

    .widget{ padding:12px; min-width:0; }
    .widgetHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .wTitle{ display:flex; gap:10px; align-items:flex-start; }
    .wIcon{
      width:28px; height:28px;
      border-radius:10px;
      background:#eef2ff;
      border:1px solid #e0e7ff;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#3730a3;
      font-weight:900;
      font-size:12px;
      flex:0 0 auto;
    }
    .wTitle h4{
      margin:0;
      font-size:13px;
      letter-spacing:-0.2px;
    }
    .wTitle .desc{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }
    .wMeta{
      text-align:right;
      color:var(--muted);
      font-size:11px;
      white-space:nowrap;
    }

    .chart{ width:100%; height:360px; }
    #perfBar{ height:160px; }
    #moverBar{ height:360px; }

    .toolbar{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .btn{
      border:1px solid var(--border);
      background:#fff;
      color:#334155;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
    }
    .btn.active{
      border-color:#0f172a;
      color:#0f172a;
      font-weight:900;
    }

    .pill{
      font-size:11px;
      color:#334155;
      background:var(--chip);
      border:1px solid var(--border);
      padding:3px 8px;
      border-radius:999px;
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .footnote{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      line-height:1.45;
    }
    code{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    /* Universe chips */
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }
    .chipSym{
      background:var(--chip);
      border:1px solid var(--border);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:#0f172a;
      display:inline-flex;
      gap:8px;
      align-items:center;
      font-variant-numeric: tabular-nums;
    }
    .chipSym b{ font-weight:900; }
    .chipSym span{ color:var(--muted); font-size:12px; }

    /* Summary card */
    .summaryBox{
      padding:12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fbfdff;
    }
    .summaryHead{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .summaryHead .title{
      font-size:13px;
      font-weight:900;
      letter-spacing:-0.2px;
    }
    .summaryText{
      margin-top:8px;
      font-size:13px;
      line-height:1.55;
      color:#0f172a;
    }
    .summaryActions{
      display:flex;
      justify-content:flex-end;
      margin-top:14px;
    }
    
    .shareBtn{
      background:none;
      border:1px solid #ddd;
      padding:6px 12px;
      font-size:12px;
      cursor:pointer;
      border-radius:6px;
    }
    
    .shareBtn:hover{
      background:#f5f5f5;
    }

    /* ===== Top20 Heatmap Mobile Scroll ===== */
    .heatmapWrap{
      width:100%;
    }
    
    @media (max-width: 720px){
      .heatmapWrap{
        overflow-x:auto;
        -webkit-overflow-scrolling:touch;
        border-radius:12px;
      }
    
      #perfBar{
        min-width: 980px;   /* 20개가 읽히는 폭 */
        height: 220px;      /* 모바일 높이 압축 */
      }
    }


    /* ===== Responsive width 100% + no awkward shrink ===== */
    html, body { width:100%; max-width:100%; overflow-x:hidden; }
    
    .app { width:100%; max-width:100%; }
    
    /* grid에서 자식이 넘치며 가로 스크롤 만드는 걸 막는 핵심 */
    .main, .panel, .widget, .kpi { min-width:0; }
    
    /* topbar가 줄어들 때 title/meta가 자연스럽게 줄바꿈/정렬 */
    .topbar .title { flex: 1 1 360px; min-width:0; }
    .topbar .meta  { flex: 0 1 auto; }
    @media (max-width: 980px){
      .main{ padding:14px 14px 28px; }      /* 좁을 때 여백만 살짝 줄여서 100% 체감 */
      .topbar .meta{ justify-content:flex-start; }
    }
    
    /* ===== Top20 Heatmap: keep horizontal scroll INSIDE card only ===== */
    .heatmapWrap{
      width:100%;
      max-width:100%;
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling:touch;
    }
    
    /* 히트맵은 넓이를 유지해야 글자 안 겹침 → 그래서 min-width 유지 */
    #perfBar{
      width:100%;
      min-width:980px;
    }

    
  </style>
</head>

<body>
<div class="app">

  <!-- LEFT SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>BM20 Index</h1>
        <p>Blockmedia Large-Cap 20</p>
      </div>
    </div>

    <div class="navsec">
      <div class="navtitle">Dashboards</div>
      <nav class="nav">
        <a href="https://data.blockmedia.co.kr/" target="_blank" rel="noreferrer">Data Hub <span class="tag">ROOT</span></a>
        <a href="https://data.blockmedia.co.kr/bm20_index.html" title="현재 페이지">BM20 Index <span class="tag">LIVE</span></a>
        <a href="https://ceciliamyeong.github.io/bm/krw_rolling24h_dashboard.html" target="_blank" rel="noreferrer">KRW Market <span class="tag">KRW</span></a>
      </nav>
    </div>

    <div class="navsec">
      <div class="navtitle">BM20</div>
      <nav class="nav">
        <a href="#sec-overview">Overview <span class="tag">KPI</span></a>
        <a href="#sec-series">Index Series <span class="tag">LINE</span></a>
        <a href="#sec-movers">Top Movers <span class="tag">1D</span></a>
        <a href="#sec-universe">Universe <span class="tag">20</span></a>
       
      </nav>
    </div>

    
  </aside>

  <!-- MAIN -->
  <main class="main">

    <div class="topbar">
      <div class="title">
        <h2>BM20 Index Dashboard</h2>
        <p>
          BM20은 글로벌 디지털 자산 시장을 대표하는 대형 자산 20종으로 구성된
          블록미디어 자체 산출 지수입니다.
          지수 레벨과 기간별 수익률을 통해 시장의 방향성과 강도를 파악할 수 있습니다.
        </p>
      </div>
      <div class="meta">
        <span class="chip" id="metaAsOf">ASOF: -</span>
        <span class="chip" id="metaDelta">1D: -</span>
        <span class="chip" id="metaMethod">METHOD: -</span>
      </div>
    </div>

    <!-- KPI -->
    <section id="sec-overview" class="kpiGrid">
      <div class="panel kpi">
        <p class="label">지수 레벨</p>
        <p class="value" id="kpiLevel">-</p>
        <div class="note" id="kpiLevelNote">-</div>
      </div>

      <div class="panel kpi">
        <p class="label">1D</p>
        <p class="value" id="kpi1d">-</p>
        <div class="note" id="kpiBreadth">-</div>
      </div>

      <div class="panel kpi">
        <p class="label">7D</p>
        <p class="value" id="kpi7d">-</p>
        <div class="note" id="kpi7dNote">-</div>
      </div>

      <div class="panel kpi">
        <p class="label">30D</p>
        <p class="value" id="kpi30d">-</p>
        <div class="note" id="kpi30dNote">-</div>
      </div>

      <div class="panel kpi">
        <p class="label">1Y</p>
        <p class="value" id="kpi1y">-</p>
        <div class="note" id="kpi1yNote">-</div>
      </div>

      <div class="panel kpi" style="border-color:#bfdbfe;">
        <p class="label" style="color:#1d4ed8;">Kimchi Premium</p>
        <p class="value" id="kimchiValue">-</p>
      </div>
    </section>

    <!-- SUMMARY -->
    <section class="section" id="summary">
      <div class="panel widget">
        <div class="widgetHead">
          <div class="wTitle">
            <div class="wIcon">N</div>
            <div>
              <h4>Market Summary</h4>
              <div class="desc">BM20 일일 시장 요약</div>
            </div>
          </div>
          <div class="wMeta" id="newsMeta">-</div>
        </div>

        <div class="summaryBox">
          <div class="summaryHead">
            <div class="title" id="newsTitle">-</div>
            <div class="pill" id="newsBadge">NEWS</div>
          </div>
          <div class="summaryText" id="newsBody">-</div>
          <div class="summaryActions">
            <button class="shareBtn" onclick="shareSection('summary')">Share</button>
          </div>
        </div>
      </div>
    </section>

    <!-- INDEX SERIES -->
    <section class="section" id="sec-series">
      <div class="sectionHead">
        <div>
          <h3>Index Series</h3>
        
          <div class="toolbar">
            <button class="btn active" id="btn1y">1Y</button>
            <button class="btn" id="btnytd">YTD</button>
            <button class="btn" id="btnall">ALL</button>
            <span class="pill" id="seriesStatus">series: -</span>
          </div>
        </div>
        <div class="right" id="seriesMeta">-</div>
      </div>

      <div class="panel widget">
        <div class="widgetHead">
          <div class="wTitle">
            <div class="wIcon">L</div>
            <div>
              <h4>BM20 Index (Line)</h4>
            
            </div>
          </div>
       
        </div>
        <div id="seriesChart" class="chart"></div>
      </div>
    </section>

<!-- TOP MOVERS -->
<section class="section" id="sec-movers">
  <div class="sectionHead">
    <div>
      <h3>Top Movers (1D Return)</h3>
    </div>
    <div class="right" id="moverMeta">-</div>
  </div>

  <!-- 1) SUMMARY 먼저 -->
  <div class="panel widget">
    <div class="widgetHead">
      <div class="wTitle">
        <div class="wIcon">⇧</div>
        <div>
          <h4>Best 3 / Worst 3</h4>
        </div>
      </div>
      <div class="wMeta" id="bwMeta"></div>
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <span class="pill">Best 3: <b id="best3">-</b></span>
      <span class="pill">Worst 3: <b id="worst3">-</b></span>
      <span class="pill">Breadth: <b id="breadth">-</b></span>
    </div>

    <div class="footnote" style="margin-top:10px">
      
    </div>
  </div>

  <!-- 2) TOP MOVERS VISUAL 크게 -->
  <div class="panel widget" style="margin-top:12px;">
    <div class="widgetHead">
      <div class="wTitle">
        <div class="wIcon">M</div>
        <div>
          <h4>Top Movers (Visual)</h4>
          <div class="desc">가장 큰 움직임을 위/아래로 강조</div>
        </div>
      </div>
      <div class="wMeta"></div>
    </div>
    <div id="moverBar" class="chart"></div>
  </div>

  <!-- 3) TOP20 HEATMAP (맨 마지막, full-width) -->
  <div class="panel widget" style="margin-top:12px;">
    <div class="widgetHead">
      <div class="wTitle">
        <div class="wIcon">H</div>
        <div>
          <h4>Top 20 Heatmap</h4>
          <div class="desc">BM20 전체 등락률 분포</div>
        </div>
      </div>
      <div class="wMeta"></div>
    </div>

    <div class="heatmapWrap">
      <div id="perfBar" class="chart"></div>
    </div>
  </div>
</section>

    <!-- UNIVERSE -->
    <section class="section" id="sec-universe">
      <div class="sectionHead">
        <div>
          <h3>Index Construction & Methodology</h3>
          <p>지수 구성 방식 및 리밸런싱 원칙</p>
        </div>
        <div class="right" id="uniMeta">-</div>
      </div>

      <div class="panel widget">
        <div class="widgetHead">
          <div class="wTitle">
            <div class="wIcon">R</div>
            <div>
              <h4>Index Construction</h4>
              <div class="desc">BM20 구성 방식 및 편입 원칙</div>
            </div>
          </div>
        </div>
      
        <div class="footnote">
          BM20은 글로벌 디지털 자산 시장을 대표하는 대형 자산 20종으로 구성된 바스켓 지수입니다.<br>
          BTC 30%, ETH 20%, XRP·USDT·BNB 각 5%를 핵심 비중으로 반영하며,<br>
          나머지 15종은 동일 가중(총 35%)으로 편입됩니다.<br>
          지수 구성은 분기별 리밸런싱을 통해 시장 구조 변화를 반영합니다.
        </div>
      </div>


        <div class="panel widget">
          <div class="widgetHead">
            <div class="wTitle">
              <div class="wIcon">20</div>
              <div>
                <h4>Current Universe </h4>
                <div class="desc">편입 자산 구성 · 기준일: <span id="uniAsOf">-</span></div>
              </div>
            </div>
            <div class="wMeta" id="uniStats">-</div>
          </div>

          <div class="chips" id="uniList"></div>
          <div class="footnote">
            * 구성 자산은 리밸런싱 일정에 따라 자동 업데이트됩니다.
          </div>
        </div>
      </div>
    </section>

    <!-- Disclaimer -->
    <section class="section">
      <div class="panel widget" style="background:#f8fafc;">
        <div class="widgetHead">
          <div class="wTitle">
            <div class="wIcon">ℹ</div>
            <div>
              <h4>Disclaimer</h4>
              <div class="desc">Information Purpose Only</div>
            </div>
          </div>
        </div>
    
        <div class="footnote" style="font-size:12px; color:#64748b; line-height:1.6;">
          본 지수 및 대시보드에 제공되는 정보는 시장 동향 파악을 위한 참고 자료이며,
          특정 디지털 자산에 대한 투자 권유 또는 재무적 조언을 구성하지 않습니다.
          투자 결정은 각 투자자의 판단과 책임 하에 이루어져야 합니다.
        </div>
      </div>
    </section>

  </main>
</div>

<script>
  // ===== Utils =====
  const qs = (s, el=document) => el.querySelector(s);
  const qsa = (s, el=document) => Array.from(el.querySelectorAll(s));

  const fmtNum = (v, digits=2) => {
    const n = Number(v);
    if (!Number.isFinite(n)) return "-";
    return new Intl.NumberFormat('en-US',{maximumFractionDigits:digits}).format(n);
  };

  // v is ratio (0.0123 => 1.23%)
  const fmtPctRatio = (v, digits=2) => {
    const n = Number(v);
    if (!Number.isFinite(n)) return "-";
    const sign = n > 0 ? "+" : "";
    return sign + (n*100).toFixed(digits) + "%";
  };

  // v is percent number (1.23 => 1.23%)
  const fmtPctNumber = (v, digits=2) => {
    const n = Number(v);
    if (!Number.isFinite(n)) return "-";
    const sign = n > 0 ? "+" : "";
    return sign + n.toFixed(digits) + "%";
  };

  const bust = () => "v=" + Date.now();

  async function fetchAnyJson(urls){
    for (const u of urls){
      try{
        const r = await fetch(u + (u.includes("?") ? "&" : "?") + bust(), {cache:'no-store'});
        if (r.ok) return {url:u, json: await r.json()};
      }catch(e){}
    }
    throw new Error("No JSON found");
  }

  async function fetchTextTry(url){
    try{
      const r = await fetch(url + "?" + bust(), {cache:'no-store'});
      if (r.ok) return await r.text();
    }catch(e){}
    return null;
  }

  function ymdFrom(asof){
    const t = asof ? new Date(asof) : new Date();
    const y=t.getFullYear(), m=String(t.getMonth()+1).padStart(2,'0'), d=String(t.getDate()).padStart(2,'0');
    return `${y}-${m}-${d}`;
  }

  function extractKimchi(obj){
    if (obj == null) return null;

    if (typeof obj === 'number' && Number.isFinite(obj)){
      if (obj >= 1) return obj / 100;
      return obj;
    }
    if (typeof obj === 'string'){
      const s = obj.trim();
      const hasPct = s.includes('%');
      const v = parseFloat(s.replace('%',''));
      if (!Number.isFinite(v)) return null;
      if (hasPct) return v/100;
      return v >= 1 ? v/100 : v;
    }
    if (typeof obj === 'object'){
      const candidates = [
    // ✅ SSOT: root latest news
    `bm/bm20_news_latest.txt`,
    `bm20_news_latest.txt`,

    // ✅ Prefer latest endpoints
    `bm/out/latest/bm20_news_${d}.txt`,
    `out/latest/bm20_news_${d}.txt`,
    `bm/out/latest/bm20_news_latest.txt`,
    `out/latest/bm20_news_latest.txt`,

    // Fallback to dated paths
    `out/${d}/bm20_news_${d}.txt`,
    `archive/${d}/bm20_news_${d}.txt`,
    `bm/out/${d}/bm20_news_${d}.txt`,
    `bm/archive/${d}/bm20_news_${d}.txt`,
  ];
      for (const k of candidates){
        if (Object.hasOwn(obj,k)) return extractKimchi(obj[k]);
      }
      for (const k of Object.keys(obj)){
        const out = extractKimchi(obj[k]);
        if (out != null) return out;
      }
    }
    return null;
  }

  function setDeltaChip(el, ratio){
    if (!el) return;
    const n = Number(ratio);
    if (!Number.isFinite(n)) { el.textContent = "1D: -"; return; }
    const s = (n>=0 ? "▲ " : "▼ ") + fmtPctRatio(n, 2);
    el.innerHTML = `1D: <span class="delta ${n>=0?'up':'down'}">${s}</span>`;
  }

  function parseFunding(f){
    if (f==null) return "-";
    if (typeof f === 'number') return fmtPctRatio(f,2);
    if (typeof f === 'string') return f;
    if (typeof f === 'object'){
      const btc = f.btc ?? f.BTC ?? f.Btc;
      const eth = f.eth ?? f.ETH ?? f.Eth;
      const p = x => (typeof x === 'number') ? fmtPctRatio(x,2) : (x ?? "-");
      return `BTC ${p(btc)} · ETH ${p(eth)}`;
    }
    return "-";
  }

  // ===== Charts =====
  let seriesChart, perfChart, moverChart;
  let SERIES = [];
  let LATEST = null;

  function initCharts(){
    seriesChart = echarts.init(document.getElementById("seriesChart"));
    perfChart   = echarts.init(document.getElementById("perfBar"));
    moverChart  = echarts.init(document.getElementById("moverBar"));

    const ro = new ResizeObserver(() => {
      requestAnimationFrame(() => {
        seriesChart?.resize();
        perfChart?.resize();
        moverChart?.resize();
      });
    });
    [seriesChart, perfChart, moverChart].forEach(c => c && ro.observe(c.getDom()));
    document.addEventListener("visibilitychange", () => {
      if (!document.hidden) setTimeout(()=>[seriesChart,perfChart,moverChart].forEach(c=>c?.resize()), 50);
    });
  }

  function sliceSeries(mode){
    const arr = SERIES.slice().sort((a,b)=>a.t-b.t);
    if (!arr.length) return arr;

    if (mode === "YTD"){
      const y0 = new Date(new Date().getFullYear(),0,1);
      return arr.filter(p => p.t >= y0);
    }
    if (mode === "1Y"){
      const d = new Date();
      d.setFullYear(d.getFullYear()-1);
      return arr.filter(p => p.t >= d);
    }
    return arr;
  }

  function renderSeries(mode){
    const data = sliceSeries(mode);
    const status = document.getElementById("seriesStatus");
    const meta = document.getElementById("seriesMeta");

    if (!data.length){
      status.textContent = "series: -";
      meta.textContent = "no data";
      seriesChart?.clear();
      return;
    }

    status.textContent = `${mode}`;
    meta.textContent = "";

    const x = data.map(d => d.date);
    const y = data.map(d => d.v);

    // axis range with padding
    const minV = Math.min(...y);
    const maxV = Math.max(...y);
    const pad = (maxV-minV) * 0.12 || 1;
    const ymin = Math.floor(minV - pad);
    const ymax = Math.ceil(maxV + pad);

    seriesChart.setOption({
      animationDuration: 2400,
      animationEasing: "quarticInOut",
      grid: { left: 52, right: 18, top: 28, bottom: 36, containLabel: true },
      tooltip: {
        trigger: "axis",
        axisPointer: { type: "line" },
        formatter: (params) => {
          const p = params[0];
          const idx = p.dataIndex;
          const v = y[idx];
          return `<b>${x[idx]}</b><br/>BM20 ${Math.round(v).toLocaleString()}`;
        }
      },
      xAxis: {
        type: "category",
        data: x,
        boundaryGap: false,
        axisLabel: { color: "#64748b", hideOverlap:true },
        axisLine: { lineStyle:{ color:"#e5e7eb" } },
        axisTick: { show:false }
      },
      yAxis: {
        type: "value",
        min: ymin,
        max: ymax,
        axisLabel: {
          color:"#64748b",
          formatter: function (value) {
            return Math.round(value).toLocaleString();
          }
        },
        splitLine: { show:true, lineStyle:{ color:"#e5e7eb" } }
      },
      dataZoom: [
        { type:"inside", start: 0, end: 100 },
        { type:"slider", height: 18, bottom: 8 }
      ],
      series: [{
        type: "line",
        data: y,
        smooth: true,
        symbol: "circle",
        symbolSize: 5,
        showSymbol: false,
        lineStyle: { width: 2 },
        areaStyle: { opacity: 0.08 }
      }]
    }, true);
  }

  // ===== Load Latest + Universe binding (public) =====
  function bindUniverseAndMethodology(j){
    const asofTxt = (j.asOf || j.as_of || j.date || j.day || '') + '';
    const asofEl = document.getElementById('uniAsOf');
    if (asofEl) asofEl.textContent = asofTxt || '-';
  
    const comps = Array.isArray(j.components) ? j.components : [];
    const uniList = document.getElementById('uniList');
    const uniStats = document.getElementById('uniStats');
    const uniMeta = document.getElementById('uniMeta');
  
    // 공개 페이지: Universe만 표시
    if (!uniList) return;
  
    const rows = comps
      .map(x => ({
        symbol: (x.symbol || '').toUpperCase(),
        weight: Number(x.weight ?? x.weight_ratio ?? x.w ?? x.weight_base)
      }))
      .filter(x => x.symbol && Number.isFinite(x.weight))
      .sort((a,b)=>b.weight-a.weight);
  
    // chips render
    uniList.innerHTML = rows.map(r=>{
      const w = r.weight * 100;
      return `<span class="chipSym" title="${w.toFixed(2)}%">
        <b>${r.symbol}</b><span>${w.toFixed(2)}%</span>
      </span>`;
    }).join('');
  
    // 민감/내부수치(Σweight 소수점 등) 제거: 개수만 간단히
    if (uniStats) uniStats.textContent = rows.length ? `Universe ${rows.length}` : '';
    if (uniMeta) uniMeta.textContent = asofTxt ? `asOf ${asofTxt}` : '';
  }


  // ===== Load series =====
  async function loadSeries(){
    const status = document.getElementById("seriesStatus");
    const { url, json: arr } = await fetchAnyJson(["bm20_series.json","series.json","bm/bm20_series.json","bm/series.json"]);
    const points = (Array.isArray(arr)?arr:[]).map(d=>{
      const date = (d.date||d.day||d.asof||d.asOf||d[0]);
      const v = Number(d.level||d.index||d.value||d.close||d.bm20Level||d[1]);
      const t = new Date(date || Date.now());
      return { date: (date ? String(date).slice(0,10) : ymdFrom(null)), t, v };
    }).filter(p => Number.isFinite(p.v) && p.t.toString() !== "Invalid Date")
      .sort((a,b)=>a.t-b.t);

    SERIES = points;
    const el = document.getElementById("seriesStatus");
    if (el) el.textContent = `series: ${url} · points: ${points.length}`;
  }

  // ===== Load CSV =====
  async function loadPerfCSV(asof){
    const d = ymdFrom(asof);
    const main = `out/${d}/bm20_daily_data_${d}.csv`;
    const csv = await fetchTextTry(main);
    if (csv) return {d, path: main, csv};
    const alt = `bm/out/${d}/bm20_daily_data_${d}.csv`;
    const csv2 = await fetchTextTry(alt);
    if (csv2) return {d, path: alt, csv: csv2};
    return null;
  }

  function parseCSV(csv){
    const lines = csv.trim().split(/\r?\n/);
    if (lines.length < 2) return [];
    const head = lines[0].split(',').map(s=>s.trim());
    const idx = Object.fromEntries(head.map((h,i)=>[h,i]));

    const get = (cols, key) => cols[idx[key]];

    const rows = lines.slice(1).map(line=>{
      const c = line.split(',').map(s=>s.trim());
      const sym = (get(c,'symbol')||'').toUpperCase();
      const pct = Number(get(c,'price_change_pct'));
      const ret = Number.isFinite(pct) ? (pct/100) : null; // ratio
      return { symbol: sym, ret_1d: ret };
    }).filter(r=>r.symbol && r.ret_1d!=null);

    return rows;
  }

  function renderMovers(rows, asof, sourcePath){
    const moverMeta = document.getElementById("moverMeta");
    const bwMeta = document.getElementById("bwMeta");
    if (moverMeta) moverMeta.textContent = `${asof || "-"}`;
    if (bwMeta) bwMeta.textContent = "";

    // best/worst
    const sorted = rows.slice().sort((a,b)=>b.ret_1d - a.ret_1d);
    const best3 = sorted.slice(0,3);
    const worst3 = sorted.slice(-3).reverse();

    const upCount = rows.filter(r=>r.ret_1d>0).length;
    const downCount = rows.filter(r=>r.ret_1d<0).length;

    qs("#best3").textContent = best3.map(r=>`${r.symbol}(${fmtPctRatio(r.ret_1d,2)})`).join(" · ") || "-";
    qs("#worst3").textContent = worst3.map(r=>`${r.symbol}(${fmtPctRatio(r.ret_1d,2)})`).join(" · ") || "-";
    qs("#breadth").textContent = `${upCount} ↑ · ${downCount} ↓`;

    const breadthEl = document.getElementById("breadth");
    const kpiBreadth = document.getElementById("kpiBreadth");
    if (kpiBreadth) kpiBreadth.textContent = `상승 ${upCount} · 하락 ${downCount}`;

    // --- Top20 Heatmap (Worst → Best order) ---

    // 전체를 수익률 기준으로 정렬 (Worst → Best)
    const topN = rows
      .slice()
      .sort((a, b) => a.ret_1d - b.ret_1d)  // ascending
      .slice(0, 20);
    
    const xCats = topN.map(r => r.symbol);
    const vals  = topN.map(r => r.ret_1d);
    
    // heatmap data: [xIndex, yIndex(0), value]
    const heatData = vals.map((v, i) => [i, 0, v]);
    const isMobile = window.matchMedia("(max-width: 720px)").matches;
    
    perfChart.setOption({
      grid: { left: 18, right: 18, top: 14, bottom: 46, containLabel: true },
    
      tooltip: {
        trigger: "item",
        formatter: (p) => {
          const sym = xCats[p.data[0]];
          const v = p.data[2];
          return `<b>${sym}</b><br/>1D ${fmtPctRatio(v,2)}`;
        }
      },
    
      xAxis: {
        type: "category",
        data: xCats,
        axisLabel: {
          color:"#0f172a",
          interval: 0
        },
        axisTick: { show:false },
        axisLine: { lineStyle:{ color:"#e5e7eb" } }
      },
    
      yAxis: {
        type: "category",
        data: ["1D"],
        axisTick:{ show:false },
        axisLabel:{ 
          show: !isMobile,   // ✅ 모바일에서는 숨김
          color:"#0f172a"
        }
      },
    
      visualMap: {
        show: false,
        min: Math.min(...vals),
        max: Math.max(...vals),
        dimension: 2,
        inRange: {
          // Worst(음수) → 빨강, Neutral → 회색, Best(양수) → 초록
          color: ["#dc2626", "#f1f5f9", "#16a34a"]
        }
      },
    
      series: [{
        type: "heatmap",
        data: heatData,
    
        label: {
          show: true,                 // ✅ 무조건 보이게 (일단 복구)
          position: "inside",
          formatter: (p) => fmtPctRatio(p.data[2], 2),  // ✅ heatmap은 data[2]
          color: "#0f172a",
          fontWeight: 800
        },
    
        itemStyle: {
          borderColor: "#ffffff",
          borderWidth: 2,
          borderRadius: 8
        },
    
        emphasis: {
          itemStyle: { shadowBlur: 10 }
        }
      }]
    }, true);

    if (isMobile) {
      setTimeout(() => perfChart.resize(), 80);
    }


    // movers visual (best & worst emphasis)
    const movers = best3.concat(worst3);
    const moverCats = movers.map(r=>r.symbol);
    const moverVals = movers.map(r=>r.ret_1d);

    moverChart.setOption({
      grid: { left: 18, right: 18, top: 18, bottom: 12, containLabel: true },
      tooltip: {
        trigger: "axis",
        axisPointer: { type: "shadow" },
        formatter: (params) => {
          const p = params[0];
          return `<b>${p.name}</b><br/>1D ${fmtPctRatio(p.value,2)}`;
        }
      },
      xAxis: {
        type: "value",
        axisLabel: { color:"#64748b", formatter: v => (v*100).toFixed(0)+"%" },
        splitLine: { show:true, lineStyle:{ color:"#e5e7eb" } }
      },
      yAxis: { type: "category", data: moverCats, axisTick:{show:false}, axisLabel:{color:"#0f172a"} },
      series: [{
        type: "bar",
        data: moverVals,
        barWidth: 18,
        itemStyle: { color: (p)=> (p.value>=0 ? "#16a34a" : "#dc2626") },
        label: { show:true, position:"right", formatter: p=>fmtPctRatio(p.value,2), fontWeight:900 }
      }]
    }, true);
  }

  // ===== News loader =====
  async function loadNews(asof){
  const d = ymdFrom(asof);
  const candidates = [
    // ✅ Prefer latest endpoints first
    `bm/out/latest/bm20_news_${d}.txt`,
    `out/latest/bm20_news_${d}.txt`,
    `bm/out/latest/bm20_news_latest.txt`,
    `out/latest/bm20_news_latest.txt`,

    // Fallback to dated paths
    `out/${d}/bm20_news_${d}.txt`,
    `archive/${d}/bm20_news_${d}.txt`,
    `bm/out/${d}/bm20_news_${d}.txt`,
    `bm/archive/${d}/bm20_news_${d}.txt`,
  ];
    for (const p of candidates){
      const txt = await fetchTextTry(p);
      if (txt){
        const lines = txt.trim().split(/\r?\n/);
        const title = lines[0] || "BM20 Update";
        const body = lines.slice(1).join("\n").trim() || lines[0] || "-";

        const meta = document.getElementById("newsMeta");
        if (meta) meta.textContent = `Updated ${d}`;

        const a = document.getElementById("newsLink");
        if (a){
          a.style.display = "inline";
          a.href = p;
          a.textContent = `bm20_news_${d}.txt`;
        }

        document.getElementById("newsTitle").textContent = title;
        document.getElementById("newsBody").textContent = body;
        return true;
      }
    }
    // fallback: no news
    const meta = document.getElementById("newsMeta");
    if (meta) meta.textContent = `asOf ${d} · news not found`;
    return false;
  }

  // ===== Main loader =====
  async function loadLatest(){
    const { json: j } = await fetchAnyJson(["bm20_latest.json","latest.json","bm/bm20_latest.json","bm/latest.json"]);
    LATEST = j;

    const asof = j.asOf || j.as_of || j.date || j.day || "";
    const level = j.bm20Level ?? j.level ?? j.index ?? j.value;

    const R = j.returns || {};
    const r1 = j.bm20ChangePct ?? R["1D"];
    const r7 = R["7D"];
    const r30 = R["30D"];
    const r1y = R["1Y"];
    const rytd = R["YTD"];

    // meta chips
    const metaAsOf = document.getElementById("metaAsOf");
    if (metaAsOf) metaAsOf.innerHTML = `ASOF: <b>${asof || "-"}</b>`;
    setDeltaChip(document.getElementById("metaDelta"), r1);

    // KPI values
    document.getElementById("kpiLevel").textContent = fmtNum(level, 2);
    document.getElementById("kpiLevelNote").textContent = `base=100 · ${asof || "-"}`;

    document.getElementById("kpi1d").innerHTML = `<span class="delta ${(Number(r1)>=0)?'up':'down'}">${fmtPctRatio(r1,2)}</span>`;
    document.getElementById("kpi7d").textContent = fmtPctRatio(r7,2);
    document.getElementById("kpi30d").textContent = fmtPctRatio(r30,2);
    document.getElementById("kpi1y").textContent = fmtPctRatio(r1y,2);

    document.getElementById("kpi7dNote").textContent = "rolling";
    document.getElementById("kpi30dNote").textContent = "rolling";
    document.getElementById("kpi1yNote").textContent = "rolling";

    // Kimchi / Funding
    const funding = j.funding_rates || j.funding || j.funding_bps || j.fundingRate;
    const kLatest = j.kimchi_2025 ?? j.kimchi_premium_pct ?? j.kimchi_premium_latest ?? j.kimchi;
    const kimchiRatio = extractKimchi(kLatest);

    const kimchiEl = document.getElementById("kimchiValue");
    if (kimchiEl) kimchiEl.textContent = (kimchiRatio!=null) ? fmtPctRatio(kimchiRatio,2) : "-";


    // News
    await loadNews(asof);

    // Universe & Methodology
    bindUniverseAndMethodology(j);

    // Load CSV + movers
    const perf = await loadPerfCSV(asof);
    if (perf){
      const rows = parseCSV(perf.csv);
      renderMovers(rows, asof, perf.path);
    }

    // Link hook
    const newsPath = j.news_file || j.news_path || j.news;
    if (newsPath && typeof newsPath === "string"){
      const a = document.getElementById("newsLink");
      if (a){
        a.style.display = "inline";
        a.href = newsPath;
      }
    }
  }

  function shareSection(id){
    const url = window.location.origin + window.location.pathname + "#" + id;
    navigator.clipboard.writeText(url);
    alert("Link copied");
  }


  
  // ===== Controls =====
  function setActive(btnId){
    ["btn1y","btnytd","btnall"].forEach(id => {
      const b = document.getElementById(id);
      if (b) b.classList.toggle("active", id === btnId);
    });
  }

  async function main(){
    initCharts();

    await loadSeries();
    renderSeries("1Y");
    setActive("btn1y");

    document.getElementById("btn1y")?.addEventListener("click", ()=>{
      renderSeries("1Y"); setActive("btn1y");
    });
    document.getElementById("btnytd")?.addEventListener("click", ()=>{
      renderSeries("YTD"); setActive("btnytd");
    });
    document.getElementById("btnall")?.addEventListener("click", ()=>{
      renderSeries("ALL"); setActive("btnall");
    });

    await loadLatest();

    window.addEventListener("resize", ()=>{
      seriesChart?.resize(); perfChart?.resize(); moverChart?.resize();
    });
  }

  main().catch(err=>{
    console.error(err);
    alert("BM20 로딩 실패: bm20_latest.json / bm20_series.json / out/YYYY-MM-DD/*.csv 경로를 확인하세요.");
  });
</script>

</body>
</html>
